<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Transfer Button Fix Verification</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <style>
        .test-result { margin-top: 20px; }
        .debug-info { background-color: #f8f9fa; padding: 15px; border-radius: 5px; }
    </style>
</head>
<body>
    <div class="container mt-5">
        <h1 class="mb-4">Transfer Button Fix Verification</h1>
        <p class="lead">This page verifies that the transfer button functionality is working correctly after the fixes.</p>
        
        <div class="card mb-4">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">Test Scenario: THEATRE-PH Active Store (Dispensary ID: 58)</h5>
            </div>
            <div class="card-body">
                <p>Based on our database check, this dispensary has an active store with 35 inventory items.</p>
                
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Medication</th>
                                <th>Batch Number</th>
                                <th>Stock Quantity</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>Alcohol Swabs</td>
                                <td>BATCH001</td>
                                <td>1000</td>
                                <td>
                                    <button type="button" class="btn btn-sm btn-primary transfer-btn" 
                                            data-medication="1"
                                            data-medication-name="Alcohol Swabs"
                                            data-batch="BATCH001"
                                            data-quantity="1000">
                                        Transfer
                                    </button>
                                </td>
                            </tr>
                            <tr>
                                <td>Ampicillin</td>
                                <td>BATCH002</td>
                                <td>1000</td>
                                <td>
                                    <button type="button" class="btn btn-sm btn-primary transfer-btn" 
                                            data-medication="2"
                                            data-medication-name="Ampicillin"
                                            data-batch="BATCH002"
                                            data-quantity="1000">
                                        Transfer
                                    </button>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- Transfer Modal (Exact replica of the template) -->
        <div class="modal fade" id="transferModal" tabindex="-1" aria-labelledby="transferModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="transferModalLabel">Transfer Medication to Dispensary</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <form id="transferForm">
                        <div class="modal-body">
                            <input type="hidden" id="medicationId" name="medication_id">
                            <input type="hidden" id="batchNumber" name="batch_number">
                            
                            <div class="mb-3">
                                <label for="medicationName" class="form-label">Medication</label>
                                <input type="text" class="form-control" id="medicationName" readonly>
                            </div>
                            
                            <div class="mb-3">
                                <label for="availableQuantity" class="form-label">Available Quantity</label>
                                <input type="number" class="form-control" id="availableQuantity" readonly>
                            </div>
                            
                            <div class="mb-3">
                                <label for="transferQuantity" class="form-label">Transfer Quantity</label>
                                <input type="number" class="form-control" id="transferQuantity" name="quantity" min="1" required>
                            </div>
                            
                            <div class="mb-3">
                                <label for="dispensary" class="form-label">To Dispensary</label>
                                <input type="text" class="form-control" id="dispensary" value="THEATRE-PH" readonly>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="submit" class="btn btn-primary">Transfer</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        
        <div class="test-result">
            <div class="card">
                <div class="card-header">
                    <h5>Test Results</h5>
                </div>
                <div class="card-body">
                    <div id="result-message" class="alert alert-info">
                        Click on a transfer button to test the functionality.
                    </div>
                    
                    <div class="debug-info mt-3">
                        <h6>Debug Information:</h6>
                        <pre id="debug-output">No actions yet.</pre>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="mt-4">
            <h4>Fix Summary</h4>
            <div class="card">
                <div class="card-body">
                    <h5>Issues Fixed:</h5>
                    <ol>
                        <li>✅ Removed duplicate incomplete [active_store_detail](file://c:\Users\dell\Desktop\MY_PRODUCTS\HMS\pharmacy\views.py#L925-L947) function that was overriding the complete version</li>
                        <li>✅ Added missing Bootstrap JavaScript libraries to base template</li>
                        <li>✅ Corrected the order of JavaScript library loading (jQuery before Bootstrap)</li>
                        <li>✅ Verified that [inventory_items](file://c:\Users\dell\Desktop\MY_PRODUCTS\HMS\pharmacy\views.py#L937-L937) are properly passed to the template context</li>
                    </ol>
                    
                    <h5>Expected Behavior:</h5>
                    <ul>
                        <li>Clicking transfer buttons should populate the modal with medication details</li>
                        <li>Modal should open with correct medication name, batch, and available quantity</li>
                        <li>Transfer quantity should be validated against available quantity</li>
                        <li>Form submission should work correctly</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <script>
        $(document).ready(function() {
            console.log("Transfer test page loaded");
            
            // Handle transfer button clicks
            $('.transfer-btn').click(function() {
                console.log("Transfer button clicked");
                
                var medicationId = $(this).data('medication');
                var medicationName = $(this).data('medication-name');
                var batchNumber = $(this).data('batch');
                var availableQuantity = $(this).data('quantity');
                
                // Debug output
                var debugInfo = {
                    event: "Transfer button clicked",
                    medicationId: medicationId,
                    medicationName: medicationName,
                    batchNumber: batchNumber,
                    availableQuantity: availableQuantity,
                    timestamp: new Date().toISOString()
                };
                
                $('#debug-output').text(JSON.stringify(debugInfo, null, 2));
                
                // Populate modal form
                $('#medicationId').val(medicationId);
                $('#medicationName').val(medicationName);
                $('#batchNumber').val(batchNumber);
                $('#availableQuantity').val(availableQuantity);
                $('#transferQuantity').attr('max', availableQuantity).val('');
                
                // Update result message
                $('#result-message').removeClass('alert-info alert-warning alert-danger')
                                   .addClass('alert-success')
                                   .html('<strong>Success!</strong> Transfer button clicked and modal populated.<br>' +
                                         '<strong>Medication:</strong> ' + medicationName + '<br>' +
                                         '<strong>Batch:</strong> ' + batchNumber + '<br>' +
                                         '<strong>Available Quantity:</strong> ' + availableQuantity);
                
                console.log("Modal form populated with data:", {
                    medicationId: medicationId,
                    medicationName: medicationName,
                    batchNumber: batchNumber,
                    availableQuantity: availableQuantity
                });
            });
            
            // Handle form submission
            $('#transferForm').submit(function(e) {
                e.preventDefault();
                console.log("Transfer form submitted");
                
                var formData = {
                    medication_id: $('#medicationId').val(),
                    batch_number: $('#batchNumber').val(),
                    quantity: $('#transferQuantity').val(),
                    medication_name: $('#medicationName').val(),
                    available_quantity: $('#availableQuantity').val(),
                    dispensary: $('#dispensary').val()
                };
                
                // Debug output
                $('#debug-output').text(JSON.stringify(formData, null, 2));
                
                // Validate form
                if (!formData.quantity || formData.quantity <= 0) {
                    $('#result-message').removeClass('alert-info alert-success')
                                       .addClass('alert-warning')
                                       .html('<strong>Validation Error!</strong> Please enter a valid transfer quantity.');
                    return;
                }
                
                if (parseInt(formData.quantity) > parseInt(formData.available_quantity)) {
                    $('#result-message').removeClass('alert-info alert-success')
                                       .addClass('alert-warning')
                                       .html('<strong>Validation Error!</strong> Transfer quantity cannot exceed available quantity.');
                    return;
                }
                
                // Simulate successful transfer
                $('#result-message').removeClass('alert-info alert-warning')
                                   .addClass('alert-success')
                                   .html('<strong>Transfer Successful!</strong><br>' +
                                         '<strong>Medication:</strong> ' + formData.medication_name + '<br>' +
                                         '<strong>Batch:</strong> ' + formData.batch_number + '<br>' +
                                         '<strong>Quantity Transferred:</strong> ' + formData.quantity + '<br>' +
                                         '<strong>To Dispensary:</strong> ' + formData.dispensary);
                
                // Close modal
                var transferModal = bootstrap.Modal.getInstance(document.getElementById('transferModal'));
                if (transferModal) {
                    transferModal.hide();
                }
                
                console.log("Transfer simulation completed:", formData);
            });
            
            // Handle modal events for debugging
            $('#transferModal').on('show.bs.modal', function (event) {
                console.log("Modal is being shown");
                $('#debug-output').text("Modal show event triggered");
            });
            
            $('#transferModal').on('shown.bs.modal', function (event) {
                console.log("Modal is fully shown");
                $('#debug-output').text("Modal shown event triggered - modal is now visible");
            });
            
            $('#transferModal').on('hide.bs.modal', function (event) {
                console.log("Modal is being hidden");
            });
            
            $('#transferModal').on('hidden.bs.modal', function (event) {
                console.log("Modal is fully hidden");
            });
        });
    </script>
</body>
</html>
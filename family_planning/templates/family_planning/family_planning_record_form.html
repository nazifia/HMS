{% extends 'base.html' %}
{% load static %}
{% load custom_filters %}
{% load widget_tweaks %}

{% block title %}{{ title }}{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-sm-flex align-items-center justify-content-between mb-4">
        <h1 class="h3 mb-0 text-gray-800">{{ title }}</h1>
    </div>

    <div class="card shadow mb-4">
        <div class="card-body">
            <form method="POST">
                {% csrf_token %}
                <div class="row">
                    <div class="col-md-6">
                        
                <div class="form-group">
                    <label for="{{ form.method_used.id_for_label }}">Method Used</label>
                    {{ form.method_used|add_class:"form-control" }}
                </div>
                
                <div class="form-group">
                    <label for="{{ form.start_date.id_for_label }}">Start Date</label>
                    {{ form.start_date|add_class:"form-control" }}
                </div>
                
                <div class="form-group">
                    <label for="{{ form.end_date.id_for_label }}">End Date</label>
                    {{ form.end_date|add_class:"form-control" }}
                </div>
                
                <div class="form-group">
                    <label for="{{ form.side_effects.id_for_label }}">Side Effects</label>
                    {{ form.side_effects|add_class:"form-control" }}
                </div>
                
                <div class="form-group">
                    <label for="{{ form.compliance.id_for_label }}">Compliance</label>
                    {{ form.compliance|add_class:"form-control" }}
                </div>
                
                <div class="form-group">
                    <label for="{{ form.refill_date.id_for_label }}">Refill Date</label>
                    {{ form.refill_date|add_class:"form-control" }}
                </div>
                
                <div class="form-group">
                    <label for="{{ form.partner_involvement.id_for_label }}">Partner Involvement</label>
                    {{ form.partner_involvement|add_class:"form-control" }}
                </div>
                
                <div class="form-group">
                    <label for="{{ form.education_provided.id_for_label }}">Education Provided</label>
                    {{ form.education_provided|add_class:"form-control" }}
                </div>
                
                <div class="form-group">
                    <label for="{{ form.follow_up_date.id_for_label }}">Follow Up Date</label>
                    {{ form.follow_up_date|add_class:"form-control" }}
                </div>
                
                <div class="form-group">
                    <label for="{{ form.discontinuation_reason.id_for_label }}">Discontinuation Reason</label>
                    {{ form.discontinuation_reason|add_class:"form-control" }}
                </div>
                
<div class="form-group">
                            <label for="{{ form.patient.id_for_label }}">Patient *</label>
                            {{ form.patient|add_class:"form-control" }}
                        </div>
                    </div>
                    <div class="col-md-6">
                        <!-- Doctor Selection with Search -->
                        <div class="form-group">
                            <label for="{{ form.doctor.id_for_label }}">Doctor</label>

                            <!-- Enhanced Doctor Search Field -->
                            <div class="input-group mb-2">
                                <input type="text" id="doctor_search" class="form-control" placeholder="Search by name...">
                                <button class="btn btn-outline-secondary" type="button" id="clear_doctor_search">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>

                            <!-- Doctor Dropdown with Select2 -->
                            <select id="doctor_dropdown" class="form-control select2" data-placeholder="Select a doctor...">
                                <option value="">Select a doctor...</option>
                            </select>

                            <!-- Hidden field for form submission -->
                            {{ form.doctor|add_class:"d-none" }}

                            <!-- Selected Doctor Info -->
                            <div id="selected_doctor_info" class="mt-2 p-2 bg-light rounded" style="display: none;">
                                <strong>Selected Doctor:</strong>
                                <span id="doctor_name"></span>
                                <br>
                                <small class="text-muted">
                                    Department: <span id="doctor_department"></span>
                                </small>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="{{ form.visit_date.id_for_label }}">Visit Date *</label>
                            {{ form.visit_date|add_class:"form-control" }}
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="{{ form.chief_complaint.id_for_label }}">Chief Complaint</label>
                    {{ form.chief_complaint|add_class:"form-control" }}
                </div>
                
                <div class="form-group">
                    <label for="{{ form.history_of_present_illness.id_for_label }}">History of Present Illness</label>
                    {{ form.history_of_present_illness|add_class:"form-control" }}
                </div>
                
                <div class="form-group">
                    <label for="{{ form.diagnosis.id_for_label }}">Diagnosis</label>
                    {{ form.diagnosis|add_class:"form-control" }}
                </div>
                
                <div class="form-group">
                    <label for="{{ form.treatment_plan.id_for_label }}">Treatment Plan</label>
                    {{ form.treatment_plan|add_class:"form-control" }}
                </div>
                
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="{{ form.follow_up_required.id_for_label }}">Follow-up Required</label>
                            {{ form.follow_up_required|add_class:"form-control" }}
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="{{ form.follow_up_date.id_for_label }}">Follow-up Date</label>
                            {{ form.follow_up_date|add_class:"form-control" }}
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="{{ form.notes.id_for_label }}">Notes</label>
                    {{ form.notes|add_class:"form-control" }}
                </div>
                
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-save"></i> Save Record
                </button>
                <a href="{% url 'family_planning:family_planning_records_list' %}" class="btn btn-secondary">
                    <i class="fas fa-times"></i> Cancel
                </a>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    let allDoctors = [];

    // Load all doctors via AJAX
    $.ajax({
        url: '/accounts/api/users/?role=doctor',
        method: 'GET',
        success: function(data) {
            allDoctors = data.users || [];
            populateDoctorDropdown(allDoctors);

            // Pre-fill if editing existing record
            const existingDoctorId = $('#id_doctor').val();
            if (existingDoctorId) {
                selectDoctor(existingDoctorId);
            }
        },
        error: function(xhr, status, error) {
            console.error('Error loading doctors:', error);
        }
    });

    // Populate doctor dropdown
    function populateDoctorDropdown(doctors) {
        const $dropdown = $('#doctor_dropdown');
        $dropdown.find('option:not(:first)').remove();

        doctors.forEach(function(doctor) {
            const fullName = `${doctor.first_name} ${doctor.last_name}`.trim() || doctor.username;
            const department = doctor.department_name || 'N/A';
            $dropdown.append(
                $('<option></option>')
                    .attr('value', doctor.id)
                    .attr('data-name', fullName)
                    .attr('data-department', department)
                    .text(`${fullName} (${department})`)
            );
        });
    }

    // Handle doctor search input
    let searchTimeout;
    $('#doctor_search').on('input', function() {
        clearTimeout(searchTimeout);
        const searchTerm = $(this).val().toLowerCase().trim();

        searchTimeout = setTimeout(function() {
            if (searchTerm === '') {
                populateDoctorDropdown(allDoctors);
            } else {
                const filtered = allDoctors.filter(function(doctor) {
                    const fullName = `${doctor.first_name} ${doctor.last_name}`.toLowerCase();
                    return fullName.includes(searchTerm) ||
                           doctor.username.toLowerCase().includes(searchTerm);
                });
                populateDoctorDropdown(filtered);
            }
        }, 300);
    });

    // Handle doctor dropdown selection
    $('#doctor_dropdown').on('change', function() {
        const selectedId = $(this).val();
        if (selectedId) {
            selectDoctor(selectedId);
        } else {
            clearDoctorSelection();
        }
    });

    // Select doctor and update UI
    function selectDoctor(doctorId) {
        const doctor = allDoctors.find(d => String(d.id) === String(doctorId));
        if (doctor) {
            $('#id_doctor').val(doctor.id);
            $('#doctor_dropdown').val(doctor.id);

            const fullName = `${doctor.first_name} ${doctor.last_name}`.trim() || doctor.username;
            $('#doctor_name').text(fullName);
            $('#doctor_department').text(doctor.department_name || 'N/A');
            $('#selected_doctor_info').show();
        }
    }

    // Clear doctor selection
    function clearDoctorSelection() {
        $('#id_doctor').val('');
        $('#doctor_dropdown').val('');
        $('#doctor_search').val('');
        $('#selected_doctor_info').hide();
        populateDoctorDropdown(allDoctors);
    }

    // Handle clear button
    $('#clear_doctor_search').on('click', function() {
        clearDoctorSelection();
    });
});
</script>
{% endblock %}
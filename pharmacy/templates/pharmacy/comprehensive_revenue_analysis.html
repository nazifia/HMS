{% extends "base.html" %}
{% load static %}
{% load pharmacy_tags %}

{% block title %}Comprehensive Revenue Analysis{% endblock %}

{% block extra_css %}
<link href="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.css" rel="stylesheet">
<style>
    .revenue-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 15px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
    .module-card {
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        transition: transform 0.3s ease;
    }
    .module-card:hover {
        transform: translateY(-5px);
    }
    .chart-container {
        position: relative;
        height: 400px;
        margin: 20px 0;
    }
    .metric-value {
        font-size: 2rem;
        font-weight: bold;
        color: #2c3e50;
    }
    .metric-label {
        font-size: 0.9rem;
        color: #7f8c8d;
        text-transform: uppercase;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1 class="h3 mb-0">Comprehensive Hospital Revenue Analysis</h1>
                <div class="d-flex gap-2">
                    <button type="button" class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#filterModal">
                        <i class="fas fa-filter me-1"></i> Advanced Filters
                    </button>
                    <button type="button" class="btn btn-outline-success" onclick="exportRevenueData()">
                        <i class="fas fa-download me-1"></i> Export Data
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Filter Buttons -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <div class="d-flex flex-wrap gap-2 mb-3">
                        <a href="?filter_type=current_month" class="btn {% if filter_form.filter_type.value == 'current_month' %}btn-primary{% else %}btn-outline-primary{% endif %} btn-sm">
                            <i class="fas fa-calendar-day me-1"></i> Current Month
                        </a>
                        <a href="?filter_type=previous_month" class="btn {% if filter_form.filter_type.value == 'previous_month' %}btn-primary{% else %}btn-outline-primary{% endif %} btn-sm">
                            <i class="fas fa-calendar-minus me-1"></i> Previous Month
                        </a>
                        <a href="?filter_type=last_3_months" class="btn {% if filter_form.filter_type.value == 'last_3_months' %}btn-primary{% else %}btn-outline-primary{% endif %} btn-sm">
                            <i class="fas fa-calendar-alt me-1"></i> Last 3 Months
                        </a>
                        <a href="?filter_type=last_6_months" class="btn {% if filter_form.filter_type.value == 'last_6_months' %}btn-primary{% else %}btn-outline-primary{% endif %} btn-sm">
                            <i class="fas fa-calendar me-1"></i> Last 6 Months
                        </a>
                        <a href="?filter_type=year_to_date" class="btn {% if filter_form.filter_type.value == 'year_to_date' %}btn-primary{% else %}btn-outline-primary{% endif %} btn-sm">
                            <i class="fas fa-calendar-year me-1"></i> Year to Date
                        </a>
                    </div>
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <small class="text-muted">
                                <i class="fas fa-info-circle me-1"></i>
                                Showing revenue from <strong>{{ start_date|date:'M d, Y' }}</strong> to <strong>{{ end_date|date:'M d, Y' }}</strong>
                                {% if selected_departments %}
                                | Filtered by: 
                                {% for dept in selected_departments %}
                                    <span class="badge bg-secondary">{{ dept|title }}</span>
                                {% endfor %}
                                {% endif %}
                            </small>
                        </div>
                        <div class="col-md-4 text-end">
                            <small class="text-muted">
                                <i class="fas fa-clock me-1"></i> Last updated: {{ performance_metrics.days_in_period }} days
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Total Revenue Overview with Metrics -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="revenue-card text-center">
                <div class="row">
                    <div class="col-md-3">
                        <h3 class="mb-1">Total Hospital Revenue</h3>
                        <div class="metric-value">₦{{ total_revenue|floatformat:2 }}</div>
                        <div class="metric-label">{{ start_date|date:'M d, Y' }} - {{ end_date|date:'M d, Y' }}</div>
                    </div>
                    <div class="col-md-3">
                        <h6 class="mb-1">Total Transactions</h6>
                        <div class="metric-value" style="font-size: 1.5rem;">{{ performance_metrics.total_transactions|floatformat:0 }}</div>
                        <div class="metric-label">All Payment Types</div>
                    </div>
                    <div class="col-md-3">
                        <h6 class="mb-1">Average Transaction</h6>
                        <div class="metric-value" style="font-size: 1.5rem;">₦{{ performance_metrics.average_transaction_value|floatformat:2 }}</div>
                        <div class="metric-label">Per Transaction</div>
                    </div>
                    <div class="col-md-3">
                        <h6 class="mb-1">Daily Average</h6>
                        <div class="metric-value" style="font-size: 1.5rem;">₦{{ performance_metrics.daily_average|floatformat:2 }}</div>
                        <div class="metric-label">Per Day</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Module-wise Revenue Breakdown -->
    <div class="row mb-4">
        {% for source in revenue_sources %}
        <div class="col-lg-4 col-md-6 mb-3">
            <div class="card module-card h-100">
                <div class="card-body text-center">
                    <i class="{{ source.icon }} fa-3x text-{{ source.color }} mb-3"></i>
                    <h5 class="card-title">{{ source.name }} Revenue</h5>
                    <div class="metric-value text-{{ source.color }}">₦{{ source.revenue|floatformat:2 }}</div>
                    {% if source.name == 'Pharmacy' %}
                        <div class="metric-label">{{ pharmacy_revenue.total_prescriptions|default:0 }} Prescriptions</div>
                        <div class="metric-label">{{ pharmacy_revenue.total_medications_dispensed|default:0 }} Items Dispensed</div>
                    {% elif source.name == 'Laboratory' %}
                        <div class="metric-label">{{ lab_revenue.total_tests|default:0 }} Tests Completed</div>
                    {% elif source.name == 'Consultations' %}
                        <div class="metric-label">{{ consultation_revenue.total_consultations|default:0 }} Consultations</div>
                    {% elif source.name == 'Theatre' %}
                        <div class="metric-label">{{ theatre_revenue.total_surgeries|default:0 }} Surgeries</div>
                    {% elif source.name == 'Admissions' %}
                        <div class="metric-label">{{ admission_revenue.total_admissions|default:0 }} Admissions</div>
                    {% elif source.name == 'General & Others' %}
                        <div class="metric-label">{{ general_revenue.total_payments|default:0 }} Payments</div>
                    {% elif source.name == 'Wallet' %}
                        <div class="metric-label">{{ wallet_revenue.total_transactions|default:0 }} Transactions</div>
                    {% endif %}
                    {% if total_revenue > 0 %}
                        <div class="mt-2">
                            <span class="badge bg-{{ source.color }}">{{ source.revenue|mul:100|div:total_revenue|floatformat:1 }}% of total</span>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- Revenue Trends Chart -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">Monthly Revenue Trends</h5>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="revenueChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Revenue Distribution Pie Chart -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">Revenue Distribution</h5>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="distributionChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">Revenue Summary</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Module</th>
                                    <th>Revenue</th>
                                    <th>Percentage</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for source in revenue_sources %}
                                <tr>
                                    <td><i class="{{ source.icon }} text-{{ source.color }}"></i> {{ source.name }}</td>
                                    <td>₦{{ source.revenue|floatformat:2 }}</td>
                                    <td>{% if total_revenue > 0 %}{{ source.revenue|mul:100|div:total_revenue|floatformat:1 }}%{% else %}0%{% endif %}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                            <tfoot>
                                <tr class="table-primary">
                                    <th>Total</th>
                                    <th>₦{{ total_revenue|floatformat:2 }}</th>
                                    <th>100%</th>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% if include_daily_breakdown and daily_breakdown %}
<!-- Daily Revenue Breakdown -->
<div class="container-fluid">
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">Daily Revenue Breakdown</h5>
                    <small class="text-muted">Day-by-day revenue analysis for the selected period</small>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="dailyChart"></canvas>
                    </div>
                    <div class="table-responsive mt-3">
                        <table class="table table-striped table-sm">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Pharmacy</th>
                                    <th>Laboratory</th>
                                    <th>Consultations</th>
                                    <th>Theatre</th>
                                    <th>Admissions</th>
                                    <th>General</th>
                                    <th>Wallet</th>
                                    <th>Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for day in daily_breakdown %}
                                <tr>
                                    <td>{{ day.date|date:'M d, Y' }}</td>
                                    <td>₦{{ day.pharmacy|floatformat:2 }}</td>
                                    <td>₦{{ day.laboratory|floatformat:2 }}</td>
                                    <td>₦{{ day.consultations|floatformat:2 }}</td>
                                    <td>₦{{ day.theatre|floatformat:2 }}</td>
                                    <td>₦{{ day.admissions|floatformat:2 }}</td>
                                    <td>₦{{ day.general|floatformat:2 }}</td>
                                    <td>₦{{ day.wallet|floatformat:2 }}</td>
                                    <td><strong>₦{{ day.total_revenue|floatformat:2 }}</strong></td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Advanced Filter Modal -->
<div class="modal fade" id="filterModal" tabindex="-1" aria-labelledby="filterModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="filterModalLabel">Advanced Revenue Filters</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="get" id="advancedFilterForm">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            {{ filter_form.filter_type.label_tag }}
                            {{ filter_form.filter_type }}
                        </div>
                        <div class="col-md-3 mb-3" id="month-field">
                            {{ filter_form.month.label_tag }}
                            {{ filter_form.month }}
                        </div>
                        <div class="col-md-3 mb-3" id="year-field">
                            {{ filter_form.year.label_tag }}
                            {{ filter_form.year }}
                        </div>
                    </div>
                    <div class="row" id="custom-date-fields">
                        <div class="col-md-6 mb-3">
                            {{ filter_form.start_date.label_tag }}
                            {{ filter_form.start_date }}
                        </div>
                        <div class="col-md-6 mb-3">
                            {{ filter_form.end_date.label_tag }}
                            {{ filter_form.end_date }}
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-12 mb-3">
                            {{ filter_form.departments.label_tag }}
                            <div class="row">
                                {% for choice in filter_form.departments %}
                                <div class="col-md-4 mb-2">
                                    <div class="form-check">
                                        {{ choice.tag }}
                                        <label class="form-check-label" for="{{ choice.id_for_label }}">
                                            {{ choice.choice_label }}
                                        </label>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-12 mb-3">
                            <div class="form-check">
                                {{ filter_form.include_daily_breakdown }}
                                <label class="form-check-label" for="{{ filter_form.include_daily_breakdown.id_for_label }}">
                                    {{ filter_form.include_daily_breakdown.label }}
                                </label>
                                <small class="form-text text-muted d-block">{{ filter_form.include_daily_breakdown.help_text }}</small>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Apply Filters</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
<script>
// Filter form handling
function handleFilterTypeChange() {
    const filterType = document.getElementById('filter-type-select').value;
    const monthField = document.getElementById('month-field');
    const yearField = document.getElementById('year-field');
    const customDateFields = document.getElementById('custom-date-fields');
    
    // Hide all conditional fields first
    monthField.style.display = 'none';
    yearField.style.display = 'none';
    customDateFields.style.display = 'none';
    
    // Show relevant fields based on filter type
    if (filterType === 'specific_month') {
        monthField.style.display = 'block';
        yearField.style.display = 'block';
    } else if (filterType === 'custom_range') {
        customDateFields.style.display = 'block';
    }
}

// Initialize filter form
document.addEventListener('DOMContentLoaded', function() {
    handleFilterTypeChange();
});

// Export functionality
function exportRevenueData() {
    const params = new URLSearchParams(window.location.search);
    params.set('export', 'csv');
    const exportUrl = '{% url "pharmacy:comprehensive_revenue_analysis" %}?' + params.toString();
    window.open(exportUrl, '_blank');
}

// Monthly Revenue Trends Chart
const ctx = document.getElementById('revenueChart').getContext('2d');
const revenueChart = new Chart(ctx, {
    type: 'line',
    data: {
        labels: {{ chart_data.months|safe }},
        datasets: [{
            label: 'Pharmacy',
            data: {{ chart_data.pharmacy|safe }},
            borderColor: '#007bff',
            backgroundColor: 'rgba(0, 123, 255, 0.1)',
            tension: 0.4,
            fill: false
        }, {
            label: 'Laboratory',
            data: {{ chart_data.laboratory|safe }},
            borderColor: '#28a745',
            backgroundColor: 'rgba(40, 167, 69, 0.1)',
            tension: 0.4,
            fill: false
        }, {
            label: 'Consultations',
            data: {{ chart_data.consultations|safe }},
            borderColor: '#17a2b8',
            backgroundColor: 'rgba(23, 162, 184, 0.1)',
            tension: 0.4,
            fill: false
        }, {
            label: 'Theatre',
            data: {{ chart_data.theatre|safe }},
            borderColor: '#ffc107',
            backgroundColor: 'rgba(255, 193, 7, 0.1)',
            tension: 0.4,
            fill: false
        }, {
            label: 'Admissions',
            data: {{ chart_data.admissions|safe }},
            borderColor: '#dc3545',
            backgroundColor: 'rgba(220, 53, 69, 0.1)',
            tension: 0.4,
            fill: false
        }, {
            label: 'General & Others',
            data: {{ chart_data.general|safe }},
            borderColor: '#6c757d',
            backgroundColor: 'rgba(108, 117, 125, 0.1)',
            tension: 0.4,
            fill: false
        }, {
            label: 'Wallet',
            data: {{ chart_data.wallet|safe }},
            borderColor: '#343a40',
            backgroundColor: 'rgba(52, 58, 64, 0.1)',
            tension: 0.4,
            fill: false
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        interaction: {
            mode: 'index',
            intersect: false,
        },
        scales: {
            y: {
                beginAtZero: true,
                ticks: {
                    callback: function(value) {
                        return '₦' + value.toLocaleString();
                    }
                }
            }
        },
        plugins: {
            tooltip: {
                callbacks: {
                    label: function(context) {
                        return context.dataset.label + ': ₦' + context.parsed.y.toLocaleString();
                    }
                }
            },
            legend: {
                position: 'top',
                labels: {
                    usePointStyle: true,
                    padding: 20
                }
            }
        }
    }
});

// Revenue Distribution Pie Chart
const ctx2 = document.getElementById('distributionChart').getContext('2d');
const distributionChart = new Chart(ctx2, {
    type: 'doughnut',
    data: {
        labels: [{% for source in revenue_sources %}'{{ source.name }}'{% if not forloop.last %},{% endif %}{% endfor %}],
        datasets: [{
            data: [{% for source in revenue_sources %}{{ source.revenue|floatformat:2 }}{% if not forloop.last %},{% endif %}{% endfor %}],
            backgroundColor: [
                '#007bff',  // Pharmacy
                '#28a745',  // Laboratory
                '#17a2b8',  // Consultations
                '#ffc107',  // Theatre
                '#dc3545',  // Admissions
                '#6c757d',  // General
                '#343a40'   // Wallet
            ],
            borderWidth: 2,
            borderColor: '#ffffff'
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            tooltip: {
                callbacks: {
                    label: function(context) {
                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                        const percentage = total > 0 ? ((context.parsed / total) * 100).toFixed(1) : '0';
                        return context.label + ': ₦' + context.parsed.toLocaleString() + ' (' + percentage + '%)';
                    }
                }
            },
            legend: {
                position: 'bottom',
                labels: {
                    usePointStyle: true,
                    padding: 15,
                    generateLabels: function(chart) {
                        const original = Chart.defaults.plugins.legend.labels.generateLabels;
                        const labels = original.call(this, chart);
                        const total = chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
                        
                        labels.forEach((label, index) => {
                            const value = chart.data.datasets[0].data[index];
                            const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : '0';
                            label.text = label.text + ' (' + percentage + '%)';
                        });
                        
                        return labels;
                    }
                }
            }
        },
        cutout: '50%'
    }
});

// Daily breakdown chart (if available)
{% if daily_breakdown %}
const dailyCtx = document.getElementById('dailyChart');
if (dailyCtx) {
    const dailyChart = new Chart(dailyCtx.getContext('2d'), {
        type: 'bar',
        data: {
            labels: [{% for day in daily_breakdown %}'{{ day.date_str }}'{% if not forloop.last %},{% endif %}{% endfor %}],
            datasets: [{
                label: 'Total Daily Revenue',
                data: [{% for day in daily_breakdown %}{{ day.total_revenue|floatformat:2 }}{% if not forloop.last %},{% endif %}{% endfor %}],
                backgroundColor: 'rgba(0, 123, 255, 0.7)',
                borderColor: '#007bff',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return '₦' + value.toLocaleString();
                        }
                    }
                }
            },
            plugins: {
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return 'Revenue: ₦' + context.parsed.y.toLocaleString();
                        }
                    }
                }
            }
        }
    });
}
{% endif %}

// Real-time updates (if needed)
function refreshData() {
    // This could be used for real-time updates
    location.reload();
}

// Auto-refresh every 5 minutes (optional)
// setInterval(refreshData, 300000);
</script>
{% endblock %}

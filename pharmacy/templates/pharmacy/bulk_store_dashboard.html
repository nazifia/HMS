{% extends "base.html" %}
{% load static %}
{% load pharmacy_tags %}

{% block title %}{{ title }}{% endblock %}

{% block extra_css %}
<style>
    .bulk-store-card {
        transition: transform 0.2s;
        border-left: 4px solid #17a2b8;
    }
    .bulk-store-card:hover {
        transform: translateY(-2px);
    }
    .metric-value {
        font-size: 2rem;
        font-weight: bold;
        color: #17a2b8;
    }
    .transfer-status {
        font-size: 0.8rem;
    }
    .low-stock {
        color: #dc3545;
        font-weight: bold;
    }
    .expiring-soon {
        color: #ffc107;
        font-weight: bold;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="d-sm-flex align-items-center justify-content-between mb-4">
        <h1 class="h3 mb-0 text-gray-800">{{ title }}</h1>
        <div>
            <a href="{% url 'pharmacy:procurement_dashboard' %}" class="btn btn-secondary">
                <i class="fas fa-arrow-left"></i> Back to Procurement
            </a>
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#transferModal">
                <i class="fas fa-exchange-alt"></i> Request Transfer
            </button>
            <!-- DEBUG: Instant transfer button added -->
            <span class="badge bg-info ms-2">INSTANT TRANSFER ENABLED</span>
        </div>
    </div>

    <!-- Bulk Store Overview -->
    <div class="row mb-4">
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card bulk-store-card shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-info text-uppercase mb-1">
                                Total Medications
                            </div>
                            <div class="metric-value">{{ total_medications }}</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-pills fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card shadow h-100 py-2 border-success border-start border-4">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                                Total Stock Value
                            </div>
                            <div class="metric-value text-success">₦{{ total_stock_value|floatformat:2 }}</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-dollar-sign fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card shadow h-100 py-2 border-warning border-start border-4">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">
                                Low Stock Items
                            </div>
                            <div class="metric-value text-warning">{{ low_stock_count }}</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-exclamation-triangle fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card shadow h-100 py-2 border-danger border-start border-4">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-danger text-uppercase mb-1">
                                Expiring Soon
                            </div>
                            <div class="metric-value text-danger">{{ expiring_soon_count }}</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-calendar-times fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Pending Transfer Requests -->
    {% if pending_transfers %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-warning">
                        <i class="fas fa-clock"></i> Pending Transfer Requests
                    </h6>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-bordered">
                            <thead>
                                <tr>
                                    <th>Medication</th>
                                    <th>Quantity</th>
                                    <th>To Dispensary</th>
                                    <th>Requested By</th>
                                    <th>Requested At</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for transfer in pending_transfers %}
                                <tr>
                                    <td>{{ transfer.medication.name }}</td>
                                    <td>{{ transfer.quantity }}</td>
                                    <td>{{ transfer.to_active_store.dispensary.name }}</td>
                                    <td>{{ transfer.requested_by.get_full_name }}</td>
                                    <td>{{ transfer.requested_at|date:"M d, Y g:i A" }}</td>
                                    <td>
                                        {% if transfer.status == 'pending' and not transfer.approved_by %}
                                            <!-- Show Approve button for pending transfers -->
                                            <a href="{% url 'pharmacy:approve_medication_transfer' transfer.id %}"
                                               class="btn btn-sm btn-success">
                                                <i class="fas fa-check"></i> Approve
                                            </a>
                                            <!-- Instant Transfer Button for Pending Transfers -->
                                            <button type="button" class="btn btn-sm btn-warning instant-transfer-btn"
                                                    data-transfer-id="{{ transfer.id }}"
                                                    data-instant-url="{% url 'pharmacy:instant_medication_transfer' %}">
                                                <i class="fas fa-bolt"></i> Instant Transfer
                                            </button>
                                        {% elif transfer.status == 'in_transit' or transfer.approved_by %}
                                            <!-- Show Execute button for approved/in_transit transfers -->
                                            <a href="{% url 'pharmacy:execute_medication_transfer' transfer.id %}"
                                               class="btn btn-sm btn-primary">
                                                <i class="fas fa-shipping-fast"></i> Execute
                                            </a>
                                        {% endif %}
                                        <!-- Cancel Button (always available for pending/in_transit) -->
                                        {% if transfer.status in 'pending,in_transit' %}
                                        <button type="button" class="btn btn-sm btn-danger cancel-transfer-btn"
                                                data-transfer-id="{{ transfer.id }}"
                                                data-cancel-url="{% url 'pharmacy:cancel_medication_transfer' transfer.id %}">
                                            <i class="fas fa-times"></i> Cancel
                                        </button>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Bulk Store Inventory -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">
                        <i class="fas fa-warehouse"></i> Bulk Store Inventory
                    </h6>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-bordered" id="inventoryTable">
                            <thead>
                                <tr>
                                    <th>Medication</th>
                                    <th>Stock Quantity</th>
                                    <th>Unit Cost</th>
                                    <th>Total Value</th>
                                    <th>Batch Number</th>
                                    <th>Expiry Date</th>
                                    <th>Supplier</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in bulk_inventory %}
                                <tr>
                                    <td>{{ item.medication.name }}</td>
                                    <td>
                                        {% if item.stock_quantity <= 50 %}
                                            <span class="low-stock">{{ item.stock_quantity }}</span>
                                        {% else %}
                                            {{ item.stock_quantity }}
                                        {% endif %}
                                    </td>
                                    <td>₦{{ item.unit_cost|floatformat:2 }}</td>
                                    <td>₦{{ item.stock_quantity|mul:item.unit_cost|floatformat:2 }}</td>
                                    <td>{{ item.batch_number|default:"N/A" }}</td>
                                    <td>
                                        {% if item.expiry_date %}
                                            {% with days=(item.expiry_date|timeuntil_days) %}
                                                {% if days <= 30 and days >= 0 %}
                                                    <span class="expiring-soon">{{ item.expiry_date|date:"M d, Y" }}</span>
                                                {% elif days < 0 %}
                                                    <span class="text-danger">{{ item.expiry_date|date:"M d, Y" }} (Expired)</span>
                                                {% else %}
                                                    {{ item.expiry_date|date:"M d, Y" }}
                                                {% endif %}
                                            {% endwith %}
                                        {% else %}
                                            N/A
                                        {% endif %}
                                    </td>
                                    <td>{{ item.supplier.name|default:"N/A" }}</td>
                                    <td>
                                        {% if item.expiry_date %}
                                            {% with days=(item.expiry_date|timeuntil_days) %}
                                                {% if days < 0 %}
                                                    <span class="badge bg-danger">Expired</span>
                                                {% elif days <= 30 %}
                                                    <span class="badge bg-warning">Expiring Soon</span>
                                                {% elif item.stock_quantity <= 50 %}
                                                    <span class="badge bg-warning">Low Stock</span>
                                                {% else %}
                                                    <span class="badge bg-success">Good</span>
                                                {% endif %}
                                            {% endwith %}
                                        {% else %}
                                            {% if item.stock_quantity <= 50 %}
                                                <span class="badge bg-warning">Low Stock</span>
                                            {% else %}
                                                <span class="badge bg-success">Good</span>
                                            {% endif %}
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Available Dispensaries -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">
                        <i class="fas fa-store"></i> Available Dispensaries
                    </h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        {% for dispensary in dispensaries %}
                        <div class="col-md-4 mb-3">
                            <div class="card h-100 border-primary border-start border-4">
                                <div class="card-body">
                                    <h6 class="card-title text-primary">
                                        <i class="fas fa-store-alt"></i> {{ dispensary.name }}
                                    </h6>
                                    <p class="card-text">
                                        <small class="text-muted">
                                            <i class="fas fa-map-marker-alt"></i> {{ dispensary.location|default:"No location specified" }}
                                        </small>
                                    </p>
                                    {% if dispensary.description %}
                                    <p class="card-text">{{ dispensary.description|truncatewords:15 }}</p>
                                    {% endif %}
                                    <div class="d-flex justify-content-between align-items-center">
                                        <span class="badge bg-{% if dispensary.is_active %}success{% else %}secondary{% endif %}">
                                            {% if dispensary.is_active %}Active{% else %}Inactive{% endif %}
                                        </span>
                                        {% if dispensary.manager %}
                                        <small class="text-muted">
                                            <i class="fas fa-user"></i> {{ dispensary.manager.get_full_name }}
                                        </small>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% empty %}
                        <div class="col-12">
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle"></i> No dispensaries found.
                                <a href="{% url 'pharmacy:dispensary_list' %}" class="alert-link">Create a dispensary</a> to start managing inventory.
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Recent Transfers -->
    <div class="row">
        <div class="col-12">
            <div class="card shadow">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">
                        <i class="fas fa-history"></i> Recent Transfers
                    </h6>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Medication</th>
                                    <th>Quantity</th>
                                    <th>To Dispensary</th>
                                    <th>Status</th>
                                    <th>Date</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for transfer in recent_transfers %}
                                <tr>
                                    <td>{{ transfer.medication.name }}</td>
                                    <td>{{ transfer.quantity }}</td>
                                    <td>{{ transfer.to_active_store.dispensary.name }}</td>
                                    <td>
                                        <span class="badge transfer-status bg-{% if transfer.status == 'completed' %}success{% elif transfer.status == 'pending' %}warning{% elif transfer.status == 'in_transit' %}info{% elif transfer.status == 'cancelled' %}danger{% else %}secondary{% endif %}">
                                            {{ transfer.get_status_display }}
                                        </span>
                                    </td>
                                    <td>{{ transfer.requested_at|date:"M d, Y g:i A" }}</td>
                                    <td>
                                        {% if transfer.status == 'pending' or transfer.status == 'in_transit' %}
                                        <a href="{% url 'pharmacy:cancel_medication_transfer' transfer.id %}" 
                                           class="btn btn-sm btn-danger"
                                           onclick="return confirmCancelTransfer({{ transfer.id }});">
                                            <i class="fas fa-times"></i> Cancel
                                        </a>
                                        {% elif transfer.status == 'cancelled' %}
                                        <span class="badge bg-secondary">Already Cancelled</span>
                                        {% elif transfer.status == 'completed' %}
                                        <span class="badge bg-success">Completed</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Transfer Request Modal -->
<div class="modal fade" id="transferModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">
                    <i class="fas fa-exchange-alt me-2"></i>Request Medication Transfer
                    <span class="badge bg-warning ms-2">INSTANT TRANSFER AVAILABLE</span>
                </h5>
                <!-- DEBUG: Modal form ID: transferForm -->
                <!-- DEBUG: Instant Transfer Button ID: instantTransferBtn -->
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form method="post" action="{% url 'pharmacy:request_medication_transfer' %}" id="transferForm">
                <div class="modal-body">
                    {% csrf_token %}

                    <!-- Dispensary Information Section -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h6 class="text-primary border-bottom pb-2">
                                <i class="fas fa-store me-2"></i>Available Dispensaries
                            </h6>
                            <div class="row">
                                {% for dispensary in dispensaries %}
                                <div class="col-md-6 mb-3">
                                    <div class="card h-100 border-primary border-start border-4">
                                        <div class="card-body p-3">
                                            <h6 class="card-title text-primary mb-1">
                                                <i class="fas fa-store-alt me-1"></i>{{ dispensary.name }}
                                            </h6>
                                            {% if dispensary.location %}
                                            <p class="card-text small text-muted mb-1">
                                                <i class="fas fa-map-marker-alt me-1"></i>{{ dispensary.location }}
                                            </p>
                                            {% endif %}
                                            {% if dispensary.manager %}
                                            <p class="card-text small text-muted mb-1">
                                                <i class="fas fa-user me-1"></i>Manager: {{ dispensary.manager.get_full_name }}
                                            </p>
                                            {% endif %}
                                            <span class="badge bg-{% if dispensary.is_active %}success{% else %}secondary{% endif %} small">
                                                {% if dispensary.is_active %}Active{% else %}Inactive{% endif %}
                                            </span>
                                        </div>
                                    </div>
                                </div>
                                {% empty %}
                                <div class="col-12">
                                    <div class="alert alert-warning">
                                        <i class="fas fa-exclamation-triangle me-2"></i>
                                        No dispensaries available. Please create dispensaries first.
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>

                    <hr>

                    <!-- Transfer Form Section -->
                    <h6 class="text-primary border-bottom pb-2 mb-3">
                        <i class="fas fa-clipboard-list me-2"></i>Transfer Details
                    </h6>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="medication" class="form-label">
                                    <i class="fas fa-pills me-1"></i>Medication <span class="text-danger">*</span>
                                </label>
                                <select class="form-control" id="medication" name="medication" required>
                                    <option value="">Select Medication</option>
                                    {% for item in bulk_inventory %}
                                        <option value="{{ item.medication.id }}" data-available="{{ item.stock_quantity }}">
                                            {{ item.medication.name }} - {{ item.medication.strength }}
                                            ({{ item.stock_quantity }} available)
                                        </option>
                                    {% endfor %}
                                </select>
                                <div class="form-text">Select the medication to transfer from bulk store</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="quantity" class="form-label">
                                    <i class="fas fa-sort-numeric-up me-1"></i>Quantity <span class="text-danger">*</span>
                                </label>
                                <input type="number" class="form-control" id="quantity" name="quantity" min="1" required>
                                <div class="form-text" id="quantity-help">Enter the quantity to transfer</div>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="active_store" class="form-label">
                            <i class="fas fa-store me-1"></i>Destination Dispensary <span class="text-danger">*</span>
                        </label>
                        <select class="form-control" id="active_store" name="active_store" required>
                            <option value="">Select Dispensary</option>
                            {% for dispensary in dispensaries %}
                                <option value="{{ dispensary.active_store.id }}"
                                        data-dispensary-name="{{ dispensary.name }}"
                                        data-location="{{ dispensary.location|default:'' }}"
                                        data-manager="{{ dispensary.manager.get_full_name|default:'' }}">
                                    {{ dispensary.name }}
                                    {% if dispensary.location %} - {{ dispensary.location }}{% endif %}
                                    {% if dispensary.manager %} (Manager: {{ dispensary.manager.get_full_name }}){% endif %}
                                </option>
                            {% empty %}
                                <option value="" disabled>No dispensaries available</option>
                            {% endfor %}
                        </select>
                        <div class="form-text">Select the dispensary where you want to transfer the medication</div>
                    </div>

                    <div class="mb-3 border border-warning rounded p-3 bg-light">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="instant_transfer" name="instant_transfer">
                            <label class="form-check-label" for="instant_transfer">
                                <i class="fas fa-bolt text-warning"></i>
                                <strong class="text-warning">Instant Transfer</strong> - Transfer medication immediately (bypasses approval process)
                            </label>
                            <div class="form-text">
                                <small class="text-info">Check this box to execute the transfer instantly. The medication will be moved from bulk store to the selected dispensary immediately.</small>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="notes" class="form-label">
                            <i class="fas fa-sticky-note me-1"></i>Transfer Notes
                        </label>
                        <textarea class="form-control" id="notes" name="notes" rows="3"
                                  placeholder="Enter any additional notes about this transfer request..."></textarea>
                        <div class="form-text">Optional: Add any special instructions or reasons for the transfer</div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-outline-primary" id="requestTransferBtn">
                        <span class="btn-text">Request Transfer</span>
                        <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                    </button>
                    <button type="button" class="btn btn-warning btn-lg" id="instantTransferBtn" style="display: inline-block !important;">
                        <i class="fas fa-bolt"></i> <strong class="btn-text">Instant Transfer</strong>
                        <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Instant Transfer Confirmation Modal -->
<div class="modal fade" id="instantTransferConfirmModal" tabindex="-1" aria-labelledby="instantTransferConfirmModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-warning border-3">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title" id="instantTransferConfirmModalLabel">
                    <i class="fas fa-exclamation-triangle me-2"></i>Confirm Instant Transfer
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-warning mb-3">
                    <i class="fas fa-bolt me-2"></i>
                    <strong>Warning:</strong> This will bypass the approval process and transfer the medication immediately!
                </div>

                <h6 class="text-primary mb-3">Transfer Details:</h6>
                <table class="table table-sm table-bordered">
                    <tr>
                        <th width="40%">Medication:</th>
                        <td id="confirm-medication">-</td>
                    </tr>
                    <tr>
                        <th>Quantity:</th>
                        <td id="confirm-quantity">-</td>
                    </tr>
                    <tr>
                        <th>Destination:</th>
                        <td id="confirm-destination">-</td>
                    </tr>
                    <tr>
                        <th>Notes:</th>
                        <td id="confirm-notes">-</td>
                    </tr>
                </table>

                <div class="alert alert-info mb-0">
                    <i class="fas fa-info-circle me-2"></i>
                    The medication will be transferred immediately and the stock will be updated in both stores.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-warning" id="confirmInstantTransferBtn">
                    <i class="fas fa-bolt"></i> <strong>Confirm Instant Transfer</strong>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Cancel Transfer Confirmation Modal -->
<div class="modal fade" id="cancelTransferConfirmModal" tabindex="-1" aria-labelledby="cancelTransferConfirmModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-danger border-3">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="cancelTransferConfirmModalLabel">
                    <i class="fas fa-times-circle me-2"></i>Confirm Cancel Transfer
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-danger mb-3">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <strong>Warning:</strong> This action cannot be undone!
                </div>

                <p class="mb-3">Are you sure you want to cancel <strong>Transfer #<span id="cancel-transfer-id">-</span></strong>?</p>

                <div class="alert alert-info mb-0">
                    <i class="fas fa-info-circle me-2"></i>
                    You will be redirected to provide a cancellation reason.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">No, Keep Transfer</button>
                <a href="#" class="btn btn-danger" id="confirmCancelTransferBtn">
                    <i class="fas fa-times"></i> Yes, Cancel Transfer
                </a>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize DataTable with Bootstrap 5 compatibility
    console.log('DEBUG: Page loaded, checking for instantTransferBtn...');
    try {
        if (typeof $ !== 'undefined' && $('#inventoryTable').length) {
            $('#inventoryTable').DataTable({
                pageLength: 25,
                order: [[0, 'asc']],
                responsive: true,
                dom: '<"row"<"col-sm-12 col-md-6"l><"col-sm-12 col-md-6"f>>' +
                     '<"row"<"col-sm-12"tr>>' +
                     '<"row"<"col-sm-12 col-md-5"i><"col-sm-12 col-md-7"p>>'
            });
        }
    } catch (e) {
        console.error('DataTable initialization error:', e);
    }

    // Enhanced transfer modal functionality
    const medicationSelect = document.getElementById('medication');
    const quantityInput = document.getElementById('quantity');
    const quantityHelp = document.getElementById('quantity-help');
    const activeStoreSelect = document.getElementById('active_store');
    const transferForm = document.getElementById('transferForm');
    const transferModal = document.getElementById('transferModal');
    const requestTransferBtn = document.getElementById('requestTransferBtn');
    const instantTransferBtn = document.getElementById('instantTransferBtn');

    // Function to get form elements safely
    function getFormElements() {
        return {
            medication: document.getElementById('medication'),
            quantity: document.getElementById('quantity'),
            quantityHelp: document.getElementById('quantity-help'),
            activeStore: document.getElementById('active_store'),
            transferForm: document.getElementById('transferForm')
        };
    }

    // Medication selection handler
    if (medicationSelect) {
        medicationSelect.addEventListener('change', function() {
            const selectedOption = this.options[this.selectedIndex];
            const availableQuantity = selectedOption ? selectedOption.getAttribute('data-available') : null;

            if (quantityInput) {
                if (availableQuantity !== null && availableQuantity !== '') {
                    quantityInput.setAttribute('max', availableQuantity);
                    if (quantityHelp) {
                        quantityHelp.textContent = 'Enter quantity to transfer (Max: ' + availableQuantity + ' available)';
                    }
                } else {
                    quantityInput.removeAttribute('max');
                    if (quantityHelp) {
                        quantityHelp.textContent = 'Enter the quantity to transfer';
                    }
                }
            }
        });
    }

    // Quantity validation handler
    if (quantityInput) {
        quantityInput.addEventListener('input', function() {
            const quantity = parseInt(this.value) || 0;
            const maxQuantity = parseInt(this.getAttribute('max')) || 0;

            if (maxQuantity && quantity > maxQuantity) {
                this.classList.add('is-invalid');
                if (quantityHelp) {
                    quantityHelp.textContent = 'Quantity cannot exceed available stock (' + maxQuantity + ')';
                    quantityHelp.classList.add('text-danger');
                }
            } else {
                this.classList.remove('is-invalid');
                if (quantityHelp) {
                    quantityHelp.textContent = 'Enter quantity to transfer (Max: ' + maxQuantity + ' available)';
                    quantityHelp.classList.remove('text-danger');
                }
            }
        });
    }

    // Active store selection handler
    if (activeStoreSelect) {
        activeStoreSelect.addEventListener('change', function() {
            const selectedOption = this.options[this.selectedIndex];
            const dispensaryName = selectedOption ? selectedOption.getAttribute('data-dispensary-name') : null;
            const location = selectedOption ? selectedOption.getAttribute('data-location') : null;
            const manager = selectedOption ? selectedOption.getAttribute('data-manager') : null;

            // Remove existing details
            const existingDetails = document.getElementById('dispensary-details');
            if (existingDetails) {
                existingDetails.remove();
            }

            if (dispensaryName) {
                let details = 'Transferring to: ' + dispensaryName;
                if (location) details += ' (' + location + ')';
                if (manager) details += ' - Manager: ' + manager;

                // Show details below the select
                const detailsDiv = document.createElement('div');
                detailsDiv.id = 'dispensary-details';
                detailsDiv.className = 'form-text text-info mt-1';
                detailsDiv.innerHTML = '<i class="fas fa-info-circle me-1"></i>' + details;
                this.parentNode.insertBefore(detailsDiv, this.nextSibling);
            }
        });
    }

    // Reset form when modal is closed
    if (transferModal) {
        transferModal.addEventListener('hidden.bs.modal', function() {
            console.log('DEBUG: Modal opened, checking for instantTransferBtn...');
            console.log('DEBUG: instantTransferBtn element:', document.getElementById('instantTransferBtn'));
            console.log('DEBUG: All buttons with [id*=TransferBtn]:', document.querySelectorAll('[id*=TransferBtn]'));
            console.log('DEBUG: All buttons in modal footer:', document.querySelectorAll('.modal-footer button'));
            if (transferForm) {
                transferForm.reset();
            }
            if (quantityInput) {
                quantityInput.classList.remove('is-invalid');
            }
            if (quantityHelp) {
                quantityHelp.textContent = 'Enter the quantity to transfer';
                quantityHelp.classList.remove('text-danger');
            }
            const existingDetails = document.getElementById('dispensary-details');
            if (existingDetails) {
                existingDetails.remove();
            }
        });
    }

    // Modal initialization removed - no auto-open

    // Function to show validation error
    function showValidationError(message) {
        // Remove any existing error alerts
        const existingAlert = transferModal.querySelector('.validation-alert');
        if (existingAlert) {
            existingAlert.remove();
        }

        // Create new error alert
        const alert = document.createElement('div');
        alert.className = 'alert alert-danger alert-dismissible fade show validation-alert';
        alert.innerHTML = `
            <i class="fas fa-exclamation-circle me-2"></i>
            <strong>Validation Error:</strong> ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        `;

        // Insert at the top of modal body
        const modalBody = transferModal.querySelector('.modal-body');
        modalBody.insertBefore(alert, modalBody.firstChild);

        // Auto-dismiss after 5 seconds
        setTimeout(() => {
            if (alert && alert.parentNode) {
                alert.classList.remove('show');
                setTimeout(() => alert.remove(), 150);
            }
        }, 5000);
    }

    // Form validation function

    // Handle instant transfer button clicks for pending transfers
    document.addEventListener('click', function(e) {
        if (e.target && e.target.classList.contains('instant-transfer-btn')) {
            e.preventDefault();
            const transferId = e.target.getAttribute('data-transfer-id');
            if (transferId && confirm('Execute instant transfer for #' + transferId + '? This will complete the transfer immediately.')) {
                const url = e.target.getAttribute('data-instant-url');
                if (url) {
                    // Create a form and submit the instant transfer
                    const form = document.createElement('form');
                    form.method = 'POST';
                    form.action = url;
                    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
                    if (csrfToken) {
                        const csrfInput = document.createElement('input');
                        csrfInput.type = 'hidden';
                        csrfInput.name = 'csrfmiddlewaretoken';
                        csrfInput.value = csrfToken.value;
                        form.appendChild(csrfInput);
                    }
                    // Add transfer ID to form
                    const transferIdInput = document.createElement('input');
                    transferIdInput.type = 'hidden';
                    transferIdInput.name = 'transfer_id';
                    transferIdInput.value = transferId;
                    form.appendChild(transferIdInput);
                    // Add instant transfer flag
                    const instantInput = document.createElement('input');
                    instantInput.type = 'hidden';
                    instantInput.name = 'instant_transfer';
                    instantInput.value = 'true';
                    form.appendChild(instantInput);
                    document.body.appendChild(form);
                    form.submit();
                }
            }
        }
    });

    // Handle cancel transfer button clicks
    document.addEventListener('click', function(e) {
        if (e.target && e.target.classList.contains('cancel-transfer-btn')) {
            e.preventDefault();
            const transferId = e.target.getAttribute('data-transfer-id');
            const cancelUrl = e.target.getAttribute('data-cancel-url');
            if (transferId && confirmCancelTransfer(transferId)) {
                if (cancelUrl) {
                    window.location.href = cancelUrl;
                }
            }
        }
    });
    function validateTransferForm() {
        const elements = getFormElements();
        const medication = elements.medication ? elements.medication.value : null;
        const activeStore = elements.activeStore ? elements.activeStore.value : null;
        const quantity = elements.quantity ? elements.quantity.value : null;

        if (!medication || !activeStore || !quantity) {
            showValidationError('Please fill in all required fields (Medication, Quantity, and Destination Dispensary).');
            return false;
        }

        if (parseInt(quantity) <= 0) {
            showValidationError('Quantity must be greater than zero.');
            return false;
        }

        const maxQuantity = parseInt(elements.quantity.getAttribute('max')) || 0;
        if (maxQuantity && parseInt(quantity) > maxQuantity) {
            showValidationError(`Quantity cannot exceed available stock (${maxQuantity} units available).`);
            return false;
        }

        return true;
    }

    // Function to show loading state on button
    function setButtonLoading(button, isLoading) {
        if (!button) return;

        const btnText = button.querySelector('.btn-text');
        const spinner = button.querySelector('.spinner-border');

        if (isLoading) {
            button.disabled = true;
            if (btnText) btnText.classList.add('d-none');
            if (spinner) spinner.classList.remove('d-none');
        } else {
            button.disabled = false;
            if (btnText) btnText.classList.remove('d-none');
            if (spinner) spinner.classList.add('d-none');
        }
    }

    // Handle Request Transfer button click
    if (requestTransferBtn) {
        requestTransferBtn.addEventListener('click', function() {
            if (validateTransferForm()) {
                if (transferForm) {
                    setButtonLoading(requestTransferBtn, true);
                    transferForm.action = '{% url "pharmacy:request_medication_transfer" %}';
                    transferForm.submit();
                }
            }
        });
    }

    // Handle Instant Transfer button click - Show confirmation modal
    if (instantTransferBtn) {
        instantTransferBtn.addEventListener('click', function() {
            if (validateTransferForm()) {
                // Populate confirmation modal with transfer details
                const elements = getFormElements();
                const medicationSelect = elements.medication;
                const quantityInput = elements.quantity;
                const activeStoreSelect = elements.activeStore;
                const notesInput = document.getElementById('notes');

                // Get selected option texts
                const medicationText = medicationSelect.options[medicationSelect.selectedIndex].text;
                const destinationText = activeStoreSelect.options[activeStoreSelect.selectedIndex].text;

                // Update confirmation modal
                document.getElementById('confirm-medication').textContent = medicationText;
                document.getElementById('confirm-quantity').textContent = quantityInput.value;
                document.getElementById('confirm-destination').textContent = destinationText;
                document.getElementById('confirm-notes').textContent = notesInput ? notesInput.value || 'None' : 'None';

                // Hide transfer modal and show confirmation modal
                const transferModalInstance = bootstrap.Modal.getInstance(transferModal);
                if (transferModalInstance) {
                    transferModalInstance.hide();
                }

                const confirmModal = new bootstrap.Modal(document.getElementById('instantTransferConfirmModal'));
                confirmModal.show();
            }
        });
    } else {
        console.log('DEBUG: instantTransferBtn not found!');
    }

    // Handle Instant Transfer Confirmation
    const confirmInstantTransferBtn = document.getElementById('confirmInstantTransferBtn');
    if (confirmInstantTransferBtn) {
        confirmInstantTransferBtn.addEventListener('click', function() {
            if (transferForm) {
                setButtonLoading(confirmInstantTransferBtn, true);
                transferForm.action = '{% url "pharmacy:instant_medication_transfer" %}';
                transferForm.submit();
            }
        });
    }

    // Handle Cancel Transfer button clicks
    const cancelTransferButtons = document.querySelectorAll('.cancel-transfer-btn');
    const cancelTransferModal = document.getElementById('cancelTransferConfirmModal');
    const confirmCancelBtn = document.getElementById('confirmCancelTransferBtn');

    cancelTransferButtons.forEach(button => {
        button.addEventListener('click', function() {
            const transferId = this.getAttribute('data-transfer-id');
            const cancelUrl = this.getAttribute('data-cancel-url');

            // Update modal content
            document.getElementById('cancel-transfer-id').textContent = transferId;
            confirmCancelBtn.setAttribute('href', cancelUrl);

            // Show modal
            const modal = new bootstrap.Modal(cancelTransferModal);
            modal.show();
        });
    });

    // Legacy function for backward compatibility (if any old code still uses it)
    function confirmCancelTransfer(transferId) {
        if (confirm('Are you sure you want to cancel transfer #' + transferId + '? This action cannot be undone.')) {
            return true;
        }
        return false;
    }
});
</script>
{% endblock %}

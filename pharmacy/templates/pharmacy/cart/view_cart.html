{% extends 'base.html' %}
{% load static %}
{% load custom_filters %}

{% block title %}{{ page_title }}{% endblock %}

{% block extra_css %}
<!-- Cart Table CSS Improvements - Updated: 2025-11-23 -->
<style>
    .cart-container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 20px;
    }
    
    .cart-header {
        background: #667eea;
        color: white;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        border-left: 5px solid #4CAF50; /* Visual indicator of updated CSS */
    }
    
    .cart-status-badge {
        font-size: 1rem;
        padding: 6px 12px;
        border-radius: 6px;
    }
    
    .dispensary-section {
        background: white;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        border: 1px solid #e0e0e0;
    }
    
    .cart-items-table {
        background: white;
        border-radius: 8px;
        overflow-x: auto;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        margin-bottom: 20px;
        border: 1px solid #e0e0e0;
    }

    .cart-items-table table {
        margin-bottom: 0;
        min-width: 1000px;
        width: 100%;
    }

    .cart-items-table thead {
        background: #667eea;
    }

    .cart-items-table th {
        color: white;
        font-weight: 600;
        border-right: 1px solid rgba(255,255,255,0.2);
        border-bottom: 2px solid #5568d3;
        padding: 14px 12px;
        font-size: 0.85rem;
        text-align: center;
        vertical-align: middle;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        white-space: nowrap;
    }

    .cart-items-table th:first-child {
        text-align: left;
        padding-left: 16px;
    }

    .cart-items-table th:last-child {
        border-right: none;
    }

    .cart-items-table th i {
        display: block;
        font-size: 1.1rem;
        margin-bottom: 4px;
        opacity: 0.9;
    }

    .cart-items-table th span {
        display: block;
        font-size: 0.8rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.3px;
        line-height: 1.2;
    }

    .cart-items-table tbody tr {
        transition: background-color 0.2s ease;
        border-left: 3px solid transparent;
    }

    .cart-items-table td {
        padding: 14px 12px;
        vertical-align: middle;
        border-bottom: 1px solid #e9ecef;
        border-right: 1px solid #f0f0f0;
        font-size: 0.9rem;
        background-color: white;
    }

    .cart-items-table td:first-child {
        padding-left: 16px;
    }

    .cart-items-table td:last-child {
        border-right: none;
    }

    .cart-items-table tbody tr:nth-child(even):not([style*="background-color"]) {
        background-color: #f8f9fa;
    }

    .cart-items-table tbody tr:hover:not([style*="background-color"]) {
        background-color: #f0f6ff;
        border-left-color: #667eea;
    }

    .cart-items-table tbody tr[style*="background-color: #d4edda"] {
        border-left-color: #28a745;
        background-color: #d4edda;
    }

    .cart-items-table tbody tr[style*="background-color: #d4edda"] td {
        background-color: #d4edda;
        font-weight: 600;
        color: #155724;
    }

    .cart-items-table tbody tr[style*="background-color: #fff3cd"] {
        border-left-color: #ffc107;
        background-color: #fff3cd;
    }

    .cart-items-table tbody tr[style*="background-color: #fff3cd"] td {
        background-color: #fff3cd;
        font-weight: 600;
        color: #856404;
    }

    .medication-cell {
        min-width: 200px;
        max-width: 300px;
        position: relative;
        padding-left: 40px;
    }

    .medication-cell::before {
        content: "\f484";
        font-family: "Font Awesome 5 Free";
        font-weight: 900;
        position: absolute;
        left: 12px;
        top: 50%;
        transform: translateY(-50%);
        font-size: 1.4rem;
        color: #667eea;
        opacity: 0.2;
    }

    .medication-name {
        font-size: 1rem;
        font-weight: 600;
        color: #2c3e50;
        display: block;
        margin-bottom: 4px;
        line-height: 1.3;
        text-transform: capitalize;
    }

    .medication-strength {
        font-size: 0.85rem;
        color: #495057;
        display: inline-block;
        font-weight: 500;
        background: #e9ecef;
        padding: 3px 8px;
        border-radius: 4px;
        border-left: 2px solid #667eea;
        margin-bottom: 4px;
    }

    .quantity-input {
        width: 70px;
        text-align: center;
        font-weight: 600;
        border: 2px solid #e0e0e0;
        border-radius: 6px;
        padding: 8px 6px;
        font-size: 1rem;
        color: #2c3e50;
        transition: border-color 0.2s ease, box-shadow 0.2s ease;
    }

    .quantity-input:focus {
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        outline: none;
    }

    .quantity-input:hover {
        border-color: #a0a0a0;
    }

    .quantity-input.is-invalid {
        border-color: #dc3545;
        box-shadow: 0 0 0 3px rgba(220, 53, 69, 0.1);
    }

    .quantity-input.is-invalid:focus {
        border-color: #dc3545;
        box-shadow: 0 0 0 3px rgba(220, 53, 69, 0.2);
    }

    /* Quantity input wrapper with enhanced max stock indicator */
    .numeric-cell small {
        font-weight: 600;
        color: #495057;
        background: #f8f9fa;
        padding: 2px 6px;
        border-radius: 4px;
        display: inline-block;
        margin-top: 4px;
        font-size: 0.75rem;
    }

    .stock-badge {
        padding: 6px 12px;
        border-radius: 6px;
        font-size: 0.85rem;
        font-weight: 600;
        display: inline-block;
        white-space: nowrap;
        text-transform: uppercase;
        letter-spacing: 0.3px;
        transition: all 0.2s ease;
    }

    .stock-badge:hover {
        transform: translateY(-1px);
        box-shadow: 0 2px 4px rgba(0,0,0,0.15);
    }

    .stock-badge i {
        margin-right: 4px;
    }

    .price-cell {
        font-weight: 600;
        color: #2c3e50;
        text-align: right;
        white-space: nowrap;
        font-size: 0.95rem;
    }

    .price-highlight {
        font-size: 1rem;
        color: #667eea;
        font-weight: 700;
    }

    .numeric-cell {
        text-align: center;
        font-weight: 600;
        font-size: 0.9rem;
    }

    .status-badge-cell {
        text-align: center;
    }

    .badge {
        font-weight: 600;
        letter-spacing: 0.3px;
        padding: 6px 10px;
        border-radius: 6px;
        transition: all 0.2s ease;
    }

    .badge:hover {
        transform: translateY(-1px);
        box-shadow: 0 2px 4px rgba(0,0,0,0.15);
    }

    .btn-sm {
        font-weight: 600;
        padding: 6px 10px;
        transition: all 0.2s ease;
    }

    .btn-sm:hover {
        transform: translateY(-1px);
        box-shadow: 0 2px 4px rgba(0,0,0,0.15);
    }

    /* Stock Status Badge Colors */
    .bg-success {
        background-color: #28a745;
        color: white;
    }

    .bg-warning {
        background-color: #ffc107;
        color: #212529;
    }

    .bg-danger {
        background-color: #dc3545;
        color: white;
    }

    .bg-info {
        background-color: #17a2b8;
        color: white;
    }

    .bg-secondary {
        background-color: #6c757d;
        color: white;
    }

    /* Enhanced stock badges with solid colors */
    .stock-badge.bg-success {
        background-color: #28a745;
        box-shadow: 0 1px 3px rgba(40, 167, 69, 0.3);
    }

    .stock-badge.bg-success:hover {
        background-color: #218838;
        box-shadow: 0 2px 6px rgba(40, 167, 69, 0.4);
    }

    .stock-badge.bg-warning {
        background-color: #ffc107;
        box-shadow: 0 1px 3px rgba(255, 193, 7, 0.3);
    }

    .stock-badge.bg-warning:hover {
        background-color: #e0a800;
        box-shadow: 0 2px 6px rgba(255, 193, 7, 0.4);
    }

    .stock-badge.bg-danger {
        background-color: #dc3545;
        box-shadow: 0 1px 3px rgba(220, 53, 69, 0.3);
    }

    .stock-badge.bg-danger:hover {
        background-color: #c82333;
        box-shadow: 0 2px 6px rgba(220, 53, 69, 0.4);
    }

    .scroll-hint {
        display: none;
        background: #f8f9fa;
        padding: 12px;
        text-align: center;
        color: #667eea;
        font-size: 0.9rem;
        font-weight: 500;
        border: 1px dashed #667eea;
        border-radius: 6px;
        margin-bottom: 10px;
    }

    @media (max-width: 1400px) {
        .scroll-hint {
            display: block;
        }
    }

    .table-header-label {
        background: #f8f9fa;
        padding: 15px 20px;
        border-radius: 8px 8px 0 0;
        border: 1px solid #e0e0e0;
        border-bottom: none;
        margin-bottom: 0;
    }

    .table-header-label h4 {
        margin: 0;
        color: #2c3e50;
        font-weight: 600;
        font-size: 1.1rem;
    }

    .table-header-label .item-count {
        color: #667eea;
        font-weight: 600;
    }

    @media (max-width: 768px) {
        .cart-items-table th {
            font-size: 0.75rem;
            padding: 8px 6px;
        }

        .cart-items-table td {
            font-size: 0.8rem;
            padding: 8px 6px;
        }

        .medication-name {
            font-size: 0.9rem;
        }

        .quantity-input {
            width: 60px;
            font-size: 0.9rem;
        }
        
        .cart-items-table table {
            min-width: 800px;
        }
    }

    @media (max-width: 576px) {
        .cart-items-table table {
            min-width: 700px;
        }
        
        .cart-items-table th, .cart-items-table td {
            padding: 6px 4px;
            font-size: 0.75rem;
        }
        
        .quantity-input {
            width: 50px;
            font-size: 0.8rem;
            padding: 6px 4px;
        }
    }

    .cart-summary {
        background: white;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        border: 1px solid #e0e0e0;
    }
    
    .summary-row {
        display: flex;
        justify-content: space-between;
        padding: 8px 0;
        border-bottom: 1px solid #e9ecef;
    }
    
    .summary-row:last-child {
        border-bottom: none;
        font-size: 1.1rem;
        font-weight: 600;
        padding-top: 12px;
    }
    
    .nhia-info {
        background: #e8f5e9;
        border-left: 4px solid #4caf50;
        padding: 15px;
        border-radius: 6px;
        margin-bottom: 20px;
    }
    
    .action-buttons {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
    }
    
    .btn-checkout {
        background: #667eea;
        border: none;
        padding: 10px 24px;
        font-size: 1rem;
        font-weight: 600;
        border-radius: 6px;
        transition: all 0.2s ease;
    }
    
    .btn-checkout:hover {
        background: #5a6fd8;
        transform: translateY(-1px);
        box-shadow: 0 2px 4px rgba(0,0,0,0.15);
    }
    
    /* Focus styles for accessibility */
    .quantity-input:focus,
    .btn:focus,
    .btn-sm:focus {
        outline: 2px solid #667eea;
        outline-offset: 2px;
    }
    
    /* High contrast mode support */
    @media (prefers-contrast: high) {
        .cart-items-table th {
            background: #000;
            color: #fff;
            border-color: #fff;
        }
        
        .quantity-input {
            border-color: #000;
        }
        
        .quantity-input:focus {
            border-color: #000;
            outline: 2px solid #000;
        }
    }
    
    /* Reduced motion support */
    @media (prefers-reduced-motion: reduce) {
        .quantity-input,
        .badge,
        .stock-badge,
        .btn-sm,
        .btn-checkout {
            transition: none;
        }
        
        .quantity-input:focus,
        .quantity-input:hover,
        .badge:hover,
        .stock-badge:hover,
        .btn-sm:hover,
        .btn-checkout:hover {
            transform: none;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="cart-container">
    <!-- Cart Header -->
    <div class="cart-header">
        <div class="row align-items-center">
            <div class="col-md-8">
                <h3 class="mb-2">
                    <i class="fas fa-shopping-cart"></i> Prescription Cart #{{ cart.id }}
                </h3>
                <p class="mb-1"><strong>Patient:</strong> {{ cart.prescription.patient.get_full_name }} (ID: {{ cart.prescription.patient.patient_id }})</p>
                <p class="mb-1"><strong>Prescription:</strong> #{{ cart.prescription.id }}</p>
                <p class="mb-0"><strong>Created by:</strong> {{ cart.created_by.get_full_name }}</p>
            </div>
            <div class="col-md-4 text-md-end">
                <span class="cart-status-badge badge bg-{{ cart.status }}">
                    {{ cart.get_status_display }}
                </span>
            </div>
        </div>
    </div>

    <!-- NHIA Info -->
    {% if is_nhia_patient %}
    <div class="nhia-info">
        <h5><i class="fas fa-info-circle"></i> NHIA Patient</h5>
        <p class="mb-0">Patient pays <strong>10%</strong>, NHIA covers <strong>90%</strong> of medication costs.</p>
    </div>
    {% endif %}

    <!-- Dispensary Selection -->
    {% if cart.status in 'active,invoiced' %}
    <div class="dispensary-section">
        <h5><i class="fas fa-hospital"></i> Select Dispensary</h5>
        <form method="post" action="{% url 'pharmacy:update_cart_dispensary' cart.id %}" id="dispensary-form">
            {% csrf_token %}
            <div class="row align-items-center">
                <div class="col-md-12">
                    <label for="dispensary_id" class="form-label">Dispensary</label>
                    <select name="dispensary_id" id="dispensary_id" class="form-select" required onchange="updateDispensary()">
                        {% if not cart.dispensary %}
                        <option value="">-- Select Dispensary --</option>
                        {% endif %}
                        {% for dispensary in dispensaries %}
                        <option value="{{ dispensary.id }}" {% if cart.dispensary and cart.dispensary.id == dispensary.id %}selected{% endif %}>
                            {{ dispensary.name }} - {{ dispensary.location }}
                        </option>
                        {% endfor %}
                    </select>
                    <small class="text-muted">
                        <i class="fas fa-info-circle"></i> Dispensary will update automatically when selected
                    </small>
                </div>
            </div>
        </form>
    </div>
    {% else %}
    <div class="dispensary-section">
        <h5><i class="fas fa-hospital"></i> Dispensary</h5>
        <p class="mb-0"><strong>{{ cart.dispensary.name }}</strong> - {{ cart.dispensary.location }}</p>
    </div>
    {% endif %}

    <!-- Cart Items -->
    <div class="scroll-hint">
        <i class="fas fa-arrows-alt-h"></i> Scroll horizontally to see all columns
    </div>

    <div class="table-header-label">
        <h4>
            <i class="fas fa-pills"></i> Cart Items
            <span class="item-count">({{ cart.items.count }} item{{ cart.items.count|pluralize }})</span>
        </h4>
    </div>

    <div class="cart-items-table">
        <table class="table mb-0">
            <thead>
                <tr>
                    <th>
                        <i class="fas fa-capsules"></i>
                        <span>Medication</span>
                    </th>
                    <th>
                        <i class="fas fa-prescription"></i>
                        <span>Prescribed</span>
                    </th>
                    <th>
                        <i class="fas fa-calculator"></i>
                        <span>Quantity</span>
                    </th>
                    {% if cart.status in 'paid,partially_dispensed' %}
                    <th>
                        <i class="fas fa-hand-holding-medical"></i>
                        <span>To Dispense</span>
                    </th>
                    {% endif %}
                    {% if cart.status in 'partially_dispensed,completed' %}
                    <th>
                        <i class="fas fa-check"></i>
                        <span>Dispensed</span>
                    </th>
                    <th>
                        <i class="fas fa-hourglass-half"></i>
                        <span>Remaining</span>
                    </th>
                    {% endif %}
                    <th>
                        <i class="fas fa-tag"></i>
                        <span>Unit Price</span>
                    </th>
                    <th>
                        <i class="fas fa-boxes"></i>
                        <span>Stock</span>
                    </th>
                    <th>
                        <i class="fas fa-dollar-sign"></i>
                        <span>Subtotal</span>
                    </th>
                    {% if is_nhia_patient %}
                    <th>
                        <i class="fas fa-user"></i>
                        <span>You Pay</span>
                    </th>
                    <th>
                        <i class="fas fa-hospital"></i>
                        <span>NHIA</span>
                    </th>
                    {% endif %}
                    {% if cart.status in 'active,invoiced' %}
                    <th>
                        <i class="fas fa-cog"></i>
                        <span>Action</span>
                    </th>
                    {% endif %}
                </tr>
            </thead>
            <tbody>
                {% for item in cart.items.all %}
                {% with stock_status=item.get_stock_status %}
                <tr id="cart-item-{{ item.id }}" {% if item.is_fully_dispensed %}style="background-color: #d4edda;"{% elif item.is_partially_dispensed %}style="background-color: #fff3cd;"{% endif %}>
                    <td class="medication-cell">
                        <span class="medication-name">{{ item.prescription_item.medication.name }}</span>
                        <span class="medication-strength">{{ item.prescription_item.medication.strength }}</span>
                        {% if item.is_fully_dispensed %}
                        <span class="badge bg-success mt-2"><i class="fas fa-check-circle"></i> Fully Dispensed</span>
                        {% elif item.is_partially_dispensed %}
                        <span class="badge bg-warning text-dark mt-2"><i class="fas fa-exclamation-circle"></i> Partially Dispensed</span>
                        {% endif %}
                    </td>
                    <td class="numeric-cell">
                        <span class="badge bg-info text-white" style="font-size: 0.9rem; padding: 6px 12px;">
                            {{ item.prescription_item.quantity }}
                        </span>
                    </td>
                    <td class="numeric-cell">
                        {% if cart.status in 'active,invoiced' %}
                        <div class="d-flex flex-column align-items-center">
                            <input type="number"
                                   class="form-control quantity-input cart-quantity-input mb-1"
                                   value="{{ item.quantity }}"
                                   min="1"
                                   max="{{ item.available_stock }}"
                                   data-item-id="{{ item.id }}"
                                   data-unit-price="{{ item.unit_price }}"
                                   data-is-nhia="{{ is_nhia_patient|yesno:'true,false' }}"
                                   data-max-stock="{{ item.available_stock }}"
                                   oninput="updateQuantityLive({{ item.id }}, this.value)"
                                   onchange="updateQuantity({{ item.id }}, this.value)"
                                   title="Max available in stock: {{ item.available_stock }}">
                            <small class="text-muted text-center" style="font-size: 0.75rem;">
                                <i class="fas fa-box"></i> Max: {{ item.available_stock }}
                            </small>
                        </div>
                        {% else %}
                        <span class="badge bg-secondary" style="font-size: 0.9rem; padding: 6px 12px;">
                            {{ item.quantity }}
                        </span>
                        {% endif %}
                    </td>
                    {% if cart.status in 'paid,partially_dispensed' %}
                    <td class="numeric-cell">
                        {% with remaining=item.get_remaining_quantity available=item.get_available_to_dispense_now %}
                        {% if remaining > 0 %}
                        <div class="d-flex flex-column align-items-center">
                            <input type="number"
                                   class="form-control quantity-input dispense-quantity-input mb-1"
                                   id="dispense-qty-{{ item.id }}"
                                   value="{{ available }}"
                                   min="0"
                                   max="{{ available }}"
                                   data-item-id="{{ item.id }}"
                                   data-max-available="{{ available }}"
                                   title="Max available: {{ available }}">
                            <small class="text-muted" style="font-size: 0.75rem;">Max: {{ available }}</small>
                        </div>
                        {% else %}
                        <span class="badge bg-success">Dispensed</span>
                        {% endif %}
                        {% endwith %}
                    </td>
                    {% endif %}
                    {% if cart.status in 'partially_dispensed,completed' %}
                    <td class="numeric-cell">
                        <strong class="text-success" style="font-size: 1.1rem;">{{ item.quantity_dispensed }}</strong>
                        {% if item.quantity_dispensed > 0 %}
                        <br><span class="badge bg-success-subtle text-success mt-1" style="font-size: 0.75rem;">{{ item.get_dispensing_progress_percentage }}%</span>
                        {% endif %}
                    </td>
                    <td class="numeric-cell">
                        <strong class="{% if item.get_remaining_quantity > 0 %}text-danger{% else %}text-success{% endif %}" style="font-size: 1.1rem;">
                            {{ item.get_remaining_quantity }}
                        </strong>
                    </td>
                    {% endif %}
                    <td class="price-cell">{{ item.unit_price|currency }}</td>
                    <td class="status-badge-cell">
                        <span class="stock-badge bg-{{ stock_status.css_class }} text-white">
                            <i class="fas fa-{{ stock_status.icon }}"></i>
                            {{ stock_status.message }}
                        </span>
                    </td>
                    <td class="price-cell price-highlight item-subtotal">{{ item.get_subtotal|currency }}</td>
                    {% if is_nhia_patient %}
                    <td class="price-cell text-primary item-patient-pays">{{ item.get_patient_pays|currency }}</td>
                    <td class="price-cell text-success item-nhia-covers">{{ item.get_nhia_covers|currency }}</td>
                    {% endif %}
                    {% if cart.status in 'active,invoiced' %}
                    <td class="text-center">
                        <a href="{% url 'pharmacy:remove_cart_item' item.id %}"
                           class="btn btn-sm btn-danger"
                           onclick="return confirm('Remove this item from cart?')"
                           title="Remove item">
                            <i class="fas fa-trash"></i>
                        </a>
                    </td>
                    {% endif %}
                </tr>
                {% endwith %}
                {% empty %}
                <tr>
                    <td colspan="20" class="text-center py-5">
                        <div class="d-flex flex-column align-items-center">
                            <i class="fas fa-shopping-cart fa-4x text-muted mb-3"></i>
                            <h5 class="text-muted">Cart is Empty</h5>
                            <p class="text-muted mb-0">No items have been added to this cart yet.</p>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Cart Status Widget and Summary -->
    <div class="row">
        <div class="col-md-8">
            <!-- Cart Status Timeline -->
            {% include 'pharmacy/cart/_cart_status_widget.html' with cart=cart %}
        </div>

        <div class="col-md-4">
            <!-- Cart Summary Widget -->
            {% include 'pharmacy/cart/_cart_summary_widget.html' with cart=cart show_actions=True %}
        </div>
    </div>
</div>

<script>
// Real-time update function (fires as user types)
function updateQuantityLive(itemId, quantity) {
    const input = document.querySelector(`input[data-item-id="${itemId}"]`);
    const maxStock = parseInt(input.dataset.maxStock);
    const quantityInt = parseInt(quantity) || 0;

    // Validate against stock
    if (quantityInt > maxStock) {
        input.classList.add('is-invalid');
        input.title = `Exceeds available stock! Max: ${maxStock}`;
    } else {
        input.classList.remove('is-invalid');
        input.title = `Max available in stock: ${maxStock}`;
    }

    // Calculate and update totals in real-time (client-side only)
    if (quantityInt > 0) {
        const unitPrice = parseFloat(input.dataset.unitPrice);
        const isNhia = input.dataset.isNhia === 'true';

        // Calculate item totals
        const itemSubtotal = quantityInt * unitPrice;
        const itemPatientPays = isNhia ? itemSubtotal * 0.1 : itemSubtotal;
        const itemNhiaCovers = isNhia ? itemSubtotal * 0.9 : 0;

        // Update item row
        const row = document.getElementById(`cart-item-${itemId}`);
        if (row) {
            row.querySelector('.item-subtotal').textContent = `₦${itemSubtotal.toFixed(2)}`;
            {% if is_nhia_patient %}
            row.querySelector('.item-patient-pays').textContent = `₦${itemPatientPays.toFixed(2)}`;
            row.querySelector('.item-nhia-covers').textContent = `₦${itemNhiaCovers.toFixed(2)}`;
            {% endif %}
        }

        // Recalculate cart totals from all items
        let cartSubtotal = 0;
        let cartPatientPayable = 0;
        let cartNhiaCoverage = 0;

        document.querySelectorAll('.cart-quantity-input').forEach(inp => {
            const qty = parseInt(inp.value) || 0;
            const price = parseFloat(inp.dataset.unitPrice);
            const nhia = inp.dataset.isNhia === 'true';

            const subtotal = qty * price;
            cartSubtotal += subtotal;
            cartPatientPayable += nhia ? subtotal * 0.1 : subtotal;
            cartNhiaCoverage += nhia ? subtotal * 0.9 : 0;
        });

        // Update cart totals in table footer
        const cartSubtotalEl = document.getElementById('cart-subtotal');
        const cartPatientPayableEl = document.getElementById('cart-patient-payable');
        if (cartSubtotalEl) cartSubtotalEl.textContent = `₦${cartSubtotal.toFixed(2)}`;
        if (cartPatientPayableEl) cartPatientPayableEl.textContent = `₦${cartPatientPayable.toFixed(2)}`;
        {% if is_nhia_patient %}
        const cartNhiaCoverageEl = document.getElementById('cart-nhia-coverage');
        if (cartNhiaCoverageEl) cartNhiaCoverageEl.textContent = `₦${cartNhiaCoverage.toFixed(2)}`;
        {% endif %}

        // Update summary widget totals
        const summarySubtotalEl = document.getElementById('summary-subtotal');
        const summaryTotalAmountEl = document.getElementById('summary-total-amount');
        if (summarySubtotalEl) summarySubtotalEl.textContent = `₦${cartSubtotal.toFixed(2)}`;
        if (summaryTotalAmountEl) summaryTotalAmountEl.textContent = `₦${cartPatientPayable.toFixed(2)}`;

        {% if is_nhia_patient %}
        const summaryPatientPayableEl = document.getElementById('summary-patient-payable');
        const summaryNhiaCoverageEl = document.getElementById('summary-nhia-coverage');
        const summaryNhiaCoverageDetailEl = document.getElementById('summary-nhia-coverage-detail');
        if (summaryPatientPayableEl) summaryPatientPayableEl.textContent = `₦${cartPatientPayable.toFixed(2)}`;
        if (summaryNhiaCoverageEl) summaryNhiaCoverageEl.textContent = `₦${cartNhiaCoverage.toFixed(2)}`;
        if (summaryNhiaCoverageDetailEl) summaryNhiaCoverageDetailEl.textContent = `-₦${cartNhiaCoverage.toFixed(2)}`;
        {% endif %}
    }
}

// Save to server function (fires when user finishes editing)
function updateQuantity(itemId, quantity) {
    const input = document.querySelector(`input[data-item-id="${itemId}"]`);
    const maxStock = parseInt(input.dataset.maxStock);
    const quantityInt = parseInt(quantity);

    // Client-side validation
    if (quantityInt <= 0) {
        alert('Quantity must be greater than zero');
        input.value = input.min || 1;
        return;
    }

    if (quantityInt > maxStock) {
        alert(`Cannot exceed available stock!\n\nRequested: ${quantityInt}\nAvailable in stock: ${maxStock}\n\nPlease adjust the quantity.`);
        input.value = maxStock;
        // Update display with corrected value
        updateQuantityLive(itemId, maxStock);
        return;
    }

    // Save to server
    fetch(`/pharmacy/cart/item/${itemId}/update-quantity/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify({ quantity: quantityInt })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Update with server response (more accurate)
            const row = document.getElementById(`cart-item-${itemId}`);
            row.querySelector('.item-subtotal').textContent = `₦${data.item_subtotal.toFixed(2)}`;
            {% if is_nhia_patient %}
            row.querySelector('.item-patient-pays').textContent = `₦${data.item_patient_pays.toFixed(2)}`;
            row.querySelector('.item-nhia-covers').textContent = `₦${data.item_nhia_covers.toFixed(2)}`;
            {% endif %}

            // Update stock status if available
            if (data.stock_status) {
                const stockCell = row.querySelector('.stock-status');
                if (stockCell) {
                    const status = data.stock_status;
                    stockCell.innerHTML = `
                        <span class="badge bg-${status.css_class}">
                            <i class="fas fa-${status.icon}"></i> ${status.message}
                        </span>
                    `;
                }
            }

            // Update cart totals from server
            const cartSubtotalEl = document.getElementById('cart-subtotal');
            const cartPatientPayableEl = document.getElementById('cart-patient-payable');
            if (cartSubtotalEl) cartSubtotalEl.textContent = `₦${data.cart_subtotal.toFixed(2)}`;
            if (cartPatientPayableEl) cartPatientPayableEl.textContent = `₦${data.cart_patient_payable.toFixed(2)}`;
            {% if is_nhia_patient %}
            const cartNhiaCoverageEl = document.getElementById('cart-nhia-coverage');
            if (cartNhiaCoverageEl) cartNhiaCoverageEl.textContent = `₦${data.cart_nhia_coverage.toFixed(2)}`;
            {% endif %}

            // Update summary widget totals
            const summarySubtotalEl = document.getElementById('summary-subtotal');
            const summaryTotalAmountEl = document.getElementById('summary-total-amount');
            if (summarySubtotalEl) summarySubtotalEl.textContent = `₦${data.cart_subtotal.toFixed(2)}`;
            if (summaryTotalAmountEl) summaryTotalAmountEl.textContent = `₦${data.cart_patient_payable.toFixed(2)}`;

            {% if is_nhia_patient %}
            const summaryPatientPayableEl = document.getElementById('summary-patient-payable');
            const summaryNhiaCoverageEl = document.getElementById('summary-nhia-coverage');
            const summaryNhiaCoverageDetailEl = document.getElementById('summary-nhia-coverage-detail');
            if (summaryPatientPayableEl) summaryPatientPayableEl.textContent = `₦${data.cart_patient_payable.toFixed(2)}`;
            if (summaryNhiaCoverageEl) summaryNhiaCoverageEl.textContent = `₦${data.cart_nhia_coverage.toFixed(2)}`;
            if (summaryNhiaCoverageDetailEl) summaryNhiaCoverageDetailEl.textContent = `-₦${data.cart_nhia_coverage.toFixed(2)}`;
            {% endif %}

            // Show success feedback
            showUpdateFeedback(row, true);
            input.classList.remove('is-invalid');
        } else {
            alert('Error: ' + data.error);
            location.reload();
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Failed to update quantity. Please try again.');
        location.reload();
    });
}

function showUpdateFeedback(row, success) {
    // Add a brief highlight animation to show the update was successful
    if (success) {
        row.style.backgroundColor = '#d4edda';
        setTimeout(() => {
            row.style.backgroundColor = '';
        }, 1000);
    }
}

function updateDispensary() {
    // Use setTimeout to ensure the select value has been updated
    setTimeout(function() {
        const form = document.getElementById('dispensary-form');
        const select = document.getElementById('dispensary_id');

        console.log('updateDispensary called, select.value:', select.value);

        // Only submit if a valid dispensary is selected (not empty option)
        if (select.value && select.value !== '') {
            console.log('Valid dispensary selected, submitting via fetch');

            // Show loading indicator
            const loadingHTML = `
                <div class="d-flex align-items-center">
                    <div class="spinner-border spinner-border-sm text-primary me-2" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <span>Updating dispensary and checking stock availability...</span>
                </div>
            `;

            // Create a temporary div to show loading
            const loadingDiv = document.createElement('div');
            loadingDiv.className = 'alert alert-info mt-2 mb-0';
            loadingDiv.innerHTML = loadingHTML;
            select.parentElement.appendChild(loadingDiv);
            select.disabled = true;

            // Use FormData to capture the current form state
            const formData = new FormData(form);

            // Manually ensure the dispensary_id is included (in case FormData doesn't pick it up)
            formData.set('dispensary_id', select.value);

            // Log the form data for debugging
            console.log('Form data being sent:');
            for (let [key, value] of formData.entries()) {
                console.log(`  ${key}: ${value}`);
            }

            // Submit using fetch to ensure the current form data is sent
            fetch(form.action, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => {
                if (response.redirected) {
                    // Follow the redirect
                    window.location.href = response.url;
                } else {
                    // Reload the page
                    window.location.reload();
                }
            })
            .catch(error => {
                console.error('Error submitting form:', error);
                alert('Failed to update dispensary. Please try again.');
                window.location.reload();
            });
        } else {
            console.log('Empty dispensary selected, not submitting');
            // User selected the empty "-- Select Dispensary --" option
            // Don't submit the form, just ignore
            return false;
        }
    }, 10); // Small delay to ensure value is updated
}

function prepareDispenseForm(cartId) {
    // Get all dispense quantity inputs
    const dispenseInputs = document.querySelectorAll('.dispense-quantity-input');
    const container = document.getElementById(`dispense-quantities-container-${cartId}`);

    // Clear container
    container.innerHTML = '';

    let hasQuantities = false;
    let invalidQuantities = [];

    // Collect quantities and add hidden inputs
    dispenseInputs.forEach(input => {
        const itemId = input.dataset.itemId;
        const quantity = parseInt(input.value) || 0;
        const maxAvailable = parseInt(input.dataset.maxAvailable) || 0;

        // Validate quantity
        if (quantity > maxAvailable) {
            invalidQuantities.push({
                itemId: itemId,
                quantity: quantity,
                maxAvailable: maxAvailable
            });
        }

        if (quantity > 0) {
            hasQuantities = true;
            // Create hidden input for this item's dispense quantity
            const hiddenInput = document.createElement('input');
            hiddenInput.type = 'hidden';
            hiddenInput.name = `dispense_qty_${itemId}`;
            hiddenInput.value = quantity;
            container.appendChild(hiddenInput);
        }
    });

    // Check for validation errors
    if (invalidQuantities.length > 0) {
        let errorMsg = 'Invalid quantities:\n';
        invalidQuantities.forEach(item => {
            errorMsg += `Item ${item.itemId}: Entered ${item.quantity}, but only ${item.maxAvailable} available\n`;
        });
        alert(errorMsg);
        return false;
    }

    // Check if at least one quantity is entered
    if (!hasQuantities) {
        alert('Please enter at least one quantity to dispense.');
        return false;
    }

    // Confirm before dispensing
    return confirm('Are you sure you want to dispense these medications?');
}
</script>
{% endblock %}


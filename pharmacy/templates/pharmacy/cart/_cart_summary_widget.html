{% load custom_filters %}
{% comment %}
Cart Summary Widget - Reusable component for displaying cart summary
Usage: {% include 'pharmacy/cart/_cart_summary_widget.html' with cart=cart show_actions=True %}
{% endcomment %}

<style>
    .cart-summary-widget {
        background: white;
        border-radius: 10px;
        padding: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        position: sticky;
        top: 20px;
    }
    
    .summary-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 2px solid #f0f0f0;
    }
    
    .summary-items {
        margin-bottom: 20px;
    }
    
    .summary-item {
        display: flex;
        justify-content: space-between;
        padding: 10px 0;
        border-bottom: 1px solid #f5f5f5;
    }
    
    .summary-item:last-child {
        border-bottom: none;
    }
    
    .item-label {
        color: #666;
        font-weight: 500;
    }
    
    .item-value {
        font-weight: 600;
        color: #333;
    }
    
    .summary-total {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 15px;
        border-radius: 8px;
        margin: 20px 0;
    }
    
    .total-label {
        font-size: 0.9rem;
        opacity: 0.9;
        margin-bottom: 5px;
    }
    
    .total-amount {
        font-size: 1.8rem;
        font-weight: 700;
    }
    
    .nhia-breakdown {
        background: #e8f5e9;
        border-left: 4px solid #4caf50;
        padding: 12px;
        border-radius: 5px;
        margin-bottom: 15px;
    }
    
    .nhia-row {
        display: flex;
        justify-content: space-between;
        padding: 5px 0;
        font-size: 0.9rem;
    }
    
    .action-buttons {
        display: flex;
        flex-direction: column;
        gap: 10px;
    }
    
    .quick-stats {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 10px;
        margin-bottom: 15px;
    }
    
    .stat-box {
        background: #f8f9fa;
        padding: 10px;
        border-radius: 5px;
        text-align: center;
    }
    
    .stat-value {
        font-size: 1.3rem;
        font-weight: 700;
        color: #667eea;
    }
    
    .stat-label {
        font-size: 0.75rem;
        color: #666;
        margin-top: 3px;
    }
</style>

<div class="cart-summary-widget">
    <!-- Summary Header -->
    <div class="summary-header">
        <h6 class="mb-0"><i class="fas fa-calculator"></i> Cart Summary</h6>
        <span class="badge bg-primary">{{ cart.get_total_items }} item{{ cart.get_total_items|pluralize }}</span>
    </div>
    
    <!-- Dispensing Progress (if partially dispensed or completed) -->
    {% if cart.status in 'partially_dispensed,completed' %}
    {% with progress=cart.get_dispensing_progress %}
    <div class="alert alert-info mb-3">
        <h6 class="mb-2"><i class="fas fa-chart-line"></i> Dispensing Progress</h6>
        <div class="progress mb-2" style="height: 25px;">
            <div class="progress-bar bg-success" role="progressbar"
                 style="width: {{ progress.percentage }}%;"
                 aria-valuenow="{{ progress.percentage }}"
                 aria-valuemin="0"
                 aria-valuemax="100">
                {{ progress.percentage }}%
            </div>
        </div>
        <div class="row text-center">
            <div class="col-4">
                <small class="text-success"><strong>{{ progress.fully_dispensed }}</strong><br>Fully Dispensed</small>
            </div>
            <div class="col-4">
                <small class="text-warning"><strong>{{ progress.partially_dispensed }}</strong><br>Partial</small>
            </div>
            <div class="col-4">
                <small class="text-danger"><strong>{{ progress.pending }}</strong><br>Pending</small>
            </div>
        </div>
        <hr>
        <small>
            <i class="fas fa-pills"></i> Dispensed: <strong>{{ progress.dispensed_quantity }}</strong> / {{ progress.total_quantity }}
        </small>
    </div>
    {% endwith %}
    {% endif %}

    <!-- Quick Stats -->
    <div class="quick-stats">
        <div class="stat-box">
            <div class="stat-value">{{ cart.get_total_items }}</div>
            <div class="stat-label">Items</div>
        </div>
        <div class="stat-box">
            <div class="stat-value">
                {% if cart.prescription.patient.is_nhia_patient %}
                <i class="fas fa-check-circle text-success"></i>
                {% else %}
                <i class="fas fa-times-circle text-muted"></i>
                {% endif %}
            </div>
            <div class="stat-label">NHIA</div>
        </div>
    </div>
    
    <!-- NHIA Breakdown (if applicable) -->
    {% if cart.prescription.patient.is_nhia_patient %}
    <div class="nhia-breakdown">
        <div class="nhia-row">
            <span><i class="fas fa-user"></i> Patient (10%):</span>
            <strong id="summary-patient-payable">{{ cart.get_patient_payable|currency }}</strong>
        </div>
        <div class="nhia-row">
            <span><i class="fas fa-hospital"></i> NHIA (90%):</span>
            <strong id="summary-nhia-coverage">{{ cart.get_nhia_coverage|currency }}</strong>
        </div>
    </div>
    {% endif %}

    <!-- Summary Items -->
    <div class="summary-items">
        <div class="summary-item">
            <span class="item-label">Subtotal:</span>
            <span class="item-value" id="summary-subtotal">{{ cart.get_subtotal|currency }}</span>
        </div>

        {% if cart.prescription.patient.is_nhia_patient %}
        <div class="summary-item">
            <span class="item-label">NHIA Coverage:</span>
            <span class="item-value text-success" id="summary-nhia-coverage-detail">-{{ cart.get_nhia_coverage|currency }}</span>
        </div>
        {% endif %}
        
        {% if cart.dispensary %}
        <div class="summary-item">
            <span class="item-label">Dispensary:</span>
            <span class="item-value">{{ cart.dispensary.name }}</span>
        </div>
        {% endif %}
    </div>
    
    <!-- Total Amount -->
    <div class="summary-total">
        <div class="total-label">
            {% if cart.prescription.patient.is_nhia_patient %}
            Patient Pays (10%)
            {% else %}
            Total Amount
            {% endif %}
        </div>
        <div class="total-amount" id="summary-total-amount">{{ cart.get_patient_payable|currency }}</div>
    </div>
    
    <!-- Action Buttons (if show_actions is True) -->
    {% if show_actions %}
    <div class="action-buttons">
        {% if cart.status == 'active' %}
            {% with can_checkout=cart.can_generate_invoice %}
                {% if can_checkout.0 %}
                    <form method="post" action="{% url 'pharmacy:generate_invoice_from_cart' cart.id %}">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-primary w-100">
                            <i class="fas fa-file-invoice-dollar"></i> Generate Invoice
                        </button>
                    </form>
                {% else %}
                    <button type="button" class="btn btn-secondary w-100" disabled title="{{ can_checkout.1 }}">
                        <i class="fas fa-lock"></i> Generate Invoice
                    </button>
                    <small class="text-danger text-center">{{ can_checkout.1 }}</small>
                {% endif %}
            {% endwith %}
            
            <a href="{% url 'pharmacy:prescription_detail' cart.prescription.id %}" class="btn btn-outline-secondary w-100">
                <i class="fas fa-arrow-left"></i> Back to Prescription
            </a>
            
            <a href="{% url 'pharmacy:cancel_cart' cart.id %}" 
               class="btn btn-outline-danger w-100"
               onclick="return confirm('Cancel this cart?')">
                <i class="fas fa-times"></i> Cancel Cart
            </a>
            
        {% elif cart.status == 'invoiced' %}
            {% if cart.invoice and cart.invoice.status == 'paid' %}
                {# Invoice is paid but cart status not updated - show dispensing button #}
                <div class="alert alert-success mb-3">
                    <i class="fas fa-check-circle"></i>
                    <strong>Payment Completed</strong><br>
                    <small>Ready to dispense</small>
                </div>
                <form method="post" action="{% url 'pharmacy:complete_dispensing_from_cart' cart.id %}" id="dispense-form-{{ cart.id }}">
                    {% csrf_token %}
                    <div id="dispense-quantities-container-{{ cart.id }}"></div>
                    <button type="submit" class="btn btn-success w-100" onclick="return prepareDispenseForm({{ cart.id }})">
                        <i class="fas fa-pills"></i> Dispense Medications
                    </button>
                </form>
                <small class="text-muted d-block text-center mt-2">
                    <i class="fas fa-info-circle"></i> Enter quantities to dispense in the table above
                </small>
            {% else %}
                {# Invoice not paid - show payment button #}
                <a href="{% url 'pharmacy:prescription_payment' cart.prescription.id %}" class="btn btn-warning w-100">
                    <i class="fas fa-credit-card"></i> Process Payment
                </a>
            {% endif %}

        {% elif cart.status == 'paid' %}
            <form method="post" action="{% url 'pharmacy:complete_dispensing_from_cart' cart.id %}" id="dispense-form-{{ cart.id }}">
                {% csrf_token %}
                <div id="dispense-quantities-container-{{ cart.id }}"></div>
                <button type="submit" class="btn btn-success w-100" onclick="return prepareDispenseForm({{ cart.id }})">
                    <i class="fas fa-pills"></i> Dispense Medications
                </button>
            </form>
            <small class="text-muted d-block text-center mt-2">
                <i class="fas fa-info-circle"></i> Enter quantities to dispense in the table above
            </small>

        {% elif cart.status == 'partially_dispensed' %}
            <div class="alert alert-warning mb-3">
                <i class="fas fa-exclamation-triangle"></i>
                <strong>Partial Dispensing</strong><br>
                <small>Some items are pending stock availability</small>
            </div>

            {% if cart.has_pending_items %}
            <form method="post" action="{% url 'pharmacy:complete_dispensing_from_cart' cart.id %}" id="dispense-form-{{ cart.id }}">
                {% csrf_token %}
                <div id="dispense-quantities-container-{{ cart.id }}"></div>
                <button type="submit" class="btn btn-primary w-100 mb-2" onclick="return prepareDispenseForm({{ cart.id }})">
                    <i class="fas fa-pills"></i> Dispense Remaining Items
                </button>
            </form>
            <small class="text-muted d-block text-center mb-3">
                <i class="fas fa-info-circle"></i> Enter quantities to dispense in the table above
            </small>
            {% endif %}

            <a href="{% url 'pharmacy:cart_receipt' cart.id %}" class="btn btn-outline-info w-100 mb-2" target="_blank">
                <i class="fas fa-receipt"></i> View Receipt
            </a>

        {% elif cart.status == 'completed' %}
            <div class="alert alert-success mb-3">
                <i class="fas fa-check-circle"></i>
                <strong>Fully Dispensed</strong><br>
                <small>All items have been dispensed</small>
            </div>

            <a href="{% url 'pharmacy:cart_receipt' cart.id %}" class="btn btn-outline-info w-100 mb-2" target="_blank">
                <i class="fas fa-receipt"></i> View Receipt
            </a>
            
        {% elif cart.status == 'completed' %}
            <a href="{% url 'pharmacy:prescription_detail' cart.prescription.id %}" class="btn btn-primary w-100">
                <i class="fas fa-file-prescription"></i> View Prescription
            </a>
            
            <button onclick="window.print()" class="btn btn-outline-primary w-100">
                <i class="fas fa-print"></i> Print Receipt
            </button>
        {% endif %}
    </div>
    {% endif %}
    
    <!-- Additional Info -->
    <div class="mt-3 pt-3 border-top">
        <small class="text-muted">
            <div class="d-flex justify-content-between mb-1">
                <span>Created:</span>
                <span>{{ cart.created_at|date:"M d, Y" }}</span>
            </div>
            <div class="d-flex justify-content-between mb-1">
                <span>By:</span>
                <span>{{ cart.created_by.get_full_name }}</span>
            </div>
            <div class="d-flex justify-content-between">
                <span>Status:</span>
                <span class="badge bg-{{ cart.status }}">{{ cart.get_status_display }}</span>
            </div>
        </small>
    </div>
</div>


{% extends 'base_print.html' %}
{% load static %}
{% load custom_filters %}

{% block title %}Cart Receipt - #{{ cart.id }}{% endblock %}

{% block extra_css %}
<style>
    @media print {
        .no-print { display: none !important; }
        body { margin: 0; padding: 20px; }
    }
    
    .receipt-container {
        max-width: 800px;
        margin: 0 auto;
        padding: 30px;
        background: white;
    }
    
    .receipt-header {
        text-align: center;
        border-bottom: 3px solid #333;
        padding-bottom: 20px;
        margin-bottom: 30px;
    }
    
    .hospital-name {
        font-size: 1.8rem;
        font-weight: bold;
        color: #333;
        margin-bottom: 5px;
    }
    
    .receipt-title {
        font-size: 1.3rem;
        color: #666;
        margin-top: 10px;
    }
    
    .receipt-info {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-bottom: 30px;
    }
    
    .info-section {
        padding: 15px;
        background: #f8f9fa;
        border-radius: 5px;
    }
    
    .info-section h6 {
        font-weight: bold;
        color: #333;
        margin-bottom: 10px;
        border-bottom: 2px solid #dee2e6;
        padding-bottom: 5px;
    }
    
    .info-row {
        display: flex;
        justify-content: space-between;
        padding: 5px 0;
    }
    
    .info-label {
        color: #666;
        font-weight: 500;
    }
    
    .info-value {
        color: #333;
        font-weight: 600;
    }
    
    .items-table {
        width: 100%;
        border-collapse: collapse;
        margin-bottom: 30px;
    }
    
    .items-table th {
        background: #333;
        color: white;
        padding: 12px;
        text-align: left;
        font-weight: 600;
    }
    
    .items-table td {
        padding: 10px 12px;
        border-bottom: 1px solid #dee2e6;
    }
    
    .items-table tbody tr:hover {
        background: #f8f9fa;
    }
    
    .summary-section {
        margin-top: 30px;
        padding: 20px;
        background: #f8f9fa;
        border-radius: 5px;
    }
    
    .summary-row {
        display: flex;
        justify-content: space-between;
        padding: 8px 0;
        font-size: 1.1rem;
    }
    
    .summary-row.total {
        border-top: 2px solid #333;
        margin-top: 10px;
        padding-top: 15px;
        font-size: 1.3rem;
        font-weight: bold;
    }
    
    .nhia-section {
        background: #e8f5e9;
        border-left: 4px solid #4caf50;
        padding: 15px;
        margin-bottom: 20px;
        border-radius: 5px;
    }
    
    .footer-section {
        margin-top: 40px;
        padding-top: 20px;
        border-top: 2px solid #dee2e6;
        text-align: center;
        color: #666;
    }
    
    .signature-section {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 40px;
        margin-top: 50px;
    }
    
    .signature-box {
        text-align: center;
    }
    
    .signature-line {
        border-top: 2px solid #333;
        margin-top: 60px;
        padding-top: 10px;
    }
    
    .print-button {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 1000;
    }
</style>
{% endblock %}

{% block content %}
<button onclick="window.print()" class="btn btn-primary print-button no-print">
    <i class="fas fa-print"></i> Print Receipt
</button>

<div class="receipt-container">
    <!-- Receipt Header -->
    <div class="receipt-header">
        <div class="hospital-name">{{ hospital_name|default:"Hospital Management System" }}</div>
        <div>{{ hospital_address|default:"" }}</div>
        <div>{{ hospital_phone|default:"" }}</div>
        <div class="receipt-title">PRESCRIPTION CART RECEIPT</div>
    </div>

    <!-- Receipt Info -->
    <div class="receipt-info">
        <div class="info-section">
            <h6>Cart Information</h6>
            <div class="info-row">
                <span class="info-label">Cart ID:</span>
                <span class="info-value">#{{ cart.id }}</span>
            </div>
            <div class="info-row">
                <span class="info-label">Status:</span>
                <span class="info-value">{{ cart.get_status_display }}</span>
            </div>
            <div class="info-row">
                <span class="info-label">Created:</span>
                <span class="info-value">{{ cart.created_at|date:"M d, Y H:i" }}</span>
            </div>
            <div class="info-row">
                <span class="info-label">Created By:</span>
                <span class="info-value">{{ cart.created_by.get_full_name }}</span>
            </div>
            {% if cart.dispensary %}
            <div class="info-row">
                <span class="info-label">Dispensary:</span>
                <span class="info-value">{{ cart.dispensary.name }}</span>
            </div>
            {% endif %}
        </div>
        
        <div class="info-section">
            <h6>Patient Information</h6>
            <div class="info-row">
                <span class="info-label">Name:</span>
                <span class="info-value">{{ cart.prescription.patient.get_full_name }}</span>
            </div>
            <div class="info-row">
                <span class="info-label">Patient ID:</span>
                <span class="info-value">{{ cart.prescription.patient.patient_id }}</span>
            </div>
            <div class="info-row">
                <span class="info-label">Prescription:</span>
                <span class="info-value">#{{ cart.prescription.id }}</span>
            </div>
            {% if cart.prescription.patient.is_nhia_patient %}
            <div class="info-row">
                <span class="info-label">NHIA Status:</span>
                <span class="info-value text-success">NHIA Patient</span>
            </div>
            <div class="info-row">
                <span class="info-label">NHIA Number:</span>
                <span class="info-value">{{ cart.prescription.patient.nhia_number }}</span>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- NHIA Info -->
    {% if cart.prescription.patient.is_nhia_patient %}
    <div class="nhia-section">
        <strong>NHIA Patient:</strong> Patient pays 10%, NHIA covers 90% of medication costs.
    </div>
    {% endif %}

    <!-- Items Table -->
    <table class="items-table">
        <thead>
            <tr>
                <th>Medication</th>
                <th style="text-align: center;">Quantity</th>
                <th style="text-align: right;">Unit Price</th>
                <th style="text-align: right;">Subtotal</th>
                {% if cart.prescription.patient.is_nhia_patient %}
                <th style="text-align: right;">Patient (10%)</th>
                <th style="text-align: right;">NHIA (90%)</th>
                {% endif %}
            </tr>
        </thead>
        <tbody>
            {% for item in cart.items.all %}
            <tr>
                <td>
                    <strong>{{ item.prescription_item.medication.name }}</strong><br>
                    <small>{{ item.prescription_item.medication.strength }}</small>
                </td>
                <td style="text-align: center;">{{ item.quantity }}</td>
                <td style="text-align: right;">{{ item.unit_price|currency }}</td>
                <td style="text-align: right;">{{ item.get_subtotal|currency }}</td>
                {% if cart.prescription.patient.is_nhia_patient %}
                <td style="text-align: right;">{{ item.get_patient_pays|currency }}</td>
                <td style="text-align: right;">{{ item.get_nhia_covers|currency }}</td>
                {% endif %}
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <!-- Summary Section -->
    <div class="summary-section">
        <div class="summary-row">
            <span>Subtotal:</span>
            <span>{{ cart.get_subtotal|currency }}</span>
        </div>
        
        {% if cart.prescription.patient.is_nhia_patient %}
        <div class="summary-row">
            <span>NHIA Coverage (90%):</span>
            <span class="text-success">{{ cart.get_nhia_coverage|currency }}</span>
        </div>
        {% endif %}
        
        <div class="summary-row total">
            <span>{% if cart.prescription.patient.is_nhia_patient %}Patient Pays (10%):{% else %}Total Amount:{% endif %}</span>
            <span>{{ cart.get_patient_payable|currency }}</span>
        </div>
    </div>

    <!-- Invoice Info -->
    {% if cart.invoice %}
    <div class="info-section" style="margin-top: 20px;">
        <h6>Invoice Information</h6>
        <div class="info-row">
            <span class="info-label">Invoice ID:</span>
            <span class="info-value">#{{ cart.invoice.id }}</span>
        </div>
        <div class="info-row">
            <span class="info-label">Invoice Status:</span>
            <span class="info-value">{{ cart.invoice.get_status_display }}</span>
        </div>
        {% if cart.invoice.status == 'paid' %}
        <div class="info-row">
            <span class="info-label">Payment Date:</span>
            <span class="info-value">{{ cart.invoice.updated_at|date:"M d, Y H:i" }}</span>
        </div>
        {% endif %}
    </div>
    {% endif %}

    <!-- Signature Section -->
    <div class="signature-section">
        <div class="signature-box">
            <div class="signature-line">
                Pharmacist Signature
            </div>
        </div>
        <div class="signature-box">
            <div class="signature-line">
                Patient Signature
            </div>
        </div>
    </div>

    <!-- Footer -->
    <div class="footer-section">
        <p>This is a computer-generated receipt.</p>
        <p>Printed on {{ now|date:"M d, Y H:i" }}</p>
        <p>Thank you for choosing our services!</p>
    </div>
</div>
{% endblock %}


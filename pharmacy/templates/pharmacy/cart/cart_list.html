{% extends 'base.html' %}
{% load static %}
{% load custom_filters %}

{% block title %}Prescription Carts{% endblock %}

{% block extra_css %}
<style>
    .carts-container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 20px;
    }
    
    .page-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 10px;
        padding: 30px;
        margin-bottom: 30px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    
    .filter-section {
        background: white;
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .cart-card {
        background: white;
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 15px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        transition: transform 0.2s, box-shadow 0.2s;
    }
    
    .cart-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }
    
    .cart-header-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
        padding-bottom: 15px;
        border-bottom: 2px solid #f0f0f0;
    }
    
    .cart-info {
        flex: 1;
    }
    
    .cart-status-badge {
        font-size: 0.9rem;
        padding: 6px 14px;
        border-radius: 20px;
        font-weight: 600;
    }
    
    .status-active { background: #e3f2fd; color: #1976d2; }
    .status-invoiced { background: #fff3e0; color: #f57c00; }
    .status-paid { background: #e8f5e9; color: #388e3c; }
    .status-completed { background: #f3e5f5; color: #7b1fa2; }
    .status-cancelled { background: #ffebee; color: #c62828; }
    
    .cart-details {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin-bottom: 15px;
    }
    
    .detail-item {
        display: flex;
        flex-direction: column;
    }
    
    .detail-label {
        font-size: 0.85rem;
        color: #666;
        margin-bottom: 4px;
    }
    
    .detail-value {
        font-size: 1rem;
        font-weight: 600;
        color: #333;
    }
    
    .cart-actions {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
    }
    
    .empty-state {
        text-align: center;
        padding: 60px 20px;
        background: white;
        border-radius: 10px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .empty-state i {
        font-size: 4rem;
        color: #ccc;
        margin-bottom: 20px;
    }
</style>
{% endblock %}

{% block content %}
<div class="carts-container">
    <!-- Page Header -->
    <div class="page-header">
        <h2 class="mb-2">
            <i class="fas fa-shopping-cart"></i> Prescription Carts
        </h2>
        <p class="mb-0">Manage and track prescription billing carts</p>
    </div>

    <!-- Filter Section -->
    <div class="filter-section">
        <form method="get" class="row g-3">
            <div class="col-md-3">
                <label for="status" class="form-label">Status</label>
                <select name="status" id="status" class="form-select">
                    <option value="">All Statuses</option>
                    <option value="active" {% if request.GET.status == 'active' %}selected{% endif %}>Active</option>
                    <option value="invoiced" {% if request.GET.status == 'invoiced' %}selected{% endif %}>Invoiced</option>
                    <option value="paid" {% if request.GET.status == 'paid' %}selected{% endif %}>Paid</option>
                    <option value="completed" {% if request.GET.status == 'completed' %}selected{% endif %}>Completed</option>
                    <option value="cancelled" {% if request.GET.status == 'cancelled' %}selected{% endif %}>Cancelled</option>
                </select>
            </div>
            <div class="col-md-3">
                <label for="dispensary" class="form-label">Dispensary</label>
                <select name="dispensary" id="dispensary" class="form-select">
                    <option value="">All Dispensaries</option>
                    {% for dispensary in dispensaries %}
                    <option value="{{ dispensary.id }}" {% if request.GET.dispensary == dispensary.id|stringformat:"s" %}selected{% endif %}>
                        {{ dispensary.name }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-4">
                <label for="search" class="form-label">Search Patient</label>
                <input type="text" name="search" id="search" class="form-control" 
                       placeholder="Patient name or prescription ID" 
                       value="{{ request.GET.search }}">
            </div>
            <div class="col-md-2">
                <label class="form-label">&nbsp;</label>
                <button type="submit" class="btn btn-primary w-100">
                    <i class="fas fa-filter"></i> Filter
                </button>
            </div>
        </form>
    </div>

    <!-- Carts List -->
    {% if carts %}
        {% for cart in carts %}
        <div class="cart-card">
            <div class="cart-header-row">
                <div class="cart-info">
                    <h5 class="mb-1">
                        <i class="fas fa-shopping-cart"></i> Cart #{{ cart.id }}
                    </h5>
                    <small class="text-muted">Created {{ cart.created_at|date:"M d, Y H:i" }}</small>
                </div>
                <span class="cart-status-badge status-{{ cart.status }}">
                    {{ cart.get_status_display }}
                </span>
            </div>
            
            <div class="cart-details">
                <div class="detail-item">
                    <span class="detail-label">Patient</span>
                    <span class="detail-value">{{ cart.prescription.patient.get_full_name }} (ID: {{ cart.prescription.patient.patient_id }})</span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">Prescription</span>
                    <span class="detail-value">#{{ cart.prescription.id }}</span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">Items</span>
                    <span class="detail-value">{{ cart.get_total_items }}</span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">Dispensary</span>
                    <span class="detail-value">{{ cart.dispensary.name|default:"Not selected" }}</span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">Created By</span>
                    <span class="detail-value">{{ cart.created_by.get_full_name }}</span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">Total Amount</span>
                    <span class="detail-value text-primary">{{ cart.get_patient_payable|currency }}</span>
                </div>
            </div>
            
            <div class="cart-actions">
                <a href="{% url 'pharmacy:view_cart' cart.id %}" class="btn btn-primary btn-sm">
                    <i class="fas fa-eye"></i> View Cart
                </a>
                
                {% if cart.status == 'active' %}
                    <a href="{% url 'pharmacy:view_cart' cart.id %}" class="btn btn-success btn-sm">
                        <i class="fas fa-edit"></i> Edit Cart
                    </a>
                {% endif %}
                
                {% if cart.status == 'invoiced' %}
                    <a href="{% url 'pharmacy:prescription_payment' cart.prescription.id %}" class="btn btn-warning btn-sm">
                        <i class="fas fa-credit-card"></i> Process Payment
                    </a>
                {% endif %}
                
                {% if cart.status == 'paid' %}
                    <a href="{% url 'pharmacy:complete_dispensing_from_cart' cart.id %}" class="btn btn-success btn-sm">
                        <i class="fas fa-check-circle"></i> Complete Dispensing
                    </a>
                {% endif %}
                
                <a href="{% url 'pharmacy:prescription_detail' cart.prescription.id %}" class="btn btn-outline-secondary btn-sm">
                    <i class="fas fa-file-prescription"></i> View Prescription
                </a>
                
                {% if cart.status == 'active' %}
                    <a href="{% url 'pharmacy:cancel_cart' cart.id %}" 
                       class="btn btn-outline-danger btn-sm"
                       onclick="return confirm('Cancel this cart?')">
                        <i class="fas fa-times"></i> Cancel
                    </a>
                {% endif %}
            </div>
        </div>
        {% endfor %}
        
        <!-- Pagination -->
        {% if is_paginated %}
        <nav aria-label="Page navigation">
            <ul class="pagination justify-content-center">
                {% if page_obj.has_previous %}
                <li class="page-item">
                    <a class="page-link" href="?page=1{% if request.GET.status %}&status={{ request.GET.status }}{% endif %}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}">First</a>
                </li>
                <li class="page-item">
                    <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% if request.GET.status %}&status={{ request.GET.status }}{% endif %}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}">Previous</a>
                </li>
                {% endif %}
                
                <li class="page-item active">
                    <span class="page-link">Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}</span>
                </li>
                
                {% if page_obj.has_next %}
                <li class="page-item">
                    <a class="page-link" href="?page={{ page_obj.next_page_number }}{% if request.GET.status %}&status={{ request.GET.status }}{% endif %}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}">Next</a>
                </li>
                <li class="page-item">
                    <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}{% if request.GET.status %}&status={{ request.GET.status }}{% endif %}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}">Last</a>
                </li>
                {% endif %}
            </ul>
        </nav>
        {% endif %}
    {% else %}
        <!-- Empty State -->
        <div class="empty-state">
            <i class="fas fa-shopping-cart"></i>
            <h4 class="text-muted">No Carts Found</h4>
            <p class="text-muted">
                {% if request.GET.status or request.GET.search %}
                    No carts match your filter criteria. Try adjusting your filters.
                {% else %}
                    No prescription carts have been created yet.
                {% endif %}
            </p>
            {% if request.GET.status or request.GET.search %}
            <a href="{% url 'pharmacy:cart_list' %}" class="btn btn-primary">
                <i class="fas fa-redo"></i> Clear Filters
            </a>
            {% endif %}
        </div>
    {% endif %}
</div>
{% endblock %}


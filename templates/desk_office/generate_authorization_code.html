{% extends "base.html" %}
{% load static %}

{% block title %}Generate Authorization Code - NHIA Authorization{% endblock %}

{% block extra_css %}
<style>
.form-container {
    max-width: 800px;
    margin: 0 auto;
}
.patient-card {
    border-left: 4px solid #007bff;
    transition: transform 0.2s ease-in-out;
}
.patient-card:hover {
    transform: translateY(-2px);
}
.code-preview {
    background-color: #f8f9fa;
    border: 2px dashed #dee2e6;
    font-family: 'Courier New', monospace;
    font-size: 1.2rem;
    text-align: center;
    padding: 20px;
    letter-spacing: 2px;
}
.required-field::after {
    content: " *";
    color: #dc3545;
}
.search-results {
    max-height: 300px;
    overflow-y: auto;
}
.patient-result-item {
    cursor: pointer;
    transition: background-color 0.2s ease;
}
.patient-result-item:hover {
    background-color: #e9ecef;
}
.loading-indicator {
    display: none;
}
.htmx-request .loading-indicator {
    display: inline-block;
}
.htmx-request .search-icon {
    display: none;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Page Heading -->
    <div class="d-sm-flex align-items-center justify-content-between mb-4">
        <h1 class="h3 mb-0 text-gray-800">
            <i class="fas fa-qrcode"></i> Generate Authorization Code
        </h1>
        <div class="btn-group" role="group">
            <a href="{% url 'desk_office:authorization_code_list' %}" class="btn btn-outline-primary btn-sm">
                <i class="fas fa-list"></i> All Codes
            </a>
            <a href="{% url 'desk_office:authorization_dashboard' %}" class="btn btn-outline-info btn-sm">
                <i class="fas fa-tachometer-alt"></i> Dashboard
            </a>
        </div>
    </div>

    {% if messages %}
        <div class="alert-container mb-4">
            {% for message in messages %}
                <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            {% endfor %}
        </div>
    {% endif %}

    <div class="row">
        <div class="col-lg-8">
            <div class="card shadow form-container">
                <div class="card-header py-3 bg-primary text-white">
                    <h6 class="m-0 font-weight-bold">
                        <i class="fas fa-plus-circle"></i> Create New Authorization Code
                    </h6>
                </div>
                <div class="card-body">
                    <form method="post" id="generateCodeForm">
                        {% csrf_token %}
                        
                        <!-- Patient Search Section -->
                        <div class="mb-4">
                            <label for="patient_search" class="form-label required-field">
                                <i class="fas fa-search"></i> Search NHIA Patient
                            </label>
                            <div class="input-group">
                                <input type="text"
                                       class="form-control"
                                       id="patient_search"
                                       name="q"
                                       placeholder="Search by patient name, ID, NHIA number, or phone..."
                                       value="{{ search_query|default:'' }}"
                                       hx-get="{% url 'core:patient_search_ajax' %}"
                                       hx-target="#patientResults"
                                       hx-trigger="keyup changed delay:300ms"
                                       hx-include="[name='q']"
                                       hx-vals='{"patient_type": "nhia"}'
                                       hx-headers='{"X-CSRFToken": "{{ csrf_token }}"}'
                                       {% if selected_patient %}disabled{% endif %}>
                                <button type="submit" name="search_patients" class="btn btn-outline-primary" {% if selected_patient %}disabled{% endif %}>
                                    <i class="fas fa-search search-icon"></i>
                                    <span class="spinner-border spinner-border-sm loading-indicator" role="status"></span>
                                    Search
                                </button>
                                {% if selected_patient %}
                                    <button type="button" class="btn btn-outline-secondary" onclick="clearPatientSelection()">
                                        <i class="fas fa-times"></i> Clear
                                    </button>
                                {% endif %}
                            </div>
                            <input type="hidden" name="patient_type" value="nhia">
                            
                            <!-- Search Results -->
                            <div id="patientResults" class="search-results mt-3">
                                <!-- HTMX will populate this -->
                            </div>
                        </div>

                        {% if selected_patient %}
                        <!-- Selected Patient Display -->
                        <div class="card patient-card mb-4">
                            <div class="card-body">
                                <h6 class="card-title text-primary mb-3">
                                    <i class="fas fa-user-check"></i> Selected Patient
                                </h6>
                                <div class="row">
                                    <div class="col-md-6">
                                        <h6>{{ selected_patient.get_full_name }}</h6>
                                        <p class="mb-1">
                                            <strong>Patient ID:</strong> {{ selected_patient.patient_id }}
                                        </p>
                                        <p class="mb-1">
                                            <strong>Age:</strong> {{ selected_patient.age }} years | 
                                            <strong>Gender:</strong> {{ selected_patient.get_gender_display }}
                                        </p>
                                        <p class="mb-1">
                                            <strong>Phone:</strong> {{ selected_patient.phone_number }}
                                        </p>
                                    </div>
                                    <div class="col-md-6">
                                        {% if selected_patient.nhia_info %}
                                            <p class="mb-1">
                                                <strong>NHIA Number:</strong><br>
                                                <span class="badge bg-info">{{ selected_patient.nhia_info.nhia_reg_number }}</span>
                                            </p>
                                            {% if selected_patient.nhia_info.nhia_plan %}
                                            <p class="mb-1">
                                                <strong>NHIA Plan:</strong><br>
                                                <span class="badge bg-secondary">{{ selected_patient.nhia_info.get_nhia_plan_display }}</span>
                                            </p>
                                            {% endif %}
                                        {% endif %}
                                        <p class="mb-1">
                                            <strong>Patient Type:</strong><br>
                                            <span class="badge bg-info">NHIA</span>
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Authorization Code Details -->
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="amount" class="form-label required-field">Authorization Amount (â‚¦)</label>
                                    <input type="number" 
                                           class="form-control" 
                                           id="amount" 
                                           name="amount" 
                                           value="{{ form.amount.value|default:'0.00' }}"
                                           step="0.01" 
                                           min="0" 
                                           required>
                                    <small class="form-text text-muted">
                                        Maximum amount this authorization code can cover
                                    </small>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="expiry_days" class="form-label">Expiry Period</label>
                                    <select class="form-select" id="expiry_days" name="expiry_days" required>
                                        <option value="7" {% if form.expiry_days.value == '7' %}selected{% endif %}>7 days</option>
                                        <option value="14" {% if form.expiry_days.value == '14' %}selected{% endif %}>14 days</option>
                                        <option value="30" {% if form.expiry_days.value == '30' or not form.expiry_days.value %}selected{% endif %}>30 days (Recommended)</option>
                                        <option value="60" {% if form.expiry_days.value == '60' %}selected{% endif %}>60 days</option>
                                        <option value="90" {% if form.expiry_days.value == '90' %}selected{% endif %}>90 days</option>
                                    </select>
                                    <small class="form-text text-muted">
                                        How long this authorization code remains valid
                                    </small>
                                </div>
                            </div>
                        </div>

                        <div class="row mb-4">
                            <div class="col-md-12">
                                <div class="mb-3">
                                    <label class="form-label required-field">Code Generation Method</label>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="code_type" id="auto_code" value="auto" 
                                               {% if form.code_type.value != 'manual' %}checked{% endif %}>
                                        <label class="form-check-label" for="auto_code">
                                            <i class="fas fa-magic"></i> Auto-generate code (Recommended)
                                        </label>
                                        <small class="form-text text-muted d-block ml-4">
                                            System will generate a unique authorization code automatically
                                        </small>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="code_type" id="manual_code" value="manual"
                                               {% if form.code_type.value == 'manual' %}checked{% endif %}>
                                        <label class="form-check-label" for="manual_code">
                                            <i class="fas fa-keyboard"></i> Enter manual code
                                        </label>
                                        <small class="form-text text-muted d-block ml-4">
                                            You can specify your own authorization code
                                        </small>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="row mb-4" id="manual_code_field" style="{% if form.code_type.value != 'manual' %}display: none;{% endif %}">
                            <div class="col-md-12">
                                <div class="mb-3">
                                    <label for="manual_code_input" class="form-label">Manual Authorization Code</label>
                                    <input type="text" 
                                           class="form-control" 
                                           id="manual_code_input" 
                                           name="manual_code" 
                                           value="{{ form.manual_code.value|default:'' }}"
                                           placeholder="Enter authorization code (e.g., AUTH-20231024-ABC123)"
                                           maxlength="20"
                                           {% if form.code_type.value == 'manual' %}required{% endif %}>
                                    <small class="form-text text-muted">
                                        Code must be unique and follow the format: AUTH-YYYYMMDD-XXXXXX
                                    </small>
                                </div>
                            </div>
                        </div>

                        <!-- Code Preview -->
                        <div class="row mb-4">
                            <div class="col-md-12">
                                <div class="mb-3">
                                    <label class="form-label">Code Preview</label>
                                    <div class="code-preview" id="codePreview">
                                        {% if form.manual_code.value %}
                                            {{ form.manual_code.value }}
                                        {% else %}
                                            AUTH-{{ "now"|date:"Ym" }}-XXXXXX
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="row mb-4">
                            <div class="col-md-12">
                                <div class="mb-3">
                                    <label for="notes" class="form-label">Authorization Notes (Optional)</label>
                                    <textarea class="form-control" 
                                              id="notes" 
                                              name="notes" 
                                              rows="3" 
                                              placeholder="Add any notes about this authorization...">{{ form.notes.value|default:'' }}</textarea>
                                    <small class="form-text text-muted">
                                        These notes will be visible to medical staff when using this code
                                    </small>
                                </div>
                            </div>
                        </div>

                        <div class="row mb-4">
                            <div class="col-md-12">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="notify_patient" id="notify_patient" checked>
                                    <label class="form-check-label" for="notify_patient">
                                        <i class="fas fa-bell"></i> Send notification to patient (if contact information available)
                                    </label>
                                </div>
                            </div>
                        </div>

                        <!-- Hidden patient ID field -->
                        <input type="hidden" name="patient_id" value="{{ selected_patient.id }}">
                        <input type="hidden" name="generate_code" value="1">

                        <!-- Form Actions -->
                        <div class="d-flex justify-content-between">
                            <div>
                                <a href="{% url 'desk_office:authorization_dashboard' %}" class="btn btn-secondary">
                                    <i class="fas fa-arrow-left"></i> Back to Dashboard
                                </a>
                                <a href="{% url 'desk_office:authorization_code_list' %}" class="btn btn-outline-info">
                                    <i class="fas fa-list"></i> View All Codes
                                </a>
                            </div>
                            <div>
                                <button type="submit" class="btn btn-success btn-lg">
                                    <i class="fas fa-qrcode"></i> Generate Authorization Code
                                </button>
                            </div>
                        </div>
                        {% endif %}
                    </form>
                </div>
            </div>
        </div>

        <!-- Side Panel -->
        <div class="col-lg-4">
            <!-- Instructions Card -->
            <div class="card shadow mb-4">
                <div class="card-header py-3 bg-info text-white">
                    <h6 class="m-0 font-weight-bold">
                        <i class="fas fa-info-circle"></i> Instructions
                    </h6>
                </div>
                <div class="card-body">
                    <ol class="mb-0">
                        <li class="mb-2">Search for the NHIA patient using name, ID, NHIA number, or phone</li>
                        <li class="mb-2">Select the patient from the search results</li>
                        <li class="mb-2">Enter the authorization amount</li>
                        <li class="mb-2">Choose the expiry period</li>
                        <li class="mb-2">Select code generation method (auto or manual)</li>
                        <li class="mb-2">Add optional notes</li>
                        <li class="mb-0">Click "Generate Authorization Code"</li>
                    </ol>
                </div>
            </div>

            <!-- Recent Codes Card -->
            {% if recent_codes %}
            <div class="card shadow mb-4">
                <div class="card-header py-3 bg-secondary text-white">
                    <h6 class="m-0 font-weight-bold">
                        <i class="fas fa-history"></i> Recently Generated Codes
                    </h6>
                </div>
                <div class="card-body">
                    {% for code in recent_codes %}
                    <div class="border-bottom pb-2 mb-2">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <code class="text-primary">{{ code.code }}</code><br>
                                <small class="text-muted">{{ code.patient.get_full_name }}</small><br>
                                <small>â‚¦{{ code.amount|floatformat:2 }}</small>
                            </div>
                            <span class="badge 
                                {% if code.status == 'active' %}bg-success
                                {% elif code.status == 'expired' %}bg-secondary
                                {% elif code.status == 'used' %}bg-info
                                {% else %}bg-warning{% endif %}">
                                {{ code.get_status_display|title }}
                            </span>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            <!-- Help Card -->
            <div class="card shadow mb-4">
                <div class="card-header py-3 bg-warning text-dark">
                    <h6 class="m-0 font-weight-bold">
                        <i class="fas fa-question-circle"></i> Need Help?
                    </h6>
                </div>
                <div class="card-body">
                    <p class="mb-2">
                        <strong>Authorization codes</strong> are used for NHIA patients to authorize medical services.
                    </p>
                    <p class="mb-2">
                        <strong>Format:</strong> AUTH-YYYYMMDD-XXXXXX
                    </p>
                    <p class="mb-2">
                        <strong>Expiry:</strong> Codes can be set to expire after 7, 14, 30, 60, or 90 days.
                    </p>
                    <p class="mb-0">
                        <strong>Support:</strong> Contact IT support for technical issues.
                    </p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Toggle manual code field based on code type selection
document.querySelectorAll('input[name="code_type"]').forEach(function(radio) {
    radio.addEventListener('change', function() {
        const manualField = document.getElementById('manual_code_field');
        const manualInput = document.getElementById('manual_code_input');
        
        if (this.value === 'manual') {
            manualField.style.display = 'block';
            manualInput.required = true;
            manualInput.focus();
        } else {
            manualField.style.display = 'none';
            manualInput.required = false;
            manualInput.value = '';
            updateCodePreview();
        }
    });
});

// Update code preview
function updateCodePreview() {
    const codeType = document.querySelector('input[name="code_type"]:checked').value;
    const manualCode = document.getElementById('manual_code_input').value;
    const preview = document.getElementById('codePreview');
    
    if (codeType === 'manual' && manualCode) {
        preview.textContent = manualCode;
    } else {
        const date = new Date();
        const dateStr = date.getFullYear() + 
                       String(date.getMonth() + 1).padStart(2, '0') + 
                       String(date.getDate()).padStart(2, '0');
        preview.textContent = `AUTH-${dateStr}-XXXXXX`;
    }
}

// Update preview when manual code changes
document.getElementById('manual_code_input').addEventListener('input', updateCodePreview);

// Clear patient selection
function clearPatientSelection() {
    window.location.href = '{% url "desk_office:generate_authorization_code" %}';
}

// Form validation
document.getElementById('generateCodeForm').addEventListener('submit', function(e) {
    const codeType = document.querySelector('input[name="code_type"]:checked').value;
    
    if (codeType === 'manual') {
        const manualCode = document.getElementById('manual_code_input').value;
        
        if (!manualCode.trim()) {
            e.preventDefault();
            alert('Please enter a manual authorization code.');
            document.getElementById('manual_code_input').focus();
            return;
        }
        
        // Validate manual code format
        if (!manualCode.match(/^AUTH-\d{8}-[A-Z0-9]{6,}$/)) {
            e.preventDefault();
            alert('Manual code must follow the format: AUTH-YYYYMMDD-XXXXXX (minimum 6 characters after date)');
            document.getElementById('manual_code_input').focus();
            return;
        }
    }
    
    const amount = parseFloat(document.getElementById('amount').value);
    if (isNaN(amount) || amount <= 0) {
        e.preventDefault();
        alert('Please enter a valid positive amount.');
        document.getElementById('amount').focus();
        return;
    }
    
    const expiryDays = parseInt(document.getElementById('expiry_days').value);
    if (expiryDays < 1 || expiryDays > 365) {
        e.preventDefault();
        alert('Expiry days must be between 1 and 365.');
        document.getElementById('expiry_days').focus();
        return;
    }
    
    // Confirm before generating
    if (!confirm('Are you sure you want to generate this authorization code?')) {
        e.preventDefault();
        return;
    }
});

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    updateCodePreview();
});

// Handle HTMX errors
htmx.on('htmx:responseError', function(evt) {
    console.error('HTMX error:', evt.detail);
    const target = evt.target;
    if (target.id === 'patientResults') {
        target.innerHTML = '<div class="alert alert-danger">Error loading patients. Please try again.</div>';
    }
});

// Clear search results when input is cleared
document.getElementById('patient_search').addEventListener('input', function() {
    if (this.value.trim() === '') {
        document.getElementById('patientResults').innerHTML = '';
    }
});
</script>
{% endblock %}

{% extends "base.html" %}
{% load static %}

{% block title %}Generate Authorization Code - NHIA Authorization{% endblock %}

{% block extra_css %}
<style>
.form-container {
    max-width: 800px;
    margin: 0 auto;
}
.patient-card {
    border-left: 4px solid #007bff;
    transition: transform 0.2s ease-in-out;
}
.patient-card:hover {
    transform: translateY(-2px);
}
.code-preview {
    background-color: #f8f9fa;
    border: 2px dashed #dee2e6;
    font-family: 'Courier New', monospace;
    font-size: 1.2rem;
    text-align: center;
    padding: 20px;
    letter-spacing: 2px;
}
.required-field::after {
    content: " *";
    color: #dc3545;
}
.search-results {
    max-height: 300px;
    overflow-y: auto;
}
.patient-result-item {
    cursor: pointer;
    transition: background-color 0.2s ease;
}
.patient-result-item:hover {
    background-color: #e9ecef;
}
.loading-indicator {
    display: none;
}
.htmx-request .loading-indicator {
    display: inline-block;
}
.htmx-request .search-icon {
    display: none;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Page Heading -->
    <div class="d-sm-flex align-items-center justify-content-between mb-4">
        <h1 class="h3 mb-0 text-gray-800">
            <i class="fas fa-qrcode"></i> Generate Authorization Code [MINIMAL TEST VERSION]
        </h1>
        <div class="btn-group" role="group">
            <a href="{% url 'desk_office:authorization_code_list' %}" class="btn btn-outline-primary btn-sm">
                <i class="fas fa-list"></i> All Codes
            </a>
            <a href="{% url 'desk_office:authorization_dashboard' %}" class="btn btn-outline-info btn-sm">
                <i class="fas fa-tachometer-alt"></i> Dashboard
            </a>
        </div>
    </div>

    {% if messages %}
        <div class="alert-container mb-4">
            {% for message in messages %}
                <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            {% endfor %}
        </div>
    {% endif %}

    <div class="row">
        <div class="col-lg-8">
            <div class="card shadow form-container">
                <div class="card-header py-3 bg-primary text-white">
                    <h6 class="m-0 font-weight-bold">
                        <i class="fas fa-plus-circle"></i> Create New Authorization Code
                    </h6>
                </div>
                <div class="card-body">
                    <form method="post" id="authorization-form" action="">
                        {% csrf_token %}
                        
                        <!-- Hidden patient ID field - CRITICAL FOR SUBMISSION -->
                        <input type="hidden" name="patient_id" value="{{ selected_patient.id }}">
                        <input type="hidden" name="generate_code" value="1">

                    {% if selected_patient %}
                        <!-- Selected Patient Display -->
                        <div class="card patient-card mb-4">
                            <div class="card-body">
                                <h6 class="card-title text-primary mb-3">
                                    <i class="fas fa-user-check"></i> Selected Patient
                                </h6>
                                <div class="row">
                                    <div class="col-md-6">
                                        <h6>{{ selected_patient.get_full_name }}</h6>
                                        <p class="mb-1">
                                            <strong>Patient ID:</strong> {{ selected_patient.patient_id }}
                                        </p>
                                        <p class="mb-1">
                                            <strong>Age:</strong> {{ selected_patient.age }} years | 
                                            <strong>Gender:</strong> {{ selected_patient.get_gender_display }}
                                        </p>
                                        <p class="mb-1">
                                            <strong>Phone:</strong> {{ selected_patient.phone_number }}
                                        </p>
                                    </div>
                                    <div class="col-md-6">
                                        {% if selected_patient.nhia_info %}
                                            <p class="mb-1">
                                                <strong>NHIA Number:</strong><br>
                                                <span class="badge bg-info">{{ selected_patient.nhia_info.nhia_reg_number }}</span>
                                            </p>
                                        {% endif %}
                                        <p class="mb-1">
                                            <strong>Patient Type:</strong><br>
                                            <span class="badge bg-info">NHIA</span>
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Authorization Code Details -->
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="service_type" class="form-label required-field">Service Type</label>
                                    <select class="form-select" id="service_type" name="service_type" required>
                                        <option value="">Select Service Type</option>
                                        <option value="laboratory">Laboratory</option>
                                        <option value="radiology">Radiology</option>
                                        <option value="theatre">Theatre</option>
                                        <option value="inpatient">Inpatient</option>
                                        <option value="dental">Dental</option>
                                        <option value="opthalmic">Ophthalmic</option>
                                        <option value="ent">ENT</option>
                                        <option value="oncology">Oncology</option>
                                        <option value="general">General</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="amount" class="form-label required-field">Authorization Amount (â‚¦)</label>
                                    <input type="number"
                                           class="form-control"
                                           id="amount"
                                           name="amount"
                                           value="1000.00"
                                           step="0.01"
                                           min="0"
                                           required>
                                </div>
                            </div>
                        </div>

                        <div class="row mb-4">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="expiry_days" class="form-label">Expiry Period</label>
                                    <select class="form-select" id="expiry_days" name="expiry_days" required>
                                        <option value="7">7 days</option>
                                        <option value="14">14 days</option>
                                        <option value="30" selected>30 days (Recommended)</option>
                                        <option value="60">60 days</option>
                                        <option value="90">90 days</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="row mb-4">
                            <div class="col-md-12">
                                <div class="mb-3">
                                    <label for="notes" class="form-label">Authorization Notes (Optional)</label>
                                    <textarea class="form-control" 
                                              id="notes" 
                                              name="notes" 
                                              rows="3" 
                                              placeholder="Add any notes about this authorization..."></textarea>
                                </div>
                            </div>
                        </div>

                        <!-- Form Actions -->
                        <div class="d-flex justify-content-between">
                            <div>
                                <a href="{% url 'desk_office:authorization_dashboard' %}" class="btn btn-secondary">
                                    <i class="fas fa-arrow-left"></i> Back to Dashboard
                                </a>
                            </div>
                            <div>
                                <button type="submit" class="btn btn-success btn-lg">
                                    <i class="fas fa-qrcode"></i> Generate Authorization Code
                                </button>
                            </div>
                        </div>
                    {% else %}
                        <!-- Patient Selection Required -->
                        <div class="alert alert-warning">
                            <h5><i class="fas fa-exclamation-triangle"></i> Patient Selection Required</h5>
                            <p>Please select a patient from the dashboard or search for an NHIA patient first.</p>
                            <a href="{% url 'desk_office:authorization_dashboard' %}" class="btn btn-primary">
                                <i class="fas fa-search"></i> Go to Patient Search
                            </a>
                        </div>
                    {% endif %}
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// ABSOLUTELY MINIMAL FORM HANDLER
document.addEventListener('DOMContentLoaded', function() {
    console.log('=== MINIMAL FORM LOADER ===');
    
    const form = document.getElementById('authorization-form');
    console.log('Form found:', form ? 'YES' : 'NO');
    
    if (form) {
        console.log('Form action:', form.action);
        console.log('Form method:', form.method);
        
        // Add SUBMIT event listener ONLY for logging
        form.addEventListener('submit', function(e) {
            console.log('=== FORM SUBMIT EVENT FIRED ===');
            console.log('Event:', e);
            console.log('Will submit to:', form.action || 'current page');
            console.log('Method:', form.method || 'GET');
            // DO NOT BLOCK SUBMISSION
        });
        
        // Add CLICK event listener to submit button
        const submitBtn = form.querySelector('button[type="submit"]');
        if (submitBtn) {
            console.log('Submit button found');
            submitBtn.addEventListener('click', function(e) {
                console.log('=== SUBMIT BUTTON CLICKED ===');
                console.log('Event:', e);
                // DO NOT BLOCK - let it submit
            });
        }
    }
});
</script>
{% endblock %}

{% extends 'base.html' %}
{% load static %}
{% load permission_tags %}

{% block title %}
  Bed Occupancy Report - {{ block.super }}
{% endblock title %}

{% block page_title %}
  Bed Occupancy Report
{% endblock page_title %}

{% block breadcrumbs %}
  <li class="breadcrumb-item"><a href="{% url 'dashboard:dashboard' %}">Dashboard</a></li>
  <li class="breadcrumb-item"><a href="{% url 'inpatient:admission_list' %}">Inpatient</a></li>
  <li class="breadcrumb-item active" aria-current="page">Bed Occupancy Report</li>
{% endblock breadcrumbs %}

{% block content %}
<div class="container-fluid">
    {% if not user|has_permission:'inpatient.view' %}
        {% permission_denied_message user "inpatient.view" %}
    {% else %}
    <!-- Hospital Overview Cards -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card bg-primary text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h4>{{ total_beds_hospital|default:0 }}</h4>
                            <p class="mb-0">Total Beds</p>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-bed fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-danger text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h4>{{ total_occupied_hospital|default:0 }}</h4>
                            <p class="mb-0">Occupied Beds</p>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-bed fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-success text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h4>{{ total_available_hospital|default:0 }}</h4>
                            <p class="mb-0">Available Beds</p>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-bed fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-info text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h4>{{ overall_occupancy_rate|floatformat:1|default:0 }}%</h4>
                            <p class="mb-0">Occupancy Rate</p>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-chart-pie fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Ward Details Table -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">Ward-wise Bed Occupancy</h5>
                    <div>
                        <button class="btn btn-outline-primary btn-sm" onclick="window.print()">
                            <i class="fas fa-print"></i> Print Report
                        </button>
                        {% if user|has_permission:'inpatient.view' %}
                        <a href="{% url 'inpatient:bed_dashboard' %}" class="btn btn-outline-secondary btn-sm ms-2">
                            <i class="fas fa-bed"></i> Bed Dashboard
                        </a>
                        {% endif %}
                    </div>
                </div>
                <div class="card-body">
                    {% if report_data %}
                    <div class="table-responsive">
                        <table class="table table-striped table-hover" id="wardOccupancyTable">
                            <thead class="table-dark">
                                <tr>
                                    <th>Ward Name</th>
                                    <th>Ward Type</th>
                                    <th>Total Beds</th>
                                    <th>Occupied</th>
                                    <th>Available</th>
                                    <th>Occupancy Rate</th>
                                    <th>Avg Length of Stay</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for ward_data in report_data %}
                                <tr>
                                    <td>
                                        <strong>{{ ward_data.ward.name }}</strong>
                                        <br><small class="text-muted">{{ ward_data.ward.description|default:"No description" }}</small>
                                    </td>
                                    <td>
                                        <span class="badge bg-secondary">{{ ward_data.ward.get_ward_type_display|default:"General" }}</span>
                                    </td>
                                    <td>
                                        <span class="badge bg-primary">{{ ward_data.total_beds|default:0 }}</span>
                                    </td>
                                    <td>
                                        <span class="badge bg-danger">{{ ward_data.occupied_beds|default:0 }}</span>
                                    </td>
                                    <td>
                                        <span class="badge bg-success">{{ ward_data.available_beds|default:0 }}</span>
                                    </td>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <div class="progress flex-grow-1 me-2" style="width: 100px;">
                                                <div class="progress-bar" 
                                                     role="progressbar" 
                                                     style="width: {{ ward_data.occupancy_rate|floatformat:1|default:0 }}%"
                                                     aria-valuenow="{{ ward_data.occupancy_rate|floatformat:1|default:0 }}"
                                                     aria-valuemin="0" 
                                                     aria-valuemax="100">
                                                </div>
                                            </div>
                                            <span class="text-nowrap">{{ ward_data.occupancy_rate|floatformat:1|default:0 }}%</span>
                                        </div>
                                    </td>
                                    <td>
                                        <span class="badge bg-info">{{ ward_data.avg_length_of_stay|floatformat:1|default:0 }} days</span>
                                    </td>
                                    <td>
                                        {% if user|has_permission:'inpatient.view' %}
                                        <a href="{% url 'inpatient:ward_detail' ward_data.ward.id %}" 
                                           class="btn btn-outline-primary btn-sm" 
                                           title="View Ward Details">
                                            <i class="fas fa-eye"></i>
                                        </a>
                                        {% endif %}
                                    </td>
                                </tr>
                                
                                <!-- Expandable row for current admissions -->
                                <tr class="ward-admissions-row" style="display: none;">
                                    <td colspan="8">
                                        <div class="p-3 border-start border-3 border-primary">
                                            <h6>Current Admissions in {{ ward_data.ward.name }}:</h6>
                                            {% if ward_data.current_admissions %}
                                            <div class="table-responsive">
                                                <table class="table table-sm">
                                                    <thead>
                                                        <tr>
                                                            <th>Patient</th>
                                                            <th>Admission Date</th>
                                                            <th>Attending Doctor</th>
                                                            <th>Days Stayed</th>
                                                            <th>Diagnosis</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        {% for admission in ward_data.current_admissions %}
                                                        <tr>
                                                            <td>
                                                                <a href="{% url 'inpatient:admission_detail' admission.id %}">
                                                                    {{ admission.patient.get_full_name|default:"Unknown Patient" }}
                                                                </a>
                                                                <br><small class="text-muted">{{ admission.patient.patient_id|default:"N/A" }}</small>
                                                            </td>
                                                            <td>{{ admission.admission_date|date:"M d, Y"|default:"Unknown" }}</td>
                                                            <td>
                                                                {% if admission.attending_doctor %}
                                                                    Dr. {{ admission.attending_doctor.get_full_name|default:"Unknown" }}
                                                                {% else %}
                                                                    <span class="text-muted">Not assigned</span>
                                                                {% endif %}
                                                            </td>
                                                            <td>
                                                                <span class="badge bg-light text-dark">{{ admission.get_duration|default:0 }} days</span>
                                                            </td>
                                                            <td>
                                                                {% if admission.primary_diagnosis %}
                                                                    {{ admission.primary_diagnosis|truncatechars:50|default:"No diagnosis" }}
                                                                {% else %}
                                                                    <span class="text-muted">No diagnosis</span>
                                                                {% endif %}
                                                            </td>
                                                        </tr>
                                                        {% endfor %}
                                                    </tbody>
                                                </table>
                                            </div>
                                            {% else %}
                                            <p class="text-muted">No current admissions in this ward.</p>
                                            {% endif %}
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center py-5">
                        <i class="fas fa-bed fa-3x text-muted mb-3"></i>
                        <h5 class="text-muted">No ward data available</h5>
                        <p class="text-muted">No wards have been configured in the system.</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Summary Statistics -->
    {% if report_data %}
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title">Summary Statistics</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Hospital-wide Metrics:</h6>
                            <ul class="list-unstyled">
                                <li><strong>Total Capacity:</strong> {{ total_beds_hospital|default:0 }} beds</li>
                                <li><strong>Currently Occupied:</strong> {{ total_occupied_hospital|default:0 }} beds</li>
                                <li><strong>Available Capacity:</strong> {{ total_available_hospital|default:0 }} beds</li>
                                <li><strong>Average Occupancy Rate:</strong> {{ overall_occupancy_rate|floatformat:1|default:0 }}%</li>
                                <li><strong>Average Length of Stay:</strong> {{ avg_length_of_stay|floatformat:1|default:0 }} days</li>
                            </ul>
                        </div>
                        <div class="col-md-6">
                            <h6>Capacity Analysis:</h6>
                            {% if overall_occupancy_rate|floatformat:1 > 85 %}
                            <div class="alert alert-warning">
                                <i class="fas fa-exclamation-triangle"></i>
                                <strong>High Occupancy Alert:</strong> Overall occupancy is above 85%. Consider transferring patients or opening additional beds.
                            </div>
                            {% elif overall_occupancy_rate|floatformat:1 > 95 %}
                            <div class="alert alert-danger">
                                <i class="fas fa-exclamation-circle"></i>
                                <strong>Overcapacity Alert:</strong> Overall occupancy is above 95%. Immediate action required.
                            </div>
                            {% else %}
                            <div class="alert alert-success">
                                <i class="fas fa-check-circle"></i>
                                <strong>Good Capacity:</strong> Overall occupancy is within acceptable limits.
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
    {% endif %}
</div>

{% endblock content %}

{% block js %}
{{ block.super }}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize DataTable
    if ($.fn.DataTable) {
        $('#wardOccupancyTable').DataTable({
            "pageLength": 25,
            "lengthMenu": [[10, 25, 50, -1], [10, 25, 50, "All"]],
            "order": [[5, "desc"]], // Sort by occupancy rate descending
            "columnDefs": [
                { "orderable": false, "targets": [7] } // Disable sorting on Actions column
            ],
            "dom": 'Bfrtip',
            "buttons": [
                'copy', 'csv', 'excel', 'pdf', 'print'
            ]
        });
    }

    // Add click event for expanding ward admissions
    document.querySelectorAll('tbody tr').forEach(function(row) {
        row.addEventListener('click', function() {
            const nextRow = row.nextElementSibling;
            if (nextRow && nextRow.classList.contains('ward-admissions-row')) {
                if (nextRow.style.display === 'none' || !nextRow.style.display) {
                    nextRow.style.display = 'table-row';
                    row.classList.add('table-primary');
                } else {
                    nextRow.style.display = 'none';
                    row.classList.remove('table-primary');
                }
            }
        });
    });

    // Add hover effect for better UX
    document.querySelectorAll('tbody tr').forEach(function(row) {
        row.style.cursor = 'pointer';
        row.addEventListener('mouseenter', function() {
            row.style.backgroundColor = '#f8f9fa';
        });
        row.addEventListener('mouseleave', function() {
            if (!row.classList.contains('table-primary')) {
                row.style.backgroundColor = '';
            }
        });
    });

    // Print styling
    window.addEventListener('beforeprint', function() {
        document.querySelectorAll('.btn, .breadcrumb, .card-header').forEach(function(el) {
            el.style.display = 'none';
        });
    });

    window.addEventListener('afterprint', function() {
        document.querySelectorAll('.btn, .breadcrumb, .card-header').forEach(function(el) {
            el.style.display = '';
        });
    });
});
</script>
{% endblock js %}

{% extends 'base.html' %}
{% load custom_filters %}
{% load core_form_tags %}

{% block title %}{{ title }} - Hospital Management System{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-sm-flex align-items-center justify-content-between mb-4">
        <h1 class="h3 mb-0 text-gray-800">{{ title }}</h1>
        <a href="{% url 'consultations:waiting_list' %}" class="d-none d-sm-inline-block btn btn-sm btn-secondary shadow-sm">
            <i class="fas fa-arrow-left fa-sm text-white-50"></i> Back to Waiting List
        </a>
    </div>

    <div class="row">
        <div class="col-lg-8 mx-auto">
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">Patient Details</h6>
                </div>
                <div class="card-body">
                    <form method="post">
                        {% csrf_token %}

                        <div class="mb-3">
                            <label for="{{ form.patient.id_for_label }}" class="form-label">Patient</label>
                            <div class="input-group">
                                <input type="text" id="patient-search" class="form-control" placeholder="Search patient by name or ID...">
                                <button class="btn btn-outline-secondary" type="button" id="search-patient-btn">
                                    <i class="fas fa-search"></i>
                                </button>
                            </div>
                            <div class="mt-2">
                                {{ form.patient|add_class:"form-control select2" }}
                                {% if form.patient.errors %}
                                    <div class="text-danger">
                                        {{ form.patient.errors }}
                                    </div>
                                {% endif %}
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="{{ form.doctor.id_for_label }}" class="form-label">Doctor <small class="text-muted">(Optional)</small></label>
                                {{ form.doctor|add_class:"form-control select2" }}
                                <small class="form-text text-muted">Leave empty if no specific doctor is required</small>
                                {% if form.doctor.errors %}
                                    <div class="text-danger">
                                        {{ form.doctor.errors }}
                                    </div>
                                {% endif %}
                            </div>

                            <div class="col-md-6 mb-3">
                                <label for="{{ form.consulting_room.id_for_label }}" class="form-label">Consulting Room</label>
                                {{ form.consulting_room|add_class:"form-control select2" }}
                                {% if form.consulting_room.errors %}
                                    <div class="text-danger">
                                        {{ form.consulting_room.errors }}
                                    </div>
                                {% endif %}
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="{{ form.appointment.id_for_label }}" class="form-label">Appointment (Optional)</label>
                                {{ form.appointment|add_class:"form-control select2" }}
                                {% if form.appointment.errors %}
                                    <div class="text-danger">
                                        {{ form.appointment.errors }}
                                    </div>
                                {% endif %}
                            </div>

                            <div class="col-md-6 mb-3">
                                <label for="{{ form.priority.id_for_label }}" class="form-label">Priority</label>
                                {{ form.priority|add_class:"form-control select2" }}
                                {% if form.priority.errors %}
                                    <div class="text-danger">
                                        {{ form.priority.errors }}
                                    </div>
                                {% endif %}
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="{{ form.notes.id_for_label }}" class="form-label">Notes</label>
                            {{ form.notes|add_class:"form-control" }}
                            {% if form.notes.errors %}
                                <div class="text-danger">
                                    {{ form.notes.errors }}
                                </div>
                            {% endif %}
                        </div>

                        <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                            <a href="{% url 'consultations:waiting_list' %}" class="btn btn-secondary me-md-2">
                                <i class="fas fa-times me-1"></i> Cancel
                            </a>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save me-1"></i> Add to Waiting List
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    $(document).ready(function() {
        $('.select2').select2({
            theme: 'bootstrap-5',
            width: '100%'
        });

        // Patient search functionality
        $('#search-patient-btn').click(function() {
            var searchTerm = $('#patient-search').val().trim();
            if (searchTerm.length >= 2) {
                // Try AJAX search first, but expect it might fail due to permissions
                // So immediately also do client-side filtering for better UX
                filterPatientDropdown(searchTerm);
                searchPatients(searchTerm);
            } else if (searchTerm.length > 0) {
                alert('Please enter at least 2 characters to search.');
            } else {
                // If search is empty, show all patients
                location.reload();
            }
        });

        // Also search when Enter key is pressed
        $('#patient-search').keypress(function(e) {
            if (e.which == 13) {  // Enter key
                e.preventDefault();
                $('#search-patient-btn').click();
            }
        });

        function searchPatients(searchTerm) {
            $.ajax({
                url: '/patients/search/',
                data: {
                    'q': searchTerm
                },
                dataType: 'json',
                beforeSend: function(xhr, settings) {
                    // Add CSRF token for POST requests if needed
                    if (settings.type.toUpperCase() === 'POST') {
                        xhr.setRequestHeader('X-CSRFToken', $('input[name=csrfmiddlewaretoken]').val());
                    }
                },
                success: function(data) {
                    if (data.patients && data.patients.length > 0) {
                        updatePatientDropdown(data.patients);
                    } else {
                        alert('No patients found matching: ' + searchTerm);
                        // Fallback to client-side search
                        filterPatientDropdown(searchTerm);
                    }
                },
                error: function(xhr, status, error) {
                    console.error('Search error:', error);
                    var errorMessage = 'Error searching for patients. ';
                    
                    if (xhr.status === 302) {
                        errorMessage += 'Please login to use server search. ';
                    } else if (xhr.status === 403) {
                        errorMessage += 'You don\'t have permission to use server search. ';
                    } else if (xhr.status === 404) {
                        errorMessage += 'Search endpoint not found. ';
                    } else {
                        errorMessage += error + '. ';
                    }
                    
                    errorMessage += 'Using client-side search instead.';
                    alert(errorMessage);
                    
                    // Fallback to client-side search is already done above
                }
            });
        }

        function updatePatientDropdown(patients) {
            var select = $('#id_patient');
            select.empty();
            
            // Add default option
            select.append($('<option></option>').val('').text('---------'));
            
            // Add matching patients
            $.each(patients, function(index, patient) {
                var displayText = patient.name + ' (' + patient.patient_id + ') - ' + patient.phone_number;
                select.append($('<option></option>').val(patient.id).text(displayText));
            });
            
            select.trigger('change');
        }
        
        // Client-side search fallback function
        function filterPatientDropdown(searchTerm) {
            var select = $('#id_patient');
            var originalOptions = select.find('option').clone();
            
            select.empty();
            select.append($('<option></option>').val('').text('---------'));
            
            var matchesFound = 0;
            originalOptions.each(function() {
                var option = $(this);
                if (option.val() === '') return; // Skip empty option
                
                var optionText = option.text().toLowerCase();
                var searchLower = searchTerm.toLowerCase();
                
                // Check if option text contains search term
                if (optionText.includes(searchLower)) {
                    select.append(option.clone());
                    matchesFound++;
                }
            });
            
            select.trigger('change');
            
            // Show user feedback
            if (matchesFound === 0) {
                alert('No matching patients found in the current list. Try a different search term.');
            } else {
                console.log('Found ' + matchesFound + ' matching patients');
            }
        }

        // When patient changes, update appointment options
        $('#id_patient').change(function() {
            var patientId = $(this).val();
            if (patientId) {
                // You could make an AJAX call here to get appointments for this patient
                // For now, we'll just clear the current selection
                $('#id_appointment').val(null).trigger('change');
            }
        });

        // When doctor changes, update consulting room options
        $('#id_doctor').change(function() {
            var doctorId = $(this).val();
            if (doctorId) {
                // You could make an AJAX call here to get rooms for this doctor
                // For now, we'll just clear the current selection
                $('#id_consulting_room').val(null).trigger('change');
            }
        });
    });
</script>
{% endblock %}

{% extends 'base.html' %}
{% load custom_filters %}
{% load core_form_tags %}

{% block title %}{{ title }} - Hospital Management System{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-sm-flex align-items-center justify-content-between mb-4">
        <h1 class="h3 mb-0 text-gray-800">{{ title }}</h1>
        <a href="{% url 'consultations:waiting_list' %}" class="d-none d-sm-inline-block btn btn-sm btn-secondary shadow-sm">
            <i class="fas fa-arrow-left fa-sm text-white-50"></i> Back to Waiting List
        </a>
    </div>

    <div class="row">
        <div class="col-lg-8 mx-auto">
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">Patient Details</h6>
                </div>
                <div class="card-body">
                    <form method="post">
                        {% csrf_token %}

                        <div class="mb-3">
                            <label for="{{ form.patient.id_for_label }}" class="form-label">Patient</label>
                            <div class="input-group">
                                {% comment %} <input type="text" id="patient-search" class="form-control" 
                                       placeholder="Search patient by name or ID...">
                                <button class="btn btn-outline-secondary" type="button" id="search-patient-btn">
                                    <i class="fas fa-search"></i>
                                </button> {% endcomment %}
                                <span class="search-loading ms-2" style="display: none;">
                                    <i class="fas fa-spinner fa-spin"></i>
                                </span>
                            </div>
                            <div class="mt-2">
                                {{ form.patient|add_class:"form-control select2" }}
                                {% if form.patient.errors %}
                                    <div class="text-danger">
                                        {{ form.patient.errors }}
                                    </div>
                                {% endif %}
                            </div>
                            <div id="search-feedback" class="text-danger mt-2" style="display: none;"></div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="{{ form.doctor.id_for_label }}" class="form-label">Doctor <small class="text-muted">(Optional)</small></label>
                                {{ form.doctor|add_class:"form-control select2" }}
                                <small class="form-text text-muted">Leave empty if no specific doctor is required</small>
                                {% if form.doctor.errors %}
                                    <div class="text-danger">
                                        {{ form.doctor.errors }}
                                    </div>
                                {% endif %}
                            </div>

                            <div class="col-md-6 mb-3">
                                <label for="{{ form.consulting_room.id_for_label }}" class="form-label">Consulting Room</label>
                                {{ form.consulting_room|add_class:"form-control select2" }}
                                {% if form.consulting_room.errors %}
                                    <div class="text-danger">
                                        {{ form.consulting_room.errors }}
                                    </div>
                                {% endif %}
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="{{ form.appointment.id_for_label }}" class="form-label">Appointment (Optional)</label>
                                {{ form.appointment|add_class:"form-control select2" }}
                                {% if form.appointment.errors %}
                                    <div class="text-danger">
                                        {{ form.appointment.errors }}
                                    </div>
                                {% endif %}
                            </div>

                            <div class="col-md-6 mb-3">
                                <label for="{{ form.priority.id_for_label }}" class="form-label">Priority</label>
                                {{ form.priority|add_class:"form-control select2" }}
                                {% if form.priority.errors %}
                                    <div class="text-danger">
                                        {{ form.priority.errors }}
                                    </div>
                                {% endif %}
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="{{ form.notes.id_for_label }}" class="form-label">Notes</label>
                            {{ form.notes|add_class:"form-control" }}
                            {% if form.notes.errors %}
                                <div class="text-danger">
                                    {{ form.notes.errors }}
                                </div>
                            {% endif %}
                        </div>

                        <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                            <a href="{% url 'consultations:waiting_list' %}" class="btn btn-secondary me-md-2">
                                <i class="fas fa-times me-1"></i> Cancel
                            </a>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save me-1"></i> Add to Waiting List
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Initialize Select2 for dropdowns
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize Select2
        if (typeof $.fn.select2 !== 'undefined') {
            $('.select2').select2({
                theme: 'bootstrap-5',
                width: '100%'
            });
        }

        // Set up patient search functionality
        const searchInput = document.getElementById('patient-search');
        const searchButton = document.getElementById('search-patient-btn');
        const loadingIndicator = document.querySelector('.search-loading');
        
        if (searchInput && searchButton) {
            // Search button click handler
            searchButton.addEventListener('click', function() {
                performPatientSearch();
            });
            
            // Enter key handler
            searchInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    performPatientSearch();
                }
            });
            
            // Debounced search on input
            let searchTimeout;
            searchInput.addEventListener('input', function() {
                clearTimeout(searchTimeout);
                if (this.value.trim().length >= 2) {
                    searchTimeout = setTimeout(performPatientSearch, 500);
                }
            });
        }

        // Perform patient search using HTMX
        function performPatientSearch() {
            const searchTerm = searchInput.value.trim();
            
            if (searchTerm.length === 0) {
                return;
            }
            
            if (searchTerm.length < 2) {
                showFeedback('Please enter at least 2 characters to search.', 'warning');
                return;
            }
            
            // Show loading indicator
            if (loadingIndicator) {
                loadingIndicator.style.display = 'inline-block';
            }
            
            // Check if user is likely authenticated
            const isAuthenticated = document.cookie.includes('hms_sessionid') || document.cookie.includes('sessionid');
            
            if (!isAuthenticated) {
                showFeedback('Please login to use server search. Using client-side search instead.', 'warning');
                filterPatientDropdown(searchTerm);
                if (loadingIndicator) {
                    loadingIndicator.style.display = 'none';
                }
                return;
            }
            
            // Use HTMX to make the request
            if (typeof htmx !== 'undefined' && htmx.ajax) {
                const url = '/patients/search/?q=' + encodeURIComponent(searchTerm);
                
                htmx.ajax('GET', url, {
                    target: '#patient-search-results',
                    swap: 'innerHTML'
                }).then(function() {
                    // Request completed, hide loading indicator
                    if (loadingIndicator) {
                        loadingIndicator.style.display = 'none';
                    }
                }).catch(function(error) {
                    console.error('HTMX request failed:', error);
                    showFeedback('Server search failed. Using client-side search.', 'warning');
                    filterPatientDropdown(searchTerm);
                    if (loadingIndicator) {
                        loadingIndicator.style.display = 'none';
                    }
                });
            } else {
                // HTMX not available, fall back to client-side search
                showFeedback('HTMX not available. Using client-side search.', 'warning');
                filterPatientDropdown(searchTerm);
                if (loadingIndicator) {
                    loadingIndicator.style.display = 'none';
                }
            }
        }

        // Handle HTMX response by listening to HTMX events
        document.addEventListener('htmx:afterRequest', function(evt) {
            if (evt.detail.path === '/patients/search/') {
                const xhr = evt.detail.xhr;
                if (xhr.status === 200) {
                    try {
                        const data = JSON.parse(xhr.responseText);
                        if (data.patients && data.patients.length > 0) {
                            updatePatientDropdown(data.patients);
                            showFeedback('Found ' + data.patients.length + ' patients via server search.', 'success');
                        } else {
                            showFeedback('No patients found via server search. Using client-side search.', 'warning');
                            const searchTerm = searchInput.value.trim();
                            if (searchTerm.length >= 2) {
                                filterPatientDropdown(searchTerm);
                            }
                        }
                    } catch (e) {
                        console.error('Error parsing search response:', e);
                        showFeedback('Error parsing search results. Using client-side search.', 'warning');
                    }
                } else if (xhr.status === 302 || xhr.status === 403) {
                    showFeedback('Please login to use server search. Using client-side search.', 'warning');
                    const searchTerm = searchInput.value.trim();
                    if (searchTerm.length >= 2) {
                        filterPatientDropdown(searchTerm);
                    }
                } else if (xhr.status === 404) {
                    showFeedback('Search endpoint not found. Using client-side search.', 'warning');
                    const searchTerm = searchInput.value.trim();
                    if (searchTerm.length >= 2) {
                        filterPatientDropdown(searchTerm);
                    }
                }
                
                // Hide loading indicator
                if (loadingIndicator) {
                    loadingIndicator.style.display = 'none';
                }
            }
        });

        // Update patient dropdown with search results
        function updatePatientDropdown(patients) {
            const select = document.getElementById('id_patient');
            if (!select) return;
            
            // Clear existing options (except the first empty option)
            while (select.options.length > 1) {
                select.remove(1);
            }
            
            // Add new options
            patients.forEach(function(patient) {
                const option = document.createElement('option');
                option.value = patient.id;
                option.text = patient.name + ' (' + patient.patient_id + ') - ' + patient.phone_number;
                select.add(option);
            });
            
            // Trigger change event
            if (typeof Event === 'function') {
                select.dispatchEvent(new Event('change'));
            }
        }

        // Client-side search fallback
        function filterPatientDropdown(searchTerm) {
            const select = document.getElementById('id_patient');
            if (!select) return;
            
            const options = select.options;
            let matchesFound = 0;
            
            // Show all options first
            for (let i = 0; i < options.length; i++) {
                options[i].style.display = '';
            }
            
            // Filter options
            for (let i = 0; i < options.length; i++) {
                const option = options[i];
                if (option.value === '') continue; // Skip empty option
                
                const optionText = option.text.toLowerCase();
                const searchLower = searchTerm.toLowerCase();
                
                if (optionText.includes(searchLower)) {
                    option.style.display = '';
                    matchesFound++;
                } else {
                    option.style.display = 'none';
                }
            }
            
            // Show feedback
            if (matchesFound === 0) {
                showFeedback('No matching patients found. Try a different search term.', 'danger');
            } else {
                showFeedback('Found ' + matchesFound + ' matching patients.', 'success');
            }
        }

        // Show feedback message
        function showFeedback(message, type) {
            const feedbackDiv = document.getElementById('search-feedback');
            if (feedbackDiv) {
                feedbackDiv.textContent = message;
                feedbackDiv.className = 'text-' + type + ' mt-2';
                feedbackDiv.style.display = 'block';
            }
        }

        // Handle Enter key for search
        document.getElementById('patient-search')?.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                const searchTerm = this.value.trim();
                if (searchTerm.length >= 2) {
                    // Trigger HTMX search manually if needed
                    if (typeof htmx !== 'undefined' && htmx.trigger) {
                        htmx.trigger(this, 'search');
                    }
                } else if (searchTerm.length > 0) {
                    showFeedback('Please enter at least 2 characters to search.', 'warning');
                }
            }
        });

        // Handle empty search (show all patients)
        document.getElementById('patient-search')?.addEventListener('input', function(e) {
            if (this.value.trim().length === 0) {
                // Show all options when search is cleared
                const select = document.getElementById('id_patient');
                if (select) {
                    const options = select.options;
                    for (let i = 0; i < options.length; i++) {
                        options[i].style.display = '';
                    }
                }
                showFeedback('', 'danger'); // Clear feedback
            }
        });
    });
</script>
{% endblock %}

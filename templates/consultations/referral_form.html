{% extends 'base.html' %}
{% load core_form_tags %}

{% block title %}Create Referral - Hospital Management System{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Page Header -->
    <div class="d-sm-flex align-items-center justify-content-between mb-4">
        <h1 class="h3 mb-0 text-gray-800">
            {% if consultation %}
                Create Referral for {{ consultation.patient.get_full_name }}
            {% elif patient %}
                Create Referral for {{ patient.get_full_name }}
            {% else %}
                Create Referral
            {% endif %}
        </h1>
        {% if consultation %}
            <a href="{% url 'consultations:doctor_consultation' consultation.id %}" class="d-none d-sm-inline-block btn btn-sm btn-secondary shadow-sm">
                <i class="fas fa-arrow-left fa-sm text-white-50"></i> Back to Consultation
            </a>
        {% elif patient %}
            <a href="{% url 'patients:detail' patient.id %}" class="d-none d-sm-inline-block btn btn-sm btn-secondary shadow-sm">
                <i class="fas fa-arrow-left fa-sm text-white-50"></i> Back to Patient
            </a>
        {% else %}
            <a href="{% url 'consultations:referral_tracking' %}" class="d-none d-sm-inline-block btn btn-sm btn-secondary shadow-sm">
                <i class="fas fa-arrow-left fa-sm text-white-50"></i> Back to Referrals
            </a>
        {% endif %}
    </div>

    <div class="row">
        <!-- Main Form Column -->
        <div class="col-lg-8">
            <!-- Patient Information Card -->
            {% if patient %}
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">
                        <i class="fas fa-user-circle me-2"></i>Patient Information
                    </h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="patient-info-item mb-3">
                                <strong><i class="fas fa-user me-2 text-primary"></i>Name:</strong> 
                                <span class="ms-2">{{ patient.get_full_name }}</span>
                            </div>
                            <div class="patient-info-item mb-3">
                                <strong><i class="fas fa-id-card me-2 text-primary"></i>Patient ID:</strong> 
                                <span class="ms-2">{{ patient.patient_id }}</span>
                            </div>
                            <div class="patient-info-item mb-3">
                                <strong><i class="fas fa-birthday-cake me-2 text-primary"></i>Age:</strong> 
                                <span class="ms-2">{{ patient.get_age }} years</span>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="patient-info-item mb-3">
                                <strong><i class="fas fa-venus-mars me-2 text-primary"></i>Gender:</strong> 
                                <span class="ms-2">{{ patient.get_gender_display }}</span>
                            </div>
                            <div class="patient-info-item mb-3">
                                <strong><i class="fas fa-user-tag me-2 text-primary"></i>Type:</strong> 
                                <span class="ms-2">{{ patient.get_patient_type_display }}</span>
                                {% if patient.patient_type == 'nhia' %}
                                    <span class="badge bg-primary ms-2">
                                        <i class="fas fa-shield-alt me-1"></i>NHIA
                                    </span>
                                {% endif %}
                            </div>
                            <div class="patient-info-item mb-3">
                                <strong><i class="fas fa-phone me-2 text-primary"></i>Contact:</strong> 
                                <span class="ms-2">{{ patient.phone_number|default:"Not provided" }}</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Current Admission Status -->
                    {% if current_admissions %}
                    <div class="alert alert-info mt-3">
                        <h6><i class="fas fa-procedures me-2"></i>Current Admission Status</h6>
                        {% for admission in current_admissions %}
                        <div class="admission-info">
                            <strong>Bed:</strong> {{ admission.bed.bed_number|default:"Not assigned" }} |
                            <strong>Attending Doctor:</strong> Dr. {{ admission.attending_doctor.get_full_name|default:"Not assigned" }} |
                            <strong>Admission Date:</strong> {{ admission.admission_date|date:"M d, Y" }}
                        </div>
                        {% endfor %}
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endif %}

            <!-- Referral Form Card -->
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-danger">
                        <i class="fas fa-user-md me-2"></i>Referral Details
                    </h6>
                </div>
                <div class="card-body">
                    <form method="post" id="referralForm">
                        {% csrf_token %}

                        <!-- Referral Type Selection -->
                        <div class="mb-3">
                            <label for="{{ form.referral_type.id_for_label }}" class="form-label">
                                <i class="fas fa-list me-1"></i>
                                Referral Type <span class="text-danger">*</span>
                            </label>
                            {{ form.referral_type|add_class:"form-select" }}
                            {% if form.referral_type.errors %}
                                <div class="text-danger mt-1">
                                    {{ form.referral_type.errors }}
                                </div>
                            {% endif %}
                            <div class="form-text">Select the type of referral (Department, Specialty, Unit, or Specific Doctor).</div>
                        </div>

                        <!-- Department Selection (shown when referral_type is 'department') -->
                        <div class="mb-3" id="department-field">
                            <label for="{{ form.referred_to_department.id_for_label }}" class="form-label">
                                <i class="fas fa-building me-1"></i>
                                Department
                            </label>
                            {{ form.referred_to_department|add_class:"form-select select2" }}
                            {% if form.referred_to_department.errors %}
                                <div class="text-danger mt-1">
                                    {{ form.referred_to_department.errors }}
                                </div>
                            {% endif %}
                            <div class="form-text">Select the department to refer the patient to.</div>
                        </div>

                        <!-- Specialty Input (shown when referral_type is 'specialty') -->
                        <div class="mb-3" id="specialty-field">
                            <label for="{{ form.referred_to_specialty.id_for_label }}" class="form-label">
                                <i class="fas fa-stethoscope me-1"></i>
                                Specialty
                            </label>
                            {{ form.referred_to_specialty|add_class:"form-control" }}
                            {% if form.referred_to_specialty.errors %}
                                <div class="text-danger mt-1">
                                    {{ form.referred_to_specialty.errors }}
                                </div>
                            {% endif %}
                            <div class="form-text">Enter the medical specialty (e.g., Cardiology, Neurology).</div>
                        </div>

                        <!-- Unit Input (shown when referral_type is 'unit') -->
                        <div class="mb-3" id="unit-field">
                            <label for="{{ form.referred_to_unit.id_for_label }}" class="form-label">
                                <i class="fas fa-hospital me-1"></i>
                                Unit
                            </label>
                            {{ form.referred_to_unit|add_class:"form-control" }}
                            {% if form.referred_to_unit.errors %}
                                <div class="text-danger mt-1">
                                    {{ form.referred_to_unit.errors }}
                                </div>
                            {% endif %}
                            <div class="form-text">Enter the specific unit (e.g., ICU, Emergency).</div>
                        </div>

                        <!-- Doctor Selection (shown when referral_type is 'doctor') -->
                        <div class="mb-3" id="doctor-field">
                            <label for="{{ form.referred_to_doctor.id_for_label }}" class="form-label">
                                <i class="fas fa-user-doctor me-1"></i>
                                Refer To Doctor
                            </label>
                            {{ form.referred_to_doctor|add_class:"form-select select2" }}
                            {% if form.referred_to_doctor.errors %}
                                <div class="text-danger mt-1">
                                    {{ form.referred_to_doctor.errors }}
                                </div>
                            {% endif %}
                            <div class="form-text">Select the specific doctor to refer the patient to.</div>
                        </div>

                        <div class="mb-3">
                            <label for="{{ form.reason.id_for_label }}" class="form-label">
                                <i class="fas fa-clipboard-list me-1"></i>
                                Reason for Referral <span class="text-danger">*</span>
                            </label>
                            {{ form.reason|add_class:"form-control" }}
                            {% if form.reason.errors %}
                                <div class="text-danger mt-1">
                                    {{ form.reason.errors }}
                                </div>
                            {% endif %}
                            <div class="form-text">Provide a clear reason for the referral (e.g., specialist consultation, second opinion, advanced treatment).</div>
                        </div>

                        <div class="mb-3">
                            <label for="{{ form.notes.id_for_label }}" class="form-label">
                                <i class="fas fa-notes-medical me-1"></i>
                                Additional Notes <span class="text-muted">(Optional)</span>
                            </label>
                            {{ form.notes|add_class:"form-control" }}
                            {% if form.notes.errors %}
                                <div class="text-danger mt-1">
                                    {{ form.notes.errors }}
                                </div>
                            {% endif %}
                            <div class="form-text">Include relevant medical history, test results, current medications, or special considerations.</div>
                        </div>

                        <!-- NHIA Authorization Section -->
                        {% if patient.patient_type == 'nhia' %}
                        <div class="alert alert-warning mb-3">
                            <h6><i class="fas fa-exclamation-triangle me-2"></i>NHIA Authorization Required</h6>
                            <p class="mb-2">This NHIA patient referral may require authorization from the desk office.</p>
                            
                            {% if form.authorization_code_input %}
                            <div class="mb-3" id="authorization-field">
                                <label for="{{ form.authorization_code_input.id_for_label }}" class="form-label">
                                    <i class="fas fa-key text-warning me-1"></i> Authorization Code
                                </label>
                                {{ form.authorization_code_input|add_class:"form-control" }}
                                {% if form.authorization_code_input.errors %}
                                    <div class="text-danger mt-1">
                                        {{ form.authorization_code_input.errors }}
                                    </div>
                                {% endif %}
                                <div class="form-text">{{ form.authorization_code_input.help_text }}</div>
                            </div>
                            {% endif %}
                        </div>
                        {% endif %}

                        <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                            {% if consultation %}
                                <a href="{% url 'consultations:doctor_consultation' consultation.id %}" class="btn btn-secondary me-md-2">
                                    <i class="fas fa-times me-1"></i> Cancel
                                </a>
                            {% elif patient %}
                                <a href="{% url 'patients:detail' patient.id %}" class="btn btn-secondary me-md-2">
                                    <i class="fas fa-times me-1"></i> Cancel
                                </a>
                            {% else %}
                                <a href="{% url 'consultations:referral_tracking' %}" class="btn btn-secondary me-md-2">
                                    <i class="fas fa-times me-1"></i> Cancel
                                </a>
                            {% endif %}
                            <button type="submit" class="btn btn-danger" id="submitReferralBtn">
                                <i class="fas fa-paper-plane me-1"></i> Create Referral
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Sidebar Column -->
        <div class="col-lg-4">
            <!-- Referral History Card -->
            {% if referral_history %}
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-info">
                        <i class="fas fa-history me-2"></i>Referral History
                    </h6>
                </div>
                <div class="card-body">
                    <div class="referral-history-list">
                        {% for referral in referral_history %}
                        <div class="referral-history-item mb-3 pb-3 border-bottom">
                            <div class="d-flex justify-content-between align-items-start">
                                <div class="referral-info">
                                    <h6 class="mb-1">
                                        <i class="fas fa-arrow-right text-primary me-1"></i>
                                        To: {{ referral.get_referral_destination }}
                                    </h6>
                                    <small class="text-muted">
                                        From: Dr. {{ referral.referring_doctor.get_full_name }}
                                    </small>
                                    <p class="mb-1 small">{{ referral.reason|truncatewords:10 }}</p>
                                    <small class="text-muted">
                                        <i class="fas fa-calendar me-1"></i>
                                        {{ referral.referral_date|date:"M d, Y H:i" }}
                                    </small>
                                </div>
                                <span class="badge bg-{% if referral.status == 'pending' %}warning{% elif referral.status == 'accepted' %}info{% elif referral.status == 'completed' %}success{% else %}secondary{% endif %}">
                                    {{ referral.get_status_display }}
                                </span>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    <div class="text-center mt-3">
                        <a href="{% url 'consultations:referral_tracking' %}?patient={{ patient.id }}" class="btn btn-sm btn-outline-info">
                            <i class="fas fa-list me-1"></i> View All Referrals
                        </a>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Recent Consultations Card -->
            {% if recent_consultations %}
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-success">
                        <i class="fas fa-stethoscope me-2"></i>Recent Consultations
                    </h6>
                </div>
                <div class="card-body">
                    <div class="consultation-list">
                        {% for consultation in recent_consultations %}
                        <div class="consultation-item mb-3 pb-3 border-bottom">
                            <h6 class="mb-1">
                                <i class="fas fa-user-md text-success me-1"></i>
                                Dr. {{ consultation.doctor.get_full_name }}
                            </h6>
                            <p class="mb-1 small text-muted">{{ consultation.chief_complaint|default:"No chief complaint recorded"|truncatewords:8 }}</p>
                            <small class="text-muted">
                                <i class="fas fa-calendar me-1"></i>
                                {{ consultation.consultation_date|date:"M d, Y H:i" }}
                            </small>
                            <span class="badge bg-{% if consultation.status == 'pending' %}warning{% elif consultation.status == 'in_progress' %}info{% elif consultation.status == 'completed' %}success{% else %}secondary{% endif %} ms-2">
                                {{ consultation.get_status_display }}
                            </span>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Referral Guidelines Card -->
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-warning">
                        <i class="fas fa-info-circle me-2"></i>Referral Guidelines
                    </h6>
                </div>
                <div class="card-body">
                    <h6><i class="fas fa-check-circle text-success me-2"></i>When to Refer:</h6>
                    <ul class="list-unstyled mb-3">
                        <li><i class="fas fa-arrow-right text-muted me-2"></i>Specialist consultation needed</li>
                        <li><i class="fas fa-arrow-right text-muted me-2"></i>Second opinion required</li>
                        <li><i class="fas fa-arrow-right text-muted me-2"></i>Advanced diagnostic procedures</li>
                        <li><i class="fas fa-arrow-right text-muted me-2"></i>Specialized treatment beyond scope</li>
                        <li><i class="fas fa-arrow-right text-muted me-2"></i>Emergency specialist intervention</li>
                    </ul>
                    
                    <h6><i class="fas fa-exclamation-triangle text-warning me-2"></i>Important Notes:</h6>
                    <ul class="list-unstyled mb-0">
                        <li><i class="fas fa-arrow-right text-muted me-2"></i>Provide clear reason for referral</li>
                        <li><i class="fas fa-arrow-right text-muted me-2"></i>Include relevant medical history</li>
                        <li><i class="fas fa-arrow-right text-muted me-2"></i>Mention current medications</li>
                        <li><i class="fas fa-arrow-right text-muted me-2"></i>NHIA patients may need authorization</li>
                        <li><i class="fas fa-arrow-right text-muted me-2"></i>Ensure receiving doctor availability</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    $(document).ready(function() {
        $('.select2').select2({
            theme: 'bootstrap-5',
            width: '100%'
        });

        // Function to show/hide fields based on referral type
        function toggleReferralFields() {
            const referralType = $('#{{ form.referral_type.id_for_label }}').val();

            // Hide all conditional fields first
            $('#department-field').hide();
            $('#specialty-field').hide();
            $('#unit-field').hide();
            $('#doctor-field').hide();

            // Show relevant field based on selection
            if (referralType === 'department') {
                $('#department-field').show();
            } else if (referralType === 'specialty') {
                $('#specialty-field').show();
                $('#department-field').show(); // Can also select department for specialty
            } else if (referralType === 'unit') {
                $('#unit-field').show();
                $('#department-field').show(); // Can also select department for unit
            } else if (referralType === 'doctor') {
                $('#doctor-field').show();
            }
        }

        // Initialize field visibility on page load
        toggleReferralFields();

        // Update field visibility when referral type changes
        $('#{{ form.referral_type.id_for_label }}').change(function() {
            toggleReferralFields();
        });

        // Form validation
        $('#referralForm').on('submit', function(e) {
            const referralType = $('#{{ form.referral_type.id_for_label }}').val();
            const reason = $('#{{ form.reason.id_for_label }}').val().trim();
            let isValid = true;
            let errorMessage = '';

            // Validate based on referral type
            if (referralType === 'department') {
                const department = $('#{{ form.referred_to_department.id_for_label }}').val();
                if (!department) {
                    isValid = false;
                    errorMessage = 'Please select a department to refer the patient to.';
                }
            } else if (referralType === 'specialty') {
                const specialty = $('#{{ form.referred_to_specialty.id_for_label }}').val().trim();
                if (!specialty) {
                    isValid = false;
                    errorMessage = 'Please enter the specialty to refer the patient to.';
                }
            } else if (referralType === 'unit') {
                const unit = $('#{{ form.referred_to_unit.id_for_label }}').val().trim();
                if (!unit) {
                    isValid = false;
                    errorMessage = 'Please enter the unit to refer the patient to.';
                }
            } else if (referralType === 'doctor') {
                const doctor = $('#{{ form.referred_to_doctor.id_for_label }}').val();
                if (!doctor) {
                    isValid = false;
                    errorMessage = 'Please select a doctor to refer the patient to.';
                }
            }

            if (!isValid) {
                e.preventDefault();
                alert(errorMessage);
                return false;
            }

            if (!reason) {
                e.preventDefault();
                alert('Please provide a reason for the referral.');
                $('#{{ form.reason.id_for_label }}').focus();
                return false;
            }

            // Show loading state
            const submitBtn = $('#submitReferralBtn');
            submitBtn.prop('disabled', true);
            submitBtn.html('<i class="fas fa-spinner fa-spin me-1"></i> Creating Referral...');
        });

        // Check if authorization is required based on patient selection
        function checkAuthorizationRequirement() {
            // This would need to be implemented with AJAX call to check if patient is NHIA
            // For now, we'll show it conditionally
            var patientId = $('#{{ form.patient.id_for_label }}').val();
            if (patientId) {
                // Show authorization field if needed
                // This would be determined by checking patient NHIA status and referred doctor's department
                // $('#authorization-field').show();
            }
        }

        // Check authorization requirement when patient or referred doctor changes
        $('#{{ form.patient.id_for_label }}, #{{ form.referred_to_doctor.id_for_label }}').change(checkAuthorizationRequirement);
    });
</script>
{% endblock %}

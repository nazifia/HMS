{% extends 'base.html' %}
{% load form_tags %}
{% load static %}
{% load pharmacy_tags %}

{% block title %}Dispense Medications - Hospital Management System{% endblock %}

{% block extra_css %}
<style>
    @keyframes bounce {
        0%, 20%, 50%, 80%, 100% {
            transform: translateX(-50%) translateY(0);
        }
        40% {
            transform: translateX(-50%) translateY(-10px);
        }
        60% {
            transform: translateX(-50%) translateY(-5px);
        }
    }

    /* Dispensed row styling */
    tr.dispensed-row {
        background-color: #f8f9fa;
        opacity: 0.7;
    }

    tr.dispensed-row td {
        color: #6c757d;
    }

    /* Disabled checkbox styling */
    input[type="checkbox"]:disabled {
        cursor: not-allowed;
        opacity: 0.5;
    }

    /* Message styling */
    .alert {
        border-left: 4px solid;
        border-radius: 0.375rem;
    }

    .alert-success {
        background-color: #d1e7dd;
        border-left-color: #0f5132;
        color: #0f5132;
    }

    .alert-info {
        background-color: #cff4fc;
        border-left-color: #055160;
        color: #055160;
    }

    .alert-warning {
        background-color: #fff3cd;
        border-left-color: #664d03;
        color: #664d03;
    }

    .alert-danger {
        background-color: #f8d7da;
        border-left-color: #842029;
        color: #842029;
    }

    /* Badge for dispensed status */
    .badge-dispensed {
        background-color: #198754;
        color: white;
        padding: 0.35em 0.65em;
        font-size: 0.75em;
        font-weight: 600;
        border-radius: 0.25rem;
    }

    .badge-pending {
        background-color: #ffc107;
        color: #000;
        padding: 0.35em 0.65em;
        font-size: 0.75em;
        font-weight: 600;
        border-radius: 0.25rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-12 mb-4">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h4 class="mb-0">{{ title }}</h4>
            </div>
            <div class="card-body">
                <!-- Info: Invoice will be generated after dispensing -->
                <div class="alert alert-info mb-4">
                    <i class="fas fa-info-circle me-2"></i>
                    <strong>Note:</strong> The invoice for dispensed medicines will be generated and sent to billing only after you confirm dispensing below.
                </div>
                <!-- Prescription Information -->
                <div class="card mb-4">
                    <div class="card-header bg-light">
                        <h5 class="mb-0">Prescription Information</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="row mb-3">
                                    <div class="col-md-4 text-muted">Prescription ID:</div>
                                    <div class="col-md-8">{{ prescription.id }}</div>
                                </div>
                                <div class="row mb-3">
                                    <div class="col-md-4 text-muted">Date:</div>
                                    <div class="col-md-8">{{ prescription.prescription_date|date:"F d, Y" }}</div>
                                </div>
                                <div class="row mb-3">
                                    <div class="col-md-4 text-muted">Diagnosis:</div>
                                    <div class="col-md-8">{{ prescription.diagnosis }}</div>
                                </div>
                                <div class="row mb-3">
                                    <div class="col-md-4 text-muted">Status:</div>
                                    <div class="col-md-8">
                                        {% if prescription.status == 'pending' %}
                                            <span class="badge bg-warning">Pending</span>
                                        {% elif prescription.status == 'processing' %}
                                            <span class="badge bg-info">Processing</span>
                                        {% elif prescription.status == 'completed' %}
                                            <span class="badge bg-success">Completed</span>
                                        {% elif prescription.status == 'cancelled' %}
                                            <span class="badge bg-danger">Cancelled</span>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="row mb-3">
                                    <div class="col-md-4 text-muted">Patient:</div>
                                    <div class="col-md-8">
                                        <a href="{% url 'patients:detail' prescription.patient.id %}">
                                            {{ prescription.patient.get_full_name }}
                                        </a>
                                    </div>
                                </div>
                                <div class="row mb-3">
                                    <div class="col-md-4 text-muted">Patient ID:</div>
                                    <div class="col-md-8">{{ prescription.patient.patient_id }}</div>
                                </div>
                                <div class="row mb-3">
                                    <div class="col-md-4 text-muted">Doctor:</div>
                                    <div class="col-md-8">Dr. {{ prescription.doctor.get_full_name }}</div>
                                </div>
                                <div class="row mb-3">
                                    <div class="col-md-4 text-muted">Department:</div>
                                    <div class="col-md-8">{{ prescription.doctor.profile.department|default:"Not specified" }}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- NHIA Payment Information - Prominent Display -->
                {% if is_nhia_patient %}
                <div class="card border-success shadow-sm mb-4">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-shield-alt me-2"></i>NHIA Patient - Payment Breakdown
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-4">
                                <div class="text-center p-3 bg-light rounded">
                                    <small class="text-muted d-block mb-1">Total Medication Cost</small>
                                    <h4 class="text-primary mb-0">₦{{ total_medication_cost|floatformat:2 }}</h4>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="text-center p-3 bg-warning bg-opacity-10 rounded border border-warning">
                                    <small class="text-muted d-block mb-1">
                                        <i class="fas fa-user me-1"></i>Patient Pays (10%)
                                    </small>
                                    <h3 class="text-warning mb-0 fw-bold">₦{{ total_patient_pays|floatformat:2 }}</h3>
                                    <small class="text-success mt-1 d-block">
                                        <i class="fas fa-info-circle"></i> Only 10% required
                                    </small>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="text-center p-3 bg-success bg-opacity-10 rounded border border-success">
                                    <small class="text-muted d-block mb-1">
                                        <i class="fas fa-shield-alt me-1"></i>NHIA Covers (90%)
                                    </small>
                                    <h4 class="text-success mb-0">₦{{ total_nhia_covers|floatformat:2 }}</h4>
                                    <small class="text-muted mt-1 d-block">
                                        <i class="fas fa-check-circle"></i> Covered by insurance
                                    </small>
                                </div>
                            </div>
                        </div>
                        <div class="alert alert-info mt-3 mb-0">
                            <i class="fas fa-info-circle me-2"></i>
                            <strong>NHIA Benefit:</strong> As an NHIA patient, you save <strong>₦{{ total_nhia_covers|floatformat:2 }}</strong> (90% of total cost).
                            You only need to pay <strong>₦{{ total_patient_pays|floatformat:2 }}</strong> for all medications.
                        </div>
                    </div>
                </div>
                {% else %}
                <div class="card border-primary shadow-sm mb-4">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-user me-2"></i>Payment Information
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6 offset-md-3">
                                <div class="text-center p-3 bg-primary bg-opacity-10 rounded border border-primary">
                                    <small class="text-muted d-block mb-1">Total Amount Due</small>
                                    <h3 class="text-primary mb-0 fw-bold">₦{{ total_patient_pays|floatformat:2 }}</h3>
                                    <small class="text-muted mt-1 d-block">Full payment required</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}

                <!-- Dispense Options -->
                <div class="card">
                    <div class="card-header bg-warning text-dark">
                        <h5 class="mb-0">Choose Dispensing Method</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <!-- Quick Dispense Option -->
                            <div class="col-md-6 mb-3">
                                <div class="card border-warning h-100">
                                    <div class="card-body text-center">
                                        <i class="fas fa-bolt fa-2x text-warning mb-2"></i>
                                        <h5 class="text-warning">Quick Dispense</h5>
                                        <p class="small text-muted mb-3">
                                            Select medications individually for immediate dispensing. 
                                            Best for single items or urgent requests.
                                        </p>
                                        <a href="{% url 'pharmacy:dispense_prescription_original' prescription.id %}" 
                                           class="btn btn-warning btn-lg w-100">
                                            <i class="fas fa-prescription-bottle-alt"></i> 
                                            Quick Dispense
                                        </a>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Cart Dispense Option -->
                            <div class="col-md-6 mb-3">
                                <div class="card border-success h-100">
                                    <div class="card-body text-center">
                                        <i class="fas fa-shopping-cart fa-2x text-success mb-2"></i>
                                        <h5 class="text-success">Dispense via Cart</h5>
                                        <p class="small text-muted mb-3">
                                            Creates a cart with ALL prescription items for batch processing. 
                                            Best for full prescriptions or multiple items.
                                        </p>
                                        <a href="{% url 'pharmacy:create_cart_from_prescription' prescription.id %}" 
                                           class="btn btn-success btn-lg w-100">
                                            <i class="fas fa-shopping-cart"></i> 
                                            Dispense via Cart
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="text-center mt-4">
                            <a href="{% url 'pharmacy:prescription_detail' prescription.id %}" class="btn btn-secondary">
                                <i class="fas fa-arrow-left"></i> Back to Prescription
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

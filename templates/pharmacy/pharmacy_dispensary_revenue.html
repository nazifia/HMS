{% extends 'base.html' %}
{% load static %}
{% load custom_filters %}

{% block title %}Pharmacy Dispensary Revenue{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                <h4 class="mb-0">Pharmacy Dispensary Revenue</h4>
                <button class="btn btn-light" onclick="window.print()">
                    <i class="fas fa-print"></i> Print Report
                </button>
            </div>
            <div class="card-body">
                <!-- Filter Form -->
                <form method="GET" class="mb-4">
                    <div class="row">
                        <div class="col-md-4">
                            <label for="start_date" class="form-label">Start Date</label>
                            <input type="date" class="form-control" id="start_date" name="start_date" value="{{ start_date|date:'Y-m-d' }}">
                        </div>
                        <div class="col-md-4">
                            <label for="end_date" class="form-label">End Date</label>
                            <input type="date" class="form-control" id="end_date" name="end_date" value="{{ end_date|date:'Y-m-d' }}">
                        </div>
                        <div class="col-md-4">
                            <label for="search" class="form-label">Search Dispensary</label>
                            <input type="text" class="form-control" id="search" name="search" value="{{ search_query }}" placeholder="Search dispensary name...">
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-md-12">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-filter"></i> Filter
                            </button>
                            <button type="button" class="btn btn-secondary" onclick="resetFilters()">
                                <i class="fas fa-redo"></i> Reset
                            </button>
                        </div>
                    </div>
                </form>

                <!-- Overall Statistics -->
                <div class="row mb-4">
                    <div class="col-md-3">
                        <div class="card bg-primary text-white">
                            <div class="card-body">
                                <h5 class="card-title">Total Revenue</h5>
                                <h3>{{ total_pharmacy_revenue|default:0|currency }}</h3>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-success text-white">
                            <div class="card-body">
                                <h5 class="card-title">Total Transactions</h5>
                                <h3>{{ performance_metrics.total_transactions|default:"0" }}</h3>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-info text-white">
                            <div class="card-body">
                                <h5 class="card-title">Medications Dispensed</h5>
                                <h3>{{ performance_metrics.total_medications_dispensed|default:"0" }}</h3>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-warning text-dark">
                            <div class="card-body">
                                <h5 class="card-title">Active Dispensaries</h5>
                                <h3>{{ performance_metrics.dispensaries_count|default:"0" }}</h3>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Performance Metrics -->
                <div class="row mb-4">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header bg-secondary text-white">
                                <h5 class="mb-0">Performance Metrics</h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-6">
                                        <p><strong>Average Transaction Value:</strong></p>
                                        <h4>{{ performance_metrics.average_transaction_value|default:0|currency }}</h4>
                                    </div>
                                    <div class="col-6">
                                        <p><strong>Daily Average Revenue:</strong></p>
                                        <h4>{{ performance_metrics.daily_average|default:0|currency }}</h4>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header bg-secondary text-white">
                                <h5 class="mb-0">Date Range</h5>
                            </div>
                            <div class="card-body">
                                <p><strong>From:</strong> {{ start_date|date:"F j, Y" }}</p>
                                <p><strong>To:</strong> {{ end_date|date:"F j, Y" }}</p>
                                <p><strong>Days:</strong> {{ performance_metrics.days_in_period }}</p>
                            </div>
                        </div>
                    </div>
                </div>



                <!-- Dispensary Revenue Table -->
                <div class="card mb-4">
                    <div class="card-header bg-light d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Dispensary Revenue Breakdown</h5>
                        <span class="badge bg-primary">
                            {{ dispensary_data|length }} Dispensaries
                        </span>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped table-hover" id="dispensaryRevenueTable">
                                <thead class="table-dark">
                                    <tr>
                                        <th>Dispensary</th>
                                        <th>Revenue</th>
                                        <th>Transactions</th>
                                        <th>Medications Dispensed</th>
                                        <th>Prescriptions</th>
                                        <th>Avg. Transaction</th>
                                        <th>Revenue Share</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for dispensary in dispensary_data %}
                                    <tr>
                                        <td>
                                            {% if dispensary.dispensary %}
                                                <strong>{{ dispensary.dispensary.name }}</strong>
                                                {% if dispensary.dispensary.location %}
                                                    <br><small class="text-muted">{{ dispensary.dispensary.location }}</small>
                                                {% endif %}
                                            {% else %}
                                                <span class="text-muted">Unassigned</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <strong>{{ dispensary.revenue|currency }}</strong>
                                        </td>
                                        <td>{{ dispensary.transactions }}</td>
                                        <td>{{ dispensary.quantity_dispensed }}</td>
                                        <td>{{ dispensary.prescriptions_count }}</td>
                                        <td>
                                            {% if dispensary.transactions > 0 %}
                                                {{ dispensary.revenue|div:dispensary.transactions|currency }}
                                            {% else %}
                                                - 
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if total_pharmacy_revenue > 0 %}
                                                <div class="progress" style="height: 20px;">
                                                    <div class="progress-bar bg-success" 
                                                         role="progressbar" 
                                                         style="width: {{ dispensary.revenue|div:total_pharmacy_revenue|mul:100|floatformat:1 }}%" 
                                                         aria-valuenow="{{ dispensary.revenue|div:total_pharmacy_revenue|mul:100|floatformat:1 }}" 
                                                         aria-valuemin="0" 
                                                         aria-valuemax="100">
                                                        {{ dispensary.revenue|div:total_pharmacy_revenue|mul:100|floatformat:1 }}%
                                                    </div>
                                                </div>
                                            {% else %}
                                                - 
                                            {% endif %}
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                                <tfoot class="table-dark">
                                    <tr>
                                        <th>Total</th>
                                        <th>{{ total_pharmacy_revenue|currency }}</th>
                                        <th>{{ performance_metrics.total_transactions }}</th>
                                        <th>{{ performance_metrics.total_medications_dispensed }}</th>
                                        <th>{{ dispensary_data|map_attribute:'prescriptions_count'|sum_list }}</th>
                                        <th>
                                            {% if performance_metrics.total_transactions > 0 %}
                                                {{ performance_metrics.average_transaction_value|currency }}
                                            {% else %}
                                                - 
                                            {% endif %}
                                        </th>
                                        <th>100%</th>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    </div>
                </div>


            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<!-- DataTables -->
<script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.11.5/js/dataTables.bootstrap5.min.js"></script>

<script>
// Reset filters function
function resetFilters() {
    window.location.href = window.location.pathname;
}

// Initialize DataTable
$(document).ready(function() {
    $('#dispensaryRevenueTable').DataTable({
        order: [[1, 'desc']], // Sort by revenue column by default
        pageLength: 10,
        responsive: true,
        dom: '<"row"<"col-md-6"l><"col-md-6"f>>rt<"row"<"col-md-6"i><"col-md-6"p>>',
        language: {
            search: "Search dispensaries:",
            lengthMenu: "Show _MENU_ dispensaries per page"
        }
    });
});




</script>
{% endblock %}

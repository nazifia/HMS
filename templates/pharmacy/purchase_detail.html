{% extends 'base.html' %}
{% load form_tags %}
{% load widget_tweaks %}

{% block title %}Purchase Details - Hospital Management System{% endblock %}

{% block extra_css %}
<style>
    .status-badge {
        font-size: 0.9rem;
        padding: 0.5rem 1rem;
    }
    .approval-card {
        border-left: 4px solid #007bff;
    }
    .payment-card {
        border-left: 4px solid #28a745;
    }
    .action-buttons .btn {
        margin-right: 0.5rem;
        margin-bottom: 0.5rem;
    }
    .icon-circle {
        height: 2rem;
        width: 2rem;
        border-radius: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header with Status -->
    <div class="d-sm-flex align-items-center justify-content-between mb-4">
        <h1 class="h3 mb-0 text-gray-800">{{ title }}</h1>
        <div class="d-flex align-items-center">
            <span class="badge status-badge
                {% if purchase.approval_status == 'approved' %}badge-success
                {% elif purchase.approval_status == 'pending' %}badge-warning
                {% elif purchase.approval_status == 'rejected' %}badge-danger
                {% else %}badge-secondary{% endif %}">
                {{ purchase.get_approval_status_display }}
            </span>
            <span class="badge status-badge ml-2
                {% if purchase.payment_status == 'paid' %}badge-success
                {% elif purchase.payment_status == 'partial' %}badge-warning
                {% else %}badge-secondary{% endif %}">
                Payment: {{ purchase.get_payment_status_display }}
            </span>
        </div>
    </div>

    <div class="row">
        <!-- Purchase Information -->
        <div class="col-lg-8">
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">Purchase Information</h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="row mb-3">
                                <div class="col-md-4 text-muted">Purchase ID:</div>
                                <div class="col-md-8"><strong>{{ purchase.id }}</strong></div>
                            </div>
                            <div class="row mb-3">
                                <div class="col-md-4 text-muted">Invoice Number:</div>
                                <div class="col-md-8">{{ purchase.invoice_number }}</div>
                            </div>
                            <div class="row mb-3">
                                <div class="col-md-4 text-muted">Purchase Date:</div>
                                <div class="col-md-8">{{ purchase.purchase_date|date:"F d, Y" }}</div>
                            </div>
                            <div class="row mb-3">
                                <div class="col-md-4 text-muted">Supplier:</div>
                                <div class="col-md-8">{{ purchase.supplier.name }}</div>
                            </div>
                            <div class="row mb-3">
                                <div class="col-md-4 text-muted">Dispensary:</div>
                                <div class="col-md-8">{{ purchase.dispensary.name|default:"Not Assigned" }}</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="row mb-3">
                                <div class="col-md-4 text-muted">Total Amount:</div>
                                <div class="col-md-8"><strong>â‚¦{{ purchase.total_amount|floatformat:2 }}</strong></div>
                            </div>
                            <div class="row mb-3">
                                <div class="col-md-4 text-muted">Items Count:</div>
                                <div class="col-md-8">{{ purchase.get_items_count }} items</div>
                            </div>
                            <div class="row mb-3">
                                <div class="col-md-4 text-muted">Total Quantity:</div>
                                <div class="col-md-8">{{ purchase.get_total_quantity }} units</div>
                            </div>
                            <div class="row mb-3">
                                <div class="col-md-4 text-muted">Created By:</div>
                                <div class="col-md-8">{{ purchase.created_by.get_full_name|default:"N/A" }}</div>
                            </div>
                            <div class="row mb-3">
                                <div class="col-md-4 text-muted">Created At:</div>
                                <div class="col-md-8">{{ purchase.created_at|date:"F d, Y g:i A" }}</div>
                            </div>
                        </div>
                    </div>

                    {% if purchase.notes %}
                    <div class="row mt-3">
                        <div class="col-12">
                            <h6>Notes:</h6>
                            <p class="text-muted">{{ purchase.notes }}</p>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">Actions</h6>
                </div>
                <div class="card-body">

                    <div class="action-buttons">

                        {% if purchase.approval_status == 'draft' and purchase.items.exists %}
                            <button type="button" class="btn btn-warning" data-bs-toggle="modal" data-bs-target="#submitApprovalModal" id="submitApprovalBtn">
                                <i class="fas fa-paper-plane"></i> Submit for Approval
                            </button>

                        {% else %}

                        {% endif %}

                        {% if purchase.approval_status == 'pending' and can_approve %}
                            <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#approveModal" id="approveBtn">
                                <i class="fas fa-check"></i> Approve Purchase
                            </button>
                            <button type="button" class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#rejectModal" id="rejectBtn">
                                <i class="fas fa-times"></i> Reject Purchase
                            </button>

                        {% endif %}


                        {% if purchase.can_be_paid and can_pay %}
                            <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#paymentModal" id="processPaymentBtn">
                                <i class="fas fa-credit-card"></i> Process Payment
                            </button>

                        {% else %}

                        {% endif %}

                        {% if purchase.approval_status == 'draft' %}
                            <button type="button" class="btn btn-info" data-bs-toggle="modal" data-bs-target="#addItemModal">
                                <i class="fas fa-plus"></i> Add Item
                            </button>
                        {% endif %}

                        <a href="{% url 'pharmacy:manage_purchases' %}" class="btn btn-secondary">
                            <i class="fas fa-arrow-left"></i> Back to Purchases
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sidebar with Approval & Payment History -->
        <div class="col-lg-4">
            <!-- Approval History -->
            <div class="card approval-card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">Approval History</h6>
                </div>
                <div class="card-body">
                    {% if approvals %}
                        {% for approval in approvals %}
                        <div class="d-flex align-items-center mb-3">
                            <div class="mr-3">
                                <div class="icon-circle
                                    {% if approval.status == 'approved' %}bg-success
                                    {% elif approval.status == 'rejected' %}bg-danger
                                    {% else %}bg-warning{% endif %}">
                                    <i class="fas
                                        {% if approval.status == 'approved' %}fa-check
                                        {% elif approval.status == 'rejected' %}fa-times
                                        {% else %}fa-clock{% endif %} text-white"></i>
                                </div>
                            </div>
                            <div class="flex-grow-1">
                                <div class="small text-gray-500">{{ approval.created_at|date:"M d, Y g:i A" }}</div>
                                <div class="font-weight-bold">{{ approval.get_status_display }}</div>
                                <div class="small">by {{ approval.approver.get_full_name }}</div>
                                {% if approval.comments %}
                                <div class="small text-muted mt-1">{{ approval.comments }}</div>
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="text-center text-muted">
                            <i class="fas fa-clipboard-list fa-2x mb-2"></i>
                            <p>No approval history yet</p>
                        </div>
                    {% endif %}
                </div>
            </div>

            <!-- Payment History -->
            <div class="card payment-card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-success">Payment History</h6>
                </div>
                <div class="card-body">
                    {% if payments %}
                        {% for payment in payments %}
                        <div class="d-flex align-items-center mb-3">
                            <div class="mr-3">
                                <div class="icon-circle bg-success">
                                    <i class="fas fa-dollar-sign text-white"></i>
                                </div>
                            </div>
                            <div class="flex-grow-1">
                                <div class="small text-gray-500">{{ payment.payment_date|date:"M d, Y" }}</div>
                                <div class="font-weight-bold">â‚¦{{ payment.amount|floatformat:2 }}</div>
                                <div class="small">{{ payment.get_payment_method_display }}</div>
                                <div class="small">by {{ payment.received_by.get_full_name }}</div>
                                {% if payment.transaction_id %}
                                <div class="small text-muted">Ref: {{ payment.transaction_id }}</div>
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="text-center text-muted">
                            <i class="fas fa-credit-card fa-2x mb-2"></i>
                            <p>No payments recorded yet</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
                        <div class="row mb-3">
                            <div class="col-md-4 text-muted">Total Amount:</div>
                            <div class="col-md-8">â‚¦{{ purchase.total_amount }}</div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-4 text-muted">Payment Status:</div>
                            <div class="col-md-8">
                                {% if purchase.payment_status == 'paid' %}
                                    <span class="badge bg-success">Paid</span>
                                {% elif purchase.payment_status == 'partial' %}
                                    <span class="badge bg-warning">Partial</span>
                                {% elif purchase.payment_status == 'pending' %}
                                    <span class="badge bg-danger">Pending</span>
                                {% endif %}
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-4 text-muted">Created By:</div>
                            <div class="col-md-8">{{ purchase.created_by.get_full_name }}</div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-4 text-muted">Notes:</div>
                            <div class="col-md-8">{{ purchase.notes|default:"No notes provided." }}</div>
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <h5 class="border-bottom pb-2 mb-3">Supplier Information</h5>
                        <div class="row mb-3">
                            <div class="col-md-4 text-muted">Supplier:</div>
                            <div class="col-md-8">{{ purchase.supplier.name }}</div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-4 text-muted">Contact Person:</div>
                            <div class="col-md-8">{{ purchase.supplier.contact_person }}</div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-4 text-muted">Email:</div>
                            <div class="col-md-8">{{ purchase.supplier.email }}</div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-4 text-muted">Phone:</div>
                            <div class="col-md-8">{{ purchase.supplier.phone_number }}</div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-4 text-muted">Address:</div>
                            <div class="col-md-8">
                                {{ purchase.supplier.address }}<br>
                                {{ purchase.supplier.city }}, {{ purchase.supplier.state }} {{ purchase.supplier.postal_code }}<br>
                                {{ purchase.supplier.country }}
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Purchase Items -->
                <div class="row mt-4">
                    <div class="col-md-12">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5 class="border-bottom pb-2 mb-0">Purchase Items</h5>
                            {% if purchase.approval_status == 'draft' %}
                                <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addItemModal" id="addItemBtn">
                                    <i class="fas fa-plus"></i> Add Item
                                </button>
                            {% else %}
                                <small class="text-muted">Items can only be added to draft purchases (Current: {{ purchase.approval_status }})</small>
                            {% endif %}
                        </div>
                        
                        {% if purchase_items %}
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>Medication</th>
                                            <th>Quantity</th>
                                            <th>Unit Price</th>
                                            <th>Total Price</th>
                                            <th>Batch Number</th>
                                            <th>Expiry Date</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for item in purchase_items %}
                                            <tr>
                                                <td>
                                                    <a href="{% url 'pharmacy:medication_detail' item.medication.id %}">
                                                        {{ item.medication.name }}
                                                    </a>
                                                    <div class="small text-muted">{{ item.medication.strength }} - {{ item.medication.dosage_form }}</div>
                                                </td>
                                                <td>{{ item.quantity }}</td>
                                                <td>â‚¦{{ item.unit_price }}</td>
                                                <td>â‚¦{{ item.total_price }}</td>
                                                <td>{{ item.batch_number }}</td>
                                                <td>
                                                    {{ item.expiry_date|date:"M d, Y" }}
                                                </td>
                                                <td>
                                                    <a href="{% url 'pharmacy:delete_purchase_item' item.id %}" class="btn btn-sm btn-danger">
                                                        <i class="fas fa-trash"></i>
                                                    </a>
                                                </td>
                                            </tr>
                                        {% endfor %}
                                    </tbody>
                                    <tfoot>
                                        <tr class="table-primary">
                                            <th colspan="3" class="text-end">Total:</th>
                                            <th>â‚¦{{ purchase.total_amount }}</th>
                                            <th colspan="3"></th>
                                        </tr>
                                    </tfoot>
                                </table>
                            </div>
                        {% else %}
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle me-2"></i>
                                No items have been added to this purchase yet.
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            <div class="card-footer">
                <a href="{% url 'pharmacy:manage_purchases' %}" class="btn btn-secondary">
                    <i class="fas fa-arrow-left"></i> Back to Purchases
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Add Item Modal -->
<div class="modal fade" id="addItemModal" tabindex="-1" aria-labelledby="addItemModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="addItemModalLabel">Add Purchase Item</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="post" action="{% url 'pharmacy:add_purchase_item' purchase.id %}">
                {% csrf_token %}
                <div class="modal-body">
                    {% if item_form.non_field_errors %}
                        <div class="alert alert-danger">
                            {{ item_form.non_field_errors }}
                        </div>
                    {% endif %}
                    <div class="row">
                        <div class="col-md-12 mb-3">
                            <label for="{{ item_form.medication.id_for_label }}" class="form-label">Medication</label>
                            {{ item_form.medication|add_class:"form-select select2" }}
                            {% if item_form.medication.errors %}
                                <div class="text-danger">
                                    {{ item_form.medication.errors }}
                                </div>
                            {% endif %}
                        </div>
                        
                        <div class="col-md-3 mb-3">
                            <label for="{{ item_form.quantity.id_for_label }}" class="form-label">Quantity</label>
                            {{ item_form.quantity|add_class:"form-control" }}
                            {% if item_form.quantity.errors %}
                                <div class="text-danger">
                                    {{ item_form.quantity.errors }}
                                </div>
                            {% endif %}
                        </div>

                        <div class="col-md-3 mb-3">
                            <label for="{{ item_form.unit_price.id_for_label }}" class="form-label">Unit Price (â‚¦)</label>
                            {{ item_form.unit_price|add_class:"form-control" }}
                            {% if item_form.unit_price.errors %}
                                <div class="text-danger">
                                    {{ item_form.unit_price.errors }}
                                </div>
                            {% endif %}
                        </div>

                        <div class="col-md-3 mb-3">
                            <label class="form-label">Total Price (â‚¦)</label>
                            <div class="form-control bg-light" id="totalPriceDisplay">0.00</div>
                        </div>

                        <div class="col-md-3 mb-3">
                            <label for="{{ item_form.batch_number.id_for_label }}" class="form-label">Batch Number</label>
                            {{ item_form.batch_number|add_class:"form-control" }}
                            {% if item_form.batch_number.errors %}
                                <div class="text-danger">
                                    {{ item_form.batch_number.errors }}
                                </div>
                            {% endif %}
                        </div>

                        
                        <div class="col-md-12 mb-3">
                            <label for="{{ item_form.expiry_date.id_for_label }}" class="form-label">Expiry Date</label>
                            {{ item_form.expiry_date|add_class:"form-control" }}
                            {% if item_form.expiry_date.errors %}
                                <div class="text-danger">
                                    {{ item_form.expiry_date.errors }}
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add Item</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Submit for Approval Modal -->
<div class="modal fade" id="submitApprovalModal" tabindex="-1" aria-labelledby="submitApprovalModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="submitApprovalModalLabel">
                    <i class="fas fa-paper-plane me-2"></i>Submit Purchase for Approval
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="post" action="{% url 'pharmacy:submit_purchase_for_approval' purchase.id %}">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        Are you sure you want to submit Purchase #<strong>{{ purchase.invoice_number }}</strong> for approval?
                    </div>

                    <div class="mb-3">
                        <label for="approval_notes" class="form-label">
                            <i class="fas fa-sticky-note me-1"></i>Approval Notes (Optional)
                        </label>
                        <textarea class="form-control" id="approval_notes" name="approval_notes" rows="3"
                                  placeholder="Add any notes for the approval process..."></textarea>
                    </div>

                    <div class="mb-3">
                        <label for="priority_level" class="form-label">
                            <i class="fas fa-flag me-1"></i>Priority Level
                        </label>
                        <select class="form-select" id="priority_level" name="priority_level">
                            <option value="normal">Normal</option>
                            <option value="urgent">Urgent</option>
                            <option value="critical">Critical</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label for="expected_delivery_date" class="form-label">
                            <i class="fas fa-calendar me-1"></i>Expected Delivery Date
                        </label>
                        <input type="date" class="form-control" id="expected_delivery_date" name="expected_delivery_date"
                               required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-1"></i>Cancel
                    </button>
                    <button type="submit" class="btn btn-warning">
                        <i class="fas fa-paper-plane me-1"></i>Submit for Approval
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Approve Purchase Modal -->
<div class="modal fade" id="approveModal" tabindex="-1" aria-labelledby="approveModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title" id="approveModalLabel">
                    <i class="fas fa-check-circle me-2"></i>Approve Purchase
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="post" action="{% url 'pharmacy:approve_purchase' purchase.id %}">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        Are you sure you want to approve Purchase #<strong>{{ purchase.invoice_number }}</strong>?
                    </div>

                    <div class="mb-3">
                        <label for="approve_notes" class="form-label">
                            <i class="fas fa-sticky-note me-1"></i>Approval Notes (Optional)
                        </label>
                        <textarea class="form-control" id="approve_notes" name="approval_notes" rows="3"
                                  placeholder="Add any notes for this approval..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-1"></i>Cancel
                    </button>
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-check-circle me-1"></i>Approve Purchase
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Reject Purchase Modal -->
<div class="modal fade" id="rejectModal" tabindex="-1" aria-labelledby="rejectModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="rejectModalLabel">
                    <i class="fas fa-times-circle me-2"></i>Reject Purchase
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="post" action="{% url 'pharmacy:reject_purchase' purchase.id %}">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Are you sure you want to reject Purchase #<strong>{{ purchase.invoice_number }}</strong>?
                    </div>

                    <div class="mb-3">
                        <label for="reject_reason" class="form-label">
                            <i class="fas fa-comment me-1"></i>Rejection Reason (Required) <span class="text-danger">*</span>
                        </label>
                        <textarea class="form-control" id="reject_reason" name="rejection_reason" rows="4"
                                  placeholder="Enter the reason for rejecting this purchase..." required></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-1"></i>Cancel
                    </button>
                    <button type="submit" class="btn btn-danger">
                        <i class="fas fa-times-circle me-1"></i>Reject Purchase
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Payment Processing Modal -->
<div class="modal fade" id="paymentModal" tabindex="-1" aria-labelledby="paymentModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="paymentModalLabel">Process Payment</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="post">
                {% csrf_token %}
                <input type="hidden" name="action" value="process_payment">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="payment_amount" class="form-label">Payment Amount <span class="text-danger">*</span></label>
                                <div class="input-group">
                                    <span class="input-group-text">â‚¦</span>
                                    <input type="number" class="form-control" id="payment_amount" name="payment_amount"
                                           value="{{ purchase.total_amount }}" step="0.01" min="0.01" required>
                                </div>
                                <div class="form-text">Total Amount: â‚¦{{ purchase.total_amount|floatformat:2 }}</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="payment_method" class="form-label">Payment Method <span class="text-danger">*</span></label>
                                <select class="form-select" id="payment_method" name="payment_method" required>
                                    <option value="bank_transfer">Bank Transfer</option>
                                    <option value="cash">Cash</option>
                                    <option value="cheque">Cheque</option>
                                    <option value="credit_card">Credit Card</option>
                                    <option value="mobile_money">Mobile Money</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="payment_reference" class="form-label">Payment Reference/Transaction ID</label>
                        <input type="text" class="form-control" id="payment_reference" name="payment_reference"
                               placeholder="Enter transaction reference or ID">
                    </div>
                    <div class="mb-3">
                        <label for="payment_notes" class="form-label">Payment Notes</label>
                        <textarea class="form-control" id="payment_notes" name="payment_notes" rows="3"
                                  placeholder="Enter any additional payment notes..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Process Payment</button>
                </div>
            </form>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize modals and form functionality
        const addItemModal = document.getElementById('addItemModal');

        // Initialize select2 for medication dropdown
        if (typeof $.fn.select2 !== 'undefined') {
            $('.select2').select2({
                theme: 'bootstrap-5',
                width: '100%',
                dropdownParent: $('#addItemModal')
            });
        }







        // Submit for approval modal functionality
        const submitApprovalModal = document.getElementById('submitApprovalModal');
        const submitApprovalBtn = document.getElementById('submitApprovalBtn');







        // Approve and reject modals
        const approveModal = document.getElementById('approveModal');
        const rejectModal = document.getElementById('rejectModal');



        // Payment modal functionality
        const paymentModal = document.getElementById('paymentModal');


        const processPaymentBtn = document.getElementById('processPaymentBtn');



        // Calculate total price when quantity or unit price changes
        $('#{{ item_form.quantity.id_for_label }}, #{{ item_form.unit_price.id_for_label }}').on('input', function() {
            var quantity = parseFloat($('#{{ item_form.quantity.id_for_label }}').val()) || 0;
            var unitPrice = parseFloat($('#{{ item_form.unit_price.id_for_label }}').val()) || 0;
            var totalPrice = quantity * unitPrice;

            // Display total price in the form
            $('#totalPriceDisplay').text(totalPrice.toFixed(2));
            console.log('Total Price: â‚¦' + totalPrice.toFixed(2));
        });

        // Debug form submission
        $('#addItemModal form').on('submit', function(e) {
            console.log('Form submitted');
            console.log('Form data:', $(this).serialize());

            // Check if required fields are filled
            var medication = $('#{{ item_form.medication.id_for_label }}').val();
            var quantity = $('#{{ item_form.quantity.id_for_label }}').val();
            var unitPrice = $('#{{ item_form.unit_price.id_for_label }}').val();
            var expiryDate = $('#{{ item_form.expiry_date.id_for_label }}').val();

            console.log('Medication:', medication);
            console.log('Quantity:', quantity);
            console.log('Unit Price:', unitPrice);
            console.log('Expiry Date:', expiryDate);

            if (!medication || !quantity || !unitPrice || !expiryDate) {
                console.log('Missing required fields');
                alert('Please fill in all required fields');
                e.preventDefault();
                return false;
            }
        });
    });
</script>
{% endblock %}

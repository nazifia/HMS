{% extends 'enhanced_base.html' %}
{% load core_tags %}

{% block title %}Permission Management{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Page Header -->
    <div class="page-header">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h1 class="page-title">
                    <i class="fas fa-shield-alt me-2"></i>Permission Management
                </h1>
                <p class="text-muted mb-0">Manage user roles and system permissions</p>
            </div>
            <div class="d-flex gap-2">
                <button class="btn btn-primary" onclick="showAddRoleModal()">
                    <i class="fas fa-plus me-2"></i>Add Role
                </button>
                <a href="{% url 'core:admin_dashboard' %}" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left me-2"></i>Back to Dashboard
                </a>
            </div>
        </div>
    </div>

    <!-- Permission Overview Cards -->
    <div class="row mb-4">
        <div class="col-md-4">
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="icon-box bg-primary bg-gradient text-white rounded-3 p-3 me-3">
                            <i class="fas fa-user-shield"></i>
                        </div>
                        <div>
                            <h6 class="text-muted mb-1">Total Roles</h6>
                            <h4 class="mb-0">{{ roles|length }}</h4>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="icon-box bg-success bg-gradient text-white rounded-3 p-3 me-3">
                            <i class="fas fa-list-check"></i>
                        </div>
                        <div>
                            <h6 class="text-muted mb-1">System Permissions</h6>
                            <h4 class="mb-0">{{ total_permissions }}</h4>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="icon-box bg-info bg-gradient text-white rounded-3 p-3 me-3">
                            <i class="fas fa-users-cog"></i>
                        </div>
                        <div>
                            <h6 class="text-muted mb-1">Active Users</h6>
                            <h4 class="mb-0">{{ roles|aggregate:Sum:'user_count' }}</h4>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Roles Management -->
    <div class="row">
        <div class="col-lg-8 mb-4">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white border-0 py-3">
                    <h5 class="mb-0">
                        <i class="fas fa-user-tag me-2"></i>System Roles
                    </h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead class="table-light">
                                <tr>
                                    <th>Role Name</th>
                                    <th>Description</th>
                                    <th>Users</th>
                                    <th>Permissions</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for role in roles %}
                                <tr>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <div class="role-icon me-2">
                                                <i class="fas {{ role.name|role_icon }} text-primary"></i>
                                            </div>
                                            <div>
                                                <div class="fw-semibold">{{ role.name|title }}</div>
                                                {% if role.parent %}
                                                    <small class="text-muted">Child of: {{ role.parent.name }}</small>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <span class="text-muted">
                                            {{ role.description|truncate_chars:50|default:"No description" }}
                                        </span>
                                    </td>
                                    <td>
                                        <span class="badge bg-primary">{{ role.user_count }}</span>
                                        <small class="text-muted">users</small>
                                    </td>
                                    <td>
                                        <span class="badge bg-light text-dark">{{ role.permissions.count }}</span>
                                        <small class="text-muted">permissions</small>
                                    </td>
                                    <td>
                                        <div class="btn-group btn-group-sm" role="group">
                                            <button class="btn btn-outline-primary" onclick="viewRolePermissions({{ role.id }})">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                            <button class="btn btn-outline-success" onclick="editRole({{ role.id }})">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            <button class="btn btn-outline-danger" onclick="deleteRole({{ role.id }})">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="5" class="text-center py-4">
                                        <i class="fas fa-user-tag fa-2x text-muted mb-3 d-block"></i>
                                        No roles found. Create your first role to get started.
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Permission Matrix -->
        <div class="col-lg-4 mb-4">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white border-0 py-3">
                    <h5 class="mb-0">
                        <i class="fas fa-th me-2"></i>Permission Matrix
                    </h5>
                </div>
                <div class="card-body">
                    <div class="permission-matrix">
                        <table class="table table-sm">
                            <thead class="table-light">
                                <tr>
                                    <th>Role</th>
                                    <th class="text-center">Users</th>
                                    <th class="text-center">Patients</th>
                                    <th class="text-center">Billing</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for role in roles %}
                                <tr>
                                    <td class="user-role-cell">{{ role.name|title }}</td>
                                    <td class="text-center">
                                        {% if 'create_user' in role.get_all_permissions|get_all_permission_names %}
                                            <i class="fas fa-check-circle text-success"></i>
                                        {% else %}
                                            <i class="fas fa-times-circle text-danger"></i>
                                        {% endif %}
                                    </td>
                                    <td class="text-center">
                                        {% if 'view_patients' in role.get_all_permissions|get_all_permission_names %}
                                            <i class="fas fa-check-circle text-success"></i>
                                        {% else %}
                                            <i class="fas fa-times-circle text-danger"></i>
                                        {% endif %}
                                    </td>
                                    <td class="text-center">
                                        {% if 'create_invoice' in role.get_all_permissions|get_all_permission_names %}
                                            <i class="fas fa-check-circle text-success"></i>
                                        {% else %}
                                            <i class="fas fa-times-circle text-danger"></i>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    <div class="mt-3">
                        <small class="text-muted">
                            <i class="fas fa-info-circle me-1"></i>
                            This matrix shows key permissions for each role. Click "View" to see all permissions.
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Role-Permission Assignment -->
    <div class="row">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white border-0 py-3 d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-user-cog me-2"></i>Role-Permission Assignment
                    </h5>
                    <button class="btn btn-sm btn-outline-info" onclick="refreshPermissions()">
                        <i class="fas fa-sync-alt me-2"></i>Refresh Permissions
                    </button>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4">
                            <label class="form-label">Select Role</label>
                            <select class="form-select mb-3" id="role-select" onchange="loadRolePermissions()">
                                <option value="">Choose a role...</option>
                                {% for role in roles %}
                                    <option value="{{ role.id }}">{{ role.name|title }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-8">
                            <label class="form-label">Available Permissions</label>
                            <div id="permissions-container" class="permission-grid">
                                <p class="text-muted">Select a role to view and edit permissions.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Role Details Modal -->
<div class="modal fade" id="roleDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Role Permissions</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="role-details-content">
                <!-- Content loaded dynamically -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="saveRolePermissions()">Save Changes</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.7.0/chart.min.css">
<style>
.permission-grid {
    max-height: 400px;
    overflow-y: auto;
    padding: 1rem;
    border: 1px solid #e9ecef;
    border-radius: 0.375rem;
    background: #f8f9fa;
}

.permission-group {
    margin-bottom: 1.5rem;
}

.permission-group h6 {
    font-weight: 600;
    color: #495057;
    margin-bottom: 0.75rem;
    padding-bottom: 0.5rem;
    border-bottom: 1px solid #e9ecef;
}

.permission-item {
    display: flex;
    align-items: center;
    padding: 0.5rem 0;
}

.permission-checkbox {
    margin-right: 0.75rem;
}

.permission-label {
    flex-grow: 1;
    cursor: pointer;
}

.permission-description {
    font-size: 0.875rem;
    color: #6c757d;
}

.role-icon {
    width: 32px;
    text-align: center;
}

.permission-matrix .table th,
.permission-matrix .table td {
    padding: 0.5rem;
    vertical-align: middle;
}

.user-role-cell {
    font-weight: 600;
    color: #495057;
}

.permission-check,
.permission-cross {
    font-size: 1rem;
}

.card-body .table-responsive {
    margin: 0;
}

.btn-group .btn {
    padding: 0.375rem 0.5rem;
}

.animate-pulse {
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0% { opacity: 1; }
    50% { opacity: 0.5; }
    100% { opacity: 1; }
}
</style>
{% endblock %}

{% block extra_js %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.7.0/chart.min.js"></script>
<script>
// Permission management JavaScript
const permissionsData = {
    user_management: {
        'create_user': 'Can create new users',
        'edit_user': 'Can edit existing users',
        'delete_user': 'Can delete users',
        'view_users': 'Can view user list and details',
        'manage_roles': 'Can assign and manage user roles',
        'reset_password': 'Can reset user passwords',
    },
    patient_management: {
        'create_patient': 'Can register new patients',
        'edit_patient': 'Can edit patient information',
        'delete_patient': 'Can delete patient records',
        'view_patients': 'Can view patient list and details',
        'access_sensitive_data': 'Can access sensitive patient data',
        'manage_patient_admission': 'Can manage patient admissions',
        'manage_patient_discharge': 'Can manage patient discharges',
    },
    billing: {
        'create_invoice': 'Can create invoices',
        'edit_invoice': 'Can edit existing invoices',
        'delete_invoice': 'Can delete invoices',
        'view_invoices': 'Can view invoice list and details',
        'process_payments': 'Can process payments and receipts',
        'manage_wallet': 'Can manage patient wallet operations',
        'view_financial_reports': 'Can view financial reports',
    },
    pharmacy: {
        'manage_inventory': 'Can manage pharmacy inventory',
        'dispense_medication': 'Can dispense medications',
        'create_prescription': 'Can create prescription orders',
        'edit_prescription': 'Can edit existing prescriptions',
        'view_prescriptions': 'Can view prescription history',
        'manage_dispensary': 'Can manage dispensary operations',
        'transfer_medication': 'Can transfer medication between dispensaries',
    }
};

function viewRolePermissions(roleId) {
    // Load role details via AJAX and show modal
    console.log('Loading role permissions for role:', roleId);
    
    // Sample implementation - replace with actual AJAX call
    fetch(`/core/api/admin/role-permissions/${roleId}/`)
        .then(response => response.json())
        .then(data => {
            displayRolePermissions(data);
            new bootstrap.Modal(document.getElementById('roleDetailsModal')).show();
        })
        .catch(error => {
            console.error('Error loading role permissions:', error);
            alert('Failed to load role permissions');
        });
}

function displayRolePermissions(roleData) {
    const container = document.getElementById('role-details-content');
    let html = `
        <div class="mb-3">
            <h5>${roleData.name}</h5>
            <p class="text-muted">${roleData.description || 'No description'}</p>
        </div>
    `;
    
    for (const [category, permissions] of Object.entries(permissionsData)) {
        html += `
            <div class="permission-group">
                <h6>${category.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase())}</h6>
        `;
        
        for (const [permName, permDesc] of Object.entries(permissions)) {
            const isChecked = roleData.permissions && roleData.permissions.includes(permName) ? 'checked' : '';
            html += `
                <div class="permission-item">
                    <input type="checkbox" class="form-check-input permission-checkbox" 
                           id="${permName}" value="${permName}" ${isChecked}>
                    <label class="form-check-label permission-label" for="${permName}">
                        ${permName.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase())}
                    </label>
                    <small class="text-muted permission-description">${permDesc}</small>
                </div>
            `;
        }
        
        html += '</div>';
    }
    
    container.innerHTML = html;
}

function loadRolePermissions() {
    const roleId = document.getElementById('role-select').value;
    if (!roleId) {
        document.getElementById('permissions-container').innerHTML = 
            '<p class="text-muted">Select a role to view and edit permissions.</p>';
        return;
    }
    
    // Load role permissions
    fetch(`/core/api/admin/role-permissions/${roleId}/`)
        .then(response => response.json())
        .then(data => {
            displayPermissionsForRole(data);
        })
        .catch(error => {
            console.error('Error loading permissions:', error);
            document.getElementById('permissions-container').innerHTML = 
                '<p class="text-danger">Failed to load permissions.</p>';
        });
}

function displayPermissionsForRole(roleData) {
    const container = document.getElementById('permissions-container');
    let html = '';
    
    for (const [category, permissions] of Object.entries(permissionsData)) {
        html += `
            <div class="permission-group">
                <h6>${category.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase())}</h6>
        `;
        
        for (const [permName, permDesc] of Object.entries(permissions)) {
            const isChecked = roleData.permissions && roleData.permissions.includes(permName) ? 'checked' : '';
            html += `
                <div class="permission-item">
                    <input type="checkbox" class="form-check-input permission-checkbox" 
                           id="perm_${permName}" value="${permName}" ${isChecked}
                           onchange="togglePermission('${permName}', this.checked)">
                    <label class="form-check-label permission-label" for="perm_${permName}">
                        ${permName.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase())}
                    </label>
                    <small class="text-muted permission-description">${permDesc}</small>
                </div>
            `;
        }
        
        html += '</div>';
    }
    
    container.innerHTML = html;
}

function togglePermission(permissionName, isGranted) {
    console.log(`Permission ${permissionName} ${isGranted ? 'granted' : 'revoked'}`);
    // Implement AJAX call to update permission
}

function saveRolePermissions() {
    // Collect all checked permissions and save via AJAX
    const checkedPermissions = [];
    document.querySelectorAll('.permission-checkbox:checked').forEach(checkbox => {
        checkedPermissions.push(checkbox.value);
    });
    
    console.log('Saving permissions:', checkedPermissions);
    // Implement save functionality
    
    // Close modal
    bootstrap.Modal.getInstance(document.getElementById('roleDetailsModal')).hide();
}

function refreshPermissions() {
    // Refresh permissions data
    location.reload();
}

function showAddRoleModal() {
    // Show modal for adding new role
    alert('Add role functionality to be implemented');
}

function editRole(roleId) {
    // Edit existing role
    alert(`Edit role ${roleId} functionality to be implemented`);
}

function deleteRole(roleId) {
    if (confirm('Are you sure you want to delete this role? This action cannot be undone.')) {
        // Delete role via AJAX
        console.log(`Deleting role ${roleId}`);
        location.reload();
    }
}

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    // Any initialization code
});
</script>
{% endblock %}

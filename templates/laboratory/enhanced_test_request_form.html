{% extends 'base.html' %}
{% load custom_filters %}
{% load form_tags %}

{% block extra_css %}
<style>
.autocomplete-results {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    z-index: 1000;
    max-height: 300px;
    overflow-y: auto;
    background: white;
    border: 1px solid #ddd;
    border-top: none;
    border-radius: 0 0 4px 4px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.autocomplete-results .list-group-item {
    border-radius: 0;
    border-left: none;
    border-right: none;
}

.autocomplete-results .list-group-item:hover {
    background-color: #f8f9fa;
    cursor: pointer;
}

.position-relative {
    position: relative;
}

.patient-dropdown-section {
    background-color: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 5px;
    padding: 15px;
    margin-top: 10px;
}

.patient-dropdown-section .form-label {
    color: #6c757d;
    font-weight: 500;
}

.htmx-indicator {
    display: none;
}

.htmx-request .htmx-indicator {
    display: inline-block;
}

.htmx-request.htmx-indicator {
    display: inline-block;
}
</style>
{% endblock %}

{% block title %}{{ title }}{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-sm-flex align-items-center justify-content-between mb-4">
        <h1 class="h3 mb-0 text-gray-800">{{ title }}</h1>
        <div>
            <a href="{% url 'laboratory:test_requests' %}" class="btn btn-secondary">
                <i class="fas fa-arrow-left"></i> Back to Test Requests
            </a>
        </div>
    </div>

    {% if patient %}
    <!-- Patient Information Section -->
    <div class="alert alert-info">
        <h5 class="alert-heading">
            <i class="fas fa-user"></i> Creating Test Request for Selected Patient
        </h5>
        <div class="row">
            <div class="col-md-6">
                <strong>Patient:</strong> {{ patient.get_full_name }}<br>
                <strong>Patient ID:</strong> {{ patient.patient_id }}<br>
                <strong>Phone:</strong> {{ patient.phone_number|default:"N/A" }}
            </div>
            <div class="col-md-6">
                <strong>Age:</strong> {{ patient.get_age }} years<br>
                <strong>Gender:</strong> {{ patient.get_gender_display }}<br>
                {% if patient.nhia_info %}
                <strong>NHIA:</strong> <span class="badge bg-success">{{ patient.nhia_info.nhia_reg_number }}</span>
                {% else %}
                <strong>NHIA:</strong> <span class="badge bg-secondary">Not Registered</span>
                {% endif %}
            </div>
        </div>
        <hr class="my-2">
        <small class="text-muted">
            <i class="fas fa-info-circle"></i> 
            Patient has been automatically selected. You can focus on selecting tests and request details.
        </small>
    </div>
    {% endif %}

    <div class="row">
        <!-- Test Request Form -->
        <div class="col-lg-8">
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">
                        <i class="fas fa-vial"></i> Test Request Details
                    </h6>
                </div>
                <div class="card-body">
                    <form method="post" id="test-request-form">
                        {% csrf_token %}
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                {% if patient %}
                                    <!-- Hidden field for preselected patient -->
                                    {{ form.patient_hidden }}
                                    <!-- Show patient field as read-only -->
                                    <label class="form-label">Patient</label>
                                    <input type="text" class="form-control" value="{{ patient.get_full_name }} ({{ patient.patient_id }})" readonly style="background-color: #e9ecef;">
                                    <small class="form-text text-muted">Patient is preselected from patient detail page</small>
                                {% else %}
                                    <label for="patientSearch" class="form-label">Search Patient</label>
                                    <div class="position-relative">
                                        <input type="text" id="patientSearch" name="q" class="form-control"
                                               placeholder="Search by name, ID, or phone..."
                                               hx-get="{% url 'patients:htmx_patient_search' %}"
                                               hx-trigger="keyup changed delay:500ms, search"
                                               hx-target="#patientResults"
                                               hx-swap="innerHTML"
                                               hx-indicator="#search-loading"
                                               autocomplete="off">
                                        <div id="search-loading" class="htmx-indicator" style="position: absolute; right: 10px; top: 8px; display: none;">
                                            <i class="fas fa-spinner fa-spin text-primary"></i>
                                        </div>
                                        <div id="patientResults" class="autocomplete-results" style="display: none;"></div>
                                    </div>
                                    <small class="form-text text-muted">
                                        <i class="fas fa-info-circle"></i> Type at least 2 characters to search
                                    </small>
                                    <div id="selected-patient-info" class="mt-2" style="display: none;">
                                        <div class="alert alert-info">
                                            <strong>Selected Patient:</strong>
                                            <span id="patient-name"></span> (<span id="patient-id"></span>)
                                            <br><small>Phone: <span id="patient-phone"></span></small>
                                        </div>
                                    </div>
                                    <div id="patient-required-warning" class="alert alert-warning mt-2" style="display: none;">
                                        <small><i class="fas fa-exclamation-triangle"></i> Please search and select a patient to continue.</small>
                                    </div>

                                    <!-- Alternative: Direct Patient Selection Dropdown -->
                                    <div class="mt-2 patient-dropdown-section">
                                        <label for="patientDropdown" class="form-label">
                                            <i class="fas fa-list"></i> Or select directly from list:
                                        </label>
                                        {{ form.patient|add_class:"form-control select2" }}
                                        {% if form.patient.errors %}
                                            <div class="text-danger">{{ form.patient.errors }}</div>
                                        {% endif %}
                                        <small class="form-text text-muted">
                                            <i class="fas fa-info-circle"></i> You can either search above or select from this dropdown
                                        </small>
                                    </div>
                                {% endif %}
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                <label for="{{ form.doctor.id_for_label }}" class="form-label">Requesting Doctor</label>
                                {{ form.doctor|add_class:"form-control select2" }}
                                {% if form.doctor.errors %}
                                    <div class="text-danger">{{ form.doctor.errors }}</div>
                                {% endif %}
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label for="{{ form.request_date.id_for_label }}" class="form-label">Request Date</label>
                                {{ form.request_date|add_class:"form-control" }}
                                {% if form.request_date.errors %}
                                    <div class="text-danger">{{ form.request_date.errors }}</div>
                                {% endif %}
                            </div>
                            
                            <div class="col-md-4 mb-3">
                                <label for="{{ form.priority.id_for_label }}" class="form-label">Priority</label>
                                {{ form.priority|add_class:"form-control" }}
                                {% if form.priority.errors %}
                                    <div class="text-danger">{{ form.priority.errors }}</div>
                                {% endif %}
                            </div>
                            
                            <div class="col-md-4 mb-3">
                                <label for="{{ form.status.id_for_label }}" class="form-label">Status</label>
                                {{ form.status|add_class:"form-control" }}
                                {% if form.status.errors %}
                                    <div class="text-danger">{{ form.status.errors }}</div>
                                {% endif %}
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="{{ form.notes.id_for_label }}" class="form-label">Notes</label>
                            {{ form.notes|add_class:"form-control" }}
                            {% if form.notes.errors %}
                                <div class="text-danger">{{ form.notes.errors }}</div>
                            {% endif %}
                        </div>
                        
                        <!-- Authorization Code Field (only for NHIA patients) -->
                        {% if patient and patient.patient_type == 'nhia' %}
                        <div class="mb-3">
                            <label for="{{ form.authorization_code.id_for_label }}" class="form-label">Authorization Code</label>
                            {{ form.authorization_code|add_class:"form-control select2" }}
                            {% if form.authorization_code.errors %}
                                <div class="text-danger">{{ form.authorization_code.errors }}</div>
                            {% endif %}
                            <small class="form-text text-muted">
                                Select an authorization code if this request is covered by NHIA.
                            </small>
                        </div>
                        {% endif %}
                        
                        <!-- Hidden field for selected tests -->
                        <input type="hidden" name="tests" id="selected-tests" value="">
                        
                        <div class="d-flex justify-content-between mt-4">
                            <a href="{% url 'laboratory:test_requests' %}" class="btn btn-secondary">
                                <i class="fas fa-arrow-left"></i> Cancel
                            </a>
                            <button type="submit" class="btn btn-primary btn-lg" id="submit-btn" disabled>
                                <i class="fas fa-save"></i> Create Test Request
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Test Selection Panel -->
        <div class="col-lg-4">
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">
                        <i class="fas fa-search"></i> Select Tests
                    </h6>
                </div>
                <div class="card-body">
                    <!-- Search Box -->
                    <div class="mb-3">
                        <input type="text" id="test-search" class="form-control" placeholder="Search tests..." autofocus>
                        <small class="text-muted">Type to search for tests by name, description, sample type, or category</small>
                    </div>
                    
                    <!-- Category Filter -->
                    <div class="mb-3">
                        <select id="category-filter" class="form-select">
                            <option value="">All Categories</option>
                            {% for category in test_categories %}
                            <option value="{{ category.id }}">{{ category.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <!-- Selected Tests Summary -->
                    <div class="mb-3">
                        <h6>Selected Tests (<span id="selected-count">0</span>)</h6>
                        <div id="selected-tests-list" class="border rounded p-2" style="min-height: 60px; max-height: 150px; overflow-y: auto;">
                            <small class="text-muted">No tests selected</small>
                        </div>
                        <div class="mt-2">
                            <strong>Total Cost: Naira <span id="total-cost">0.00</span></strong>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Available Tests -->
    <div class="card shadow mb-4">
        <div class="card-header py-3">
            <h6 class="m-0 font-weight-bold text-primary">
                <i class="fas fa-list"></i> Available Tests
            </h6>
        </div>
        <div class="card-body">
            <div class="row" id="tests-container">
                {% for category in test_categories %}
                <div class="col-12 mb-4 test-category" data-category="{{ category.id }}">
                    <h6 class="text-primary">{{ category.name }}</h6>
                    <div class="row">
                        {% for test in category.tests.all %}
                        <div class="col-md-6 col-lg-4 mb-2">
                            <div class="card test-card" data-test-id="{{ test.id }}" data-category="{{ category.id }}" data-test-name="{{ test.name|lower }}" data-price="{{ test.price }}" data-description="{{ test.description|default:''|lower }}">
                                <div class="card-body p-2">
                                    <div class="form-check">
                                        <input class="form-check-input test-checkbox" type="checkbox" value="{{ test.id }}" id="test_{{ test.id }}">
                                        <label class="form-check-label" for="test_{{ test.id }}">
                                            <strong>{{ test.name }}</strong>
                                            <small class="d-block text-muted">Naira {{ test.price }}</small>
                                            {% if test.sample_type %}
                                            <small class="d-block text-info">{{ test.sample_type }}</small>
                                            {% endif %}
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- All Tests Data for JavaScript -->
    <script type="application/json" id="all-tests-data">
    {{ all_tests_json|safe }}
    </script>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // ============================================
    // Patient Search Functionality
    // ============================================
    const patientSearchField = document.getElementById('patientSearch');
    const patientIdField = document.getElementById('id_patient');
    const patientDropdown = patientIdField; // The actual patient field
    const searchResults = document.getElementById('patientResults');
    const selectedPatientInfo = document.getElementById('selected-patient-info');
    const patientWarning = document.getElementById('patient-required-warning');
    let searchTimeout;

    // Show warning initially if no patient is selected and patient field exists
    if (patientIdField && !patientIdField.value && patientWarning) {
        patientWarning.style.display = 'block';
    }

    // Check if HTMX is available
    if (typeof htmx !== 'undefined') {
        console.log('✓ HTMX is loaded and ready');
    } else {
        console.error('✗ HTMX is not loaded!');
    }

    // HTMX event listeners for patient search
    if (patientSearchField && typeof htmx !== 'undefined') {
        console.log('✓ Setting up HTMX patient search listeners');

        // Show results when HTMX loads content
        document.body.addEventListener('htmx:afterSwap', function(evt) {
            if (evt.detail.target.id === 'patientResults') {
                const searchTerm = patientSearchField.value.trim();
                console.log('HTMX afterSwap - search term:', searchTerm);
                if (searchTerm.length >= 2 && evt.detail.target.innerHTML.trim() !== '') {
                    searchResults.style.display = 'block';
                    // Re-attach click handlers to new results
                    attachPatientResultHandlers();
                } else {
                    searchResults.style.display = 'none';
                }
            }
        });

        // Log HTMX requests
        document.body.addEventListener('htmx:beforeRequest', function(evt) {
            if (evt.detail.target.id === 'patientResults' || evt.detail.elt.id === 'patientSearch') {
                console.log('HTMX beforeRequest - URL:', evt.detail.requestConfig.path);
            }
        });

        // Handle errors
        document.body.addEventListener('htmx:responseError', function(evt) {
            console.error('HTMX error:', evt.detail);
        });
    }

    // Attach click handlers to patient search results
    function attachPatientResultHandlers() {
        searchResults.querySelectorAll('.patient-result').forEach(item => {
            item.addEventListener('click', function(e) {
                e.preventDefault();
                selectPatient(this);
            });
        });
    }

    // Initialize Select2 for patient dropdown
    if (patientDropdown && typeof $ !== 'undefined') {
        $(patientDropdown).select2({
            theme: 'bootstrap-5',
            width: '100%',
            placeholder: 'Select a patient...',
            allowClear: true,
            minimumInputLength: 0,
            minimumResultsForSearch: 0, // Always show search box
            matcher: function(params, data) {
                // If no search term, return all
                if ($.trim(params.term) === '') {
                    return data;
                }

                // Search in text
                if (data.text.toLowerCase().indexOf(params.term.toLowerCase()) > -1) {
                    return data;
                }

                // Search in data attributes if available
                if (data.element) {
                    var $element = $(data.element);
                    var patientName = $element.data('patient-name') || '';
                    var patientId = $element.data('patient-pid') || '';
                    var patientPhone = $element.data('patient-phone') || '';

                    var searchStr = (patientName + ' ' + patientId + ' ' + patientPhone).toLowerCase();
                    if (searchStr.indexOf(params.term.toLowerCase()) > -1) {
                        return data;
                    }
                }

                return null;
            },
            language: {
                searching: function() {
                    return 'Searching patients...';
                },
                noResults: function() {
                    return 'No patients found';
                },
                inputTooShort: function() {
                    return 'Type to search...';
                }
            }
        });

        // Handle dropdown selection
        $(patientDropdown).on('change', function() {
            const selectedOption = this.options[this.selectedIndex];
            if (selectedOption && selectedOption.value) {
                selectPatientFromDropdown(selectedOption);
            } else {
                clearPatientSelection();
            }
        });
    }

    // Hide results when clicking outside
    if (patientSearchField) {
        document.addEventListener('click', function(e) {
            if (!patientSearchField.contains(e.target) && !searchResults.contains(e.target)) {
                searchResults.style.display = 'none';
            }
        });

        // Add input event listener for clearing when empty
        patientSearchField.addEventListener('input', function() {
            const searchTerm = this.value.trim();
            if (searchTerm.length < 2) {
                searchResults.style.display = 'none';
                searchResults.innerHTML = '';
            }
        });
    }

    function displaySearchResults(patients) {
        if (patients.length === 0) {
            searchResults.innerHTML = '<div class="list-group-item text-muted">No patients found</div>';
            searchResults.style.display = 'block';
            return;
        }

        let html = '<div class="list-group">';
        patients.forEach(patient => {
            const age = patient.age || 'N/A';
            const gender = patient.gender || 'N/A';
            const phone = patient.phone || 'N/A';

            html += `
                <a href="#" class="list-group-item list-group-item-action patient-result"
                   data-patient-id="${patient.id}"
                   data-patient-name="${patient.name}"
                   data-patient-pid="${patient.patient_id}"
                   data-patient-age="${age}"
                   data-patient-gender="${gender}"
                   data-patient-phone="${phone}">
                    <div class="d-flex w-100 justify-content-between">
                        <h6 class="mb-1">${patient.name}</h6>
                        <small>${patient.patient_id}</small>
                    </div>
                    <p class="mb-1">Age: ${age} | Gender: ${gender}</p>
                    <small>Phone: ${phone}</small>
                </a>
            `;
        });
        html += '</div>';

        searchResults.innerHTML = html;
        searchResults.style.display = 'block';

        // Add click handlers to results
        searchResults.querySelectorAll('.patient-result').forEach(item => {
            item.addEventListener('click', function(e) {
                e.preventDefault();
                selectPatient(this);
            });
        });
    }

    function selectPatient(element) {
        const patientId = element.dataset.patientId;
        const patientName = element.dataset.patientName;
        const patientPid = element.dataset.patientPid;
        const patientPhone = element.dataset.patientPhone;

        // Set the hidden patient field
        patientIdField.value = patientId;

        // Update search field with patient name
        patientSearchField.value = patientName;

        // Show selected patient info
        document.getElementById('patient-name').textContent = patientName;
        document.getElementById('patient-id').textContent = patientPid;
        document.getElementById('patient-phone').textContent = patientPhone;

        selectedPatientInfo.style.display = 'block';
        searchResults.style.display = 'none';

        // Hide the patient warning
        if (patientWarning) {
            patientWarning.style.display = 'none';
        }

        // Sync the dropdown selection
        if (patientDropdown && typeof $ !== 'undefined') {
            $(patientDropdown).val(patientId).trigger('change.select2');
        }
    }

    function selectPatientFromDropdown(selectedOption) {
        const patientId = selectedOption.value;
        const patientText = selectedOption.text;

        // Extract patient name and ID from the dropdown text
        const match = patientText.match(/^(.+?)\s+\((.+?)\)/);
        const patientName = match ? match[1] : patientText;
        const patientPid = match ? match[2] : 'N/A';

        // Set the hidden patient field
        patientIdField.value = patientId;

        // Update search field with patient name
        if (patientSearchField) {
            patientSearchField.value = patientName;
        }

        // Show selected patient info
        document.getElementById('patient-name').textContent = patientName;
        document.getElementById('patient-id').textContent = patientPid;
        document.getElementById('patient-phone').textContent = 'N/A';

        selectedPatientInfo.style.display = 'block';
        searchResults.style.display = 'none';

        // Hide the patient warning
        if (patientWarning) {
            patientWarning.style.display = 'none';
        }
    }

    function clearPatientSelection() {
        if (patientIdField) {
            patientIdField.value = '';
        }
        if (patientSearchField) {
            patientSearchField.value = '';
        }
        selectedPatientInfo.style.display = 'none';

        if (patientWarning) {
            patientWarning.style.display = 'block';
        }

        // Clear dropdown selection
        if (patientDropdown && typeof $ !== 'undefined') {
            $(patientDropdown).val(null).trigger('change');
        }
    }

    // ============================================
    // Test Selection Functionality
    // ============================================
    const selectedTests = new Set();
    const testSearch = document.getElementById('test-search');
    const categoryFilter = document.getElementById('category-filter');
    const selectedTestsInput = document.getElementById('selected-tests');
    const selectedTestsList = document.getElementById('selected-tests-list');
    const selectedCount = document.getElementById('selected-count');
    const totalCost = document.getElementById('total-cost');
    const submitBtn = document.getElementById('submit-btn');
    
    // Load all tests data from JSON
    let allTestsData = [];
    try {
        const allTestsElement = document.getElementById('all-tests-data');
        if (allTestsElement && allTestsElement.textContent.trim()) {
            allTestsData = JSON.parse(allTestsElement.textContent);
            console.log('Loaded tests data:', allTestsData.length, 'tests');
        }
    } catch (error) {
        console.error('Error loading tests data:', error);
        // Fallback to empty array if JSON fails
        allTestsData = [];
    }
    
    // Create a lookup map for quick test data access
    const testLookup = new Map();
    allTestsData.forEach(test => {
        testLookup.set(test.id.toString(), test);
    });
    
    // Debug: Check if test cards exist on page load
    const testCards = document.querySelectorAll('.test-card');
    console.log('Found test cards:', testCards.length);
    
    // Debug: Check if search input exists
    const searchInput = document.getElementById('test-search');
    console.log('Search input element:', searchInput);
    
    function updateSelectedTests() {
        const testsArray = Array.from(selectedTests);
        selectedTestsInput.value = testsArray.join(',');
        
        // Update count
        selectedCount.textContent = testsArray.length;
        
        // Update list
        if (testsArray.length === 0) {
            selectedTestsList.innerHTML = '<small class="text-muted">No tests selected</small>';
            submitBtn.disabled = true;
        } else {
            let html = '';
            let total = 0;
            testsArray.forEach(testId => {
                const testData = testLookup.get(testId);
                if (testData) {
                    total += testData.price;
                    html += `<span class="badge bg-primary me-1 mb-1">${testData.name} <button type="button" class="btn-close btn-close-white btn-sm ms-1" onclick="removeTest('${testId}')"></button></span>`;
                }
            });
            selectedTestsList.innerHTML = html;
            totalCost.textContent = total.toFixed(2);
            submitBtn.disabled = false;
        }
    }
    
    window.removeTest = function(testId) {
        selectedTests.delete(testId);
        const checkbox = document.getElementById(`test_${testId}`);
        if (checkbox) {
            checkbox.checked = false;
        }
        updateSelectedTests();
    };
    
    // Handle test selection
    document.addEventListener('change', function(e) {
        if (e.target.classList.contains('test-checkbox')) {
            const testId = e.target.value;
            if (e.target.checked) {
                selectedTests.add(testId);
            } else {
                selectedTests.delete(testId);
            }
            updateSelectedTests();
        }
    });
    
    // Enhanced search functionality
    function performSearch() {
        const searchTerm = testSearch.value.toLowerCase().trim();
        const testCards = document.querySelectorAll('.test-card');
        
        console.log('Searching for:', searchTerm);
        console.log('Total cards found:', testCards.length);
        
        if (searchTerm === '') {
            // Show all tests if search is empty
            testCards.forEach(card => {
                card.style.display = 'block';
            });
            console.log('Empty search, showing all cards');
            return;
        }
        
        let visibleCount = 0;
        testCards.forEach(card => {
            const testId = card.dataset.testId;
            const testData = testLookup.get(testId);
            
            if (testData) {
                // Search across multiple fields: name, description, sample_type, category
                const matchesSearch = 
                    testData.name_lower.includes(searchTerm) ||
                    testData.description_lower.includes(searchTerm) ||
                    testData.sample_type_lower.includes(searchTerm) ||
                    testData.category.toLowerCase().includes(searchTerm);
                
                card.style.display = matchesSearch ? 'block' : 'none';
                if (matchesSearch) {
                    visibleCount++;
                    console.log('Match found:', testData.name);
                }
            } else {
                // Fallback: use data attributes from card if testLookup fails
                const testName = (card.dataset.testName || '').toLowerCase();
                const testDescription = (card.dataset.description || '').toLowerCase();
                const matchesFallback = testName.includes(searchTerm) || testDescription.includes(searchTerm);
                
                card.style.display = matchesFallback ? 'block' : 'none';
                if (matchesFallback) {
                    visibleCount++;
                    console.log('Fallback match found:', card.dataset.testName);
                }
            }
        });
        console.log('Visible cards after search:', visibleCount);
    }
    
    // Search with debouncing for better performance
    let searchTimeout;
    testSearch.addEventListener('input', function() {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(performSearch, 150);
    });
    
    // Category filter
    categoryFilter.addEventListener('change', function() {
        const categoryId = this.value;
        const categories = document.querySelectorAll('.test-category');
        
        categories.forEach(category => {
            if (!categoryId || category.dataset.category === categoryId) {
                category.style.display = 'block';
            } else {
                category.style.display = 'none';
            }
        });
        
        // Re-apply search after category filter
        performSearch();
    });
    
    // Auto-focus search field on page load
    testSearch.focus();
    
    // Add keyboard shortcuts
    document.addEventListener('keydown', function(e) {
        // Ctrl+F or Cmd+F to focus search
        if ((e.ctrlKey || e.metaKey) && e.key === 'f') {
            e.preventDefault();
            testSearch.focus();
            testSearch.select();
        }
        // Escape to clear search
        if (e.key === 'Escape') {
            testSearch.value = '';
            performSearch();
        }
    });
});
</script>
{% endblock %}

{% block extra_js %}
<script>
// Initialize Select2 for other form fields
$(document).ready(function() {
    // Initialize Select2 for doctor and other select fields
    $('.select2').not('#id_patient').select2({
        theme: 'bootstrap-5',
        width: '100%',
        minimumResultsForSearch: 0, // Always show search box
        allowClear: false,
        placeholder: 'Select an option...'
    });

    // Special configuration for authorization code if it exists
    if ($('#id_authorization_code').length) {
        $('#id_authorization_code').select2({
            theme: 'bootstrap-5',
            width: '100%',
            minimumResultsForSearch: 0,
            allowClear: true,
            placeholder: 'Select authorization code (optional)...'
        });
    }
});
</script>
{% endblock %}

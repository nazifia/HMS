{% extends 'base.html' %}
{% load custom_filters %}
{% load form_tags %}
{% load billing_tags %} {# Assuming you might create billing_tags later for invoice status #}
{% load hms_permissions %}

{% block title %}Test Request Details - Hospital Management System{% endblock %}

{% block extra_css %}
<style>
    @media print {
        /* Hide navigation, sidebar, and action buttons when printing */
        .navbar, .sidebar, .btn, .btn-group, .alert,
        body > nav, #accordionSidebar, .topbar, footer,
        .no-print, .card-header .btn, .dropdown {
            display: none !important;
        }

        /* Adjust page layout for printing */
        body {
            background: white !important;
        }

        .container-fluid, .row {
            width: 100% !important;
            max-width: 100% !important;
            margin: 0 !important;
            padding: 10px !important;
        }

        .card {
            border: 1px solid #000 !important;
            box-shadow: none !important;
            page-break-inside: avoid;
            margin-bottom: 20px !important;
        }

        .card-header {
            background-color: #f8f9fa !important;
            color: #000 !important;
            -webkit-print-color-adjust: exact;
            print-color-adjust: exact;
            padding: 10px !important;
        }

        .card-body {
            padding: 15px !important;
        }

        /* Add hospital header for print */
        .print-header {
            display: block !important;
            text-align: center;
            margin-bottom: 20px;
            border-bottom: 2px solid #000;
            padding-bottom: 10px;
        }

        .print-header h2 {
            margin: 0;
            font-size: 24px;
        }

        .print-header p {
            margin: 5px 0;
            font-size: 12px;
        }

        /* Ensure tables fit on page */
        table {
            font-size: 11px !important;
            width: 100% !important;
        }

        .table-responsive {
            overflow: visible !important;
        }

        /* Page breaks */
        .card {
            page-break-after: auto;
        }

        tr {
            page-break-inside: avoid;
        }

        /* Show only essential information */
        .border-bottom {
            border-bottom: 1px solid #dee2e6 !important;
        }

        /* Badge styling for print */
        .badge {
            border: 1px solid #000 !important;
            padding: 2px 5px !important;
        }
    }

    /* Hide print header on screen */
    .print-header {
        display: none;
    }

    /* Print button styling */
    .print-controls {
        position: sticky;
        top: 0;
        z-index: 1000;
        background: white;
        padding: 10px 0;
        border-bottom: 2px solid #e3e6f0;
        margin-bottom: 20px;
    }

    /* Test Result Modal z-index improvements */
    #testResultModal {
        z-index: 1060 !important;
    }

    .modal-backdrop {
        z-index: 1055 !important;
    }

    .modal-backdrop.show {
        opacity: 0.1 !important;
        z-index: 1055 !important;
        background-color: #000 !important;
    }

    #testResultModal .modal-dialog {
        z-index: 1061 !important;
        position: relative;
    }

    /* Ensure modal content is above backdrop */
    #testResultModal .modal-content {
        position: relative;
        z-index: 1062 !important;
        box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.5) !important;
        background-color: #fff !important;
    }

    /* Hide/lower z-index of page elements when modal is open */
    .modal-open #accordionSidebar,
    .modal-open .sidebar,
    .modal-open .topbar,
    .modal-open .navbar,
    .modal-open nav:not(#testResultModal nav),
    .modal-open header {
        z-index: 1 !important;
        position: relative;
    }

    /* Prevent ALL background content from interfering */
    .modal-open #wrapper,
    .modal-open #content-wrapper,
    .modal-open .page-content,
    .modal-open .container-fluid:not(#testResultModal .container-fluid),
    .modal-open .card:not(#testResultModal .card),
    .modal-open .card-body:not(#testResultModal .card-body),
    .modal-open form:not(#testResultModal form),
    .modal-open .form-control:not(#testResultModal .form-control),
    .modal-open .form-select:not(#testResultModal .form-select),
    .modal-open input:not(#testResultModal input),
    .modal-open select:not(#testResultModal select),
    .modal-open textarea:not(#testResultModal textarea),
    .modal-open button:not(#testResultModal button),
    .modal-open .btn:not(#testResultModal .btn),
    .modal-open table:not(#testResultModal table) {
        pointer-events: none !important;
    }

    /* Ensure ONLY modal elements are interactive */
    #testResultModal,
    #testResultModal *,
    #testResultModal .form-control,
    #testResultModal .form-select,
    #testResultModal button,
    #testResultModal input,
    #testResultModal textarea,
    #testResultModal select,
    #testResultModal .nav-link,
    #testResultModal .btn,
    #testResultModal .btn-close,
    #testResultModal a {
        pointer-events: auto !important;
        position: relative;
    }
    
    /* Higher stacking context for modal */
    body:not(.modal-open) .content-wrapper,
    body:not(.modal-open) #content-wrapper,
    body:not(.modal-open) .page-content,
    body:not(.modal-open) .container-fluid,
    body:not(.modal-open) .row,
    body:not(.modal-open) .card,
    body:not(.modal-open) .card-body,
    body:not(.modal-open) .form,
    body:not(.modal-open) .form-control,
    body:not(.modal-open) .form-select,
    body:not(.modal-open) input,
    body:not(.modal-open) select,
    body:not(.modal-open) button,
    body:not(.modal-open) .btn {
        z-index: auto !important;
        position: relative;
    }
    
    /* Create new stacking context */
    .modal-content-wrapper {
        position: relative;
        z-index: 9990;
    }
    
    /* Ensure modal container stays on top */
    #testResultModal .modal-dialog {
        transform: translateZ(0);
        z-index: 10001 !important;
    }

    /* Select2 dropdown positioning for modal */
    .select2-container--open {
        z-index: 1065 !important;
    }

    .select2-dropdown {
        z-index: 1065 !important;
    }

    .select2-container {
        z-index: 1063 !important;
    }

    /* Ensure modal appears above all other elements */
    .modal-open {
        overflow: hidden;
    }

    .modal-open .modal {
        overflow-x: hidden;
        overflow-y: auto;
    }
</style>
{% endblock %}

{% block content %}
<!-- Print Header (only visible when printing) -->
<div class="print-header">
    <h2>Hospital Management System</h2>
    <p>Laboratory Test Request Report</p>
    <p>Request ID: #{{ test_request.id }} | Generated on: {% now "F d, Y" %}</p>
</div>

<!-- Print Controls (hidden when printing) -->
<div class="print-controls no-print">
    <div class="container-fluid">
        <div class="d-flex justify-content-between align-items-center">
            <h4 class="mb-0"><i class="fas fa-flask"></i> Test Request #{{ test_request.id }}</h4>
            <div>
                {% if results %}
                <button onclick="window.print()" class="btn btn-primary">
                    <i class="fas fa-print"></i> Print Results
                </button>
                {% endif %}
                <a href="{% url 'laboratory:test_requests' %}" class="btn btn-secondary">
                    <i class="fas fa-arrow-left"></i> Back to List
                </a>
            </div>
        </div>
    </div>
</div>
<div class="row">
    <div class="col-md-12 mb-4">
        <!-- NHIA Exemption Alert -->
        {% if test_request.patient.is_nhia_patient %}
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            <i class="fas fa-check-circle"></i>
            <strong>NHIA Patient - Payment Exempt:</strong> This patient is exempt from laboratory test payments.
            No payment is required for this test request.
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
        {% endif %}

        <!-- NHIA Authorization Warning -->
        {% include 'includes/authorization_warning.html' with test_request=test_request %}

        <div class="card">
            <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                <h4 class="mb-0">Test Request Details</h4>
                <div>
                    {% if test_request.status == 'payment_confirmed' or test_request.status == 'sample_collected' or test_request.status == 'processing' %}{% if user|has_permission:'enter_lab_results' %}
                        <a href="{% url 'laboratory:create_test_result' test_request.id %}" class="btn btn-success me-2">
                            <i class="fas fa-vial"></i> Add Test Result
                        </a>
                    {% endif %}{% endif %}

                    {% if test_request.status == 'awaiting_payment' and test_request.invoice %}
                        <a href="{% url 'billing:detail' test_request.invoice.id %}" class="btn btn-warning me-2">
                            <i class="fas fa-file-invoice-dollar"></i> View Invoice ({{ test_request.invoice.status|capfirst }})
                        </a>
                    {% endif %}

                    <!-- Manual result entry option for authorized users -->
                    {% if user|has_permission:'enter_lab_results' %}
                        <a href="{% url 'laboratory:manual_test_result_entry' test_request.id %}" class="btn btn-outline-success me-2">
                            <i class="fas fa-flask"></i> Manual Result Entry (Full Page)
                        </a>
                    {% endif %}
                </div>
            </div>
            <div class="card-body">
                <div class="row">
                    <!-- Request Information -->
                    <div class="col-md-6">
                        <h5 class="border-bottom pb-2 mb-3">Request Information</h5>
                        <div class="row mb-3">
                            <div class="col-md-4 text-muted">Request ID:</div>
                            <div class="col-md-8">{{ test_request.id }}</div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-4 text-muted">Request Date:</div>
                            <div class="col-md-8">{{ test_request.request_date|date:"F d, Y" }}</div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-4 text-muted">Status:</div>
                            <div class="col-md-8">
                                {% if test_request.status == 'pending' %}
                                    <span class="badge bg-secondary">Pending Initial Review</span>
                                {% elif test_request.status == 'awaiting_payment' %}
                                    <span class="badge bg-warning text-dark">Awaiting Payment</span>
                                    {% if test_request.invoice %}
                                        <a href="{% url 'billing:detail' test_request.invoice.id %}" class="badge bg-primary ms-1">View Invoice</a>
                                    {% endif %}
                                {% elif test_request.status == 'payment_confirmed' %}
                                    <span class="badge bg-success">Payment Confirmed</span>
                                {% elif test_request.status == 'sample_collected' %}
                                    <span class="badge bg-info">Sample Collected</span>
                                {% elif test_request.status == 'processing' %}
                                    <span class="badge bg-info text-dark">Processing</span>
                                {% elif test_request.status == 'completed' %}
                                    <span class="badge bg-success">Completed</span>
                                {% elif test_request.status == 'cancelled' %}
                                    <span class="badge bg-danger">Cancelled</span>
                                {% endif %}
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-4 text-muted">Priority:</div>
                            <div class="col-md-8">
                                {% if test_request.priority == 'normal' %}
                                    <span class="badge bg-success">Normal</span>
                                {% elif test_request.priority == 'urgent' %}
                                    <span class="badge bg-warning">Urgent</span>
                                {% elif test_request.priority == 'emergency' %}
                                    <span class="badge bg-danger">Emergency</span>
                                {% endif %}
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-4 text-muted">Created By:</div>
                            <div class="col-md-8">
                                {% if test_request.created_by %}
                                    {{ test_request.created_by.get_full_name|default:test_request.created_by.username|default:"Unknown" }}
                                {% else %}
                                    <span class="text-muted">Unknown</span>
                                {% endif %}
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-4 text-muted">Notes:</div>
                            <div class="col-md-8">{{ test_request.notes|default:"No notes provided." }}</div>
                        </div>

                        <!-- NHIA Authorization Status -->
                        <div class="row mb-3">
                            <div class="col-md-12">
                                {% include 'includes/authorization_status.html' with object=test_request %}
                            </div>
                        </div>
                        {% if test_request.invoice %}
                        <div class="row mb-3">
                            <div class="col-md-4 text-muted">Invoice:</div>
                            <div class="col-md-8">
                                <a href="{% url 'billing:detail' test_request.invoice.id %}">#{{ test_request.invoice.id }} ({{ test_request.invoice.status|capfirst }})</a>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                    
                    <!-- Patient & Doctor Information -->
                    <div class="col-md-6">
                        <h5 class="border-bottom pb-2 mb-3">Patient & Doctor Information</h5>
                        <div class="row mb-3">
                            <div class="col-md-4 text-muted">Patient:</div>
                            <div class="col-md-8">
                                <a href="{% url 'patients:detail' test_request.patient.id %}">
                                    {{ test_request.patient.get_full_name }}
                                </a>
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-4 text-muted">Patient ID:</div>
                            <div class="col-md-8">{{ test_request.patient.patient_id }}</div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-4 text-muted">Gender:</div>
                            <div class="col-md-8">{{ test_request.patient.get_gender_display }}</div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-4 text-muted">Age:</div>
                            <div class="col-md-8">{{ test_request.patient.age }} years</div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-4 text-muted">Doctor:</div>
                            <div class="col-md-8">{% if test_request.doctor %}Dr. {{ test_request.doctor.get_full_name|default:test_request.doctor.username|default:"N/A" }}{% else %}<span class="text-muted">N/A</span>{% endif %}</div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-4 text-muted">Department:</div>
                            <div class="col-md-8">{{ test_request.doctor.profile.department|default:"Not specified" }}</div>
                        </div>
                    </div>
                </div>
                
                <!-- Requested Tests -->
                <div class="row mt-4">
                    <div class="col-md-12">
                        <h5 class="border-bottom pb-2 mb-3">Requested Tests</h5>
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead class="table-light">
                                    <tr>
                                        <th>Test Name</th>
                                        <th>Category</th>
                                        <th>Price</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for test_obj in tests %}
                                        <tr>
                                            <td>{{ test_obj.name }}</td>
                                            <td>{{ test_obj.category.name|default:"N/A" }}</td>
                                            <td>{{ test_obj.price|currency }}</td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                                <tfoot>
                                    <tr class="table-primary fw-bold">
                                        <td colspan="2" class="text-end">Total Estimated Price:</td>
                                        <td>{{ test_request.get_total_price|currency }}</td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    </div>
                </div>
                
                <!-- Test Results -->
                <div class="row mt-4">
                    <div class="col-md-12">
                        <div class="d-flex justify-content-between align-items-center border-bottom pb-2 mb-3">
                            <h5 class="mb-0">Test Results</h5>
                            <div>
                                {% if test_request.status != 'cancelled' %}
                                    <div class="btn-group" role="group">
                                        {% if user|has_permission:'enter_lab_results' %}
                                            <a href="{% url 'laboratory:manual_test_result_entry' test_request.id %}" class="btn btn-sm btn-success">
                                                <i class="fas fa-plus"></i> Add Test Result
                                            </a>
                                        {% else %}
                                            <a href="{% url 'laboratory:create_test_result' test_request.id %}" class="btn btn-sm btn-success">
                                                <i class="fas fa-plus"></i> Add Test Result
                                            </a>
                                        {% endif %}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        {% if results %}
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>Test</th>
                                            <th>Result Date</th>
                                            <th>Sample Collection</th>
                                            <th>Performed By</th>
                                            <th>Verified By</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for result in results %}
                                            <tr>
                                                <td>{{ result.test.name }}</td>
                                                <td>{{ result.result_date|date:"M d, Y" }}</td>
                                                <td>
                                                    {% if result.sample_collection_date %}
                                                        {{ result.sample_collection_date|date:"M d, Y" }}
                                                        <div class="small text-muted">({{ result.sample_collection_date|timesince }} ago)</div>
                                                    {% else %}
                                                        <span class="text-muted">Not yet collected</span>
                                                    {% endif %}
                                                </td>
                                                <td>{{ result.performed_by.get_full_name }}</td>
                                                <td>{{ result.verified_by.get_full_name }}</td>
                                                <td>
                                                    <a href="{% url 'laboratory:result_detail' result.id %}" class="btn btn-sm btn-primary">
                                                        <i class="fas fa-eye"></i> View
                                                    </a>
                                                    {# Add other action buttons if needed, e.g., Edit, Print #}
                                                </td>
                                            </tr>
                                        {% endfor %}
                                    </tbody>
                        {% else %}
                            <div class="text-center py-4">
                                <div class="mb-3">
                                    <i class="fas fa-vial fa-3x text-muted"></i>
                                </div>
                                <h6 class="text-muted">No test results available</h6>
                                <p class="text-muted mb-3">Test results will appear here once they are entered by laboratory staff.</p>
                                {% if test_request.status != 'cancelled' %}
                                    <div class="btn-group" role="group">
                                        {% if user|has_permission:'enter_lab_results' %}
                                            <a href="{% url 'laboratory:manual_test_result_entry' test_request.id %}" class="btn btn-primary">
                                                <i class="fas fa-plus"></i> Add First Test Result
                                            </a>
                                        {% else %}
                                            <a href="{% url 'laboratory:create_test_result' test_request.id %}" class="btn btn-primary">
                                                <i class="fas fa-plus"></i> Add First Test Result
                                            </a>
                                        {% endif %}
                                    </div>
                                {% endif %}
                            </div>
                        {% endif %}
                    </div>
                </div>

                <!-- Related Prescriptions -->
                {% if test_request.patient.prescriptions.exists %}
                <div class="row mt-4">
                    <div class="col-md-12">
                        <h5 class="border-bottom pb-2 mb-3">Related Prescriptions</h5>
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Prescription ID</th>
                                        <th>Date</th>
                                        <th>Doctor</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for prescription in test_request.patient.prescriptions.all|slice:":5" %}
                                    <tr>
                                        <td>{{ prescription.id }}</td>
                                        <td>{{ prescription.prescription_date|date:"M d, Y" }}</td>
                                        <td>Dr. {{ prescription.doctor.get_full_name }}</td>
                                        <td>
                                            {% if prescription.status == 'pending' %}
                                                <span class="badge bg-warning">Pending</span>
                                            {% elif prescription.status == 'approved' %}
                                                <span class="badge bg-info">Approved</span>
                                            {% elif prescription.status == 'dispensed' %}
                                                <span class="badge bg-success">Dispensed</span>
                                            {% elif prescription.status == 'cancelled' %}
                                                <span class="badge bg-danger">Cancelled</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <a href="{% url 'pharmacy:prescription_detail' prescription.id %}" class="btn btn-sm btn-primary">
                                                <i class="fas fa-eye"></i> View
                                            </a>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                {% endif %}

                <!-- Quick Actions -->
                <div class="row mt-4 no-print">
                    <div class="col-md-12">
                        <div class="card bg-light">
                            <div class="card-header">
                                <h6 class="mb-0"><i class="fas fa-bolt"></i> Quick Actions</h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-3">
                                        {% if test_request.status != 'cancelled' %}
                                            {% if user|has_permission:'enter_lab_results' %}
                                                <a href="{% url 'laboratory:manual_test_result_entry' test_request.id %}" class="btn btn-outline-primary w-100 mb-2">
                                                    <i class="fas fa-vial"></i><br>
                                                    <small>Add Test Result (Full Page)</small>
                                                </a>
                                            {% else %}
                                                <a href="{% url 'laboratory:create_test_result' test_request.id %}" class="btn btn-outline-primary w-100 mb-2">
                                                    <i class="fas fa-vial"></i><br>
                                                    <small>Add Test Result</small>
                                                </a>
                                            {% endif %}
                                        {% endif %}
                                    </div>
                                    <div class="col-md-3">
                                        {% if test_request.invoice %}
                                            <a href="{% url 'billing:detail' test_request.invoice.id %}" class="btn btn-outline-warning w-100 mb-2">
                                                <i class="fas fa-file-invoice"></i><br>
                                                <small>View Invoice</small>
                                            </a>
                                        {% endif %}
                                    </div>
                                    <div class="col-md-3">
                                        <a href="{% url 'patients:detail' test_request.patient.id %}" class="btn btn-outline-info w-100 mb-2">
                                            <i class="fas fa-user"></i><br>
                                            <small>Patient Profile</small>
                                        </a>
                                    </div>
                                    <div class="col-md-3">
                                        {% if results %}
                                            <button class="btn btn-outline-success w-100 mb-2" onclick="window.print()">
                                                <i class="fas fa-print"></i><br>
                                                <small>Print Results</small>
                                            </button>
                                        {% else %}
                                            <button class="btn btn-outline-secondary w-100 mb-2" disabled>
                                                <i class="fas fa-print"></i><br>
                                                <small>Print Results</small>
                                            </button>
                                        {% endif %}
                                    </div>
                                </div>
                                {% if results and test_request.status == 'completed' %}
                                <div class="row mt-3">
                                    <div class="col-md-12">
                                        <a href="{% url 'laboratory:create_prescription_from_test' test_request.id %}" class="btn btn-success">
                                            <i class="fas fa-prescription"></i> Create Prescription from Results
                                        </a>
                                    </div>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Test Result Modal -->
<div class="modal fade" id="testResultModal" tabindex="-1" aria-labelledby="testResultModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="testResultModalLabel">
                    <i class="fas fa-vial"></i> Add Test Result
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="testResultModalBody">
                <!-- Form content will be loaded here -->
                <div class="text-center">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2">Loading form...</p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Robust Add Test Result Modal System
    window.openTestResultModal = function(url, testRequestId) {
        const modal = new bootstrap.Modal(document.getElementById('testResultModal'), {backdrop: 'static'});
        const modalBody = document.getElementById('testResultModalBody');
        const modalTitle = document.getElementById('testResultModalLabel');

        modalTitle.innerHTML = '<i class="fas fa-vial me-2"></i> Add Test Result - Request #' + testRequestId;
        
        // Show loading
        modalBody.innerHTML = `
            <div class="text-center p-5">
                <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-3 mb-0 text-muted">Loading test result form...</p>
            </div>
        `;
        
        modal.show();

        // Load form via AJAX with proper error handling
        fetch(url, {
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'Accept': 'text/html'
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            return response.text();
        })
        .then(html => {
            // Parse HTML and extract form
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');
            
            // Try multiple selectors for form content
            let formContent = doc.querySelector('#testResultForm, form, .card-body form');
            
            if (!formContent) {
                // Fallback: look for any form
                formContent = doc.querySelector('form');
            }
            
            if (!formContent) {
                throw new Error('Form not found in response');
            }

            // Extract main content area
            const contentArea = formContent.closest('.card-body, .container, main') || formContent;
            modalBody.innerHTML = contentArea.innerHTML;

            // Initialize form event handlers
            initializeModalForm(modalBody, url);
            
        })
        .catch(error => {
            console.error('Modal load error:', error);
            modalBody.innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    Failed to load form: ${error.message}
                    <br><small>Please <a href="${url}" target="_blank">open in new tab</a> or refresh page.</small>
                </div>
                <div class="text-center mt-4">
                    <a href="${url}" class="btn btn-primary" target="_blank">
                        <i class="fas fa-external-link-alt me-2"></i>Open Full Page
                    </a>
                </div>
            `;
        });
    };

    function initializeModalForm(modalBody, url) {
        const form = modalBody.querySelector('form');
        console.log('Initializing modal form:', form, 'URL:', url);

        if (!form) {
            console.error('Form not found in modal body!');
            return;
        }

        // Handle form submission
        form.addEventListener('submit', function(e) {
            console.log('Form submit event triggered');
            e.preventDefault();
            e.stopPropagation();
            console.log('Event prevented');
            console.log('Form id:', form.id);
            console.log('Form action:', form.action);
            console.log('Calling submitModalForm with URL:', url);
            
            // Force call submitModalForm
            if (typeof submitModalForm === 'function') {
                submitModalForm(form, url);
            } else {
                console.error('submitModalForm is not defined!');
            }
        });

        // Initialize select2 if available
        if (typeof $.fn.select2 !== 'undefined') {
            $(modalBody).find('select.select2').select2({
                theme: 'bootstrap-5',
                dropdownParent: $('#testResultModal')
            });
        }

        // Focus first input
        const firstInput = modalBody.querySelector('input, select, textarea');
        if (firstInput) firstInput.focus();
    }

    // Helper function to get CSRF token
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    window.submitModalForm = function(form, url) {
        console.log('submitModalForm called with URL:', url);
        console.log('Form element:', form);
        console.log('Form action:', form.action);
        console.log('Form method:', form.method);
        
        const formData = new FormData(form);
        const submitBtn = form.querySelector('button[type="submit"], input[type="submit"]');
        const originalText = submitBtn ? submitBtn.innerHTML : '';

        console.log('Submit button found:', submitBtn);
        console.log('Form data entries:', Array.from(formData.entries()));
        console.log('Form data as object:', Object.fromEntries(formData.entries()));

        if (submitBtn) {
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Saving...';
        }

        // Get CSRF token
        const csrftoken = getCookie('csrftoken');
        console.log('CSRF token:', csrftoken);

        console.log('Sending fetch request to:', url);
        fetch(url, {
            method: 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': csrftoken
            }
        })
        .then(response => {
            if (response.redirected) {
                // Handle redirect (success)
                window.location.href = response.url;
                return;
            }
            return response.text().then(text => {
                if (response.ok) {
                    // Try to parse as JSON first
                    try {
                        return JSON.parse(text);
                    } catch {
                        // Fallback to HTML
                        return {html: text, success: false};
                    }
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            });
        })
        .then(data => {
            if (data.success || data.redirect_url) {
                // Success - reload page
                const modal = bootstrap.Modal.getInstance(document.getElementById('testResultModal'));
                modal.hide();
                
                // Show success message
                showSuccessMessage(data.message || 'Test result saved successfully!');
                setTimeout(() => window.location.reload(), 500);
            } else {
                // Show form errors
                document.getElementById('testResultModalBody').innerHTML = data.html || data;
                initializeModalForm(document.getElementById('testResultModalBody'), url);
            }
        })
        .catch(error => {
            console.error('Form submission error:', error);
            showErrorMessage('Error saving test result. Please try again.');
        })
        .finally(() => {
            if (submitBtn) {
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalText;
            }
        });
    };

    function showSuccessMessage(message) {
        const alert = document.createElement('div');
        alert.className = 'alert alert-success alert-dismissible fade show position-fixed';
        alert.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
        alert.innerHTML = `
            <div class="d-flex">
                <i class="fas fa-check-circle me-2 mt-1"></i>
                <div>${message}</div>
                <button type="button" class="btn-close ms-auto" data-bs-dismiss="alert"></button>
            </div>
        `;
        document.body.appendChild(alert);
        setTimeout(() => alert.remove(), 3000);
    }

    function showErrorMessage(message) {
        const alert = document.createElement('div');
        alert.className = 'alert alert-danger alert-dismissible fade show position-fixed';
        alert.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
        alert.innerHTML = `
            <div class="d-flex">
                <i class="fas fa-exclamation-triangle me-2 mt-1"></i>
                <div>${message}</div>
                <button type="button" class="btn-close ms-auto" data-bs-dismiss="alert"></button>
            </div>
        `;
        document.body.appendChild(alert);
        setTimeout(() => alert.remove(), 3000);
    }
});
</script>
{% endblock %}

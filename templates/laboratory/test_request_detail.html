{% extends 'base.html' %}
{% load form_tags %}
{% load billing_tags %} {# Assuming you might create billing_tags later for invoice status #}

{% block title %}Test Request Details - Hospital Management System{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-12 mb-4">
        <!-- NHIA Exemption Alert -->
        {% if test_request.patient.is_nhia_patient %}
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            <i class="fas fa-check-circle"></i>
            <strong>NHIA Patient - Payment Exempt:</strong> This patient is exempt from laboratory test payments.
            No payment is required for this test request.
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
        {% endif %}

        <!-- NHIA Authorization Warning -->
        {% include 'includes/authorization_warning.html' with test_request=test_request %}

        <div class="card">
            <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                <h4 class="mb-0">Test Request Details</h4>
                <div>
                    {% if test_request.status == 'payment_confirmed' or test_request.status == 'sample_collected' or test_request.status == 'processing' %}
                        <a href="{% url 'laboratory:create_test_result' test_request.id %}" class="btn btn-success me-2">
                            <i class="fas fa-vial"></i> Add Test Result
                        </a>
                    {% endif %}

                    {% if test_request.status == 'awaiting_payment' and test_request.invoice %}
                        <a href="{% url 'billing:detail' test_request.invoice.id %}" class="btn btn-warning me-2">
                            <i class="fas fa-file-invoice-dollar"></i> View Invoice ({{ test_request.invoice.status|capfirst }})
                        </a>
                    {% endif %}

                    <!-- Manual result entry option for authorized users -->
                    {% if user.is_staff or user.is_superuser %}
                        <a href="{% url 'laboratory:manual_test_result_entry' test_request.id %}" class="btn btn-outline-success me-2">
                            <i class="fas fa-flask"></i> Manual Result Entry
                        </a>
                    {% endif %}
                </div>
            </div>
            <div class="card-body">
                <div class="row">
                    <!-- Request Information -->
                    <div class="col-md-6">
                        <h5 class="border-bottom pb-2 mb-3">Request Information</h5>
                        <div class="row mb-3">
                            <div class="col-md-4 text-muted">Request ID:</div>
                            <div class="col-md-8">{{ test_request.id }}</div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-4 text-muted">Request Date:</div>
                            <div class="col-md-8">{{ test_request.request_date|date:"F d, Y" }}</div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-4 text-muted">Status:</div>
                            <div class="col-md-8">
                                {% if test_request.status == 'pending' %}
                                    <span class="badge bg-secondary">Pending Initial Review</span>
                                {% elif test_request.status == 'awaiting_payment' %}
                                    <span class="badge bg-warning text-dark">Awaiting Payment</span>
                                    {% if test_request.invoice %}
                                        <a href="{% url 'billing:detail' test_request.invoice.id %}" class="badge bg-primary ms-1">View Invoice</a>
                                    {% endif %}
                                {% elif test_request.status == 'payment_confirmed' %}
                                    <span class="badge bg-success">Payment Confirmed</span>
                                {% elif test_request.status == 'sample_collected' %}
                                    <span class="badge bg-info">Sample Collected</span>
                                {% elif test_request.status == 'processing' %}
                                    <span class="badge bg-info text-dark">Processing</span>
                                {% elif test_request.status == 'completed' %}
                                    <span class="badge bg-success">Completed</span>
                                {% elif test_request.status == 'cancelled' %}
                                    <span class="badge bg-danger">Cancelled</span>
                                {% endif %}
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-4 text-muted">Priority:</div>
                            <div class="col-md-8">
                                {% if test_request.priority == 'normal' %}
                                    <span class="badge bg-success">Normal</span>
                                {% elif test_request.priority == 'urgent' %}
                                    <span class="badge bg-warning">Urgent</span>
                                {% elif test_request.priority == 'emergency' %}
                                    <span class="badge bg-danger">Emergency</span>
                                {% endif %}
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-4 text-muted">Created By:</div>
                            <div class="col-md-8">
                                {% if test_request.created_by %}
                                    {{ test_request.created_by.get_full_name|default:test_request.created_by.username|default:"Unknown" }}
                                {% else %}
                                    <span class="text-muted">Unknown</span>
                                {% endif %}
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-4 text-muted">Notes:</div>
                            <div class="col-md-8">{{ test_request.notes|default:"No notes provided." }}</div>
                        </div>

                        <!-- NHIA Authorization Status -->
                        <div class="row mb-3">
                            <div class="col-md-12">
                                {% include 'includes/authorization_status.html' with object=test_request %}
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-4 text-muted">Invoice (debug):</div>
                            <div class="col-md-8">{{ test_request.invoice }}</div>
                        </div>
                    </div>
                    
                    <!-- Patient & Doctor Information -->
                    <div class="col-md-6">
                        <h5 class="border-bottom pb-2 mb-3">Patient & Doctor Information</h5>
                        <div class="row mb-3">
                            <div class="col-md-4 text-muted">Patient:</div>
                            <div class="col-md-8">
                                <a href="{% url 'patients:detail' test_request.patient.id %}">
                                    {{ test_request.patient.get_full_name }}
                                </a>
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-4 text-muted">Patient ID:</div>
                            <div class="col-md-8">{{ test_request.patient.patient_id }}</div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-4 text-muted">Gender:</div>
                            <div class="col-md-8">{{ test_request.patient.get_gender_display }}</div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-4 text-muted">Age:</div>
                            <div class="col-md-8">{{ test_request.patient.age }} years</div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-4 text-muted">Doctor:</div>
                            <div class="col-md-8">Dr. {{ test_request.doctor.get_full_name }}</div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-4 text-muted">Department:</div>
                            <div class="col-md-8">{{ test_request.doctor.profile.department|default:"Not specified" }}</div>
                        </div>
                    </div>
                </div>
                
                <!-- Requested Tests -->
                <div class="row mt-4">
                    <div class="col-md-12">
                        <h5 class="border-bottom pb-2 mb-3">Requested Tests</h5>
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead class="table-light">
                                    <tr>
                                        <th>Test Name</th>
                                        <th>Category</th>
                                        <th>Price</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for test_obj in tests %}
                                        <tr>
                                            <td>{{ test_obj.name }}</td>
                                            <td>{{ test_obj.category.name|default:"N/A" }}</td>
                                            <td>₦{{ test_obj.price|floatformat:2 }}</td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                                <tfoot>
                                    <tr class="table-primary fw-bold">
                                        <td colspan="2" class="text-end">Total Estimated Price:</td>
                                        <td>₦{{ test_request.get_total_price|floatformat:2 }}</td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    </div>
                </div>
                
                <!-- Test Results -->
                <div class="row mt-4">
                    <div class="col-md-12">
                        <div class="d-flex justify-content-between align-items-center border-bottom pb-2 mb-3">
                            <h5 class="mb-0">Test Results</h5>
                            <div>
                                {% if test_request.status != 'cancelled' %}
                                    <div class="btn-group" role="group">
                                        {% if user.is_staff or user.is_superuser %}
                                            <button type="button" class="btn btn-sm btn-success" onclick="openTestResultModal('{% url 'laboratory:manual_test_result_entry' test_request.id %}', true)">
                                                <i class="fas fa-plus"></i> Add Test Result
                                            </button>
                                            <div class="btn-group" role="group">
                                                <button type="button" class="btn btn-sm btn-success dropdown-toggle dropdown-toggle-split" data-bs-toggle="dropdown" aria-expanded="false">
                                                    <span class="visually-hidden">Toggle Dropdown</span>
                                                </button>
                                                <ul class="dropdown-menu">
                                                    <li><a class="dropdown-item" href="#" onclick="openTestResultModal('{% url 'laboratory:manual_test_result_entry' test_request.id %}', true)">
                                                        <i class="fas fa-window-restore"></i> Quick Entry (Modal)
                                                    </a></li>
                                                    <li><a class="dropdown-item" href="{% url 'laboratory:manual_test_result_entry' test_request.id %}">
                                                        <i class="fas fa-external-link-alt"></i> Full Page Entry
                                                    </a></li>
                                                </ul>
                                            </div>
                                        {% else %}
                                            <button type="button" class="btn btn-sm btn-success" onclick="openTestResultModal('{% url 'laboratory:create_test_result' test_request.id %}', false)">
                                                <i class="fas fa-plus"></i> Add Test Result
                                            </button>
                                            <div class="btn-group" role="group">
                                                <button type="button" class="btn btn-sm btn-success dropdown-toggle dropdown-toggle-split" data-bs-toggle="dropdown" aria-expanded="false">
                                                    <span class="visually-hidden">Toggle Dropdown</span>
                                                </button>
                                                <ul class="dropdown-menu">
                                                    <li><a class="dropdown-item" href="#" onclick="openTestResultModal('{% url 'laboratory:create_test_result' test_request.id %}', false)">
                                                        <i class="fas fa-window-restore"></i> Quick Entry (Modal)
                                                    </a></li>
                                                    <li><a class="dropdown-item" href="{% url 'laboratory:create_test_result' test_request.id %}">
                                                        <i class="fas fa-external-link-alt"></i> Full Page Entry
                                                    </a></li>
                                                </ul>
                                            </div>
                                        {% endif %}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        {% if results %}
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>Test</th>
                                            <th>Result Date</th>
                                            <th>Sample Collection</th>
                                            <th>Performed By</th>
                                            <th>Verified By</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for result in results %}
                                            <tr>
                                                <td>{{ result.test.name }}</td>
                                                <td>{{ result.result_date|date:"M d, Y" }}</td>
                                                <td>
                                                    {% if result.sample_collection_date %}
                                                        {{ result.sample_collection_date|date:"M d, Y" }}
                                                        <div class="small text-muted">({{ result.sample_collection_date|timesince }} ago)</div>
                                                    {% else %}
                                                        <span class="text-muted">Not yet collected</span>
                                                    {% endif %}
                                                </td>
                                                <td>{{ result.performed_by.get_full_name }}</td>
                                                <td>{{ result.verified_by.get_full_name }}</td>
                                                <td>
                                                    <a href="{% url 'laboratory:result_detail' result.id %}" class="btn btn-sm btn-primary">
                                                        <i class="fas fa-eye"></i> View
                                                    </a>
                                                    {# Add other action buttons if needed, e.g., Edit, Print #}
                                                </td>
                                            </tr>
                                        {% endfor %}
                                    </tbody>
                        {% else %}
                            <div class="text-center py-4">
                                <div class="mb-3">
                                    <i class="fas fa-vial fa-3x text-muted"></i>
                                </div>
                                <h6 class="text-muted">No test results available</h6>
                                <p class="text-muted mb-3">Test results will appear here once they are entered by laboratory staff.</p>
                                {% if test_request.status != 'cancelled' %}
                                    <div class="btn-group" role="group">
                                        {% if user.is_staff or user.is_superuser %}
                                            <button type="button" class="btn btn-primary" onclick="openTestResultModal('{% url 'laboratory:manual_test_result_entry' test_request.id %}', true)">
                                                <i class="fas fa-plus"></i> Add First Test Result
                                            </button>
                                            <div class="btn-group" role="group">
                                                <button type="button" class="btn btn-primary dropdown-toggle dropdown-toggle-split" data-bs-toggle="dropdown" aria-expanded="false">
                                                    <span class="visually-hidden">Toggle Dropdown</span>
                                                </button>
                                                <ul class="dropdown-menu">
                                                    <li><a class="dropdown-item" href="#" onclick="openTestResultModal('{% url 'laboratory:manual_test_result_entry' test_request.id %}', true)">
                                                        <i class="fas fa-window-restore"></i> Quick Entry (Modal)
                                                    </a></li>
                                                    <li><a class="dropdown-item" href="{% url 'laboratory:manual_test_result_entry' test_request.id %}">
                                                        <i class="fas fa-external-link-alt"></i> Full Page Entry
                                                    </a></li>
                                                </ul>
                                            </div>
                                        {% else %}
                                            <button type="button" class="btn btn-primary" onclick="openTestResultModal('{% url 'laboratory:create_test_result' test_request.id %}', false)">
                                                <i class="fas fa-plus"></i> Add First Test Result
                                            </button>
                                            <div class="btn-group" role="group">
                                                <button type="button" class="btn btn-primary dropdown-toggle dropdown-toggle-split" data-bs-toggle="dropdown" aria-expanded="false">
                                                    <span class="visually-hidden">Toggle Dropdown</span>
                                                </button>
                                                <ul class="dropdown-menu">
                                                    <li><a class="dropdown-item" href="#" onclick="openTestResultModal('{% url 'laboratory:create_test_result' test_request.id %}', false)">
                                                        <i class="fas fa-window-restore"></i> Quick Entry (Modal)
                                                    </a></li>
                                                    <li><a class="dropdown-item" href="{% url 'laboratory:create_test_result' test_request.id %}">
                                                        <i class="fas fa-external-link-alt"></i> Full Page Entry
                                                    </a></li>
                                                </ul>
                                            </div>
                                        {% endif %}
                                    </div>
                                {% endif %}
                            </div>
                        {% endif %}
                    </div>
                </div>

                <!-- Related Prescriptions -->
                {% if test_request.patient.prescriptions.exists %}
                <div class="row mt-4">
                    <div class="col-md-12">
                        <h5 class="border-bottom pb-2 mb-3">Related Prescriptions</h5>
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Prescription ID</th>
                                        <th>Date</th>
                                        <th>Doctor</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for prescription in test_request.patient.prescriptions.all|slice:":5" %}
                                    <tr>
                                        <td>{{ prescription.id }}</td>
                                        <td>{{ prescription.prescription_date|date:"M d, Y" }}</td>
                                        <td>Dr. {{ prescription.doctor.get_full_name }}</td>
                                        <td>
                                            {% if prescription.status == 'pending' %}
                                                <span class="badge bg-warning">Pending</span>
                                            {% elif prescription.status == 'approved' %}
                                                <span class="badge bg-info">Approved</span>
                                            {% elif prescription.status == 'dispensed' %}
                                                <span class="badge bg-success">Dispensed</span>
                                            {% elif prescription.status == 'cancelled' %}
                                                <span class="badge bg-danger">Cancelled</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <a href="{% url 'pharmacy:prescription_detail' prescription.id %}" class="btn btn-sm btn-primary">
                                                <i class="fas fa-eye"></i> View
                                            </a>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                {% endif %}

                <!-- Quick Actions -->
                <div class="row mt-4">
                    <div class="col-md-12">
                        <div class="card bg-light">
                            <div class="card-header">
                                <h6 class="mb-0"><i class="fas fa-bolt"></i> Quick Actions</h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-3">
                                        {% if test_request.status != 'cancelled' %}
                                            {% if user.is_staff or user.is_superuser %}
                                                <button type="button" class="btn btn-outline-primary w-100 mb-2" onclick="openTestResultModal('{% url 'laboratory:manual_test_result_entry' test_request.id %}', true)">
                                                    <i class="fas fa-vial"></i><br>
                                                    <small>Add Test Result</small>
                                                </button>
                                            {% else %}
                                                <button type="button" class="btn btn-outline-primary w-100 mb-2" onclick="openTestResultModal('{% url 'laboratory:create_test_result' test_request.id %}', false)">
                                                    <i class="fas fa-vial"></i><br>
                                                    <small>Add Test Result</small>
                                                </button>
                                            {% endif %}
                                        {% endif %}
                                    </div>
                                    <div class="col-md-3">
                                        {% if test_request.invoice %}
                                            <a href="{% url 'billing:detail' test_request.invoice.id %}" class="btn btn-outline-warning w-100 mb-2">
                                                <i class="fas fa-file-invoice"></i><br>
                                                <small>View Invoice</small>
                                            </a>
                                        {% endif %}
                                    </div>
                                    <div class="col-md-3">
                                        <a href="{% url 'patients:detail' test_request.patient.id %}" class="btn btn-outline-info w-100 mb-2">
                                            <i class="fas fa-user"></i><br>
                                            <small>Patient Profile</small>
                                        </a>
                                    </div>
                                    <div class="col-md-3">
                                        {% if results %}
                                            <button class="btn btn-outline-success w-100 mb-2" onclick="window.print()">
                                                <i class="fas fa-print"></i><br>
                                                <small>Print Results</small>
                                            </button>
                                        {% else %}
                                            <button class="btn btn-outline-secondary w-100 mb-2" disabled>
                                                <i class="fas fa-print"></i><br>
                                                <small>Print Results</small>
                                            </button>
                                        {% endif %}
                                    </div>
                                </div>
                                {% if results and test_request.status == 'completed' %}
                                <div class="row mt-3">
                                    <div class="col-md-12">
                                        <a href="{% url 'laboratory:create_prescription_from_test' test_request.id %}" class="btn btn-success">
                                            <i class="fas fa-prescription"></i> Create Prescription from Results
                                        </a>
                                    </div>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Test Result Modal -->
<div class="modal fade" id="testResultModal" tabindex="-1" aria-labelledby="testResultModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="testResultModalLabel">
                    <i class="fas fa-vial"></i> Add Test Result
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="testResultModalBody">
                <!-- Form content will be loaded here -->
                <div class="text-center">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2">Loading form...</p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Function to open test result modal
    window.openTestResultModal = function(url, isManualEntry = false) {
        const modal = new bootstrap.Modal(document.getElementById('testResultModal'));
        const modalBody = document.getElementById('testResultModalBody');
        const modalTitle = document.getElementById('testResultModalLabel');

        // Update modal title based on entry type
        if (isManualEntry) {
            modalTitle.innerHTML = '<i class="fas fa-flask"></i> Manual Test Result Entry';
        } else {
            modalTitle.innerHTML = '<i class="fas fa-vial"></i> Add Test Result';
        }

        // Show loading spinner
        modalBody.innerHTML = `
            <div class="text-center">
                <div class="spinner-border" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-2">Loading form...</p>
            </div>
        `;

        modal.show();

        // Load form content via AJAX
        fetch(url)
            .then(response => response.text())
            .then(html => {
                // Extract form content from the response
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                const formContent = doc.querySelector('.card-body form');
                const alertContent = doc.querySelector('.alert');

                if (formContent) {
                    let modalContent = '';

                    // Add alert if present
                    if (alertContent) {
                        modalContent += alertContent.outerHTML;
                    }

                    // Add form
                    modalContent += formContent.outerHTML;

                    modalBody.innerHTML = modalContent;

                    // Initialize select2 for the modal form
                    $(modalBody).find('.select2').select2({
                        theme: 'bootstrap-5',
                        width: '100%',
                        dropdownParent: $('#testResultModal')
                    });

                    // Handle form submission
                    const form = modalBody.querySelector('form');
                    if (form) {
                        form.addEventListener('submit', function(e) {
                            e.preventDefault();
                            submitTestResultForm(form, url);
                        });
                    }
                } else {
                    modalBody.innerHTML = '<div class="alert alert-danger">Error loading form. Please try again.</div>';
                }
            })
            .catch(error => {
                console.error('Error loading form:', error);
                modalBody.innerHTML = '<div class="alert alert-danger">Error loading form. Please try again.</div>';
            });
    };

    // Function to submit test result form via AJAX
    function submitTestResultForm(form, url) {
        const formData = new FormData(form);
        const submitBtn = form.querySelector('button[type="submit"]');
        const originalText = submitBtn.innerHTML;

        // Show loading state
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
        submitBtn.disabled = true;

        fetch(url, {
            method: 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Close modal and reload page
                bootstrap.Modal.getInstance(document.getElementById('testResultModal')).hide();

                // Show success message
                const alertDiv = document.createElement('div');
                alertDiv.className = 'alert alert-success alert-dismissible fade show';
                alertDiv.innerHTML = `
                    <i class="fas fa-check-circle"></i> ${data.message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                `;
                document.querySelector('.container-fluid').insertBefore(alertDiv, document.querySelector('.row'));

                // Reload page to show updated results
                setTimeout(() => {
                    window.location.reload();
                }, 1500);
            } else {
                // Show form with errors
                const modalBody = document.getElementById('testResultModalBody');
                modalBody.innerHTML = data.form_html;

                // Reinitialize select2
                $(modalBody).find('.select2').select2({
                    theme: 'bootstrap-5',
                    width: '100%',
                    dropdownParent: $('#testResultModal')
                });

                // Reattach form submission handler
                const newForm = modalBody.querySelector('form');
                if (newForm) {
                    newForm.addEventListener('submit', function(e) {
                        e.preventDefault();
                        submitTestResultForm(newForm, url);
                    });
                }
            }
        })
        .catch(error => {
            console.error('Error submitting form:', error);
            submitBtn.innerHTML = originalText;
            submitBtn.disabled = false;

            // Show error message
            const errorDiv = document.createElement('div');
            errorDiv.className = 'alert alert-danger';
            errorDiv.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Error submitting form. Please try again.';
            form.insertBefore(errorDiv, form.firstChild);
        });
    }
});
</script>
{% endblock %}

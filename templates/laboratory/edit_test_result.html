{% extends 'base.html' %}
{% load form_tags %}

{% block title %}{{ title }} - Hospital Management System{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-12 mb-4">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h4 class="mb-0">{{ title }}</h4>
            </div>
            <div class="card-body">
                <!-- Test Result Information -->
                <div class="card mb-4">
                    <div class="card-header bg-light">
                        <h5 class="mb-0">Test Information</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="row mb-3">
                                    <div class="col-md-4 text-muted">Test:</div>
                                    <div class="col-md-8">{{ result.test.name }}</div>
                                </div>
                                <div class="row mb-3">
                                    <div class="col-md-4 text-muted">Category:</div>
                                    <div class="col-md-8">{{ result.test.category.name }}</div>
                                </div>
                                <div class="row mb-3">
                                    <div class="col-md-4 text-muted">Sample Type:</div>
                                    <div class="col-md-8">{{ result.test.sample_type }}</div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="row mb-3">
                                    <div class="col-md-4 text-muted">Patient:</div>
                                    <div class="col-md-8">
                                        <a href="{% url 'patients:detail' result.test_request.patient.id %}">
                                            {{ result.test_request.patient.get_full_name }}
                                        </a>
                                    </div>
                                </div>
                                <div class="row mb-3">
                                    <div class="col-md-4 text-muted">Patient ID:</div>
                                    <div class="col-md-8">{{ result.test_request.patient.patient_id }}</div>
                                </div>
                                <div class="row mb-3">
                                    <div class="col-md-4 text-muted">Doctor:</div>
                                    <div class="col-md-8">Dr. {{ result.test_request.doctor.get_full_name }}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Test Result Form -->
                <form method="post" enctype="multipart/form-data">
                    {% csrf_token %}
                    
                    {{ form.management_form }}
                    {{ form.test }} {# Hidden test field for edit mode #}
                    {# Error summary block for all errors #}
                    {% if form.errors or parameter_formset.non_form_errors or parameter_formset.errors %}
                        <div class="alert alert-danger">
                            <strong>Please correct the errors below:</strong>
                            <ul class="mb-0">
                                {# Main form non-field errors #}
                                {% for error in form.non_field_errors %}
                                    <li>{{ error }}</li>
                                {% endfor %}
                                {# Main form field errors #}
                                {% for field in form.visible_fields %}
                                    {% for error in field.errors %}
                                        <li>{{ field.label }}: {{ error }}</li>
                                    {% endfor %}
                                {% endfor %}
                                {# Parameter formset non-form errors #}
                                {% for error in parameter_formset.non_form_errors %}
                                    <li>{{ error }}</li>
                                {% endfor %}
                                {# Parameter formset field errors #}
                                {% for param_form in parameter_formset.forms %}
                                    {% for field in param_form.visible_fields %}
                                        {% for error in field.errors %}
                                            <li>Parameter {{ forloop.parentloop.counter }} - {{ field.label }}: {{ error }}</li>
                                        {% endfor %}
                                    {% endfor %}
                                {% endfor %}
                            </ul>
                        </div>
                    {% endif %}
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="{{ form.result_date.id_for_label }}" class="form-label">Result Date</label>
                            {{ form.result_date|add_class:"form-control" }}
                            {% if form.result_date.errors %}
                                <div class="text-danger">
                                    {{ form.result_date.errors }}
                                </div>
                            {% endif %}
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="{{ form.sample_collection_date.id_for_label }}" class="form-label">Sample Collection Date & Time</label>
                            {{ form.sample_collection_date|add_class:"form-control" }}
                            {% if form.sample_collection_date.errors %}
                                <div class="text-danger">
                                    {{ form.sample_collection_date.errors }}
                                </div>
                            {% endif %}
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="{{ form.sample_collected_by.id_for_label }}" class="form-label">Sample Collected By</label>
                            {{ form.sample_collected_by|add_class:"form-select select2" }}
                            {% if form.sample_collected_by.errors %}
                                <div class="text-danger">
                                    {{ form.sample_collected_by.errors }}
                                </div>
                            {% endif %}
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="{{ form.performed_by.id_for_label }}" class="form-label">Performed By</label>
                            {{ form.performed_by|add_class:"form-select select2" }}
                            {% if form.performed_by.errors %}
                                <div class="text-danger">
                                    {{ form.performed_by.errors }}
                                </div>
                            {% endif %}
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="{{ form.verified_by.id_for_label }}" class="form-label">Verified By</label>
                            {{ form.verified_by|add_class:"form-select select2" }}
                            {% if form.verified_by.errors %}
                                <div class="text-danger">
                                    {{ form.verified_by.errors }}
                                </div>
                            {% endif %}
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="{{ form.result_file.id_for_label }}" class="form-label">Result File (Optional)</label>
                            {{ form.result_file|add_class:"form-control" }}
                            {% if form.result_file.errors %}
                                <div class="text-danger">
                                    {{ form.result_file.errors }}
                                </div>
                            {% endif %}
                            {% if result.result_file %}
                                <div class="form-text">
                                    Current file: <a href="{{ result.result_file.url }}" target="_blank">{{ result.result_file.name }}</a>
                                </div>
                            {% endif %}
                        </div>
                        
                        <div class="col-md-12 mb-3">
                            <label for="{{ form.notes.id_for_label }}" class="form-label">Notes</label>
                            {{ form.notes|add_class:"form-control" }}
                            {% if form.notes.errors %}
                                <div class="text-danger">
                                    {{ form.notes.errors }}
                                </div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <!-- Test Parameters -->
                    <div class="card mt-4">
                        <div class="card-header bg-light d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">Test Parameters</h5>
                            <button type="button" class="btn btn-sm btn-success" data-bs-toggle="modal" data-bs-target="#addParameterModal">
                                <i class="fas fa-plus"></i> Add Parameter
                            </button>
                        </div>
                        <div class="card-body">
                            {{ parameter_formset.management_form }}
                            {% if parameter_formset.non_form_errors %}
                                <div class="alert alert-danger">
                                    {{ parameter_formset.non_form_errors }}
                                </div>
                            {% endif %}

                            <div class="table-responsive">
                                <table class="table table-sm table-bordered">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Parameter</th>
                                            <th>Value</th>
                                            <th>Normal Range</th>
                                            <th>Unit</th>
                                            <th>Is Normal?</th>
                                            <th>Notes</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for param_form in parameter_formset %}
                                            <tr>
                                                <td>
                                                    {{ param_form.id }} {# Hidden ID field for the parameter form #}
                                                    {{ param_form.parameter.as_hidden }} {# Hidden, as it's not editable #}
                                                    <strong>{{ param_form.instance.parameter.name }}</strong>
                                                    {% if param_form.parameter.errors %}<div class="text-danger small">{{ param_form.parameter.errors|join:", " }}</div>{% endif %}
                                                </td>
                                                <td>
                                                    {{ param_form.value }}
                                                    {% if param_form.value.errors %}<div class="text-danger small">{{ param_form.value.errors|join:", " }}</div>{% endif %}
                                                </td>
                                                <td>{{ param_form.instance.parameter.normal_range|default:"N/A" }}</td>
                                                <td>{{ param_form.instance.parameter.unit|default:"N/A" }}</td>
                                                <td>
                                                    {{ param_form.is_normal }}
                                                    {% if param_form.is_normal.errors %}<div class="text-danger small">{{ param_form.is_normal.errors|join:", " }}</div>{% endif %}
                                                </td>
                                                <td>
                                                    {{ param_form.notes }}
                                                    {% if param_form.notes.errors %}<div class="text-danger small">{{ param_form.notes.errors|join:", " }}</div>{% endif %}
                                                </td>
                                            </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    
                    <div class="d-flex justify-content-between mt-4">
                        <a href="{% url 'laboratory:result_detail' result.id %}" class="btn btn-secondary">
                            <i class="fas fa-arrow-left"></i> Back to Result
                        </a>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save"></i> Save Test Result
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Add Parameter Modal -->
<div class="modal fade" id="addParameterModal" tabindex="-1" aria-labelledby="addParameterModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="addParameterModalLabel">
                    <i class="fas fa-plus-circle"></i> Add New Parameter
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="addParameterForm">
                <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
                    {% csrf_token %}

                    <!-- Parameter Selection Tabs -->
                    <ul class="nav nav-tabs mb-4" id="parameterTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="predefined-tab" data-bs-toggle="tab" data-bs-target="#predefined" type="button" role="tab" aria-controls="predefined" aria-selected="true">
                                <i class="fas fa-list me-1"></i> Select Existing Parameter
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="custom-tab" data-bs-toggle="tab" data-bs-target="#custom" type="button" role="tab" aria-controls="custom" aria-selected="false">
                                <i class="fas fa-plus me-1"></i> Add Custom Parameter
                            </button>
                        </li>
                    </ul>

                    <div class="tab-content" id="parameterTabContent">
                        <!-- Predefined Parameters Tab -->
                        <div class="tab-pane fade show active" id="predefined" role="tabpanel" aria-labelledby="predefined-tab">
                            <div class="mb-4">
                                <label for="predefined_parameter" class="form-label fw-bold">
                                    Select Parameter <span class="text-danger">*</span>
                                </label>
                                <select class="form-select form-select-lg" id="predefined_parameter" name="predefined_parameter">
                                    <option value="">Loading parameters...</option>
                                </select>
                                <div class="form-text mt-2">
                                    <i class="fas fa-info-circle me-1"></i> Choose from predefined parameters for this test
                                </div>
                            </div>

                            <!-- Parameter Info Display -->
                            <div id="parameter_info" class="alert alert-info d-none mb-4">
                                <h6 class="alert-heading mb-2">
                                    <i class="fas fa-info-circle"></i> Parameter Information
                                </h6>
                                <div class="row">
                                    <div class="col-md-6">
                                        <strong>Unit:</strong> <span id="info_unit" class="text-muted">-</span>
                                    </div>
                                    <div class="col-md-6">
                                        <strong>Normal Range:</strong> <span id="info_range" class="text-muted">-</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Custom Parameter Tab -->
                        <div class="tab-pane fade" id="custom" role="tabpanel" aria-labelledby="custom-tab">
                            <div class="mb-3">
                                <label for="custom_parameter_name" class="form-label fw-bold">
                                    Parameter Name <span class="text-danger">*</span>
                                </label>
                                <input type="text" class="form-control" id="custom_parameter_name" name="custom_parameter_name" placeholder="Enter parameter name (e.g., Hemoglobin, WBC Count)">
                            </div>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="custom_parameter_unit" class="form-label">Unit</label>
                                    <input type="text" class="form-control" id="custom_parameter_unit" name="custom_parameter_unit" placeholder="e.g., mg/dL, mmol/L, g/dL">
                                    <div class="form-text mt-1">
                                        <small>Measurement unit (optional)</small>
                                    </div>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="custom_parameter_range" class="form-label">Normal Range</label>
                                    <input type="text" class="form-control" id="custom_parameter_range" name="custom_parameter_range" placeholder="e.g., 70-100, <5.0">
                                    <div class="form-text mt-1">
                                        <small>Reference range (optional)</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Common Fields -->
                    <hr class="my-4">
                    <h6 class="mb-3">
                        <i class="fas fa-clipboard-check"></i> Result Details
                    </h6>

                    <div class="mb-4">
                        <label for="parameter_value" class="form-label fw-bold">
                            Result Value <span class="text-danger">*</span>
                        </label>
                        <input type="text" class="form-control form-control-lg" id="parameter_value" name="parameter_value" required placeholder="e.g., 120, Positive, Negative">
                        <small class="form-text text-muted d-block mt-2">
                            Enter the measured value for this parameter
                        </small>
                    </div>

                    <div class="mb-4">
                        <label for="is_normal" class="form-label fw-bold">Status</label>
                        <select class="form-select" id="is_normal" name="is_normal">
                            <option value="true" selected>Normal</option>
                            <option value="false">Abnormal</option>
                        </select>
                        <small class="form-text text-muted d-block mt-2">
                            Whether result is within normal limits
                        </small>
                    </div>

                    <div class="mb-3">
                        <label for="notes" class="form-label">Notes (Optional)</label>
                        <textarea class="form-control" id="notes" name="notes" rows="3" placeholder="Add clinical observations or interpretations"></textarea>
                        <small class="form-text text-muted d-block mt-2">
                            Additional observations or comments
                        </small>
                    </div>
                </div>
                <div class="modal-footer bg-light">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-1"></i> Cancel
                    </button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-plus me-1"></i> Add Parameter
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
    /* Modal z-index improvements */
    #addParameterModal {
        z-index: 1060 !important;
    }

    .modal-backdrop {
        z-index: 1055 !important;
    }

    .modal-backdrop.show {
        opacity: 0.1 !important;
        z-index: 1055 !important;
        background-color: #000 !important;
    }

    #addParameterModal .modal-dialog {
        z-index: 1061 !important;
        position: relative;
    }

    /* Ensure modal content is above backdrop */
    #addParameterModal .modal-content {
        position: relative;
        z-index: 1062 !important;
        box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.5) !important;
        background-color: #fff !important;
    }

    /* Hide/lower z-index of page elements when modal is open */
    .modal-open #accordionSidebar,
    .modal-open .sidebar,
    .modal-open .topbar,
    .modal-open .navbar,
    .modal-open nav:not(#addParameterModal nav),
    .modal-open header {
        z-index: 1 !important;
        position: relative;
    }

    /* Prevent ALL background content from interfering */
    .modal-open #wrapper,
    .modal-open #content-wrapper,
    .modal-open .page-content,
    .modal-open .container-fluid:not(#addParameterModal .container-fluid),
    .modal-open .card:not(#addParameterModal .card),
    .modal-open .card-body:not(#addParameterModal .card-body),
    .modal-open form:not(#addParameterForm),
    .modal-open .form-control:not(#addParameterModal .form-control),
    .modal-open .form-select:not(#addParameterModal .form-select),
    .modal-open input:not(#addParameterModal input),
    .modal-open select:not(#addParameterModal select),
    .modal-open textarea:not(#addParameterModal textarea),
    .modal-open button:not(#addParameterModal button),
    .modal-open .btn:not(#addParameterModal .btn),
    .modal-open table:not(#addParameterModal table) {
        pointer-events: none !important;
    }

    /* Ensure ONLY modal elements are interactive */
    #addParameterModal,
    #addParameterModal *,
    #addParameterModal .form-control,
    #addParameterModal .form-select,
    #addParameterModal button,
    #addParameterModal input,
    #addParameterModal textarea,
    #addParameterModal select,
    #addParameterModal .nav-link,
    #addParameterModal .btn,
    #addParameterModal .btn-close,
    #addParameterModal a {
        pointer-events: auto !important;
        position: relative;
    }

    /* Select2 dropdown positioning - ensure main form Select2 is below modal */
    .select2-container {
        z-index: auto !important;
    }

    .select2-container--open {
        z-index: auto !important;
    }

    .select2-dropdown {
        z-index: auto !important;
    }

    /* When modal is open, force all Select2 elements outside modal to be below */
    .modal-open .select2-container:not(#addParameterModal .select2-container) {
        z-index: 1 !important;
    }

    .modal-open .select2-container--open:not(#addParameterModal .select2-container--open) {
        z-index: 1 !important;
    }

    .modal-open .select2-dropdown {
        z-index: 1 !important;
    }

    /* Select2 inside modal should be above modal content */
    #addParameterModal .select2-container {
        z-index: 1065 !important;
    }

    #addParameterModal .select2-container--open {
        z-index: 1065 !important;
    }

    #addParameterModal .select2-dropdown {
        z-index: 1065 !important;
    }

    /* Modal Improvements */
    #addParameterModal .modal-body {
        padding: 1.5rem;
        background-color: #fff !important;
    }

    #addParameterModal .modal-header,
    #addParameterModal .modal-footer {
        background-color: #fff !important;
    }

    #addParameterModal .form-text,
    #addParameterModal small.form-text {
        display: block !important;
        color: #6c757d !important;
        font-size: 0.8rem !important;
        line-height: 1.5 !important;
        margin-top: 0.5rem !important;
        clear: both !important;
        padding: 0 !important;
        background: transparent !important;
    }

    /* Ensure proper spacing for form groups */
    #addParameterModal .mb-3,
    #addParameterModal .mb-4 {
        margin-bottom: 1.5rem !important;
        clear: both;
    }

    /* Clean placeholder styling */
    #addParameterModal input::placeholder,
    #addParameterModal textarea::placeholder {
        color: #adb5bd;
        font-style: italic;
        opacity: 0.7;
    }

    #addParameterModal .nav-tabs {
        border-bottom: 2px solid #dee2e6;
    }

    #addParameterModal .nav-tabs .nav-link {
        color: #495057;
        font-weight: 500;
        padding: 0.75rem 1.25rem;
        border: none;
        border-bottom: 3px solid transparent;
        transition: all 0.3s ease;
    }

    #addParameterModal .nav-tabs .nav-link:hover {
        border-bottom-color: #0d6efd;
        color: #0d6efd;
    }

    #addParameterModal .nav-tabs .nav-link.active {
        color: #0d6efd;
        background-color: transparent;
        border-bottom-color: #0d6efd;
        font-weight: 600;
    }

    #addParameterModal .tab-content {
        padding-top: 1rem;
        min-height: 150px;
    }

    #addParameterModal .form-label.fw-bold {
        color: #212529;
        font-size: 0.95rem;
        margin-bottom: 0.5rem;
    }

    #addParameterModal .form-control,
    #addParameterModal .form-select {
        border-radius: 0.375rem;
        border: 1px solid #ced4da;
        transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
    }

    #addParameterModal .form-control:focus,
    #addParameterModal .form-select:focus {
        border-color: #86b7fe;
        box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
    }

    #addParameterModal .form-control-lg {
        padding: 0.75rem 1rem;
        font-size: 1.1rem;
    }

    #addParameterModal hr {
        border-top: 2px solid #e9ecef;
        opacity: 1;
    }

    #addParameterModal textarea.form-control {
        resize: vertical;
        min-height: 80px;
    }

    /* Alert styling in modal */
    #addParameterModal .alert-info {
        background-color: #e7f3ff;
        border-color: #b3d9ff;
        color: #004085;
    }

    #addParameterModal .alert-heading {
        font-size: 0.9rem;
        font-weight: 600;
        margin-bottom: 0.5rem;
    }

    /* Table styling improvements */
    .table-responsive {
        border-radius: 0.375rem;
        overflow: hidden;
    }

    .table-sm th {
        font-weight: 600;
        font-size: 0.875rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        background-color: #f8f9fa;
        padding: 0.75rem 0.5rem;
    }

    .table-sm td {
        vertical-align: middle;
        padding: 0.75rem 0.5rem;
    }

    .table-sm input[type="text"],
    .table-sm textarea,
    .table-sm select {
        font-size: 0.875rem;
        padding: 0.375rem 0.5rem;
        width: 100%;
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize select2 for dropdowns
        $('.select2').select2({
            theme: 'bootstrap-5',
            width: '100%'
        });

        // Variables for modal handling
        const addParameterForm = document.getElementById('addParameterForm');
        const addParameterModal = new bootstrap.Modal(document.getElementById('addParameterModal'));
        const predefinedSelect = document.getElementById('predefined_parameter');
        const parameterInfo = document.getElementById('parameter_info');

        // Load predefined parameters when modal is shown
        document.getElementById('addParameterModal').addEventListener('show.bs.modal', function() {
            loadPredefinedParameters();
        });

        // Function to load predefined parameters
        function loadPredefinedParameters() {
            const testId = {{ result.test.id }};
            const resultId = {{ result.id }};

            fetch(`/laboratory/api/tests/${testId}/parameters/?result_id=${resultId}`)
                .then(response => response.json())
                .then(data => {
                    predefinedSelect.innerHTML = '<option value="">Select a parameter...</option>';

                    if (data.parameters && data.parameters.length > 0) {
                        data.parameters.forEach(param => {
                            const option = document.createElement('option');
                            option.value = JSON.stringify(param);
                            option.textContent = param.name;
                            predefinedSelect.appendChild(option);
                        });
                    } else {
                        predefinedSelect.innerHTML = '<option value="">No available parameters (all added or none defined)</option>';
                    }
                })
                .catch(error => {
                    console.error('Error loading parameters:', error);
                    predefinedSelect.innerHTML = '<option value="">Error loading parameters</option>';
                });
        }

        // Handle predefined parameter selection
        predefinedSelect.addEventListener('change', function() {
            if (this.value) {
                const param = JSON.parse(this.value);

                // Show parameter info
                document.getElementById('info_unit').textContent = param.unit || 'Not specified';
                document.getElementById('info_range').textContent = param.normal_range || 'Not specified';
                parameterInfo.classList.remove('d-none');

                // Focus on value input
                document.getElementById('parameter_value').focus();
            } else {
                parameterInfo.classList.add('d-none');
            }
        });

        // Handle form submission
        addParameterForm.addEventListener('submit', function(e) {
            e.preventDefault();

            const activeTab = document.querySelector('#parameterTabs .nav-link.active').id;
            const formData = new FormData();

            // Add CSRF token
            formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);

            // Determine parameter source and collect data
            if (activeTab === 'predefined-tab' && predefinedSelect.value) {
                const param = JSON.parse(predefinedSelect.value);
                formData.append('parameter_name', param.name);
                formData.append('parameter_unit', param.unit || '');
                formData.append('parameter_range', param.normal_range || '');
            } else if (activeTab === 'custom-tab') {
                const customName = document.getElementById('custom_parameter_name').value;
                if (!customName.trim()) {
                    alert('Please enter a parameter name for custom parameter.');
                    return;
                }
                formData.append('parameter_name', customName);
                formData.append('parameter_unit', document.getElementById('custom_parameter_unit').value);
                formData.append('parameter_range', document.getElementById('custom_parameter_range').value);
            } else {
                alert('Please select a parameter or switch to custom parameter tab.');
                return;
            }

            // Add common fields
            formData.append('parameter_value', document.getElementById('parameter_value').value);
            formData.append('is_normal', document.getElementById('is_normal').value);
            formData.append('notes', document.getElementById('notes').value);

            const submitBtn = addParameterForm.querySelector('button[type="submit"]');
            const originalHTML = submitBtn.innerHTML;

            // Show loading state
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Adding...';

            fetch('{% url "laboratory:add_result_parameter" result.id %}', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Show success message
                    const alertDiv = document.createElement('div');
                    alertDiv.className = 'alert alert-success alert-dismissible fade show';
                    alertDiv.innerHTML = `
                        ${data.message}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    `;
                    document.querySelector('.card-body').insertBefore(alertDiv, document.querySelector('.card-body').firstChild);

                    // Close modal and reset form
                    addParameterModal.hide();
                    resetModalForm();

                    // Reload the page to show the new parameter
                    setTimeout(() => {
                        window.location.reload();
                    }, 1500);
                } else {
                    alert('Error: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred while adding the parameter.');
            })
            .finally(() => {
                // Reset button state
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalHTML;
            });
        });

        // Function to reset modal form
        function resetModalForm() {
            addParameterForm.reset();
            parameterInfo.classList.add('d-none');
            // Reset to first tab
            document.getElementById('predefined-tab').click();
        }

        // Reset form when modal is hidden
        document.getElementById('addParameterModal').addEventListener('hidden.bs.modal', function() {
            resetModalForm();
        });
    });
</script>
{% endblock %}

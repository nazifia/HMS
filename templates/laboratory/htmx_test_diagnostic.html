<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HTMX Patient Search Diagnostic</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <style>
        .diagnostic-box {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
            margin: 10px 0;
        }
        .status-pass { color: #28a745; }
        .status-fail { color: #dc3545; }
        .autocomplete-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            z-index: 1000;
            max-height: 300px;
            overflow-y: auto;
            background: white;
            border: 1px solid #ddd;
            border-top: none;
            border-radius: 0 0 4px 4px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        #console-output {
            background: #000;
            color: #0f0;
            font-family: monospace;
            padding: 10px;
            height: 300px;
            overflow-y: auto;
            border-radius: 5px;
        }
    </style>
</head>
<body>
    <div class="container mt-5">
        <h1 class="mb-4">HTMX Patient Search Diagnostic Tool</h1>

        <!-- Status Checks -->
        <div class="diagnostic-box">
            <h3>System Status</h3>
            <div id="status-checks">
                <div>⏳ Running checks...</div>
            </div>
        </div>

        <!-- Test Search Box -->
        <div class="card">
            <div class="card-header">
                <h3>Patient Search Test</h3>
            </div>
            <div class="card-body">
                <div class="position-relative">
                    <label class="form-label">Search Patient (HTMX Enabled)</label>
                    <input type="text"
                           id="patientSearch"
                           name="q"
                           class="form-control"
                           placeholder="Type 'test' to search..."
                           hx-get="/patients/htmx-search/"
                           hx-trigger="keyup changed delay:500ms"
                           hx-target="#patientResults"
                           hx-swap="innerHTML"
                           hx-indicator="#search-loading">
                    <div id="search-loading" class="htmx-indicator" style="position: absolute; right: 10px; top: 38px;">
                        <i class="fas fa-spinner fa-spin text-primary"></i>
                    </div>
                    <div id="patientResults" class="autocomplete-results" style="display: none;"></div>
                </div>
                <small class="text-muted">Type at least 2 characters to trigger search</small>
            </div>
        </div>

        <!-- Console Output -->
        <div class="card mt-3">
            <div class="card-header">
                <h3>Console Output</h3>
            </div>
            <div class="card-body">
                <div id="console-output"></div>
            </div>
        </div>

        <!-- Manual Test Button -->
        <div class="mt-3">
            <button class="btn btn-primary" onclick="manualTest()">
                <i class="fas fa-play"></i> Run Manual Test
            </button>
            <button class="btn btn-secondary" onclick="clearConsole()">
                <i class="fas fa-eraser"></i> Clear Console
            </button>
        </div>
    </div>

    <script>
        // Console logging
        const consoleOutput = document.getElementById('console-output');

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const color = type === 'error' ? '#f00' : type === 'success' ? '#0f0' : '#0ff';
            consoleOutput.innerHTML += `<div style="color: ${color}">[${timestamp}] ${message}</div>`;
            consoleOutput.scrollTop = consoleOutput.scrollHeight;
            console.log(message);
        }

        function clearConsole() {
            consoleOutput.innerHTML = '';
        }

        // Run system checks
        document.addEventListener('DOMContentLoaded', function() {
            const statusDiv = document.getElementById('status-checks');
            let html = '<ul class="list-unstyled">';

            // Check 1: HTMX loaded
            if (typeof htmx !== 'undefined') {
                html += '<li class="status-pass">✓ HTMX library loaded</li>';
                log('✓ HTMX library loaded', 'success');
            } else {
                html += '<li class="status-fail">✗ HTMX library NOT loaded</li>';
                log('✗ HTMX library NOT loaded', 'error');
            }

            // Check 2: Input field exists
            const inputField = document.getElementById('patientSearch');
            if (inputField) {
                html += '<li class="status-pass">✓ Patient search input field exists</li>';
                log('✓ Patient search input field exists', 'success');

                // Check attributes
                if (inputField.getAttribute('hx-get')) {
                    html += '<li class="status-pass">✓ hx-get attribute configured: ' + inputField.getAttribute('hx-get') + '</li>';
                    log('✓ hx-get: ' + inputField.getAttribute('hx-get'), 'success');
                }
                if (inputField.getAttribute('hx-trigger')) {
                    html += '<li class="status-pass">✓ hx-trigger attribute configured: ' + inputField.getAttribute('hx-trigger') + '</li>';
                    log('✓ hx-trigger: ' + inputField.getAttribute('hx-trigger'), 'success');
                }
            } else {
                html += '<li class="status-fail">✗ Input field NOT found</li>';
                log('✗ Input field NOT found', 'error');
            }

            // Check 3: Results div exists
            const resultsDiv = document.getElementById('patientResults');
            if (resultsDiv) {
                html += '<li class="status-pass">✓ Results container exists</li>';
                log('✓ Results container exists', 'success');
            } else {
                html += '<li class="status-fail">✗ Results container NOT found</li>';
                log('✗ Results container NOT found', 'error');
            }

            html += '</ul>';
            statusDiv.innerHTML = html;

            // Setup HTMX event listeners
            if (typeof htmx !== 'undefined') {
                document.body.addEventListener('htmx:beforeRequest', function(evt) {
                    log('→ HTMX Request: ' + evt.detail.requestConfig.path, 'info');
                });

                document.body.addEventListener('htmx:afterSwap', function(evt) {
                    if (evt.detail.target.id === 'patientResults') {
                        log('✓ HTMX Response received and swapped', 'success');
                        log('  Response length: ' + evt.detail.target.innerHTML.length + ' bytes', 'info');

                        // Show results if not empty
                        if (evt.detail.target.innerHTML.trim() !== '') {
                            evt.detail.target.style.display = 'block';
                        } else {
                            evt.detail.target.style.display = 'none';
                        }
                    }
                });

                document.body.addEventListener('htmx:responseError', function(evt) {
                    log('✗ HTMX Error: ' + evt.detail.error, 'error');
                });
            }

            // Monitor input changes
            if (inputField) {
                inputField.addEventListener('input', function() {
                    const value = this.value;
                    if (value.length >= 2) {
                        log('Input: "' + value + '" (length: ' + value.length + ')', 'info');
                    }
                });
            }
        });

        function manualTest() {
            log('=== Running Manual Test ===', 'info');

            if (typeof htmx === 'undefined') {
                log('✗ Cannot run test - HTMX not loaded', 'error');
                return;
            }

            log('→ Triggering HTMX request to /patients/htmx-search/?q=test', 'info');
            htmx.ajax('GET', '/patients/htmx-search/?q=test', {
                target: '#patientResults',
                swap: 'innerHTML'
            }).then(function() {
                log('✓ Manual test request completed', 'success');
            }).catch(function(err) {
                log('✗ Manual test failed: ' + err, 'error');
            });
        }
    </script>
</body>
</html>

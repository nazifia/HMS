{% extends 'base.html' %}
{% load form_tags %}
{% load static %}
{% load patient_tags %}

{% block title %}Patients - Hospital Management System{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-8">
        <h2><i class="fas fa-user-injured me-2"></i>Patient List</h2>
    </div>
    <div class="col-md-4 text-end">
        <a href="{% url 'patients:register' %}" class="btn btn-primary">
            <i class="fas fa-plus-circle me-1"></i> Register New Patient
        </a>
    </div>
</div>

<div class="row mb-4" x-data="{
    search: '',
    typing: false,
    timeout: null,
    performSearch() {
        this.typing = true;
        clearTimeout(this.timeout);
        this.timeout = setTimeout(() => {
            this.typing = false;
            // Trigger HTMX search
            if (typeof htmx !== 'undefined') {
                const form = document.getElementById('search-form');
                if (form) {
                    // Build URL with current form data
                    const formData = new FormData(form);
                    const params = new URLSearchParams(formData);
                    htmx.trigger(form, 'search', {
                        target: '#patient-table-container'
                    });
                }
            }
        }, 300);
    },
    clearFilters() {
        const form = document.getElementById('search-form');
        if (form) {
            form.reset();
            // Manually trigger a search with cleared form
            this.search = '';
            this.performSearch();
        }
    }
}">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-light">
                <h5 class="mb-0">Search & Filter</h5>
            </div>
            <div class="card-body">
                <form
                    id="search-form"
                    method="get"
                    action="{% url 'patients:list' %}"
                    class="row g-3"
                    hx-get="{% url 'patients:list' %}"
                    hx-target="#patient-table-container"
                    hx-trigger="submit, search"
                    hx-indicator=".search-loading">
                    <div class="col-md-4">
                        <label for="id_search" class="form-label">Search</label>
                        <input type="text" name="{{ search_form.search.name }}" id="{{ search_form.search.id_for_label }}" 
                               class="form-control" value="{{ search_form.search.value|default:'' }}" 
                               @input.debounce.300ms="performSearch()" placeholder="Search patients..." x-model="search">
                        <span x-show="typing" class="text-muted small">Typing...</span>
                    </div>
                    <div class="col-md-2">
                        <label for="id_gender" class="form-label">Gender</label>
                        <select name="{{ search_form.gender.name }}" id="{{ search_form.gender.id_for_label }}" class="form-select" @change="performSearch()">
                            <option value="">All</option>
                            <option value="M" {% if search_form.gender.value == 'M' %}selected{% endif %}>Male</option>
                            <option value="F" {% if search_form.gender.value == 'F' %}selected{% endif %}>Female</option>
                            <option value="O" {% if search_form.gender.value == 'O' %}selected{% endif %}>Other</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label for="id_blood_group" class="form-label">Blood Group</label>
                        <select name="{{ search_form.blood_group.name }}" id="{{ search_form.blood_group.id_for_label }}" class="form-select" @change="performSearch()">
                            <option value="">All</option>
                            <option value="A+" {% if search_form.blood_group.value == 'A+' %}selected{% endif %}>A+</option>
                            <option value="A-" {% if search_form.blood_group.value == 'A-' %}selected{% endif %}>A-</option>
                            <option value="B+" {% if search_form.blood_group.value == 'B+' %}selected{% endif %}>B+</option>
                            <option value="B-" {% if search_form.blood_group.value == 'B-' %}selected{% endif %}>B-</option>
                            <option value="AB+" {% if search_form.blood_group.value == 'AB+' %}selected{% endif %}>AB+</option>
                            <option value="AB-" {% if search_form.blood_group.value == 'AB-' %}selected{% endif %}>AB-</option>
                            <option value="O+" {% if search_form.blood_group.value == 'O+' %}selected{% endif %}>O+</option>
                            <option value="O-" {% if search_form.blood_group.value == 'O-' %}selected{% endif %}>O-</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label for="id_city" class="form-label">City</label>
                        <input type="text" name="{{ search_form.city.name }}" id="{{ search_form.city.id_for_label }}" 
                               class="form-control" value="{{ search_form.city.value|default:'' }}" 
                               @input.debounce.300ms="performSearch()" placeholder="City">
                    </div>
                    <div class="col-md-2">
                        <label for="id_patient_type" class="form-label">Patient Type</label>
                        <select name="{{ search_form.patient_type.name }}" id="{{ search_form.patient_type.id_for_label }}" class="form-select" @change="performSearch()">
                            <option value="">All Types</option>
                            <option value="regular" {% if search_form.patient_type.value == 'regular' %}selected{% endif %}>Regular</option>
                            <option value="nhia" {% if search_form.patient_type.value == 'nhia' %}selected{% endif %}>NHIA</option>
                            <option value="private" {% if search_form.patient_type.value == 'private' %}selected{% endif %}>Private Pay</option>
                            <option value="insurance" {% if search_form.patient_type.value == 'insurance' %}selected{% endif %}>Private Insurance</option>
                            <option value="corporate" {% if search_form.patient_type.value == 'corporate' %}selected{% endif %}>Corporate</option>
                            <option value="staff" {% if search_form.patient_type.value == 'staff' %}selected{% endif %}>Staff</option>
                            <option value="dependant" {% if search_form.patient_type.value == 'dependant' %}selected{% endif %}>Dependant</option>
                            <option value="emergency" {% if search_form.patient_type.value == 'emergency' %}selected{% endif %}>Emergency</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="id_date_from" class="form-label">Registration Date From</label>
                        <input type="date" name="{{ search_form.date_from.name }}" id="{{ search_form.date_from.id_for_label }}" 
                               class="form-control" value="{{ search_form.date_from.value|default:'' }}" 
                               @change="performSearch()">
                    </div>
                    <div class="col-md-3">
                        <label for="id_date_to" class="form-label">Registration Date To</label>
                        <input type="date" name="{{ search_form.date_to.name }}" id="{{ search_form.date_to.id_for_label }}" 
                               class="form-control" value="{{ search_form.date_to.value|default:'' }}" 
                               @change="performSearch()">
                    </div>
                    <div class="col-md-6 d-flex align-items-end">
                        <button type="submit" class="btn btn-primary me-2">
                            <i class="fas fa-search me-1"></i> Search
                        </button>
                        <button 
                            type="button" 
                            @click="clearFilters()"
                            hx-get="{% url 'patients:list' %}"
                            hx-target="#patient-table-container"
                            hx-indicator=".search-loading"
                            class="btn btn-secondary">
                            <i class="fas fa-redo me-1"></i> Reset
                        </button>
                        <div class="search-loading htmx-indicator ms-2">
                            <i class="fas fa-spinner fa-spin"></i>
                        </div>
                        <div class="search-loading htmx-indicator ms-2">
                            <i class="fas fa-spinner fa-spin"></i>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Patients</h5>
                <span class="badge bg-light text-dark" id="patient-count">Total: {{ total_patients }}</span>
            </div>
            <div class="card-body">
                <div id="patient-table-container" class="table-responsive">
                    {% include 'patients/patient_table.html' %}
                </div>

                
            </div>
        </div>
    </div>
</div>
{% endblock %}



{% block extra_js %}
<script>
    // Alpine.js data components are initialized inline with x-data

    document.addEventListener('DOMContentLoaded', function() {
        // Initialize tooltips
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl);
        });

        // Enhanced HTMX behavior for patient table
        if (typeof htmx !== 'undefined') {
            htmx.on('htmx:afterSwap', function(evt) {
                // Re-initialize tooltips after content swap
                const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
                tooltipTriggerList.map(function (tooltipTriggerEl) {
                    return new bootstrap.Tooltip(tooltipTriggerEl);
                });

                // Update patient count if available
                const patientCount = evt.detail.elt.querySelector('#patient-count');
                if (patientCount) {
                    const fullName = evt.detail.target.querySelector('#patient-count');
                    if (fullName) {
                        fullName.textContent = patientCount.textContent;
                    }
                }
            });

            htmx.on('htmx:beforeRequest', function(evt) {
                // Show loading state on table
                const target = evt.target;
                if (target && target.id === 'patient-table') {
                    target.style.opacity = '0.6';
                }
            });

            htmx.on('htmx:afterRequest', function(evt) {
                // Hide loading state
                const target = evt.target;
                if (target && target.id === 'patient-table') {
                    target.style.opacity = '1';
                }
            });
        }

        // Quick keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            // Ctrl/Cmd + K to focus search
            if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
                e.preventDefault();
                const searchInput = document.getElementById('id_search');
                if (searchInput) {
                    searchInput.focus();
                }
            }
        });
    });
</script>

<style>
    .htmx-indicator {
        opacity: 0;
        transition: opacity 0.3s ease-in-out;
    }
    
    .htmx-indicator.htmx-request {
        opacity: 1;
    }
    
    .htmx-request .table {
        opacity: 0.6;
    }
    
    /* Enhanced loading states */
    .fade-in {
        animation: fadeIn 0.3s ease-in;
    }
    
    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }
    
    /* Pagination loading effects */
    #patient-table {
        transition: opacity 0.2s ease-in-out;
    }
    
    #patient-table.htmx-request {
        opacity: 0.7;
    }
    
    /* Search input enhancements */
    #id_search:focus {
        box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
    }
    
    .search-loading {
        color: #007bff;
    }
</style>
{% endblock %}

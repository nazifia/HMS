{% extends "base.html" %}
{% load static %}
{% load custom_filters %}

{% block title %}Activity Statistics - HMS{% endblock %}

{% block extra_css %}
<style>
.stats-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 1.5rem 0;
    margin-bottom: 2rem;
}

.stats-card {
    background: white;
    border-radius: 12px;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    padding: 1.5rem;
    margin-bottom: 1.5rem;
    transition: transform 0.2s;
}

.stats-card:hover {
    transform: translateY(-2px);
}

.chart-container {
    position: relative;
    height: 300px;
    width: 100%;
}

.time-range-selector .btn {
    margin-right: 5px;
}

.time-range-selector .btn.active {
    background-color: #007bff;
    border-color: #007bff;
}

.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1.5rem;
}

.stat-item {
    text-align: center;
    padding: 1.5rem;
    background: #f8f9fa;
    border-radius: 8px;
    border-left: 4px solid #007bff;
}

.stat-value {
    font-size: 2rem;
    font-weight: bold;
    color: #007bff;
}

.stat-label {
    font-size: 0.9rem;
    color: #6c757d;
    text-transform: uppercase;
    letter-spacing: 1px;
}

.table-striped-custom tbody tr:nth-of-type(odd) {
    background-color: rgba(0, 123, 255, 0.05);
}

.progress-container {
    margin-bottom: 1rem;
}

.progress-title {
    font-weight: 500;
    color: #495057;
    margin-bottom: 0.5rem;
}

.progress-bar-custom {
    background-color: #007bff;
    border-radius: 4px;
}

.hourly-chart {
    background: white;
    padding: 2rem;
    border-radius: 12px;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    margin-bottom: 2rem;
}

.chart-title {
    font-size: 1.2rem;
    font-weight: 600;
    color: #495057;
    margin-bottom: 1.5rem;
    text-align: center;
}

.alert-trend {
    display: flex;
    justify-content: space-around;
    margin-bottom: 1rem;
}

.trend-item {
    text-align: center;
    padding: 1rem;
    background: #f8f9fa;
    border-radius: 8px;
}

.trend-number {
    font-size: 1.5rem;
    font-weight: bold;
}

.trend-label {
    font-size: 0.8rem;
    color: #6c757d;
    margin-top: 0.25rem;
}

.trend-positive { color: #28a745; }
.trend-negative { color: #dc3545; }
.trend-neutral { color: #6c757d; }

.data-export {
    position: sticky;
    top: 20px;
}
</style>
{% endblock %}

{% block content %}
<!-- Header -->
<div class="stats-header">
    <div class="container">
        <div class="row align-items-center">
            <div class="col-md-8">
                <h1 class="mb-2">Activity Statistics & Analytics</h1>
                <p class="mb-0">Comprehensive analysis of system activities and user behavior patterns</p>
            </div>
            <div class="col-md-4 text-md-end">
                <div class="time-range-selector">
                    <div class="btn-group" role="group">
                        <a href="?time_range=1d" class="btn btn-sm {% if time_range == '1d' %}active{% endif %}">1D</a>
                        <a href="?time_range=7d" class="btn btn-sm {% if time_range == '7d' %}active{% endif %}">7D</a>
                        <a href="?time_range=30d" class="btn btn-sm {% if time_range == '30d' %}active{% endif %}">30D</a>
                        <a href="?time_range=90d" class="btn btn-sm {% if time_range == '90d' %}active{% endif %}">90D</a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="container">
    <!-- Overview Stats -->
    <div class="stats-grid mb-4">
        <div class="stat-item">
            <div class="stat-value">{{ active_users_stats|length }}</div>
            <div class="stat-label">Active Users</div>
        </div>
        <div class="stat-item">
            <div class="stat-value">{{ module_stats|length }}</div>
            <div class="stat-label">Modules Used</div>
        </div>
        <div class="stat-item">
            <div class="stat-value">{{ risk_stats|length }}</div>
            <div class="stat-label">Risk Levels</div>
        </div>
        <div class="stat-item">
            <div class="stat-value">{{ alert_stats|length }}</div>
            <div class="stat-label">Alert Types</div>
        </div>
    </div>

    <div class="row">
        <!-- Top Users -->
        <div class="col-lg-4">
            <div class="stats-card">
                <h5 class="card-title mb-3">
                    <i class="fas fa-users me-2"></i>Most Active Users
                </h5>
                
                {% if active_users_stats %}
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>User</th>
                                    <th>Activities</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for user_stat in active_users_stats %}
                                <tr>
                                    <td>
                                        <strong>{{ user_stat.user__username }}</strong>
                                    </td>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <span class="badge bg-primary me-2">{{ user_stat.activity_count }}</span>
                                            <div class="progress-container flex-grow-1">
                                                <div class="progress" style="height: 8px;">
                                                    <div class="progress-bar progress-bar-custom" 
                                                         style="width: {{ user_stat.activity_count }}%">
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <div class="text-center text-muted py-3">
                        <i class="fas fa-users fa-2x mb-2"></i>
                        <p>No user activity data available.</p>
                    </div>
                {% endif %}
            </div>
        </div>

        <!-- Module Usage -->
        <div class="col-lg-4">
            <div class="stats-card">
                <h5 class="card-title mb-3">
                    <i class="fas fa-cube me-2"></i>Module Usage
                </h5>
                
                {% if module_stats %}
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Module</th>
                                    <th>Activities</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for module in module_stats %}
                                <tr>
                                    <td>
                                        <strong>{{ module.module|title }}</strong>
                                    </td>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <span class="badge bg-info me-2">{{ module.activity_count }}</span>
                                            <div class="progress-container flex-grow-1">
                                                <div class="progress" style="height: 8px;">
                                                    <div class="progress-bar bg-info" 
                                                         style="width: {{ module.activity_count }}%">
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <div class="text-center text-muted py-3">
                        <i class="fas fa-cube fa-2x mb-2"></i>
                        <p>No module usage data available.</p>
                    </div>
                {% endif %}
            </div>
        </div>

        <!-- Risk Analysis -->
        <div class="col-lg-4">
            <div class="stats-card">
                <h5 class="card-title mb-3">
                    <i class="fas fa-shield-alt me-2"></i>Risk Level Analysis
                </h5>
                
                {% if risk_stats %}
                    {% for level in risk_stats %}
                    <div class="mb-3">
                        <div class="progress-title d-flex justify-content-between">
                            <span>{{ level.activity_level|title }}</span>
                            <span class="badge bg-{{ 
                                'success' if level.activity_level == 'low' 
                                else 'warning' if level.activity_level == 'medium' 
                                else 'danger' if level.activity_level == 'high' 
                                else 'dark' 
                            }}">
                                {{ level.count }}
                            </span>
                        </div>
                        <div class="progress" style="height: 20px;">
                            <div class="progress-bar bg-{{ 
                                'success' if level.activity_level == 'low' 
                                else 'warning' if level.activity_level == 'medium' 
                                else 'danger' if level.activity_level == 'high' 
                                else 'dark' 
                            }}" 
                                 style="width: {{ level.count }}%">
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                    
                    <!-- Risk Summary -->
                    <div class="mt-4">
                        <h6 class="text-muted mb-2">Risk Analysis</h6>
                        
                        {% if total_risk_activities > 100 %}
                        <div class="alert alert-danger p-2">
                    {% elif total_risk_activities > 50 %}
                        <div class="alert alert-warning p-2">
                    {% else %}
                        <div class="alert alert-info p-2">
                    {% endif %}
                            <small class="fw-bold">
                                {{ total_risk_activities }} risk activities detected
                            </small>
                        </div>
                    </div>
                {% else %}
                    <div class="text-center text-muted py-3">
                        <i class="fas fa-shield-alt fa-2x mb-2"></i>
                        <p>No risk level data available.</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Hourly Activity Pattern -->
    <div class="hourly-chart">
        <h5 class="chart-title">
            <i class="fas fa-clock me-2"></i>Hourly Activity Pattern
        </h5>
        <div class="chart-container">
            <canvas id="hourlyChart"></canvas>
        </div>
    </div>

    <div class="row">
        <!-- Error Statistics -->
        <div class="col-lg-6">
            <div class="stats-card">
                <h5 class="card-title mb-3">
                    <i class="fas fa-exclamation-triangle me-2"></i>Error Statistics
                </h5>
                
                {% if error_stats %}
                    <div class="table-responsive">
                        <table class="table table-sm table-striped-custom">
                            <thead>
                                <tr>
                                    <th>Error Description</th>
                                    <th>Count</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for error in error_stats %}
                                <tr>
                                    <td>
                                        <code class="small">{{ error.description|truncatechars:60 }}</code>
                                    </td>
                                    <td>
                                        <span class="badge bg-danger">{{ error.count }}</span>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <div class="text-center text-muted py-3">
                        <i class="fas fa-check-circle fa-2x mb-2 text-success"></i>
                        <p>No errors recorded.</p>
                    </div>
                {% endif %}
            </div>
        </div>

        <!-- Alert Statistics -->
        <div class="col-lg-6">
            <div class="stats-card">
                <h5 class="card-title mb-3">
                    <i class="fas fa-bell me-2"></i>Alert Statistics
                </h5>
                
                {% if alert_stats %}
                    <div class="table-responsive">
                        <table class="table table-sm table-striped-custom">
                            <thead>
                                <tr>
                                    <th>Alert Type</th>
                                    <th>Severity</th>
                                    <th>Count</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for alert in alert_stats %}
                                <tr>
                                    <td>
                                        <strong>{{ alert.get_alert_type_display }}</strong>
                                    </td>
                                    <td>
                                        <span class="badge bg-{{ 
                                            'danger' if alert.severity == 'critical' 
                                            else 'warning' if alert.severity == 'error' 
                                            else 'info' if alert.severity == 'warning' 
                                            else 'secondary' 
                                        }}">
                                            {{ alert.severity|upper }}
                                        </span>
                                    </td>
                                    <td>
                                        <span class="badge bg-warning">{{ alert.count }}</span>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Alert Summary -->
                    <div class="mt-4">
                        <h6 class="text-muted mb-2">Alert Summary</h6>
                        
                        <div class="alert alert-warning p-2">
                            <small class="fw-bold">
                                {{ total_alerts }} alerts generated
                            </small>
                        </div>
                    </div>
                {% else %}
                    <div class="text-center text-muted py-3">
                        <i class="fas fa-bell-slash fa-2x mb-2"></i>
                        <p>No alerts recorded.</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Hourly Activity Chart
const ctx = document.getElementById('hourlyChart').getContext('2d');
const hourlyStats = {{ hourly_stats|safe }};

const hourlyChart = new Chart(ctx, {
    type: 'bar',
    data: {
        labels: hourlyStats.map(item => item.hour + ':00'),
        datasets: [{
            label: 'Activities',
            data: hourlyStats.map(item => item.count),
            backgroundColor: 'rgba(0, 123, 255, 0.6)',
            borderColor: 'rgba(0, 123, 255, 1)',
            borderWidth: 1
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                display: false
            },
            tooltip: {
                callbacks: {
                    title: function(context) {
                        return 'Hour: ' + context[0].label;
                    },
                    label: function(context) {
                        return 'Activities: ' + context.parsed.y;
                    }
                }
            }
        },
        scales: {
            y: {
                beginAtZero: true,
                ticks: {
                    stepSize: 1
                }
            },
            x: {
                maxRotation: 45,
                minRotation: 45
            }
        }
    }
});

// Animate stats on scroll
const observerOptions = {
    threshold: 0.5,
    rootMargin: '0px'
};

const observer = new IntersectionObserver((entries) => {
    entries.forEach(entry => {
        if (entry.isIntersecting) {
            animateStatCard(entry.target);
        }
    });
}, observerOptions);

document.querySelectorAll('.stat-item').forEach(card => {
    observer.observe(card);
});

function animateStatCard(card) {
    const valueElement = card.querySelector('.stat-value');
    const finalValue = parseInt(valueElement.textContent);
    let currentValue = 0;
    const increment = finalValue / 20;
    const timer = setInterval(() => {
        currentValue += increment;
        if (currentValue >= finalValue) {
            currentValue = finalValue;
            clearInterval(timer);
        }
        valueElement.textContent = Math.round(currentValue);
    }, 50);
}

// Auto-refresh every 5 minutes
setInterval(function() {
    window.location.reload();
}, 300000);
</script>
{% endblock %}

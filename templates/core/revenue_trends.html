{% extends "base.html" %}
{% load static %}
{% load custom_filters %}

{% block title %}{{ page_title }} - HMS{% endblock %}

{% block extra_css %}
<link href="{% static 'css/sb-admin-2.min.css' %}" rel="stylesheet">
<style>
    .revenue-card {
        transition: transform 0.2s;
        border-left: 4px solid #4e73df;
    }
    .revenue-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 20px rgba(0,0,0,0.1);
    }
    .revenue-amount {
        font-size: 1.8rem;
        font-weight: bold;
        color: #2e59d9;
    }
    .growth-positive {
        color: #1cc88a;
    }
    .growth-negative {
        color: #e74a3b;
    }
    .chart-container {
        position: relative;
        height: 400px;
        margin: 1rem 0;
    }
    .filter-panel {
        background: #f8f9fc;
        padding: 1.5rem;
        border-radius: 0.35rem;
        margin-bottom: 2rem;
    }
    .loading-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(255,255,255,0.8);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10;
    }
    .trend-table {
        font-size: 0.9rem;
    }
    .trend-table th {
        background: #4e73df;
        color: white;
    }
    .trend-value {
        font-weight: 600;
    }
</style>
{% endblock %}

{% block content %}
<!-- Page Heading -->
<div class="d-sm-flex align-items-center justify-content-between mb-4">
    <h1 class="h3 mb-0 text-gray-800">
        <i class="fas fa-chart-line fa-fw"></i> {{ page_title }}
    </h1>
    <div class="export-buttons">
        <button class="btn btn-success btn-sm" onclick="exportData('csv')">
            <i class="fas fa-file-csv"></i> Export CSV
        </button>
        <button class="btn btn-info btn-sm" onclick="exportData('excel')">
            <i class="fas fa-file-excel"></i> Export Excel
        </button>
        <button class="btn btn-danger btn-sm" onclick="exportData('pdf')">
            <i class="fas fa-file-pdf"></i> Export PDF
        </button>
    </div>
</div>

<!-- Filter Panel -->
<div class="filter-panel">
    <form method="GET" id="filter-form" class="row">
        <div class="col-md-2">
            <label for="start_month" class="form-label">Start Month</label>
            <select name="start_month" id="start_month" class="form-control" onchange="submitForm()">
                <option value="1" {% if start_month == '1' or start_month == 1 %}selected{% endif %}>January</option>
                <option value="2" {% if start_month == '2' or start_month == 2 %}selected{% endif %}>February</option>
                <option value="3" {% if start_month == '3' or start_month == 3 %}selected{% endif %}>March</option>
                <option value="4" {% if start_month == '4' or start_month == 4 %}selected{% endif %}>April</option>
                <option value="5" {% if start_month == '5' or start_month == 5 %}selected{% endif %}>May</option>
                <option value="6" {% if start_month == '6' or start_month == 6 %}selected{% endif %}>June</option>
                <option value="7" {% if start_month == '7' or start_month == 7 %}selected{% endif %}>July</option>
                <option value="8" {% if start_month == '8' or start_month == 8 %}selected{% endif %}>August</option>
                <option value="9" {% if start_month == '9' or start_month == 9 %}selected{% endif %}>September</option>
                <option value="10" {% if start_month == '10' or start_month == 10 %}selected{% endif %}>October</option>
                <option value="11" {% if start_month == '11' or start_month == 11 %}selected{% endif %}>November</option>
                <option value="12" {% if start_month == '12' or start_month == 12 %}selected{% endif %}>December</option>
            </select>
        </div>
        <div class="col-md-2">
            <label for="start_year" class="form-label">Start Year</label>
            <select name="start_year" id="start_year" class="form-control" onchange="submitForm()">
                {% for year in '2020,2021,2022,2023,2024,2025,2026'|split:',' %}
                    <option value="{{ year }}" {% if year == start_year|stringformat:"s" %}selected{% endif %}>{{ year }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-2">
            <label for="end_month" class="form-label">End Month</label>
            <select name="end_month" id="end_month" class="form-control" onchange="submitForm()">
                <option value="1" {% if end_month == '1' or end_month == 1 %}selected{% endif %}>January</option>
                <option value="2" {% if end_month == '2' or end_month == 2 %}selected{% endif %}>February</option>
                <option value="3" {% if end_month == '3' or end_month == 3 %}selected{% endif %}>March</option>
                <option value="4" {% if end_month == '4' or end_month == 4 %}selected{% endif %}>April</option>
                <option value="5" {% if end_month == '5' or end_month == 5 %}selected{% endif %}>May</option>
                <option value="6" {% if end_month == '6' or end_month == 6 %}selected{% endif %}>June</option>
                <option value="7" {% if end_month == '7' or end_month == 7 %}selected{% endif %}>July</option>
                <option value="8" {% if end_month == '8' or end_month == 8 %}selected{% endif %}>August</option>
                <option value="9" {% if end_month == '9' or end_month == 9 %}selected{% endif %}>September</option>
                <option value="10" {% if end_month == '10' or end_month == 10 %}selected{% endif %}>October</option>
                <option value="11" {% if end_month == '11' or end_month == 11 %}selected{% endif %}>November</option>
                <option value="12" {% if end_month == '12' or end_month == 12 %}selected{% endif %}>December</option>
            </select>
        </div>
        <div class="col-md-2">
            <label for="end_year" class="form-label">End Year</label>
            <select name="end_year" id="end_year" class="form-control" onchange="submitForm()">
                {% for year in '2020,2021,2022,2023,2024,2025,2026'|split:',' %}
                    <option value="{{ year }}" {% if year == end_year|stringformat:"s" %}selected{% endif %}>{{ year }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-2">
            <label for="department" class="form-label">Department</label>
            <select name="department" id="department" class="form-control" onchange="submitForm()">
                <option value="all" {% if department == 'all' %}selected{% endif %}>All Departments</option>
                <option value="pharmacy" {% if department == 'pharmacy' %}selected{% endif %}>Pharmacy</option>
                <option value="laboratory" {% if department == 'laboratory' %}selected{% endif %}>Laboratory</option>
                <option value="consultation" {% if department == 'consultation' %}selected{% endif %}>Consultations</option>
                <option value="theatre" {% if department == 'theatre' %}selected{% endif %}>Theatre</option>
                <option value="admissions" {% if department == 'admissions' %}selected{% endif %}>Admissions</option>
                <option value="general" {% if department == 'general' %}selected{% endif %}>General</option>
                <option value="wallet" {% if department == 'wallet' %}selected{% endif %}>Wallet</option>
            </select>
        </div>
        <div class="col-md-2 d-flex align-items-end">
            <button type="button" class="btn btn-primary btn-block" onclick="refreshData()">
                <i class="fas fa-sync-alt"></i> Refresh
            </button>
        </div>
    </form>
</div>

{% if not error %}
<!-- Summary Cards -->
<div class="row mb-4">
    {% if trends %}
        
        <!-- Total Revenue for Period -->
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card revenue-card border-left-primary shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                                Total Revenue ({{ months }} months)
                            </div>
                            <div class="revenue-amount">
                                {{ trends|sum:'total_revenue'|currency }}
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-money-bill-wave fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Average Monthly Revenue -->
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card revenue-card border-left-success shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                                Average Monthly
                            </div>
                            <div class="revenue-amount text-success">
                                ₦ {% calculate_average trends 'total_revenue' %}
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-chart-bar fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Growth Rate -->
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card revenue-card border-left-warning shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">
                                Growth Rate
                            </div>
                            {% get_growth_rate_class trends 'total_revenue' %}
                            <div class="revenue-amount {{ growth_class }}">
                                {% if growth_rate >= 0 %}+{% endif %}{{ growth_rate }}%
                            </div>
                            <div class="text-xs">First vs Last month</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-chart-line fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Active Months -->
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card revenue-card border-left-info shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-info text-uppercase mb-1">
                                Active Months
                            </div>
                            <div class="revenue-amount text-info">
                                {{ trends|filter:'total_revenue>0'|length }}/{{ trends|length }}
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-calendar-check fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    {% endif %}
</div>

<!-- Revenue Trends Chart -->
<div class="row">
    <div class="col-12">
        <div class="card shadow mb-4">
            <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                <h6 class="m-0 font-weight-bold text-primary">Revenue Trends - {{ start_date|date:'M Y' }} to {{ end_date|date:'M Y' }}</h6>
                <div class="dropdown no-arrow">
                    <a class="dropdown-toggle" href="#" role="button" id="chartTypeDropdown"
                        data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                        <i class="fas fa-ellipsis-v fa-sm fa-fw text-gray-400"></i>
                    </a>
                    <div class="dropdown-menu dropdown-menu-right shadow animated--fade-in"
                        aria-labelledby="chartTypeDropdown">
                        <div class="dropdown-header">Chart Options:</div>
                        <a class="dropdown-item" href="#" onclick="changeChartType('line')">Line Chart</a>
                        <a class="dropdown-item" href="#" onclick="changeChartType('bar')">Bar Chart</a>
                        <a class="dropdown-item" href="#" onclick="changeChartType('area')">Area Chart</a>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <div class="chart-container">
                    <canvas id="revenueTrendsChart" style="width: 100%; height: 400px;"></canvas>
                    <div id="chart-loading" class="loading-overlay" style="display: none;">
                        <div class="spinner-border text-primary" role="status">
                            <span class="sr-only">Loading...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Department-wise Trends -->
<div class="row">
    <div class="col-12">
        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">Department-wise Revenue Trends</h6>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-bordered trend-table" id="trendsTable">
                        <thead>
                            <tr>
                                <th>Month</th>
                                <th>Total Revenue</th>
                                <th>Pharmacy</th>
                                <th>Laboratory</th>
                                <th>Consultations</th>
                                <th>Theatre</th>
                                <th>Admissions</th>
                                <th>General</th>
                                <th>Wallet</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for trend in trends %}
                            <tr>
                                <td>{{ trend.month|date:"M Y" }}</td>
                                <td class="trend-value text-primary">{{ trend.total_revenue|currency }}</td>
                                <td>{{ trend.pharmacy|currency }}</td>
                                <td>{{ trend.laboratory|currency }}</td>
                                <td>{{ trend.consultations|currency }}</td>
                                <td>{{ trend.theatre|currency }}</td>
                                <td>{{ trend.admissions|currency }}</td>
                                <td>{{ trend.general|currency }}</td>
                                <td>{{ trend.wallet|currency }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                        <tfoot>
                            <tr class="bg-light">
                                <th>Total</th>
                                <th class="trend-value">{{ trends|sum:'total_revenue'|currency }}</th>
                                <th>{{ trends|sum:'pharmacy'|currency }}</th>
                                <th>{{ trends|sum:'laboratory'|currency }}</th>
                                <th>{{ trends|sum:'consultations'|currency }}</th>
                                <th>{{ trends|sum:'theatre'|currency }}</th>
                                <th>{{ trends|sum:'admissions'|currency }}</th>
                                <th>{{ trends|sum:'general'|currency }}</th>
                                <th>{{ trends|sum:'wallet'|currency }}</th>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

{% else %}
<!-- Error State -->
<div class="row">
    <div class="col-12">
        <div class="alert alert-danger">
            <h4 class="alert-heading">Error Loading Revenue Trends</h4>
            <p>{{ error }}</p>
            <hr>
            <p class="mb-0">Please try refreshing the page or contact system administrator.</p>
        </div>
    </div>
</div>
{% endif %}

{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
console.log('Revenue trends JavaScript loaded');

// Global variables
let revenueTrendsChart;
const trendsData = {{ trends_json|safe }};

console.log('trendsData defined:', trendsData);

// Initialize when page is fully loaded
function initializeAll() {
    console.log('initializeAll called');
    initializeCharts();
    if (typeof $ !== 'undefined' && $.fn.DataTable) {
        initializeDataTable();
    } else {
        console.log('jQuery or DataTables not available');
    }
}

// Try multiple initialization methods
if (typeof $ !== 'undefined') {
    console.log('jQuery is available');
    $(document).ready(function() {
        console.log('jQuery document.ready fired');
        initializeAll();
    });
} else {
    console.log('jQuery not available, using DOMContentLoaded');
    document.addEventListener('DOMContentLoaded', function() {
        console.log('DOMContentLoaded fired');
        initializeAll();
    });
}

// Also try window.onload as fallback
window.addEventListener('load', function() {
    console.log('window.load fired');
    if (!revenueTrendsChart) {
        console.log('Chart not created yet, initializing now');
        initializeAll();
    }
});

function initializeCharts() {
    console.log('initializeCharts called');
    console.log('trendsData:', trendsData);
    console.log('trendsData type:', typeof trendsData);
    console.log('trendsData length:', trendsData ? trendsData.length : 'undefined');

    if (!trendsData || !trendsData.length) {
        console.error('No trends data available for chart');
        // Show a message in the chart area
        const chartContainer = document.getElementById('revenueTrendsChart');
        if (chartContainer) {
            const parent = chartContainer.parentElement;
            parent.innerHTML = '<div class="alert alert-warning">No trend data available for the selected period.</div>';
        }
        return;
    }

    const ctx = document.getElementById('revenueTrendsChart');
    if (!ctx) {
        console.error('Chart canvas element not found');
        return;
    }

    const chartContext = ctx.getContext('2d');

    // Prepare data for chart
    // Format date labels (convert 2025-11-01 to Nov 2025)
    console.log('Preparing chart labels...');
    const labels = trendsData.map(trend => {
        console.log('Processing trend:', trend);
        const date = new Date(trend.month);
        const label = date.toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
        console.log('Created label:', label);
        return label;
    });
    console.log('Labels:', labels);
    const datasets = [
        {
            label: 'Total Revenue',
            data: trendsData.map(trend => parseFloat(trend.total_revenue)),
            borderColor: '#4e73df',
            backgroundColor: 'rgba(78, 115, 223, 0.1)',
            borderWidth: 2,
            tension: 0.3
        },
        {
            label: 'Pharmacy',
            data: trendsData.map(trend => parseFloat(trend.pharmacy)),
            borderColor: '#1cc88a',
            backgroundColor: 'rgba(28, 200, 138, 0.1)',
            borderWidth: 1,
            tension: 0.3
        },
        {
            label: 'Laboratory',
            data: trendsData.map(trend => parseFloat(trend.laboratory)),
            borderColor: '#36b9cc',
            backgroundColor: 'rgba(54, 185, 204, 0.1)',
            borderWidth: 1,
            tension: 0.3
        },
        {
            label: 'Consultations',
            data: trendsData.map(trend => parseFloat(trend.consultations)),
            borderColor: '#f6c23e',
            backgroundColor: 'rgba(246, 194, 62, 0.1)',
            borderWidth: 1,
            tension: 0.3
        },
        {
            label: 'Wallet',
            data: trendsData.map(trend => parseFloat(trend.wallet)),
            borderColor: '#e74a3b',
            backgroundColor: 'rgba(231, 74, 59, 0.1)',
            borderWidth: 1,
            tension: 0.3
        }
    ];

    console.log('Creating chart with labels:', labels);
    console.log('Datasets:', datasets);

    try {
        revenueTrendsChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: datasets
            },
            options: {
                maintainAspectRatio: false,
                responsive: true,
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return '₦' + new Intl.NumberFormat().format(value);
                            }
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: true,
                        position: 'bottom'
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) {
                                    label += ': ₦' + new Intl.NumberFormat().format(context.parsed.y);
                                }
                                return label;
                            }
                        }
                    }
                }
            }
        });
        console.log('Chart created successfully:', revenueTrendsChart);
    } catch (error) {
        console.error('Error creating chart:', error);
    }
}

function initializeDataTable() {
    $('#trendsTable').DataTable({
        responsive: true,
        pageLength: 12,
        order: [[0, 'desc']],
        dom: '<"row"<"col-sm-12 col-md-6"B><"col-sm-12 col-md-6"f>>rtip',
        buttons: [
            'copy', 'csv', 'excel', 'pdf'
        ]
    });
}

function changeChartType(type) {
    if (revenueTrendsChart) {
        if (type === 'area') {
            revenueTrendsChart.config.type = 'line';
            revenueTrendsChart.data.datasets.forEach(dataset => {
                dataset.fill = true;
            });
        } else {
            revenueTrendsChart.config.type = type;
            revenueTrendsChart.data.datasets.forEach(dataset => {
                dataset.fill = false;
            });
        }
        revenueTrendsChart.update();
    }
}

function submitForm() {
    showLoading();
    document.getElementById('filter-form').submit();
}

function refreshData() {
    showLoading();
    location.reload();
}

function resetFilters() {
    window.location.href = '{% url "core:revenue_trends_view" %}';
}

function exportData(format) {
    showLoading();
    const params = new URLSearchParams(window.location.search);
    params.set('format', format);
    
    window.location.href = '{% url "core:export_revenue_breakdown" %}?' + params.toString();
    setTimeout(hideLoading, 1000);
}

function showLoading() {
    $('.loading-overlay').show();
}

function hideLoading() {
    $('.loading-overlay').hide();
}
</script>
{% endblock %}

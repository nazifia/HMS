<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Hospital Management System{% endblock %}</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <!-- DataTables CSS -->
    <link href="https://cdn.datatables.net/1.11.5/css/dataTables.bootstrap5.min.css" rel="stylesheet">

    <!-- Select2 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" />

    <!-- Custom CSS -->
    {% load static %}
{% load form_tags %}
{% load patient_tags %}
{% load compress %}
    {% compress css %}
    <link rel="stylesheet" href="{% static 'css/style_new.css' %}">
    <link rel="stylesheet" href="{% static 'css/patient_search.css' %}">
    {% endcompress %}

    {% block extra_css %}{% endblock %}
    <style>
        /* Main layout for sidebar and content */
        html, body {
            height: 100%;
            overflow-x: hidden; /* Allow horizontal scrolling if needed */
            overflow-y: auto; /* Allow vertical scrolling */
        }
        #wrapper {
            display: flex;
            min-height: 100vh;
            width: 100vw;
            background: #f8f9fc;
            overflow-x: hidden; /* Keep horizontal hidden if desired, but allow vertical */
            overflow-y: auto; /* Allow vertical scrolling */
        }

        /* Content Wrapper */
        #content-wrapper {
            display: flex;
            flex-direction: column;
            flex-grow: 1;
            width: 100%;
            min-width: 0;
            background: #f8f9fc;
            overflow-y: auto; /* Changed from hidden to auto */
            height: 100vh;
        }

        /* Main Content Area */
        #content {
            flex: 1 0 auto;
            width: 100%;
            display: flex;
            flex-direction: column;
            padding-bottom: 80px; /* Space for footer */
            overflow-y: auto;
            height: 100vh;
        }

        /* Container Fluid for content padding */
        .container-fluid {
            flex: 1 0 auto;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
            padding: 1rem;
        }

        /* Topbar custom style */
        .topbar {
            background: #fff;
            box-shadow: 0 2px 8px rgba(0,0,0,0.03);
            border-radius: 0 0 12px 12px;
            padding: 0.5rem 2rem;
            min-height: 64px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            z-index: 1020;
        }
        .topbar .navbar-brand {
            font-weight: 700;
            color: #00bfff !important;
            font-size: 1.4rem;
            letter-spacing: 1px;
        }
        .topbar .nav-link, .topbar .fa {
            color: #23272b !important;
            font-size: 1.1rem;
        }
        .topbar .nav-link:hover {
            color: #00bfff !important;
        }
        /* Footer custom style */
        footer, .footer {
            flex-shrink: 0;
            background: #fff;
            color: #23272b;
            box-shadow: 0 -2px 8px rgba(0,0,0,0.03);
            border-radius: 12px 12px 0 0;
            padding: 1rem 2rem;
            text-align: center;
            font-size: 1rem;
            margin-top: auto;
            position: sticky;
            bottom: 0;
            width: 100%;
        }
        /* Responsive tweaks */
        @media (max-width: 991.98px) {
            .topbar, footer, .footer {
                padding: 0.5rem 1rem;
                border-radius: 0;
            }
        }
        @media (max-width: 600px) {
            .topbar, footer, .footer {
                padding: 0.5rem 0.5rem;
                font-size: 0.95rem;
            }
            .topbar .navbar-brand {
                font-size: 1.1rem;
            }
        }

        /* Auto Logout Modal Styles */
        #logoutWarningModal .modal-content {
            border: 2px solid #ffc107;
            box-shadow: 0 0 20px rgba(255, 193, 7, 0.3);
        }

        #logoutWarningModal #countdownTimer {
            font-family: 'Courier New', monospace;
            font-weight: bold;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
        }

        #logoutModal .modal-content {
            border: none;
            box-shadow: 0 0 20px rgba(0,0,0,0.2);
        }

        .modal-backdrop.show {
            opacity: 0.15;  /* Reduced from 0.3 to 0.15 */
        }

        /* Global Modal Z-Index Override */
        #logoutWarningModal, #logoutModal {
            z-index: 50010 !important;
        }

        #logoutWarningModal .modal-backdrop, #logoutModal .modal-backdrop {
            z-index: 50000 !important;
        }

        /* Session Status Indicator */
        #sessionStatus {
            cursor: default;
            font-size: 0.9rem;
        }

        #sessionIndicator {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }
    </style>
    <script>
        // Sidebar toggle for mobile - handled by sidebar.js
    </script>
    {% block extra_head %}
    {{ block.super }}
    <!-- Additional head content here -->
    {% endblock %}
</head>
<body id="page-top">

    <!-- Page Wrapper -->
    <div id="wrapper">
        <!-- Sidebar -->
        {% if user.is_authenticated %}
            {% include 'includes/sidebar.html' %}
        {% endif %}
        <!-- Content Wrapper -->
        <div id="content-wrapper" class="d-flex flex-column">
            <!-- Main Content -->
            <div id="content">
                <!-- Topbar -->
                <nav class="navbar navbar-expand navbar-light bg-white topbar mb-4 static-top shadow">
                    
                    <!-- Mobile Hamburger Menu Button -->
                    <button class="btn btn-link d-md-none rounded-circle mr-3" id="sidebarToggleTop">
                        <i class="fa fa-bars"></i>
                    </button>
                    
                    <a class="navbar-brand" href="{% url 'dashboard:dashboard' %}">HMS</a>
                    <!-- Topbar Navbar -->
                    <ul class="navbar-nav ms-auto">
                        {% if user.is_authenticated %}
                            <!-- Session Status Indicator -->
                            <li class="nav-item">
                                <span class="nav-link" id="sessionStatus">
                                    <i class="fas fa-circle text-success me-1" id="sessionIndicator"></i>
                                    <span class="d-none d-sm-inline" id="sessionText">Active</span>
                                </span>
                            </li>

                            <!-- Current Patient Context -->
                            {% if has_current_patient %}
                            <li class="nav-item">
                                <div class="nav-link" id="currentPatientContext">
                                    <i class="fas fa-user-injured text-info me-1"></i>
                                    <span class="d-none d-sm-inline">
                                        {{ current_patient.full_name }}
                                        {% if current_patient.patient_id %}({{ current_patient.patient_id }}){% endif %}
                                    </span>
                                    <div class="btn-group btn-group-xs ms-2" role="group">
                                        <a href="/patients/{{ current_patient.id }}/" class="btn btn-outline-primary btn-xs" title="View Patient">
                                            <i class="fas fa-eye"></i>
                                        </a>
                                        <button type="button" class="btn btn-outline-danger btn-xs" title="Clear Patient Context" onclick="clearPatientContext()">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    </div>
                                </div>
                            </li>
                            {% endif %}
                            <li class="nav-item dropdown no-arrow">
                                <a class="nav-link dropdown-toggle" href="#" id="userDropdown" role="button"
                                    data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                    <span class="me-2 d-none d-lg-inline text-gray-600 small">{{ user.get_full_name }}</span>
                                    {% if user.profile.profile_picture %}
                                        <img class="img-profile rounded-circle"
                                            src="{{ user.profile.profile_picture.url }}" alt="Profile Picture" style="width: 30px; height: 30px;">
                                    {% else %}
                                        <i class="fas fa-user-circle fa-2x text-gray-300"></i>
                                    {% endif %}
                                </a>
                                <!-- Dropdown - User Information -->
                                <div class="dropdown-menu dropdown-menu-end shadow animated--grow-in"
                                    aria-labelledby="userDropdown">
                                    <a class="dropdown-item" href="{% url 'accounts:profile' %}">
                                        <i class="fas fa-user fa-sm fa-fw me-2 text-gray-400"></i>
                                        Profile
                                    </a>
                                    <a class="dropdown-item" href="{% url 'accounts:edit_profile' %}">
                                        <i class="fas fa-cogs fa-sm fa-fw me-2 text-gray-400"></i>
                                        Settings
                                    </a>
                                    <div class="dropdown-divider"></div>
                                    <a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#logoutModal">
                                        <i class="fas fa-sign-out-alt fa-sm fa-fw me-2 text-gray-400"></i>
                                        Logout
                                    </a>
                                </div>
                            </li>
                        {% else %}
                            <li class="nav-item">
                                <a class="nav-link" href="{% url 'accounts:login' %}">
                                    <span class="me-2 d-none d-lg-inline text-gray-600 small">Login</span>
                                    <i class="fas fa-sign-in-alt"></i>
                                </a>
                            </li>
                        {% endif %}
                    </ul>
                </nav>
                <!-- End of Topbar -->
                <!-- Begin Page Content -->
                <div class="container-fluid">
                    {% if messages %}
                        {% for message in messages %}
                            <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                                <i class="fas fa-{% if message.tags == 'success' %}check-circle{% elif message.tags == 'error' %}exclamation-circle{% elif message.tags == 'warning' %}exclamation-triangle{% else %}info-circle{% endif %} me-2"></i>
                                {{ message }}
                                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                            </div>
                        {% endfor %}
                    {% endif %}
                    {% block content %}
                        <!-- PWA offline functionality disabled -->
                        <!-- {% if 'bot' not in request.META.HTTP_USER_AGENT|default:''|lower %}
                            <div id="offline-banner"></div>
                        {% endif %} -->
                        <!-- BEGIN: Patient Widget -->
                        {% if patient %}
                        <div class="card mb-4" id="patient-widget">
                            <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
                                <h5 class="mb-0">Patient Quick Info</h5>
                                <span class="badge bg-primary">ID: {{ patient.patient_id }}</span>
                                <button type="button" class="btn btn-light btn-sm" data-bs-toggle="modal" data-bs-target="#patientModal">
                                    <i class="fas fa-info-circle"></i> More
                                </button>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <strong>Name:</strong> {{ patient.get_full_name }}<br>
                                        <strong>Gender:</strong> {{ patient.get_gender_display }}<br>
                                        <strong>Age:</strong> {{ age }}<br>
                                        <strong>Phone:</strong> {{ patient.phone_number }}<br>
                                        <strong>Email:</strong> {{ patient.email|default:'-' }}
                                    </div>
                                    <div class="col-md-6">
                                        <strong>City:</strong> {{ patient.city|default:'-' }}<br>
                                        <strong>Blood Group:</strong> {{ patient.blood_group|default:'-' }}<br>
                                        <strong>Status:</strong> {% if patient.is_active %}<span class="badge bg-success">Active</span>{% else %}<span class="badge bg-danger">Inactive</span>{% endif %}<br>
                                        <strong>Registered:</strong> {{ patient.registration_date|date:'M d, Y' }}
                                    </div>
                                </div>
                                {% if user.is_authenticated %}
                                <div class="row mt-3">
                                    <div class="col-12">
                                        {% if patient.is_active %}
                                            <form method="post" action="{% url 'patients:toggle_patient_status' patient.id %}" style="margin-top: 0.5rem;">
                                                {% csrf_token %}
                                                <button type="submit" class="btn btn-warning btn-sm">Deactivate Patient</button>
                                            </form>
                                        {% else %}
                                            <form method="post" action="{% url 'patients:toggle_patient_status' patient.id %}" style="margin-top: 0.5rem;">
                                                {% csrf_token %}
                                                <button type="submit" class="btn btn-success btn-sm">Activate Patient</button>
                                            </form>
                                        {% endif %}
                                    </div>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        <!-- Patient Modal -->
                        <div class="modal fade" id="patientModal" tabindex="-1" aria-labelledby="patientModalLabel" aria-hidden="true">
                          <div class="modal-dialog modal-lg modal-dialog-centered">
                            <div class="modal-content">
                              <div class="modal-header bg-info text-white">
                                <h5 class="modal-title" id="patientModalLabel">Patient Full Details</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                              </div>
                              <div class="modal-body">
                                <div class="row mb-2">
                                  <div class="col-md-6">
                                    <strong>Name:</strong> {{ patient.get_full_name }}<br>
                                    <strong>Patient ID:</strong> {{ patient.patient_id }}<br>
                                    <strong>Gender:</strong> {{ patient.get_gender_display }}<br>
                                    <strong>Age:</strong> {{ age }}<br>
                                    <strong>Phone:</strong> {{ patient.phone_number }}<br>
                                    <strong>Email:</strong> {{ patient.email|default:'-' }}<br>
                                    <strong>City:</strong> {{ patient.city|default:'-' }}<br>
                                    <strong>Address:</strong> {{ patient.address|default:'-' }}<br>
                                  </div>
                                  <div class="col-md-6">
                                    <strong>Blood Group:</strong> {{ patient.blood_group|default:'-' }}<br>
                                    <strong>Status:</strong> {% if patient.is_active %}<span class="badge bg-success">Active</span>{% else %}<span class="badge bg-danger">Inactive</span>{% endif %}<br>
                                    <strong>Registered:</strong> {{ patient.registration_date|date:'M d, Y' }}<br>
                                    <strong>Last Updated:</strong> {{ patient.updated_at|date:'M d, Y H:i' }}<br>
                                    <strong>Created By:</strong> {{ patient.created_by.get_full_name|default:patient.created_by.username }}<br>
                                    <strong>Updated By:</strong> {{ patient.updated_by.get_full_name|default:patient.updated_by.username }}<br>
                                  </div>
                                </div>
                                <div class="row">
                                  <div class="col-12">
                                    <strong>Notes:</strong> {{ patient.notes|default:'No notes'|linebreaks }}
                                  </div>
                                </div>
                              </div>
                              <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                              </div>
                            </div>
                          </div>
                        </div>
                        {% endif %}
                        <!-- END: Patient Widget -->
                        {% if medical_history_form %}
                        <!-- BEGIN: Add Medical History Widget -->
                        <div class="modal fade" id="addMedicalHistoryModal" tabindex="-1" aria-labelledby="addMedicalHistoryModalLabel" aria-hidden="true">
                          <div class="modal-dialog modal-lg modal-dialog-centered">
                            <div class="modal-content">
                              <div class="modal-header bg-primary text-white">
                                <h5 class="modal-title" id="addMedicalHistoryModalLabel">Add Medical History for {{ patient.get_full_name }}</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                              </div>
                              <form method="post" enctype="multipart/form-data">
                                {% csrf_token %}
                                <div class="modal-body">
                                  <div class="mb-3">
                                    {{ medical_history_form.non_field_errors }}
                                  </div>
                                  <div class="row g-3">
                                    <div class="col-md-6">
                                      <div class="form-group mb-2">
                                        <label for="id_condition">Condition</label>
                                        {{ medical_history_form.condition }}
                                      </div>
                                      <div class="form-group mb-2">
                                        <label for="id_date">Date</label>
                                        {{ medical_history_form.date }}
                                      </div>
                                      <div class="form-group mb-2">
                                        <label for="id_doctor_name">Doctor Name</label>
                                        {{ medical_history_form.doctor_name }}
                                      </div>
                                    </div>
                                    <div class="col-md-6">
                                      <div class="form-group mb-2">
                                        <label for="id_notes">Notes</label>
                                        {{ medical_history_form.notes }}
                                      </div>
                                      <div class="form-group mb-2">
                                        <label for="id_attachments">Attachments</label>
                                        {{ medical_history_form.attachments }}
                                      </div>
                                    </div>
                                  </div>
                                </div>
                                <div class="modal-footer">
                                  <button type="submit" name="add_medical_history" class="btn btn-primary">Add Medical History</button>
                                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                </div>
                              </form>
                            </div>
                          </div>
                        </div>
                        <!-- END: Add Medical History Widget -->
                        {% endif %}
                        <!-- Radiology Requests Widget -->
                {% if user.is_authenticated %}
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="card border-info shadow-sm">
                            <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
                                <h5 class="mb-0"><i class="fas fa-x-ray me-2"></i>Recent Radiology Requests</h5>
                                <a href="{% url 'radiology:index' %}" class="btn btn-sm btn-light">View All</a>
                            </div>
                            <div class="card-body p-3">
                                {% if recent_radiology_orders %}
                                    <div class="table-responsive">
                                        <table class="table table-sm table-hover mb-0">
                                            <thead>
                                                <tr>
                                                    <th>Patient</th>
                                                    <th>Test</th>
                                                    <th>Status</th>
                                                    <th>Requested</th>
                                                    <th></th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% for order in recent_radiology_orders %}
                                                <tr>
                                                    <td>{{ order.patient.get_full_name }}</td>
                                                    <td>{{ order.test.name }}</td>
                                                    <td>{{ order.get_status_display }}</td>
                                                    <td>{{ order.order_date|date:'M d, Y H:i' }}</td>
                                                    <td><a href="{% url 'radiology:order_detail' order.id %}" class="btn btn-sm btn-outline-primary">Details</a></td>
                                                </tr>
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                {% else %}
                                    <div class="text-muted">No recent radiology requests.</div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
                <!-- End Radiology Requests Widget -->
                {% endif %}
                {% endblock %}
                <!-- /.container-fluid -->
            </div>
            <!-- End of Main Content -->
            <!-- Footer -->
            <footer class="sticky-footer bg-white">
                <div class="container my-auto">
                    <div class="copyright text-center my-auto">
                        <span>&copy; {{ year|default:2025 }} Hospital Management System. All rights reserved.</span>
                    </div>
                </div>
            </footer>
            <!-- End of Footer -->
        </div>
        <!-- End of Content Wrapper -->
    </div>
    <!-- End of Page Wrapper -->

    <!-- Logout Modal-->
    <div class="modal fade" id="logoutModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel"
        aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalLabel">Ready to Leave?</h5>
                    <button class="btn-close" type="button" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">Select "Logout" below if you are ready to end your current session.</div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" type="button" data-bs-dismiss="modal">Cancel</button>
                    <form method="post" action="{% url 'accounts:logout' %}" style="display:inline;">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-primary">Logout</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- HTMX -->
    <script src="https://unpkg.com/htmx.org@1.9.12"></script>
    
    <!-- Alpine.js -->
    <script defer src="https://unpkg.com/alpinejs@3.13.8/dist/cdn.min.js"></script>

    <!-- jQuery - Load FIRST before any scripts that use it -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Modal Fix Script -->
    <script>
        $(document).ready(function() {
            // Ensure modals work properly with custom CSS
            $('.modal').on('show.bs.modal', function (e) {
                $('body').addClass('modal-open');
                $('#wrapper').addClass('modal-open');

                // Ensure modal is properly positioned
                $(this).css({
                    'display': 'block',
                    'pointer-events': 'auto'
                });

                // Initialize Select2 for elements in the modal
                $(this).find('.select2').select2({
                    dropdownParent: $(this),
                    theme: 'bootstrap-5'
                });
            });

            $('.modal').on('shown.bs.modal', function (e) {
                // Ensure modal content is interactive
                $(this).find('.modal-content').css('pointer-events', 'auto');
                $(this).find('button, input, select, textarea, a').css('pointer-events', 'auto');

                // Focus on first input after modal is fully shown
                setTimeout(() => {
                    $(this).find('input, select, textarea').first().focus();
                }, 100);
            });

            $('.modal').on('hidden.bs.modal', function (e) {
                $('body').removeClass('modal-open');
                $('#wrapper').removeClass('modal-open');

                // Reset pointer events
                $(this).css('pointer-events', '');

                // Destroy Select2 instances to prevent memory leaks
                $(this).find('.select2').each(function() {
                    if ($(this).hasClass('select2-hidden-accessible')) {
                        $(this).select2('destroy');
                    }
                });
            });

            // Fix for modal backdrop click issues
            $('.modal').on('click', function(e) {
                if (e.target === this) {
                    $(this).modal('hide');
                }
            });

            // Handle clicks outside modal content to close modal
            $(document).on('click', '.modal', function(e) {
                if ($(e.target).hasClass('modal')) {
                    $(this).modal('hide');
                }
            });

            // Ensure modal content is clickable
            $('.modal-content').on('click', function(e) {
                e.stopPropagation();
            });

            // Prevent form submission on Enter key in modal inputs (except textareas)
            $('.modal').on('keypress', 'input:not([type="submit"])', function(e) {
                if (e.which === 13) {
                    e.preventDefault();
                    return false;
                }
            });

            // Additional fix for modal interaction issues
            $(document).on('click', '.modal-backdrop', function(e) {
                e.preventDefault();
                e.stopPropagation();
                $('.modal.show').modal('hide');
            });

            // Handle ESC key to close modal
            $(document).on('keydown', function(e) {
                if (e.key === 'Escape' && $('.modal.show').length > 0) {
                    $('.modal.show').modal('hide');
                }
            });

            // Ensure buttons in modals are clickable
            $(document).on('click', '.modal button', function(e) {
                e.stopPropagation();
            });
        });
    </script>

    <!-- Auto Logout for Inactive Users -->
    <script>
        $(document).ready(function() {
            // Auto logout configuration
            const INACTIVITY_TIMEOUT = 5 * 60 * 1000; // 5 minutes in milliseconds
            const WARNING_TIME = 1 * 60 * 1000; // Show warning 1 minute before logout

            let inactivityTimer;
            let warningTimer;
            let warningShown = false;

            // Events that reset the inactivity timer
            const resetEvents = ['mousedown', 'mousemove', 'keypress', 'scroll', 'touchstart', 'click'];

            // Function to update session status indicator
            function updateSessionStatus(status) {
                const indicator = $('#sessionIndicator');
                const text = $('#sessionText');

                switch(status) {
                    case 'active':
                        indicator.removeClass('text-warning text-danger').addClass('text-success');
                        text.text('Active');
                        break;
                    case 'warning':
                        indicator.removeClass('text-success text-danger').addClass('text-warning');
                        text.text('Warning');
                        break;
                    case 'expired':
                        indicator.removeClass('text-success text-warning').addClass('text-danger');
                        text.text('Expired');
                        break;
                }
            }

            // Function to show logout warning
            function showLogoutWarning() {
                if (warningShown) return;
                warningShown = true;
                updateSessionStatus('warning');

                // Create warning modal
                const warningModal = `
                    <div class="modal fade" id="logoutWarningModal" tabindex="-1" aria-hidden="true" data-backdrop="static" data-keyboard="false">
                        <div class="modal-dialog modal-dialog-centered">
                            <div class="modal-content border-warning">
                                <div class="modal-header bg-warning text-dark">
                                    <h5 class="modal-title">
                                        <i class="fas fa-exclamation-triangle me-2"></i>Session Timeout Warning
                                    </h5>
                                </div>
                                <div class="modal-body text-center">
                                    <div class="mb-3">
                                        <i class="fas fa-clock fa-3x text-warning mb-3"></i>
                                        <h6>Your session will expire in:</h6>
                                        <h3 class="text-danger" id="countdownTimer">01:00</h3>
                                    </div>
                                    <p class="text-muted">You will be automatically logged out due to inactivity. Click "Stay Logged In" to continue your session.</p>
                                </div>
                                <div class="modal-footer justify-content-center">
                                    <button type="button" class="btn btn-success" id="stayLoggedInBtn">
                                        <i class="fas fa-user-check me-1"></i>Stay Logged In
                                    </button>
                                    <button type="button" class="btn btn-secondary" id="logoutNowBtn">
                                        <i class="fas fa-sign-out-alt me-1"></i>Logout Now
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                // Add modal to page if it doesn't exist
                if (!$('#logoutWarningModal').length) {
                    $('body').append(warningModal);
                }

                // Show the modal
                $('#logoutWarningModal').modal('show');

                // Start countdown
                let timeLeft = 60; // 60 seconds
                const countdownInterval = setInterval(function() {
                    timeLeft--;
                    const minutes = Math.floor(timeLeft / 60);
                    const seconds = timeLeft % 60;
                    $('#countdownTimer').text(
                        String(minutes).padStart(2, '0') + ':' + String(seconds).padStart(2, '0')
                    );

                    if (timeLeft <= 0) {
                        clearInterval(countdownInterval);
                        performLogout();
                    }
                }, 1000);

                // Handle stay logged in button
                $('#stayLoggedInBtn').off('click').on('click', function() {
                    clearInterval(countdownInterval);
                    $('#logoutWarningModal').modal('hide');
                    warningShown = false;
                    updateSessionStatus('active');
                    resetInactivityTimer();
                });

                // Handle logout now button
                $('#logoutNowBtn').off('click').on('click', function() {
                    clearInterval(countdownInterval);
                    performLogout();
                });

                // Clean up when modal is hidden
                $('#logoutWarningModal').on('hidden.bs.modal', function() {
                    if (!warningShown) {
                        clearInterval(countdownInterval);
                    }
                });
            }

            // Function to perform logout
            function performLogout() {
                updateSessionStatus('expired');

                // Clear any existing modals
                $('#logoutWarningModal').modal('hide');

                // Show logout message
                const logoutMessage = `
                    <div class="modal fade" id="logoutModal" tabindex="-1" aria-hidden="true" data-backdrop="static" data-keyboard="false">
                        <div class="modal-dialog modal-dialog-centered">
                            <div class="modal-content border-warning">
                                <div class="modal-header bg-warning text-dark">
                                    <h5 class="modal-title">
                                        <i class="fas fa-exclamation-triangle me-2"></i>Session Expired
                                    </h5>
                                </div>
                                <div class="modal-body text-center py-4">
                                    <div class="mb-3">
                                        <i class="fas fa-clock fa-3x text-warning mb-3"></i>
                                        <h5>Session Timeout</h5>
                                        <p class="text-muted">You have been automatically logged out due to inactivity.</p>
                                        <p class="text-info">You will be redirected to the login page in <span id="redirectCountdown">3</span> seconds...</p>
                                    </div>
                                    <div class="d-grid gap-2">
                                        <button type="button" class="btn btn-primary" onclick="redirectToLogin()">
                                            <i class="fas fa-sign-in-alt me-2"></i>Go to Login Page Now
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                $('body').append(logoutMessage);
                $('#logoutModal').modal('show');

                // Start countdown for redirect
                let redirectTime = 3;
                const redirectInterval = setInterval(function() {
                    redirectTime--;
                    $('#redirectCountdown').text(redirectTime);

                    if (redirectTime <= 0) {
                        clearInterval(redirectInterval);
                        redirectToLogin();
                    }
                }, 1000);
            }

            // Function to redirect to login page
            function redirectToLogin() {
                // First, try to logout via AJAX to clear server session
                $.ajax({
                    url: '/accounts/logout/',
                    type: 'POST',
                    headers: {
                        'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val() ||
                                      $('meta[name=csrf-token]').attr('content') ||
                                      getCookie('csrftoken')
                    },
                    complete: function() {
                        // Always redirect to login page regardless of AJAX result
                        window.location.href = '/accounts/login/?auto_logout=1&reason=inactivity';
                    }
                });
            }

            // Function to get CSRF cookie
            function getCookie(name) {
                let cookieValue = null;
                if (document.cookie && document.cookie !== '') {
                    const cookies = document.cookie.split(';');
                    for (let i = 0; i < cookies.length; i++) {
                        const cookie = cookies[i].trim();
                        if (cookie.substring(0, name.length + 1) === (name + '=')) {
                            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                            break;
                        }
                    }
                }
                return cookieValue;
            }

            // Function to reset inactivity timer
            function resetInactivityTimer() {
                // Clear existing timers
                clearTimeout(inactivityTimer);
                clearTimeout(warningTimer);

                // Set warning timer (show warning 1 minute before logout)
                warningTimer = setTimeout(function() {
                    showLogoutWarning();
                }, INACTIVITY_TIMEOUT - WARNING_TIME);

                // Set logout timer
                inactivityTimer = setTimeout(function() {
                    if (!warningShown) {
                        performLogout();
                    }
                }, INACTIVITY_TIMEOUT);
            }

            // Bind events to reset timer
            resetEvents.forEach(function(event) {
                document.addEventListener(event, function() {
                    if (!warningShown) {
                        resetInactivityTimer();
                    }
                }, true);
            });

            // Initialize the timer and session status
            resetInactivityTimer();
            updateSessionStatus('active');

            // Handle page visibility change (when user switches tabs)
            document.addEventListener('visibilitychange', function() {
                if (document.visibilityState === 'visible' && !warningShown) {
                    resetInactivityTimer();
                }
            });

            // Make redirectToLogin globally accessible
            window.redirectToLogin = redirectToLogin;

            // Handle browser/tab close events
            window.addEventListener('beforeunload', function(e) {
                if (warningShown) {
                    // If warning is shown, prevent default browser behavior
                    e.preventDefault();
                    e.returnValue = 'Your session is about to expire. Are you sure you want to leave?';
                    return e.returnValue;
                }
            });

            // Network connectivity handling disabled (was part of PWA functionality)
            /*
            window.addEventListener('online', function() {
                if (!warningShown) {
                    resetInactivityTimer();
                }
            });

            window.addEventListener('offline', function() {
                // Pause timers when offline
                clearTimeout(inactivityTimer);
                clearTimeout(warningTimer);
            });
            */

        });

        // Patient context management functions
        function clearPatientContext() {
            if (confirm('Are you sure you want to clear the current patient context?')) {
                // Get CSRF token using multiple fallback methods
                let csrfToken = '';

                // Method 1: Try to get from meta tag
                const metaToken = document.querySelector('meta[name=csrf-token]');
                if (metaToken) {
                    csrfToken = metaToken.getAttribute('content');
                }

                // Method 2: Try to get from hidden input field
                if (!csrfToken) {
                    const inputToken = document.querySelector('input[name=csrfmiddlewaretoken]');
                    if (inputToken) {
                        csrfToken = inputToken.value;
                    }
                }

                // Method 3: Try to get from cookie (fallback)
                if (!csrfToken) {
                    const cookieValue = document.cookie
                        .split('; ')
                        .find(row => row.startsWith('csrftoken='))
                        ?.split('=')[1];
                    if (cookieValue) {
                        csrfToken = cookieValue;
                    }
                }

                // If no CSRF token found, show error
                if (!csrfToken) {
                    alert('Error: CSRF token not found. Please refresh the page and try again.');
                    return;
                }

                fetch('/patients/clear-context/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Remove the patient context from the UI
                        const patientContextElement = document.getElementById('currentPatientContext');
                        if (patientContextElement) {
                            patientContextElement.remove();
                        }
                        // Show success message
                        alert('Patient context cleared successfully.');
                        // Optionally reload the page to refresh context
                        location.reload();
                    } else {
                        alert('Error clearing patient context: ' + (data.error || 'Unknown error'));
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error clearing patient context. Please try again.');
                });
            }
        }
    </script>

    

    {% block extra_js %}{% endblock %}

    <!-- DataTables JS -->
    <script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.11.5/js/dataTables.bootstrap5.min.js"></script>

    <!-- Select2 JS -->
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

    <!-- Custom JS -->
    {% load static %}
    {% compress js %}
    <script src="{% static 'js/sidebar.js' %}"></script>
    {% endcompress %}

    <!-- Final Scroll Prevention Script -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Prevent any remaining auto-scroll behaviors
            const sidebar = document.getElementById('sidebar-container');
            if (sidebar) {
                // Force sidebar to top on page load
                setTimeout(function() {
                    sidebar.scrollTop = 0;
                }, 100);
                
                // Override any scrollIntoView calls for sidebar elements
                const sidebarElements = sidebar.querySelectorAll('*');
                sidebarElements.forEach(element => {
                    if (element.scrollIntoView) {
                        element.scrollIntoView = function(options) {
                            return false;
                        };
                    }
                });
                
                // Prevent hash-based scrolling in sidebar
                if (window.location.hash) {
                    window.scrollTo(0, 0);
                }
                
                // Monitor scroll events to detect and prevent auto-scroll
                let userScrolling = false;
                let scrollTimeout;
                
                sidebar.addEventListener('wheel', function() {
                    userScrolling = true;
                    clearTimeout(scrollTimeout);
                    scrollTimeout = setTimeout(function() {
                        userScrolling = false;
                    }, 150);
                });
                
                sidebar.addEventListener('touchstart', function() {
                    userScrolling = true;
                });
                
                // Reset scroll if it changes without user interaction
                const observer = new MutationObserver(function(mutations) {
                    if (!userScrolling) {
                        sidebar.scrollTop = 0;
                    }
                });
                
                observer.observe(sidebar, { 
                    attributes: true, 
                    attributeFilter: ['scrollTop'],
                    childList: true, 
                    subtree: true 
                });
            }
        });
    </script>

    <!-- HTMX/Alpine.js Performance Optimizations -->
    <script>
        // Global error handler to prevent JavaScript errors
        window.addEventListener('error', function(e) {
            // Suppress H.match errors that might break functionality
            if (e.error && e.error.message && e.error.message.includes('H.match')) {
                e.preventDefault();
                console.warn('Suppressed H.match error:', e.error);
                return false;
            }
        });

        // HTMX Configuration
        try {
            if (typeof htmx !== 'undefined') {
                htmx.config.globalViewTransitions = true;
                htmx.config.scrollBehavior = 'auto'; // Changed to 'auto' to prevent auto-scroll
                htmx.config.defaultSwapStyle = 'innerHTML';
                htmx.config.defaultSwapDelay = 0;
                htmx.config.defaultSettleDelay = 50;
                
                // Show loading indicators
                htmx.on('htmx:beforeRequest', function(evt) {
                    const target = evt.target;
                    if (target) {
                        target.style.opacity = '0.6';
                    }
                });
                
                htmx.on('htmx:afterRequest', function(evt) {
                    const target = evt.target;
                    if (target) {
                        target.style.opacity = '1';
                    }
                    // Re-initialize tooltips and other Bootstrap components
                    if (typeof bootstrap !== 'undefined') {
                        const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
                        tooltipTriggerList.map(function (tooltipTriggerEl) {
                            return new bootstrap.Tooltip(tooltipTriggerEl);
                        });
                    }
                });
                
                // Add custom event for search
                htmx.on('search', function(evt) {
                    try {
                        const form = evt.detail.elt;
                        if (form && form.tagName === 'FORM') {
                            // Get all form data
                            const formData = new FormData(form);
                            const url = new URL(form.action || window.location.pathname);
                            
                            // Add form data to URL
                            for (let [key, value] of formData.entries()) {
                                if (value) {
                                    url.searchParams.set(key, value);
                                }
                            }
                            
                            // Trigger HTMX request
                            htmx.ajax('GET', url, {
                                target: form.getAttribute('hx-target') || '#patient-table-container',
                                swap: form.getAttribute('hx-swap') || 'innerHTML',
                                select: form.getAttribute('hx-select') || 'body'
                            });
                        }
                    } catch (error) {
                        console.warn('HTMX search error suppressed:', error);
                    }
                });
            }
        } catch (error) {
            console.warn('HTMX configuration error suppressed:', error);
        }
        
        // Alpine.js Global Utilities
        try {
            if (typeof Alpine !== 'undefined') {
                Alpine.data('loading', () => ({
                    loading: false,
                    show() { this.loading = true; },
                    hide() { this.loading = false; }
                }));
                
                Alpine.data('search', () => ({
                    query: '',
                    typing: false,
                    timeout: null,
                    search() {
                        this.typing = true;
                        clearTimeout(this.timeout);
                        this.timeout = setTimeout(() => {
                            this.typing = false;
                            // Trigger HTMX search if available
                            const searchForm = document.getElementById('search-form');
                            if (searchForm && typeof htmx !== 'undefined') {
                                try {
                                    htmx.trigger(searchForm, 'search');
                                } catch (error) {
                                    console.warn('HTMX trigger error suppressed:', error);
                                }
                            }
                        }, 500);
                    }
                }));
            }
        } catch (error) {
            console.warn('Alpine.js configuration error suppressed:', error);
        }
    </script>
</body>
</html>

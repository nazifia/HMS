{% extends 'base.html' %}
{% load static %}
{% load widget_tweaks %}

{% block title %}
    {% if is_update %}
        Update Maintenance Log
    {% else %}
        Record Maintenance
    {% endif %} - {{ equipment.name }}
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Page Heading -->
    <div class="d-sm-flex align-items-center justify-content-between mb-4">
        <h1 class="h3 mb-0 text-gray-800">
            {% if is_update %}
                <i class="fas fa-edit mr-2"></i>Update Maintenance Log
            {% else %}
                <i class="fas fa-wrench mr-2"></i>Record Maintenance
            {% endif %}
        </h1>
        <div>
            <a href="{% url 'theatre:equipment_detail' equipment.id %}" class="btn btn-secondary">
                <i class="fas fa-arrow-left mr-2"></i>Back to Equipment
            </a>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-8">
            <div class="card shadow mb-4">
                <div class="card-header py-3 bg-primary text-white">
                    <h6 class="m-0 font-weight-bold">
                        {% if is_update %}
                            Update Maintenance Record for {{ equipment.name }}
                        {% else %}
                            Record New Maintenance for {{ equipment.name }}
                        {% endif %}
                    </h6>
                </div>
                <div class="card-body">
                    <form method="post" enctype="multipart/form-data" novalidate>
                        {% csrf_token %}
                        
                        <!-- Maintenance Type -->
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="{{ form.maintenance_type.id_for_label }}">Maintenance Type <span class="text-danger">*</span></label>
                                {% render_field form.maintenance_type class="form-select" %}
                                {% if form.maintenance_type.errors %}
                                    <div class="text-danger">
                                        {% for error in form.maintenance_type.errors %}
                                            <small>{{ error }}</small>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                            <div class="col-md-6">
                                <label for="{{ form.status.id_for_label }}">Status <span class="text-danger">*</span></label>
                                {% render_field form.status class="form-select" %}
                                {% if form.status.errors %}
                                    <div class="text-danger">
                                        {% for error in form.status.errors %}
                                            <small>{{ error }}</small>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Dates -->
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <label for="{{ form.scheduled_date.id_for_label }}">Scheduled Date <span class="text-danger">*</span></label>
                                {% render_field form.scheduled_date class="form-control" type="date" %}
                                {% if form.scheduled_date.errors %}
                                    <div class="text-danger">
                                        {% for error in form.scheduled_date.errors %}
                                            <small>{{ error }}</small>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                            <div class="col-md-4">
                                <label for="{{ form.completed_date.id_for_label }}">Completed Date</label>
                                {% render_field form.completed_date class="form-control" type="date" %}
                                <small class="form-text text-muted">Required if status is "Completed"</small>
                                {% if form.completed_date.errors %}
                                    <div class="text-danger">
                                        {% for error in form.completed_date.errors %}
                                            <small>{{ error }}</small>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                            <div class="col-md-4">
                                <label for="{{ form.next_due_date.id_for_label }}">Next Due Date</label>
                                {% render_field form.next_due_date class="form-control" type="date" %}
                                {% if form.next_due_date.errors %}
                                    <div class="text-danger">
                                        {% for error in form.next_due_date.errors %}
                                            <small>{{ error }}</small>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Description -->
                        <div class="mb-3">
                            <label for="{{ form.description.id_for_label }}">Description <span class="text-danger">*</span></label>
                            {% render_field form.description class="form-control" %}
                            {% if form.description.errors %}
                                <div class="text-danger">
                                    {% for error in form.description.errors %}
                                        <small>{{ error }}</small>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>

                        <!-- Findings -->
                        <div class="mb-3">
                            <label for="{{ form.findings.id_for_label }}">Findings</label>
                            {% render_field form.findings class="form-control" %}
                            {% if form.findings.errors %}
                                <div class="text-danger">
                                    {% for error in form.findings.errors %}
                                        <small>{{ error }}</small>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>

                        <!-- Parts Replaced -->
                        <div class="mb-3">
                            <label for="{{ form.parts_replaced.id_for_label }}">Parts Replaced</label>
                            {% render_field form.parts_replaced class="form-control" %}
                            {% if form.parts_replaced.errors %}
                                <div class="text-danger">
                                    {% for error in form.parts_replaced.errors %}
                                        <small>{{ error }}</small>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>

                        <!-- Cost and Provider -->
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <label for="{{ form.cost.id_for_label }}">Cost (â‚¦)</label>
                                {% render_field form.cost class="form-control" %}
                                {% if form.cost.errors %}
                                    <div class="text-danger">
                                        {% for error in form.cost.errors %}
                                            <small>{{ error }}</small>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                            <div class="col-md-4">
                                <label for="{{ form.external_provider.id_for_label }}">External Provider</label>
                                {% render_field form.external_provider class="form-control" %}
                                {% if form.external_provider.errors %}
                                    <div class="text-danger">
                                        {% for error in form.external_provider.errors %}
                                            <small>{{ error }}</small>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                            <div class="col-md-4">
                                <label for="{{ form.external_technician.id_for_label }}">External Technician</label>
                                {% render_field form.external_technician class="form-control" %}
                                {% if form.external_technician.errors %}
                                    <div class="text-danger">
                                        {% for error in form.external_technician.errors %}
                                            <small>{{ error }}</small>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Certificate -->
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="{{ form.certificate_number.id_for_label }}">Certificate Number</label>
                                {% render_field form.certificate_number class="form-control" %}
                                <small class="form-text text-muted">For calibration certificates</small>
                                {% if form.certificate_number.errors %}
                                    <div class="text-danger">
                                        {% for error in form.certificate_number.errors %}
                                            <small>{{ error }}</small>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                            <div class="col-md-6">
                                <label for="{{ form.document_file.id_for_label }}">Document/File</label>
                                {% render_field form.document_file class="form-control" %}
                                <small class="form-text text-muted">Upload maintenance report or certificate</small>
                                {% if form.document_file.errors %}
                                    <div class="text-danger">
                                        {% for error in form.document_file.errors %}
                                            <small>{{ error }}</small>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                        </div>

                        <div class="text-center mt-4">
                            <button type="submit" class="btn btn-primary btn-lg">
                                <i class="fas fa-save mr-2"></i>
                                {% if is_update %}
                                    Update Maintenance Log
                                {% else %}
                                    Record Maintenance
                                {% endif %}
                            </button>
                            <a href="{% url 'theatre:equipment_detail' equipment.id %}" class="btn btn-secondary btn-lg ml-2">
                                Cancel
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Equipment Info Sidebar -->
        <div class="col-lg-4">
            <div class="card shadow mb-4">
                <div class="card-header py-3 bg-info text-white">
                    <h6 class="m-0 font-weight-bold"><i class="fas fa-info-circle mr-2"></i>Equipment Info</h6>
                </div>
                <div class="card-body">
                    <p><strong>Name:</strong> {{ equipment.name }}</p>
                    <p><strong>Type:</strong> {{ equipment.get_equipment_type_display }}</p>
                    <p><strong>Quantity:</strong> {{ equipment.quantity_available }}</p>
                    <p><strong>Status:</strong> 
                        {% if equipment.is_available %}
                            <span class="badge bg-success">Available</span>
                        {% else %}
                            <span class="badge bg-danger">Unavailable</span>
                        {% endif %}
                    </p>
                    <hr>
                    <p><strong>Last Maintenance:</strong><br>
                        {% if equipment.last_maintenance_date %}
                            {{ equipment.last_maintenance_date|date:"M d, Y" }}
                        {% else %}
                            <span class="text-muted">Never</span>
                        {% endif %}
                    </p>
                    <p><strong>Next Maintenance:</strong><br>
                        {% if equipment.next_maintenance_date %}
                            {% if equipment.next_maintenance_date < today %}
                                <span class="text-danger">{{ equipment.next_maintenance_date|date:"M d, Y" }} (OVERDUE)</span>
                            {% else %}
                                {{ equipment.next_maintenance_date|date:"M d, Y" }}
                            {% endif %}
                        {% else %}
                            <span class="text-muted">Not scheduled</span>
                        {% endif %}
                    </p>
                    <p><strong>Last Calibration:</strong><br>
                        {% if equipment.last_calibration_date %}
                            {{ equipment.last_calibration_date|date:"M d, Y" }}
                        {% else %}
                            <span class="text-muted">Never</span>
                        {% endif %}
                    </p>
                </div>
            </div>

            <div class="card shadow">
                <div class="card-header py-3 bg-secondary text-white">
                    <h6 class="m-0 font-weight-bold"><i class="fas fa-lightbulb mr-2"></i>Quick Tips</h6>
                </div>
                <div class="card-body">
                    <ul class="list-unstyled mb-0">
                        <li class="mb-2"><i class="fas fa-check text-success mr-2"></i>Set status to "Completed" when work is done</li>
                        <li class="mb-2"><i class="fas fa-check text-success mr-2"></i>Always set next due date for scheduling</li>
                        <li class="mb-2"><i class="fas fa-check text-success mr-2"></i>Upload certificates for calibration</li>
                        <li><i class="fas fa-check text-success mr-2"></i>Record costs for budget tracking</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

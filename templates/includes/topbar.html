{% load custom_filters %}
{% load consultation_tags %}
<!-- Topbar -->
<nav class="navbar navbar-expand-lg navbar-light bg-white topbar mb-4 static-top shadow w-100">

    <!-- Sidebar Toggle (Topbar) -->
    <button id="sidebarToggleTop" class="btn btn-link d-lg-none rounded-circle mr-3">
        <i class="fa fa-bars"></i>
    </button>

    <!-- Topbar Brand (visible on mobile/tablet) -->
    <span class="navbar-brand d-lg-none mb-0 h5 text-dark">HMS</span>

    <!-- Topbar Search -->
    {% comment %} <form class="d-none d-sm-inline-block form-inline mr-auto ml-md-3 my-2 my-md-0 mw-100 navbar-search">
        <div class="input-group">
            <input type="text" class="form-control bg-light border-0 small" placeholder="Search for..." aria-label="Search" aria-describedby="basic-addon2">
            <div class="input-group-append">
                <button class="btn btn-primary" type="button">
                    <i class="fas fa-search fa-sm"></i>
                </button>
            </div>
        </div>
    </form> {% endcomment %}

    <!-- Topbar Navbar -->
    <ul class="navbar-nav ml-auto topbar-nav">

        <!-- Nav Item - Search Dropdown (Visible Only XS) -->
        <li class="nav-item dropdown no-arrow d-sm-none">
            <a class="nav-link dropdown-toggle" href="#" id="searchDropdown" role="button" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                <i class="fas fa-search fa-fw"></i>
            </a>
            <!-- Dropdown - Messages -->
            <div class="dropdown-menu dropdown-menu-right p-3 shadow animated--grow-in" aria-labelledby="searchDropdown">
                <form class="form-inline mr-auto w-100 navbar-search">
                    <div class="input-group">
                        <input type="text" class="form-control bg-light border-0 small" placeholder="Search for..." aria-label="Search" aria-describedby="basic-addon2">
                        <div class="input-group-append">
                            <button class="btn btn-primary" type="button">
                                <i class="fas fa-search fa-sm"></i>
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </li>

        <!-- Custom: Registration Links -->
        {% if user.is_authenticated %}
            <!-- Quick Access Links - Hidden on small screens, shown as icons on medium, full on large -->
            <!-- Custom: Staff Management -->
            {% if user.is_authenticated %}
                <!-- Bed Dashboard - HMS Custom Permission: manage_admission OR view_inpatient_records -->
                {% if user|has_permission:'manage_admission' or user|has_permission:'view_inpatient_records' %}
                <li class="nav-item d-none d-xl-block">
                    <a class="nav-link" href="{% url 'inpatient:bed_dashboard' %}">
                        <i class="fas fa-bed fa-sm fa-fw mr-2 text-gray-400"></i>
                        <span class="d-none d-xxl-inline">Bed Dashboard</span>
                    </a>
                </li>
                {% endif %}

                <!-- Dispensing Report - HMS Custom Permission: manage_inventory OR dispense_medication -->
                {% if user|has_permission:'manage_inventory' or user|has_permission:'dispense_medication' %}
                <li class="nav-item d-none d-xl-block">
                    <a class="nav-link" href="{% url 'pharmacy:dispensing_report' %}">
                        <i class="fas fa-pills fa-sm fa-fw mr-2 text-gray-400"></i>
                        <span class="d-none d-xxl-inline">Dispensing Report</span>
                    </a>
                </li>
                {% endif %}

                <!-- Revenue Statistics - HMS Custom Permission: view_financial_reports -->
                {% if user|has_permission:'view_financial_reports' %}
                <li class="nav-item d-none d-xl-block">
                    {% load url_helpers %}
                    {% safe_url_or_default 'pharmacy:simple_revenue_statistics' '#' as revenue_url %}
                    <a class="nav-link" href="{{ revenue_url }}">
                        <i class="fas fa-chart-line fa-sm fa-fw mr-2 text-gray-400"></i>
                        <span class="d-none d-xxl-inline">Revenue Statistics</span>
                    </a>
                </li>
                {% endif %}

                <!-- User Management - HMS Custom Permission: view_user_management -->
                {% if user|has_permission:'view_user_management' %}
                <li class="nav-item d-none d-lg-block">
                    <a class="nav-link" href="{% url 'accounts:user_dashboard' %}">
                        <i class="fas fa-user-shield fa-sm fa-fw mr-2 text-gray-400"></i>
                        <span class="d-none d-xxl-inline">User Management</span>
                    </a>
                </li>
                {% endif %}

                <!-- Notifications - Available to all authenticated users -->
                <li class="nav-item">
                    <a class="nav-link" href="{% url 'core:notifications_list' %}">
                        <i class="fas fa-bell fa-sm fa-fw mr-2 text-gray-400"></i>
                        <span class="d-none d-lg-inline">Notifications</span>
                    </a>
                </li>
            {% else %}
                <li class="nav-item">
                    <a class="nav-link" href="{% url 'accounts:login' %}">
                        <i class="fas fa-sign-in-alt fa-sm fa-fw mr-2 text-gray-400"></i>
                        <span class="d-none d-sm-inline">Login</span>
                    </a>
                </li>
            {% endif %}
        {% endif %}
            <!-- End Custom: Staff Management -->

        <!-- Pharmacy Dispensary Display -->
        {% if request.session.selected_dispensary_id and user.is_authenticated and user.is_active %}
        <li class="nav-item">
            <span class="nav-link text-warning">
                <i class="fas fa-clinic-medical fa-sm fa-fw mr-2"></i>
                <span>
                    {{ request.session.selected_dispensary_name|default:"Selected Dispensary" }}
                </span>
                {% if request.session.selected_dispensary_id %}
                <a href="{% url 'pharmacy:select_dispensary' %}" class="ml-2 text-danger" title="Change dispensary">
                    <i class="fas fa-exchange-alt"></i>
                </a>
                {% endif %}
            </span>
        </li>
        {% endif %}

        <div class="topbar-divider d-none d-sm-block"></div>

        <!-- Nav Item - User Information -->
        {% if user.is_authenticated %}
        <li class="nav-item dropdown no-arrow">
            <a class="nav-link dropdown-toggle" href="#" id="userDropdown" role="button" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                {% comment %} <span class="mr-2 d-none d-lg-inline text-gray-600 small">{{ user.get_full_name|default:user.username }}</span> {% endcomment %}
                <span class="mr-2 d-none d-lg-inline text-gray-600 small">
                    {% if user.first_name or user.last_name %}
                        {{ user.get_full_name }}
                    {% elif user.username %}
                        {{ user.username }}
                    {% else %}
                        {{ user.phone_number }} {# Fallback to phone_number if all else fails #}
                    {% endif %}
                </span>
                {% if user.profile.profile_picture %}
                    <img class="img-profile rounded-circle" src="{{ user.profile.profile_picture.url }}">
                {% else %}
                    <img class="img-profile rounded-circle" src="/static/img/undraw_profile.svg">
                {% endif %}
            </a>
            <!-- Dropdown - User Information -->
            <div class="dropdown-menu dropdown-menu-right shadow animated--grow-in" aria-labelledby="userDropdown">
                <a class="dropdown-item" href="{% url 'accounts:profile' %}">
                    <i class="fas fa-user fa-sm fa-fw mr-2 text-gray-400"></i>
                    Profile
                </a>
                <a class="dropdown-item" href="#">
                    <i class="fas fa-cogs fa-sm fa-fw mr-2 text-gray-400"></i>
                    Settings
                </a>
                <a class="dropdown-item" href="#">
                    <i class="fas fa-list fa-sm fa-fw mr-2 text-gray-400"></i>
                    Activity Log
                </a>
                <div class="dropdown-divider"></div>
                <form method="post" action="{% url 'accounts:logout' %}" class="dropdown-item p-0">
                    {% csrf_token %}
                    <button type="submit" class="dropdown-item">
                        <i class="fas fa-sign-out-alt fa-sm fa-fw mr-2 text-gray-400"></i>
                        Logout
                    </button>
                </form>
            </div>
        </li>
        {% else %}
        <li class="nav-item">
            <a class="nav-link" href="{% url 'accounts:login' %}">
                <i class="fas fa-sign-in-alt fa-sm fa-fw mr-2 text-gray-400"></i>
                Login
            </a>
        </li>
        {% endif %}

    </ul>
    <!-- End of Topbar -->
    <!-- Custom CSS for Priority Colors and Responsive Topbar -->
    <style>
        .bg-emergency-light { background-color: #dc3545; }
        .bg-urgent-light { background-color: #ffc107; }
        .bg-normal-light { background-color: #28a745; }

        /* Topbar Responsive Styles */
        .topbar {
            position: sticky;
            top: 0;
            z-index: 1030;
            padding: 0.5rem 1rem;
        }

        .topbar-nav {
            display: flex;
            align-items: center;
            flex-wrap: nowrap;
            overflow-x: auto;
        }

        /* Mobile Styles (< 576px) */
        @media (max-width: 575.98px) {
            .topbar {
                padding: 0.5rem;
            }

            .topbar .nav-link {
                padding: 0.5rem;
                font-size: 0.875rem;
            }

            .topbar .navbar-brand {
                font-size: 1rem;
                margin-right: auto;
            }

            #sidebarToggleTop {
                margin-right: 0.5rem;
            }

            .topbar-nav {
                gap: 0.25rem;
            }

            .img-profile {
                width: 32px;
                height: 32px;
            }
        }

        /* Tablet Styles (576px - 991px) */
        @media (min-width: 576px) and (max-width: 991.98px) {
            .topbar {
                padding: 0.75rem 1rem;
            }

            .topbar .nav-link {
                padding: 0.5rem 0.75rem;
                font-size: 0.9rem;
            }

            .topbar .navbar-brand {
                font-size: 1.25rem;
            }

            .topbar-nav {
                gap: 0.5rem;
            }

            .img-profile {
                width: 36px;
                height: 36px;
            }

            /* Show only icons on tablet for space efficiency */
            .topbar .nav-link span {
                display: none;
            }

            .topbar .nav-link i {
                margin-right: 0 !important;
            }
        }

        /* Desktop Styles (992px - 1199px) */
        @media (min-width: 992px) and (max-width: 1199.98px) {
            .topbar {
                padding: 1rem;
            }

            .topbar .nav-link {
                padding: 0.5rem 1rem;
                font-size: 0.95rem;
            }

            .topbar-nav {
                gap: 0.75rem;
            }

            .img-profile {
                width: 40px;
                height: 40px;
            }
        }

        /* Large Desktop Styles (>= 1200px) */
        @media (min-width: 1200px) {
            .topbar {
                padding: 1rem 1.5rem;
            }

            .topbar .nav-link {
                padding: 0.5rem 1rem;
                font-size: 1rem;
            }

            .topbar-nav {
                gap: 1rem;
            }

            .img-profile {
                width: 40px;
                height: 40px;
            }
        }

        /* Responsive dropdown menu */
        .dropdown-menu {
            max-width: 90vw;
        }

        @media (max-width: 575.98px) {
            .dropdown-menu {
                font-size: 0.875rem;
            }

            .dropdown-item {
                padding: 0.5rem 1rem;
            }
        }

        /* Ensure topbar doesn't overflow */
        .topbar-nav::-webkit-scrollbar {
            height: 2px;
        }

        .topbar-nav::-webkit-scrollbar-thumb {
            background: #cbd5e0;
            border-radius: 10px;
        }

        .topbar-nav::-webkit-scrollbar-track {
            background: transparent;
        }

        /* Responsive spacing for divider */
        @media (max-width: 767.98px) {
            .topbar-divider {
                display: none !important;
            }
        }
    </style>

</nav>
<!-- End of Topbar -->

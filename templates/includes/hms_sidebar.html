{% load custom_filters %}
{% load core_tags %}
{% load hms_permissions %}

<!-- Mobile Overlay -->
<div id="sidebar-overlay" class="sidebar-overlay"></div>

<!-- Sidebar -->
<div class="d-flex flex-column bg-dark sidebar vh-100" id="sidebar-container" style="width:300px !important;min-height:100vh;overflow-y:auto;scroll-behavior:auto;">
    <ul class="navbar-nav sidebar-dark accordion flex-grow-1" id="accordionSidebar" style="overflow:visible;scroll-behavior:auto;">

        <!-- Mobile Header with Hamburger Menu -->
        <div class="d-md-none mobile-sidebar-header bg-dark d-flex align-items-center justify-content-between p-3 border-bottom border-secondary">
            <div class="sidebar-brand d-flex align-items-center" href="{% url 'home' %}">
                <div class="sidebar-brand-icon">
                    <i class="fas fa-hospital text-white"></i>
                </div>
                <div class="sidebar-brand-text mx-2 text-white">HMS</div>
            </div>
            <button class="btn btn-link text-white p-0" id="mobileSidebarClose">
                <i class="fas fa-times fa-lg"></i>
            </button>
        </div>

        <!-- Desktop Sidebar - Brand -->
        <a class="sidebar-brand d-none d-md-flex align-items-center justify-content-center mt-3 mb-4" href="{% url 'home' %}">
            <div class="sidebar-brand-icon">
                <i class="fas fa-hospital text-white"></i>
            </div>
            <div class="sidebar-brand-text mx-3 text-white">HMS</div>
        </a>

        <!-- Divider -->
        <hr class="sidebar-divider my-0">

        <!-- Nav Item - Dashboard -->
        {% if user.is_superuser or user|can_show_ui:'menu_dashboard' %}
        <li class="nav-item {% if request.path == '/dashboard/' %}active{% endif %}">
            <a class="nav-link" href="{% url 'dashboard:dashboard' %}">
                <i class="fas fa-fw fa-tachometer-alt text-white"></i>
                <span class="text-white">Dashboard</span>
            </a>
        </li>
        {% endif %}

        {% if user.is_superuser or user|has_permission:'roles.view' or user|has_permission:'users.view' %}
        <li class="nav-item {% if 'role_management' in request.path or 'create_role' in request.path or 'permission_management' in request.path or 'role_demo' in request.path or 'user_permissions' in request.path or 'user_privileges' in request.path %}active{% endif %}">
            <a class="nav-link {% if not 'role_management' in request.path and not 'create_role' in request.path and not 'permission_management' in request.path and not 'role_demo' in request.path and not 'user_permissions' in request.path and not 'user_privileges' in request.path %}collapsed{% endif %}" href="#" data-bs-toggle="collapse" data-bs-target="#collapseAccessControl" aria-expanded="{% if 'role_management' in request.path or 'create_role' in request.path or 'permission_management' in request.path or 'role_demo' in request.path or 'user_permissions' in request.path or 'user_privileges' in request.path %}true{% else %}false{% endif %}" aria-controls="collapseAccessControl">
                <i class="fas fa-fw fa-shield-alt text-white"></i>
                <span class="text-white">Access Control</span>
            </a>
            <div id="collapseAccessControl" class="collapse {% if 'role_management' in request.path or 'create_role' in request.path or 'permission_management' in request.path or 'role_demo' in request.path or 'user_permissions' in request.path or 'user_privileges' in request.path %}show{% endif %}" aria-labelledby="headingAccessControl" data-parent="#accordionSidebar">
                <div class="bg-white py-2 collapse-inner rounded">
                    <h6 class="collapse-header">RBAC Management:</h6>
                    {% if user.is_superuser or user|has_permission:'roles.view' %}
                    <a class="collapse-item {% if 'role_management' in request.path %}active{% endif %}" href="{% url 'accounts:role_management' %}">Manage Roles</a>
                    {% endif %}
                    {% if user.is_superuser or user|has_permission:'roles.edit' %}
                    <a class="collapse-item {% if 'create_role' in request.path %}active{% endif %}" href="{% url 'accounts:create_role' %}">Create Role</a>
                    {% endif %}
                    {% if user.is_superuser or user|has_permission:'roles.view' %}
                    <a class="collapse-item {% if 'permission_management' in request.path %}active{% endif %}" href="{% url 'accounts:permission_management' %}">System Permissions</a>
                    {% endif %}
                    {% if user.is_superuser or user|has_permission:'users.view' %}
                    <a class="collapse-item {% if 'user_permissions' in request.path %}active{% endif %}" href="{% url 'accounts:superuser_user_permissions' %}">User Permissions</a>
                    {% endif %}
                    {% if user.is_superuser %}
                    <a class="collapse-item {% if 'role_demo' in request.path %}active{% endif %}" href="{% url 'accounts:role_demo' %}">Role Demo</a>
                    {% endif %}
                </div>
            </div>
        </li>
        {% endif %}

        <!-- Divider -->
        <hr class="sidebar-divider">



        <!-- Divider -->
        <hr class="sidebar-divider">

        <!-- Heading -->
        <div class="sidebar-heading">
            Patient Care
        </div>

        <!-- Nav Item - Consultations -->
        {% if user.is_superuser or user|has_role:'admin' or user|has_role:'doctor' or user|has_role:'nurse' or user|has_role:'receptionist' or user|has_role:'health_record_officer' %}
        <li class="nav-item {% if '/consultations/' in request.path %}active{% endif %}">
            <a class="nav-link {% if not '/consultations/' in request.path %}collapsed{% endif %}" href="#" data-bs-toggle="collapse" data-bs-target="#collapseConsultations" aria-expanded="{% if '/consultations/' in request.path %}true{% else %}false{% endif %}" aria-controls="collapseConsultations">
                <i class="fas fa-fw fa-comments text-white"></i>
                <span class="text-white">Consultations</span>
            </a>
            <div id="collapseConsultations" class="collapse {% if '/consultations/' in request.path %}show{% endif %}" aria-labelledby="headingConsultations" data-parent="#accordionSidebar">
                <div class="bg-white py-2 collapse-inner rounded">
                    <h6 class="collapse-header">Consultation Management:</h6>
                    <a class="collapse-item {% if '/consultations/list/' in request.path %}active{% endif %}" href="{% url 'consultations:consultation_list' %}">All Consultations</a>
                    <a class="collapse-item {% if '/consultations/patients/' in request.path %}active{% endif %}" href="{% url 'consultations:patient_list' %}">Create Consultation</a>
                    <a class="collapse-item {% if '/consultations/referrals/' in request.path %}active{% endif %}" href="{% url 'consultations:referral_list' %}">Referrals</a>
                    {% if user|has_role:'doctor' %}
                    <a class="collapse-item {% if '/consultations/doctor/' in request.path %}active{% endif %}" href="{% url 'consultations:doctor_dashboard' %}">Doctor Dashboard</a>
                    {% endif %}
                    {% if user.profile and user.profile.department %}
                    <a class="collapse-item {% if '/consultations/department/' in request.path %}active{% endif %}" href="{% url 'consultations:department_referral_dashboard' %}">Department Referrals</a>
                    {% endif %}
                </div>
            </div>
        </li>
        {% endif %}

        <!-- Nav Item - Patients -->
        {% if user.is_superuser or user|can_show_ui:'menu_patients' %}
        <li class="nav-item {% if '/patients/' in request.path %}active{% endif %}">
            <a class="nav-link {% if not '/patients/' in request.path %}collapsed{% endif %}" href="#" data-bs-toggle="collapse" data-bs-target="#collapsePatients" aria-expanded="{% if '/patients/' in request.path %}true{% else %}false{% endif %}" aria-controls="collapsePatients">
                <i class="fas fa-fw fa-user-injured text-white"></i>
                <span class="text-white">Patients</span>
            </a>
            <div id="collapsePatients" class="collapse {% if '/patients/' in request.path %}show{% endif %}" aria-labelledby="headingPatients" data-parent="#accordionSidebar">
                <div class="bg-white py-2 collapse-inner rounded">
                    <h6 class="collapse-header">Patient Management:</h6>
                    <a class="collapse-item {% if request.path == '/patients/list/' %}active{% endif %}" href="{% url 'patients:list' %}">All Patients</a>
                    {% if user|has_permission:'create_patient' %}
                    <a class="collapse-item {% if request.path == '/patients/register/' %}active{% endif %}" href="{% url 'patients:register' %}">Register Patient</a>
                    <a class="collapse-item {% if request.path == '/nhia/register-independent/' %}active{% endif %}" href="{% url 'nhia:register_independent_nhia_patient' %}">Register NHIA Patient</a>
                    <a class="collapse-item {% if request.path == '/nhia/register-patient/' %}active{% endif %}" href="{% url 'nhia:register_patient_for_nhia' %}">Add Patient to NHIA</a>
                    <a class="collapse-item {% if request.path == '/retainership/register-independent/' %}active{% endif %}" href="{% url 'retainership:register_independent_retainership_patient' %}">Register Retainership Patient</a>
                    {% comment %} <a class="collapse-item {% if request.path == '/retainership/register-patient/' %}active{% endif %}" href="{% url 'retainership:select_patient_for_retainership' %}">Register Retainership Patient</a> {% endcomment %}
                    <a class="collapse-item {% if '/nhia/patients/' in request.path %}active{% endif %}" href="{% url 'nhia:nhia_patient_list' %}">NHIA Patients</a>
                    {% endif %}
                    <!-- Retainership Patients: always visible, styled like NHIA -->
                    <a class="collapse-item {% if '/retainership/patients/' in request.path %}active{% endif %}" href="{% url 'retainership:retainership_patient_list' %}">Retainership Patients</a>
                </div>
            </div>
        </li>
        {% endif %}

        <!-- Nav Item - Doctors (Admin can manage, All can view list) -->
        {% if user.is_authenticated %}
        <li class="nav-item {% if '/doctors/' in request.path %}active{% endif %}">
            <a class="nav-link {% if not '/doctors/' in request.path %}collapsed{% endif %}" href="#" data-bs-toggle="collapse" data-bs-target="#collapseDoctors" aria-expanded="{% if '/doctors/' in request.path %}true{% else %}false{% endif %}" aria-controls="collapseDoctors">
                <i class="fas fa-fw fa-user-md text-white"></i>
                <span class="text-white">Doctors</span>
            </a>
            <div id="collapseDoctors" class="collapse {% if '/doctors/' in request.path %}show{% endif %}" aria-labelledby="headingDoctors" data-parent="#accordionSidebar">
                <div class="bg-white py-2 collapse-inner rounded">
                    <h6 class="collapse-header">Doctor Directory:</h6>
                    <a class="collapse-item {% if request.path == '/doctors/' %}active{% endif %}" href="{% url 'doctors:doctor_list' %}">All Doctors</a>

                    {% if user.is_superuser or user|has_role:'admin' %}
                    <div class="collapse-divider"></div>
                    <h6 class="collapse-header">Administration:</h6>
                    <a class="collapse-item {% if request.path == '/doctors/admin/doctors/' %}active{% endif %}" href="{% url 'doctors:manage_doctors' %}">Manage Doctors</a>
                    <a class="collapse-item {% if request.path == '/doctors/admin/doctors/add/' %}active{% endif %}" href="{% url 'doctors:add_doctor' %}">Add New Doctor</a>
                    <a class="collapse-item {% if request.path == '/doctors/admin/specializations/' %}active{% endif %}" href="{% url 'doctors:manage_specializations' %}">Specializations</a>
                    <a class="collapse-item {% if request.path == '/doctors/admin/leave-requests/' %}active{% endif %}" href="{% url 'doctors:manage_leave_requests' %}">Leave Requests</a>
                    {% endif %}

                    {% if user|has_role:'doctor' %}
                    <div class="collapse-divider"></div>
                    <h6 class="collapse-header">Doctor Portal:</h6>
                    <a class="collapse-item {% if request.path == '/consultations/doctor/dashboard/' %}active{% endif %}" href="{% url 'consultations:doctor_dashboard' %}">My Dashboard</a>
                    <a class="collapse-item {% if request.path == '/consultations/doctor/waiting-list/' %}active{% endif %}" href="{% url 'consultations:doctor_waiting_list' %}">Waiting Patients</a>
                    <a class="collapse-item {% if request.path == '/consultations/doctor/patients/' %}active{% endif %}" href="{% url 'consultations:patient_list' %}">My Patients</a>
                    <a class="collapse-item {% if request.path == '/consultations/doctor/consultations/' %}active{% endif %}" href="{% url 'consultations:consultation_list' %}">Consultations</a>
                    <a class="collapse-item {% if request.path == '/consultations/doctor/referrals/' %}active{% endif %}" href="{% url 'consultations:referral_list' %}">Referrals</a>
                    <a class="collapse-item {% if request.path == '/doctors/profile/' %}active{% endif %}" href="{% url 'doctors:doctor_profile' %}">My Profile</a>
                    <a class="collapse-item {% if request.path == '/doctors/availability/' %}active{% endif %}" href="{% url 'doctors:manage_availability' %}">My Availability</a>
                    <a class="collapse-item {% if request.path == '/doctors/education/' %}active{% endif %}" href="{% url 'doctors:manage_education' %}">Education</a>
                    <a class="collapse-item {% if request.path == '/doctors/experience/' %}active{% endif %}" href="{% url 'doctors:manage_experience' %}">Experience</a>
                    <a class="collapse-item {% if request.path == '/doctors/leave/' %}active{% endif %}" href="{% url 'doctors:request_leave' %}">Request Leave</a>
                    {% endif %}
                </div>
            </div>
        </li>
        {% endif %}

        <!-- Nav Item - Inpatient Management -->
        {% if user.is_superuser or user|has_role:'admin' or user|has_role:'nurse' or user|has_role:'doctor' %}
        <li class="nav-item {% if '/inpatient/' in request.path %}active{% endif %}">
            <a class="nav-link {% if not '/inpatient/' in request.path %}collapsed{% endif %}" href="#" data-bs-toggle="collapse" data-bs-target="#collapseInpatient" aria-expanded="{% if '/inpatient/' in request.path %}true{% else %}false{% endif %}" aria-controls="collapseInpatient">
                <i class="fas fa-fw fa-hospital-alt text-white"></i>
                <span class="text-white">Inpatient</span>
            </a>
            <div id="collapseInpatient" class="collapse {% if '/inpatient/' in request.path %}show{% endif %}" aria-labelledby="headingInpatient" data-parent="#accordionSidebar">
                <div class="bg-white py-2 collapse-inner rounded">
                    <h6 class="collapse-header">Inpatient Management:</h6>
                    <a class="collapse-item {% if request.path == '/inpatient/admissions/' %}active{% endif %}" href="{% url 'inpatient:admissions' %}">Admissions</a>
                    <a class="collapse-item {% if request.path == '/inpatient/wards/' %}active{% endif %}" href="{% url 'inpatient:wards' %}">Wards</a>
                    <a class="collapse-item {% if request.path == '/inpatient/beds/' %}active{% endif %}" href="{% url 'inpatient:beds' %}">Beds</a>
                    <a class="collapse-item {% if request.path == '/inpatient/bed-dashboard/' %}active{% endif %}" href="{% url 'inpatient:bed_dashboard' %}">Bed Dashboard</a>
                    <div class="collapse-divider"></div>
                    <h6 class="collapse-header">Reports:</h6>
                    <a class="collapse-item {% if request.path == '/inpatient/reports/bed-occupancy/' %}active{% endif %}" href="{% url 'inpatient:bed_occupancy_report' %}">Bed Occupancy Report</a>
                </div>
            </div>
        </li>
        {% endif %}

        <!-- Nav Item - Appointments -->
        {% if user.is_superuser or user|can_show_ui:'menu_appointments' %}
        <li class="nav-item {% if '/appointments/' in request.path %}active{% endif %}">
            <a class="nav-link {% if not '/appointments/' in request.path %}collapsed{% endif %}" href="#" data-bs-toggle="collapse" data-bs-target="#collapseAppointments" aria-expanded="{% if '/appointments/' in request.path %}true{% else %}false{% endif %}" aria-controls="collapseAppointments">
                <i class="fas fa-fw fa-calendar-check text-white"></i>
                <span class="text-white">Appointments</span>
            </a>
            <div id="collapseAppointments" class="collapse {% if '/appointments/' in request.path %}show{% endif %}" aria-labelledby="headingAppointments" data-parent="#accordionSidebar">
                <div class="bg-white py-2 collapse-inner rounded">
                    <h6 class="collapse-header">Appointment Management:</h6>
                    <a class="collapse-item {% if request.path == '/appointments/list/' %}active{% endif %}" href="{% url 'appointments:list' %}">All Appointments</a>

                    <!-- Only receptionists, health record officers, and admins can create appointments -->
                    {% if user|has_permission:'create_appointment' %}
                    <a class="collapse-item {% if request.path == '/appointments/create/' %}active{% endif %}" href="{% url 'appointments:create' %}">Schedule Appointment</a>
                    {% endif %}

                    <!-- Doctor-specific appointment views -->
                    {% if user|has_role:'doctor' %}
                    <a class="collapse-item {% if request.path == '/appointments/doctor/' %}active{% endif %}" href="{% url 'appointments:doctor_appointments' user.id %}">My Appointments</a>
                    {% endif %}

                    <!-- Admin and receptionist schedule management -->
                    {% if user.is_superuser or user|has_role:'admin' or user|has_role:'receptionist' or user|has_role:'health_record_officer' %}
                    <div class="collapse-divider"></div>
                    <h6 class="collapse-header">Schedule Management:</h6>
                    <a class="collapse-item {% if '/appointments/schedules/' in request.path %}active{% endif %}" href="{% url 'appointments:manage_doctor_schedule' %}">Doctor Schedules</a>
                    <a class="collapse-item {% if '/appointments/leaves/' in request.path %}active{% endif %}" href="{% url 'appointments:manage_doctor_leaves' %}">Doctor Leaves</a>
                    {% endif %}
                </div>
            </div>
        </li>
        {% endif %}

        <!-- Nav Item - Consulting Rooms and Waiting List (HMS Custom Permission: access_sensitive_data) -->
        {% if user.is_superuser or user|has_role:'admin' or user|has_role:'doctor' or user|has_role:'receptionist' or user|has_role:'health_record_officer' %}
        <li class="nav-item {% if '/consultations/consulting-rooms/' in request.path or '/consultations/waiting-list/' in request.path %}active{% endif %}">
            <a class="nav-link {% if not '/consultations/consulting-rooms/' in request.path and not '/consultations/waiting-list/' in request.path %}collapsed{% endif %}" href="#" data-bs-toggle="collapse" data-bs-target="#collapseConsultingRooms" aria-expanded="{% if '/consultations/consulting-rooms/' in request.path or '/consultations/waiting-list/' in request.path %}true{% else %}false{% endif %}" aria-controls="collapseConsultingRooms">
                <i class="fas fa-fw fa-door-open text-white"></i>
                <span class="text-white">Consulting Rooms</span>
            </a>
            <div id="collapseConsultingRooms" class="collapse {% if '/consultations/consulting-rooms/' in request.path or '/consultations/waiting-list/' in request.path %}show{% endif %}" aria-labelledby="headingConsultingRooms" data-parent="#accordionSidebar">
                <div class="bg-white py-2 collapse-inner rounded">
                    <h6 class="collapse-header">Room Management:</h6>
                    <a class="collapse-item {% if request.path == '/consultations/consulting-rooms/' %}active{% endif %}" href="{% url 'consultations:consulting_room_list' %}">All Rooms</a>

                    {% if user.is_superuser or user|has_role:'admin' %}
                    <a class="collapse-item {% if request.path == '/consultations/consulting-rooms/create/' %}active{% endif %}" href="{% url 'consultations:create_consulting_room' %}">Add New Room</a>
                    {% endif %}

                    <div class="collapse-divider"></div>
                    <h6 class="collapse-header">Patient Management:</h6>

                    {% if user|has_any_permission:'create_consultation,view_consultations' %}
                    <a class="collapse-item {% if request.path == '/consultations/waiting-list/' %}active{% endif %}" href="{% url 'consultations:waiting_list' %}">Waiting List</a>
                    <a class="collapse-item {% if request.path == '/consultations/waiting-list/add/' %}active{% endif %}" href="{% url 'consultations:add_to_waiting_list' %}">Add to Waiting List</a>
                    {% endif %}

                    {% if user|has_role:'doctor' %}
                    <a class="collapse-item {% if request.path == '/consultations/doctor/waiting-list/' %}active{% endif %}" href="{% url 'consultations:doctor_waiting_list' %}">My Waiting Patients</a>
                    {% endif %}
                </div>
            </div>
        </li>
        {% endif %}

        <!-- Divider -->
        <hr class="sidebar-divider">

        <!-- Heading -->
        <div class="sidebar-heading">
            Medical Services
        </div>

        <!-- Nav Item - Pharmacy -->
        {% if user.is_superuser or user|can_show_ui:'menu_pharmacy' %}
        <li class="nav-item {% if '/pharmacy/' in request.path %}active{% endif %}">
            <a class="nav-link {% if not '/pharmacy/' in request.path %}collapsed{% endif %}" href="#" data-bs-toggle="collapse" data-bs-target="#collapsePharmacy" aria-expanded="{% if '/pharmacy/' in request.path %}true{% else %}false{% endif %}" aria-controls="collapsePharmacy">
                <i class="fas fa-fw fa-pills text-white"></i>
                <span class="text-white">Pharmacy</span>
            </a>
            <div id="collapsePharmacy" class="collapse {% if '/pharmacy/' in request.path %}show{% endif %}" aria-labelledby="headingPharmacy" data-parent="#accordionSidebar">
                <div class="bg-white py-2 collapse-inner rounded">
                    <h6 class="collapse-header">Pharmacy Management:</h6>

                    <!-- Core Operations -->
                    <a class="collapse-item {% if request.path == '/pharmacy/prescriptions/' %}active{% endif %}" href="{% url 'pharmacy:prescriptions' %}">Prescriptions</a>
                    <a class="collapse-item {% if '/pharmacy/dispensed-items/' in request.path %}active{% endif %}" href="{% url 'pharmacy:dispensed_items_tracker' %}">Dispensed Items Tracker</a>

                    <!-- Cart Management -->
                    <a class="collapse-item {% if '/pharmacy/carts/' in request.path %}active{% endif %}" href="{% url 'pharmacy:cart_list' %}">Prescription Carts</a>

                    <!-- Enhanced Transfer System -->
                    <a class="collapse-item {% if '/pharmacy/transfers/' in request.path %}active{% endif %}" href="{% url 'pharmacy:enhanced_transfer_dashboard' %}">Enhanced Transfers</a>

                    <!-- Inventory management for pharmacists, admins, and users with inventory permissions -->
                    {% if user.is_superuser or user|has_role:'admin' or user|has_role:'pharmacist' or user|has_permission:'manage_inventory' %}
                    <a class="collapse-item {% if request.path == '/pharmacy/inventory/' %}active{% endif %}" href="{% url 'pharmacy:inventory' %}">Inventory</a>
                    <a class="collapse-item {% if '/pharmacy/alerts/' in request.path %}active{% endif %}" href="{% url 'pharmacy:alerts' %}">Stock Alerts</a>

                    <div class="collapse-divider"></div>
                    <h6 class="collapse-header">Medical Packs:</h6>
                    <a class="collapse-item {% if '/pharmacy/packs/' in request.path %}active{% endif %}" href="{% url 'pharmacy:medical_pack_list' %}">All Medical Packs</a>
                    <a class="collapse-item {% if request.path == '/pharmacy/packs/create/' %}active{% endif %}" href="{% url 'pharmacy:create_medical_pack' %}">Create New Pack</a>
                    <a class="collapse-item {% if '/pharmacy/pack-orders/' in request.path %}active{% endif %}" href="{% url 'pharmacy:pack_order_list' %}">Pack Orders</a>
                    <a class="collapse-item {% if request.path == '/pharmacy/pack-orders/create/' %}active{% endif %}" href="{% url 'pharmacy:create_pack_order' %}">Order Medical Pack</a>

                    <div class="collapse-divider"></div>
                    <h6 class="collapse-header">Inter-Dispensary:</h6>
                    <a class="collapse-item {% if '/pharmacy/transfers/inter/' in request.path %}active{% endif %}" href="{% url 'pharmacy:inter_dispensary_transfer_list' %}">Inter-Dispensary Transfers</a>
                    <a class="collapse-item {% if request.path == '/pharmacy/transfers/inter/create/' %}active{% endif %}" href="{% url 'pharmacy:create_inter_dispensary_transfer' %}">Create Transfer</a>
                    <a class="collapse-item {% if request.path == '/pharmacy/transfers/inter/statistics/' %}active{% endif %}" href="{% url 'pharmacy:transfer_statistics' %}">Transfer Statistics</a>

                    <div class="collapse-divider"></div>
                    <h6 class="collapse-header">Procurement:</h6>
                    <a class="collapse-item {% if '/pharmacy/procurement/' in request.path %}active{% endif %}" href="{% url 'pharmacy:procurement_dashboard' %}">Procurement Dashboard</a>
                    <a class="collapse-item {% if '/pharmacy/purchases/' in request.path %}active{% endif %}" href="{% url 'pharmacy:manage_purchases' %}">Purchase Management</a>
                    <a class="collapse-item {% if '/pharmacy/bulk-store/' in request.path %}active{% endif %}" href="{% url 'pharmacy:bulk_store_dashboard' %}">Bulk Store</a>

                    <div class="collapse-divider"></div>
                    <h6 class="collapse-header">Reports:</h6>
                    <a class="collapse-item {% if request.path == '/pharmacy/expiring-medications/' %}active{% endif %}" href="{% url 'pharmacy:expiring_medications_report' %}">Expiring Medications</a>
                    <a class="collapse-item {% if request.path == '/pharmacy/low-stock/' %}active{% endif %}" href="{% url 'pharmacy:low_stock_medications_report' %}">Low Stock Report</a>
                    {% endif %}
                </div>
            </div>
        </li>
        {% endif %}

        <!-- Nav Item - Dispensary Management (Available to pharmacists, admins, and users with inventory permissions) -->
        {% if user|has_any_permission:'manage_dispensary,transfer_medication,manage_pharmacists,manage_inventory' %}
        <li class="nav-item {% if '/pharmacy/dispensaries/' in request.path or '/pharmacy/assignments/' in request.path %}active{% endif %}">
            <a class="nav-link {% if not '/pharmacy/dispensaries/' in request.path and not '/pharmacy/assignments/' in request.path %}collapsed{% endif %}" href="#" data-bs-toggle="collapse" data-bs-target="#collapseDispensary" aria-expanded="{% if '/pharmacy/dispensaries/' in request.path or '/pharmacy/assignments/' in request.path %}true{% else %}false{% endif %}" aria-controls="collapseDispensary">
                <i class="fas fa-fw fa-store-alt text-white"></i>
                <span class="text-white">Dispensaries</span>
            </a>
            <div id="collapseDispensary" class="collapse {% if '/pharmacy/dispensaries/' in request.path or '/pharmacy/assignments/' in request.path %}show{% endif %}" aria-labelledby="headingDispensary" data-parent="#accordionSidebar">
                <div class="bg-white py-2 collapse-inner rounded">
                    <h6 class="collapse-header">Dispensary Management:</h6>
                    <a class="collapse-item {% if request.path == '/pharmacy/dispensaries/' %}active{% endif %}" href="{% url 'pharmacy:dispensary_list' %}">Manage Dispensaries</a>
                    <a class="collapse-item {% if '/pharmacy/assignments/' in request.path %}active{% endif %}" href="{% url 'pharmacy:manage_pharmacist_assignments' %}">Pharmacist Assignments</a>
                    <a class="collapse-item {% if request.path == '/pharmacy/assignments/reports/' %}active{% endif %}" href="{% url 'pharmacy:assignment_reports' %}">Assignment Reports</a>
                    {% comment %} <a class="collapse-item {% if '/pharmacy/dispensaries/inventory/' in request.path %}active{% endif %}" href="{% url 'pharmacy:dispensary_list' %}">Dispensary Inventory</a> {# Link to manage page, then navigate to specific inventory #}
                    <a class="collapse-item {% if '/pharmacy/dispensaries/dispensing-report/' in request.path %}active{% endif %}" href="{% url 'pharmacy:dispensary_list' %}">Dispensary Reports</a> {# Link to manage page, then navigate to specific report #} {% endcomment %}
                </div>
            </div>
        </li>
        {% endif %}

        <!-- Nav Item - Pharmacy Reports - Temporarily disabled -->
        <!-- <li class="nav-item {% if '/pharmacy/sales-report/' in request.path %}active{% endif %}">
            <a class="nav-link" href="{% url 'reporting:pharmacy_sales_report' %}">
                <i class="fas fa-fw fa-chart-bar text-white"></i>
                <span class="text-white">Pharmacy Report Dashboard</span>
            </a>
        </li> -->

        <!-- Nav Item - Laboratory (Available to lab technicians, doctors, and admins only) -->
        {% if user.is_superuser or user|can_show_ui:'menu_laboratory' %}
        <li class="nav-item {% if '/laboratory/' in request.path %}active{% endif %}">
            <a class="nav-link {% if not '/laboratory/' in request.path %}collapsed{% endif %}" href="#" data-bs-toggle="collapse" data-bs-target="#collapseLaboratory" aria-expanded="{% if '/laboratory/' in request.path %}true{% else %}false{% endif %}" aria-controls="collapseLaboratory">
                <i class="fas fa-fw fa-flask text-white"></i>
                <span class="text-white">Laboratory</span>
            </a>
            <div id="collapseLaboratory" class="collapse {% if '/laboratory/' in request.path %}show{% endif %}" aria-labelledby="headingLaboratory" data-parent="#accordionSidebar">
                <div class="bg-white py-2 collapse-inner rounded">
                    <h6 class="collapse-header">Lab Management:</h6>

                    <!-- Dashboard for lab staff -->
                    <a class="collapse-item {% if request.path == '/laboratory/dashboard/' %}active{% endif %}" href="{% url 'laboratory:dashboard' %}">
                        <i class="fas fa-tachometer-alt"></i> Dashboard
                    </a>

                    <!-- Test catalog visible to all lab users -->
                    <a class="collapse-item {% if request.path == '/laboratory/tests/' %}active{% endif %}" href="{% url 'laboratory:tests' %}">Tests</a>

                    <!-- Test requests for all lab users -->
                    <a class="collapse-item {% if request.path == '/laboratory/test-requests/' %}active{% endif %}" href="{% url 'laboratory:test_requests' %}">Test Requests</a>

                    <!-- Results visible to all lab users -->
                    <a class="collapse-item {% if request.path == '/laboratory/results/' %}active{% endif %}" href="{% url 'laboratory:results' %}">Results</a>

                    <!-- Lab technician specific options -->
                    {% if user|has_permission:'enter_lab_results' %}
                    <div class="collapse-divider"></div>
                    <h6 class="collapse-header">Lab Technician:</h6>
                    <a class="collapse-item {% if '/laboratory/requests/' in request.path and '/results/create/' in request.path %}active{% endif %}" href="{% url 'laboratory:test_requests' %}">Enter Results</a>
                    {% endif %}
                </div>
            </div>
        </li>
        {% endif %}

        <!-- Nav Item - Radiology (Radiology Staff full access, Doctors request, Admin full) -->
        {% if user.is_superuser or user|can_show_ui:'menu_radiology' %}
        <li class="nav-item {% if '/radiology/' in request.path %}active{% endif %}">
            <a class="nav-link" href="{% url 'radiology:index' %}">
                <i class="fas fa-fw fa-x-ray text-white"></i>
                <span class="text-white">Radiology</span>
            </a>
        </li>
        {% endif %}

        <!-- Dental Module (Available to doctors, nurses, and admins) -->
        {% if user.is_superuser or user|has_role:'admin' or user|has_role:'doctor' or user|has_role:'nurse' %}
        <li class="nav-item {% if '/dental/' in request.path %}active{% endif %}">
            <a class="nav-link" href="{% url 'dental:dashboard' %}">
                <i class="fas fa-fw fa-tooth text-white"></i>
                <span class="text-white">Dental</span>
            </a>
        </li>
        {% endif %}

        <!-- Ophthalmic Module (Available to doctors, nurses, and admins) -->
        {% if user.is_superuser or user|has_role:'admin' or user|has_role:'doctor' or user|has_role:'nurse' %}
        <li class="nav-item {% if '/ophthalmic/' in request.path %}active{% endif %}">
            <a class="nav-link" href="{% url 'ophthalmic:dashboard' %}">
                <i class="fas fa-fw fa-eye text-white"></i>
                <span class="text-white">Ophthalmic</span>
            </a>
        </li>
        {% endif %}

        <!-- ENT Module (Available to doctors, nurses, and admins) -->
        {% if user.is_superuser or user|has_role:'admin' or user|has_role:'doctor' or user|has_role:'nurse' %}
        <li class="nav-item {% if '/ent/' in request.path %}active{% endif %}">
            <a class="nav-link" href="{% url 'ent:dashboard' %}">
                <i class="fas fa-fw fa-ear-listen text-white"></i>
                <span class="text-white">ENT</span>
            </a>
        </li>
        {% endif %}

        <!-- Neurology Module (Available to doctors, nurses, and admins) -->
        {% if user.is_superuser or user|has_role:'admin' or user|has_role:'doctor' or user|has_role:'nurse' %}
        <li class="nav-item {% if '/neurology/' in request.path %}active{% endif %}">
            <a class="nav-link" href="{% url 'neurology:dashboard' %}">
                <i class="fas fa-fw fa-brain text-white"></i>
                <span class="text-white">Neurology</span>
            </a>
        </li>
        {% endif %}
        <!-- Dermatology Module (Available to doctors, nurses, and admins) -->
        {% if user.is_superuser or user|has_role:'admin' or user|has_role:'doctor' or user|has_role:'nurse' %}
        <li class="nav-item {% if '/dermatology/' in request.path %}active{% endif %}">
            <a class="nav-link" href="{% url 'dermatology:dashboard' %}">
                <i class="fas fa-fw fa-skin text-white"></i>
                <span class="text-white">Dermatology</span>
            </a>
        </li>
        {% endif %}

        <!-- Emergency Medicine Module (Available to doctors, nurses, and admins) -->
        {% if user.is_superuser or user|has_role:'admin' or user|has_role:'doctor' or user|has_role:'nurse' %}
        <li class="nav-item {% if '/emergency/' in request.path %}active{% endif %}">
            <a class="nav-link" href="{% url 'emergency:dashboard' %}">
                <i class="fas fa-fw fa-ambulance text-white"></i>
                <span class="text-white">Emergency</span>
            </a>
        </li>
        {% endif %}

        <!-- General Medicine Module (Available to doctors, nurses, and admins) -->
        {% if user.is_superuser or user|has_role:'admin' or user|has_role:'doctor' or user|has_role:'nurse' %}
        <li class="nav-item {% if '/general-medicine/' in request.path %}active{% endif %}">
            <a class="nav-link" href="{% url 'general_medicine:dashboard' %}">
                <i class="fas fa-fw fa-stethoscope text-white"></i>
                <span class="text-white">General Medicine</span>
            </a>
        </li>
        {% endif %}

        <!-- Pediatrics Module (Available to doctors, nurses, and admins) -->
        {% if user.is_superuser or user|has_role:'admin' or user|has_role:'doctor' or user|has_role:'nurse' %}
        <li class="nav-item {% if '/pediatrics/' in request.path %}active{% endif %}">
            <a class="nav-link" href="{% url 'pediatrics:dashboard' %}">
                <i class="fas fa-fw fa-child text-white"></i>
                <span class="text-white">Pediatrics</span>
            </a>
        </li>
        {% endif %}

        <!-- Surgery Module (Available to doctors, nurses, and admins) -->
        {% if user.is_superuser or user|has_role:'admin' or user|has_role:'doctor' or user|has_role:'nurse' %}
        <li class="nav-item {% if '/surgery/' in request.path %}active{% endif %}">
            <a class="nav-link" href="{% url 'surgery:dashboard' %}">
                <i class="fas fa-fw fa-procedures text-white"></i>
                <span class="text-white">Surgery</span>
            </a>
        </li>
        {% endif %}

        <!-- Cardiology Module (Available to doctors, nurses, and admins) -->
        {% if user.is_superuser or user|has_role:'admin' or user|has_role:'doctor' or user|has_role:'nurse' %}
        <li class="nav-item {% if '/cardiology/' in request.path %}active{% endif %}">
            <a class="nav-link" href="{% url 'cardiology:dashboard' %}">
                <i class="fas fa-fw fa-heart text-white"></i>
                <span class="text-white">Cardiology</span>
            </a>
        </li>
        {% endif %}

        <!-- Orthopedics Module (Available to doctors, nurses, and admins) -->
        {% if user.is_superuser or user|has_role:'admin' or user|has_role:'doctor' or user|has_role:'nurse' %}
        <li class="nav-item {% if '/orthopedics/' in request.path %}active{% endif %}">
            <a class="nav-link" href="{% url 'orthopedics:dashboard' %}">
                <i class="fas fa-fw fa-bone text-white"></i>
                <span class="text-white">Orthopedics</span>
            </a>
        </li>
        {% endif %}

        <!-- Oncology Module (Available to doctors, nurses, and admins) -->
        {% if user.is_superuser or user|has_role:'admin' or user|has_role:'doctor' or user|has_role:'nurse' %}
        <li class="nav-item {% if '/oncology/' in request.path %}active{% endif %}">
            <a class="nav-link" href="{% url 'oncology:dashboard' %}">
                <i class="fas fa-fw fa-ribbon text-white"></i>
                <span class="text-white">Oncology</span>
            </a>
        </li>
        {% endif %}

        <!-- SCBU Module (Available to doctors, nurses, and admins) -->
        {% if user.is_superuser or user|has_role:'admin' or user|has_role:'doctor' or user|has_role:'nurse' %}
        <li class="nav-item {% if '/scbu/' in request.path %}active{% endif %}">
            <a class="nav-link" href="{% url 'scbu:dashboard' %}">
                <i class="fas fa-fw fa-baby text-white"></i>
                <span class="text-white">SCBU</span>
            </a>
        </li>
        {% endif %}

        <!-- ANC Module (Available to doctors, nurses, and admins) -->
        {% if user.is_superuser or user|has_role:'admin' or user|has_role:'doctor' or user|has_role:'nurse' %}
        <li class="nav-item {% if '/anc/' in request.path %}active{% endif %}">
            <a class="nav-link" href="{% url 'anc:dashboard' %}">
                <i class="fas fa-fw fa-person-pregnant text-white"></i>
                <span class="text-white">ANC</span>
            </a>
        </li>
        {% endif %}

        <!-- Labor Module (Available to doctors, nurses, and admins) -->
        {% if user.is_superuser or user|has_role:'admin' or user|has_role:'doctor' or user|has_role:'nurse' %}
        <li class="nav-item {% if '/labor/' in request.path %}active{% endif %}">
            <a class="nav-link" href="{% url 'labor:dashboard' %}">
                <i class="fas fa-fw fa-baby-carriage text-white"></i>
                <span class="text-white">Labor</span>
            </a>
        </li>
        {% endif %}

        <!-- ICU Module (Available to doctors, nurses, and admins) -->
        {% if user.is_superuser or user|has_role:'admin' or user|has_role:'doctor' or user|has_role:'nurse' %}
        <li class="nav-item {% if '/icu/' in request.path %}active{% endif %}">
            <a class="nav-link" href="{% url 'icu:dashboard' %}">
                <i class="fas fa-fw fa-heartbeat text-white"></i>
                <span class="text-white">ICU</span>
            </a>
        </li>
        {% endif %}

        <!-- Family Planning Module (Available to doctors, nurses, and admins) -->
        {% if user.is_superuser or user|has_role:'admin' or user|has_role:'doctor' or user|has_role:'nurse' %}
        <li class="nav-item {% if '/family_planning/' in request.path %}active{% endif %}">
            <a class="nav-link" href="{% url 'family_planning:dashboard' %}">
                <i class="fas fa-fw fa-users text-white"></i>
                <span class="text-white">Family Planning</span>
            </a>
        </li>
        {% endif %}

        <!-- Gynae Emergency Module (Available to doctors, nurses, and admins) -->
        {% if user.is_superuser or user|has_role:'admin' or user|has_role:'doctor' or user|has_role:'nurse' %}
        <li class="nav-item {% if '/gynae_emergency/' in request.path %}active{% endif %}">
            <a class="nav-link" href="{% url 'gynae_emergency:dashboard' %}">
                <i class="fas fa-fw fa-ambulance text-white"></i>
                <span class="text-white">Gynae Emergency</span>
            </a>
        </li>
        {% endif %}

        <!-- Include Theatre Module Sidebar -->
        {% if user.is_superuser or user|can_show_ui:'menu_theatre' %}
        <li class="nav-item {% if '/theatre/' in request.path %}active{% endif %}">
            <a class="nav-link {% if not '/theatre/' in request.path %}collapsed{% endif %}" href="#" data-bs-toggle="collapse" data-bs-target="#collapseTheatre" aria-expanded="{% if '/theatre/' in request.path %}true{% else %}false{% endif %}" aria-controls="collapseTheatre">
                <i class="fas fa-fw fa-hospital-symbol text-white"></i>
                <span class="text-white">Theatre</span>
            </a>
            <div id="collapseTheatre" class="collapse {% if '/theatre/' in request.path %}show{% endif %}" aria-labelledby="headingTheatre" data-parent="#accordionSidebar">
                <div class="bg-white py-2 collapse-inner rounded">
                    <h6 class="collapse-header">Theatre Management:</h6>
                    <a class="collapse-item {% if request.path == '/theatre/' %}active{% endif %}" href="{% url 'theatre:dashboard' %}">Dashboard</a>
                    <a class="collapse-item {% if request.path == '/theatre/surgeries/' %}active{% endif %}" href="{% url 'theatre:surgery_list' %}">Surgeries</a>
                    <a class="collapse-item {% if request.path == '/theatre/theatres/' %}active{% endif %}" href="{% url 'theatre:theatre_list' %}">Operation Theatres</a>
                    <a class="collapse-item {% if request.path == '/theatre/surgery-types/' %}active{% endif %}" href="{% url 'theatre:surgery_type_list' %}">Surgery Types</a>
                    <a class="collapse-item {% if request.path == '/theatre/teams/' %}active{% endif %}" href="{% url 'theatre:team_list' %}">Surgical Teams</a>
                    <a class="collapse-item {% if request.path == '/theatre/equipment/' %}active{% endif %}" href="{% url 'theatre:equipment_list' %}">Equipment</a>
                    <a class="collapse-item {% if request.path == '/theatre/equipment/maintenance/' %}active{% endif %}" href="{% url 'theatre:equipment_maintenance' %}">Equipment Maintenance</a>
                    <div class="collapse-divider"></div>
                    <h6 class="collapse-header">Medical Supplies:</h6>
                    <a class="collapse-item {% if '/pharmacy/packs/' in request.path %}active{% endif %}" href="{% url 'pharmacy:medical_pack_list' %}?pack_type=surgery">Surgery Packs</a>
                    <a class="collapse-item {% if '/pharmacy/pack-orders/create/' in request.path %}active{% endif %}" href="{% url 'pharmacy:create_pack_order' %}">Order Surgery Pack</a>
                    <div class="collapse-divider"></div>
                    <h6 class="collapse-header">Reports:</h6>
                    <a class="collapse-item {% if request.path == '/theatre/reports/surgery-report/' %}active{% endif %}" href="{% url 'theatre:surgery_report' %}">Surgery Report</a>
                </div>
            </div>
        </li>
        {% endif %}

        <!-- Divider -->
        <hr class="sidebar-divider">

        <!-- Heading -->
        <div class="sidebar-heading">
            Administration
        </div>

        <!-- Nav Item - Desk Office (Available to admins and receptionists for NHIA) -->
        {% if user.is_superuser or user|can_show_ui:'menu_desk_office' %}
        <li class="nav-item {% if '/desk-office/' in request.path %}active{% endif %}">
            <a class="nav-link {% if not '/desk-office/' in request.path %}collapsed{% endif %}" href="#" data-bs-toggle="collapse" data-bs-target="#collapseDeskOffice" aria-expanded="{% if '/desk-office/' in request.path %}true{% else %}false{% endif %}" aria-controls="collapseDeskOffice">
                <i class="fas fa-fw fa-desktop text-white"></i>
                <span class="text-white">Desk Office</span>
            </a>
            <div id="collapseDeskOffice" class="collapse {% if '/desk-office/' in request.path or '/core/authorization/' in request.path %}show{% endif %}" aria-labelledby="headingDeskOffice" data-parent="#accordionSidebar">
                <div class="bg-white py-2 collapse-inner rounded">
                    <h6 class="collapse-header">NHIA Authorization:</h6>
                    <a class="collapse-item {% if 'universal_authorization_dashboard' in request.path %}active{% endif %}" href="{% url 'core:universal_authorization_dashboard' %}">
                        <i class="fas fa-globe me-1"></i> Universal Dashboard <span class="badge badge-success"></span>
                    </a>
                    {% comment %} <a class="collapse-item {% if 'authorization-dashboard' in request.path %}active{% endif %}" href="{% url 'desk_office:authorization_dashboard' %}">
                        <i class="fas fa-tachometer-alt me-1"></i> Dashboard
                    </a> {% endcomment %}
                    <a class="collapse-item {% if 'pending-consultations' in request.path %}active{% endif %}" href="{% url 'desk_office:pending_consultations' %}">
                        <i class="fas fa-stethoscope me-1"></i> Pending Consultations
                    </a>
                    <a class="collapse-item {% if 'pending-referrals' in request.path %}active{% endif %}" href="{% url 'desk_office:pending_referrals' %}">
                        <i class="fas fa-exchange-alt me-1"></i> Pending Referrals
                    </a>
                    <a class="collapse-item {% if 'authorization-codes' in request.path %}active{% endif %}" href="{% url 'desk_office:authorization_code_list' %}">
                        <i class="fas fa-key me-1"></i> Authorization Codes
                    </a>

                    {% if user.is_superuser or user|has_role:'admin' %}
                    <div class="collapse-divider"></div>
                    <h6 class="collapse-header">Bulk Operations:</h6>
                    <a class="collapse-item {% if 'bulk-authorize-consultations' in request.path %}active{% endif %}" href="{% url 'desk_office:bulk_authorize_consultations' %}">
                        <i class="fas fa-check-double me-1"></i> Bulk Authorize Consultations
                    </a>
                    <a class="collapse-item {% if 'bulk-authorize-referrals' in request.path %}active{% endif %}" href="{% url 'desk_office:bulk_authorize_referrals' %}">
                        <i class="fas fa-check-double me-1"></i> Bulk Authorize Referrals
                    </a>
                    {% endif %}

                    <div class="collapse-divider"></div>
                    {% comment %} <h6 class="collapse-header">Legacy:</h6>
                    <a class="collapse-item {% if 'generate-code' in request.path %}active{% endif %}" href="{% url 'desk_office:generate_authorization_code' %}">
                        <i class="fas fa-plus-circle me-1"></i> Generate Code (Old)
                    </a>
                    <a class="collapse-item {% if 'verify-code' in request.path %}active{% endif %}" href="{% url 'desk_office:verify_authorization_code' %}">
                        <i class="fas fa-check-circle me-1"></i> Verify Code
                    </a> {% endcomment %}
                </div>
            </div>
        </li>
        {% endif %}

        <!-- Nav Item - Notifications -->
        {% comment %} <li class="nav-item {% if '/notifications/' in request.path %}active{% endif %}">
            <a class="nav-link" href="{% url 'core:notifications_list' %}">
                <i class="fas fa-fw fa-bell text-white"></i>
                <span class="text-white">Notifications</span>
            </a>
        </li> {% endcomment %}

        <!-- Nav Item - Billing (Available to accountants, receptionists, and admins) -->
        {% if user.is_superuser or user|can_show_ui:'menu_billing' %}
        <li class="nav-item {% if '/billing/' in request.path %}active{% endif %}">
            <a class="nav-link {% if not '/billing/' in request.path %}collapsed{% endif %}" href="#" data-bs-toggle="collapse" data-bs-target="#collapseBilling" aria-expanded="{% if '/billing/' in request.path %}true{% else %}false{% endif %}" aria-controls="collapseBilling">
                <i class="fas fa-fw fa-file-invoice-dollar text-white"></i>
                <span class="text-white">Billing</span>
            </a>
            <div id="collapseBilling" class="collapse {% if '/billing/' in request.path %}show{% endif %}" aria-labelledby="headingBilling" data-parent="#accordionSidebar">
                <div class="bg-white py-2 collapse-inner rounded">
                    <h6 class="collapse-header">Billing Management:</h6>
                    <a class="collapse-item {% if request.path == '/billing/list/' %}active{% endif %}" href="{% url 'billing:list' %}">Invoices</a>
                    {% if user.is_superuser or user|can_show_ui:'btn_create_invoice' %}
                    <a class="collapse-item {% if request.path == '/billing/create/' %}active{% endif %}" href="{% url 'billing:create' %}">Create Invoice</a>
                    {% endif %}
                    {% if user.is_superuser or user|can_show_ui:'menu_billing' %}
                    <a class="collapse-item {% if request.path == '/billing/services/' %}active{% endif %}" href="{% url 'billing:services' %}">Services</a>
                    <a class="collapse-item {% if request.path == '/billing/admission-invoices/' %}active{% endif %}" href="{% url 'billing:admission_invoices' %}">Admission Invoices</a>
                    {% endif %}
                </div>
            </div>
        </li>
        {% endif %}

        <!-- Nav Item - Wallet Management -->
        {% if user.is_superuser or user|can_show_ui:'menu_billing' or user|has_permission:'wallet.manage' %}
        <li class="nav-item {% if '/patients/wallet/' in request.path %}active{% endif %}">
            <a class="nav-link {% if not '/patients/wallet/' in request.path %}collapsed{% endif %}" href="#" data-bs-toggle="collapse" data-bs-target="#collapseWallet" aria-expanded="{% if '/patients/wallet/' in request.path %}true{% else %}false{% endif %}" aria-controls="collapseWallet">
                <i class="fas fa-fw fa-wallet text-white"></i>
                <span class="text-white">Wallet Management</span>
            </a>
            <div id="collapseWallet" class="collapse {% if '/patients/wallet/' in request.path %}show{% endif %}" aria-labelledby="headingWallet" data-parent="#accordionSidebar">
                <div class="bg-white py-2 collapse-inner rounded">
                    <h6 class="collapse-header">Wallet Operations:</h6>
                    <a class="collapse-item {% if '/patients/wallet/' in request.path and '/net-impact/' not in request.path %}active{% endif %}" href="{% url 'patients:wallet_list' %}">All Wallets</a>
                    <a class="collapse-item {% if '/patients/wallet/net-impact/' in request.path %}active{% endif %}" href="{% url 'patients:wallet_net_impact_global' %}">Net Impact Report</a>
                    <!-- Commented out Admission Net Impact link as it needs a pk parameter -->
                    <!-- <a class="collapse-item {% if '/inpatient/admission-net-impact/' in request.path %}active{% endif %}" href="/inpatient/admissions/1/net-impact/">Admission Net Impact</a> -->
                </div>
            </div>
        </li>
        {% endif %}

        <!-- Nav Item - Core Features & Administration (Available to admins and authorized users) -->
        {% if user.is_superuser or user|has_role:'admin' %}
        <li class="nav-item {% if '/core/' in request.path or 'transactions' in request.path or 'authorization' in request.path %}active{% endif %}">
            <a class="nav-link {% if not '/core/' in request.path and not 'transactions' in request.path and not 'authorization' in request.path %}collapsed{% endif %}" href="#" data-bs-toggle="collapse" data-bs-target="#collapseCoreFeatures" aria-expanded="{% if '/core/' in request.path or 'transactions' in request.path or 'authorization' in request.path %}true{% else %}false{% endif %}" aria-controls="collapseCoreFeatures">
                <i class="fas fa-fw fa-cogs text-white"></i>
                <span class="text-white">Core Features</span>
            </a>
            <div id="collapseCoreFeatures" class="collapse {% if '/core/' in request.path or 'transactions' in request.path or 'authorization' in request.path %}show{% endif %}" aria-labelledby="headingCoreFeatures" data-parent="#accordionSidebar">
                <div class="bg-white py-2 collapse-inner rounded">
                    <h6 class="collapse-header">Transaction Management:</h6>
                    <a class="collapse-item {% if 'transactions' in request.path %}active{% endif %}" href="{% url 'core:comprehensive_transaction_history' %}">Transaction History</a>

                    <div class="collapse-divider"></div>
                    <h6 class="collapse-header">Authorization System:</h6>
                    <a class="collapse-item {% if 'authorization/dashboard' in request.path %}active{% endif %}" href="{% url 'core:universal_authorization_dashboard' %}">Universal Authorization</a>

                    <div class="collapse-divider"></div>
                    <h6 class="collapse-header">Admin Tools:</h6>
                    <a class="collapse-item {% if 'admin' in request.path %}active{% endif %}" href="{% url 'core:admin_dashboard' %}">Admin Dashboard</a>
                    <a class="collapse-item {% if 'activity_log' in request.path %}active{% endif %}" href="{% url 'core:activity_log' %}">Activity Log</a>
                    <a class="collapse-item {% if 'security_overview' in request.path %}active{% endif %}" href="{% url 'core:security_overview' %}">Security Overview</a>
                </div>
            </div>
        </li>
        {% endif %}

        <!-- Nav Item - User & Activity Management (Available to admins only) -->
        {% if user.is_superuser or user|has_role:'admin' %}
        <li class="nav-item {% if '/accounts/' in request.path and 'user-dashboard' in request.path or 'audit' in request.path or 'activity' in request.path %}active{% endif %}">
            <a class="nav-link {% if not '/accounts/' in request.path or not 'user-dashboard' in request.path and not 'audit' in request.path and not 'activity' in request.path %}collapsed{% endif %}" href="#" data-bs-toggle="collapse" data-bs-target="#collapseUserManagement" aria-expanded="{% if '/accounts/' in request.path and 'user-dashboard' in request.path or 'audit' in request.path or 'activity' in request.path %}true{% else %}false{% endif %}" aria-controls="collapseUserManagement">
                <i class="fas fa-fw fa-users-cog text-white"></i>
                <span class="text-white">User Management</span>
            </a>
            <div id="collapseUserManagement" class="collapse {% if '/accounts/' in request.path and 'user-dashboard' in request.path or 'audit' in request.path or 'activity' in request.path %}show{% endif %}" aria-labelledby="headingUserManagement" data-parent="#accordionSidebar">
                <div class="bg-white py-2 collapse-inner rounded">
                    <h6 class="collapse-header">User Administration:</h6>
                    <a class="collapse-item {% if 'user-dashboard' in request.path %}active{% endif %}" href="{% url 'accounts:user_dashboard' %}">All Users</a>
                    <a class="collapse-item {% if 'create_staff' in request.path %}active{% endif %}" href="{% url 'accounts:create_staff' %}">Add New User</a>

                    <div class="collapse-divider"></div>
                    <h6 class="collapse-header">Activity Monitoring:</h6>
                    <a class="collapse-item {% if 'activity-dashboard' in request.path %}active{% endif %}" href="{% url 'accounts:activity_dashboard' %}">Activity Monitor</a>
                    <a class="collapse-item {% if 'activity_alerts' in request.path %}active{% endif %}" href="{% url 'accounts:activity_alerts' %}">Activity Alerts</a>
                    <a class="collapse-item {% if 'user_sessions' in request.path %}active{% endif %}" href="{% url 'accounts:user_sessions' %}">User Sessions</a>
                    <a class="collapse-item {% if 'live_monitor' in request.path %}active{% endif %}" href="{% url 'accounts:live_monitor' %}">Live Monitor</a>
                    <a class="collapse-item {% if 'activity_statistics' in request.path %}active{% endif %}" href="{% url 'accounts:activity_statistics' %}">Activity Statistics</a>
                </div>
            </div>
        </li>
        {% endif %}

        <!-- Nav Item - Superuser User Management (Available to superusers only) -->
        {% if user.is_superuser %}
        <li class="nav-item {% if '/accounts/superuser/' in request.path %}active{% endif %}">
            <a class="nav-link {% if not '/accounts/superuser/' in request.path %}collapsed{% endif %}" href="#" data-bs-toggle="collapse" data-bs-target="#collapseSuperuserManagement" aria-expanded="{% if '/accounts/superuser/' in request.path %}true{% else %}false{% endif %}" aria-controls="collapseSuperuserManagement">
                <i class="fas fa-fw fa-user-shield text-white"></i>
                <span class="text-white">Superuser Admin</span>
            </a>
            <div id="collapseSuperuserManagement" class="collapse {% if '/accounts/superuser/' in request.path %}show{% endif %}" aria-labelledby="headingSuperuserManagement" data-parent="#accordionSidebar">
                <div class="bg-white py-2 collapse-inner rounded">
                    <h6 class="collapse-header">User Profile Management:</h6>
                    <a class="collapse-item {% if 'user_profiles' in request.path %}active{% endif %}" href="{% url 'accounts:superuser_user_profiles' %}">Edit User Profiles</a>
                    <a class="collapse-item {% if 'user_password_reset' in request.path %}active{% endif %}" href="{% url 'accounts:superuser_password_reset' %}">Reset User Passwords</a>
                    <a class="collapse-item {% if 'user_bulk_operations' in request.path %}active{% endif %}" href="{% url 'accounts:superuser_bulk_operations' %}">Bulk User Operations</a>

                    <div class="collapse-divider"></div>
                    <h6 class="collapse-header">System Administration:</h6>
                    <a class="collapse-item {% if 'system_config' in request.path %}active{% endif %}" href="{% url 'accounts:superuser_system_config' %}">System Configuration</a>
                    <a class="collapse-item {% if 'database_management' in request.path %}active{% endif %}" href="{% url 'accounts:superuser_database_management' %}">Database Management</a>
                    <a class="collapse-item {% if 'security_audit' in request.path %}active{% endif %}" href="{% url 'accounts:superuser_security_audit' %}">Security Audit</a>
                    <a class="collapse-item {% if 'backup_restore' in request.path %}active{% endif %}" href="{% url 'accounts:superuser_backup_restore' %}">Backup & Restore</a>

                    <div class="collapse-divider"></div>
                    <h6 class="collapse-header">Advanced Tools:</h6>
                    <a class="collapse-item {% if 'system_diagnostics' in request.path %}active{% endif %}" href="{% url 'accounts:superuser_system_diagnostics' %}">System Diagnostics</a>
                    <a class="collapse-item {% if 'mass_email' in request.path %}active{% endif %}" href="{% url 'accounts:superuser_mass_email' %}">Mass Email Users</a>
                    <a class="collapse-item {% if 'api_management' in request.path %}active{% endif %}" href="{% url 'accounts:superuser_api_management' %}">API Management</a>
                    <a class="collapse-item {% if 'logs_viewer' in request.path %}active{% endif %}" href="{% url 'accounts:superuser_logs_viewer' %}">System Logs Viewer</a>
                </div>
            </div>
        </li>
        {% endif %}

        <!-- Nav Item - HR (Available to admins only) -->
        {% if user.is_superuser or user|has_role:'admin' %}
        <li class="nav-item {% if '/hr/' in request.path %}active{% endif %}">
            <a class="nav-link" href="{% url 'hr:staff' %}">
                <i class="fas fa-fw fa-users text-white"></i>
                <span class="text-white">HR</span>
            </a>
        </li>
        {% endif %}

        <!-- Nav Item - Financial Reports (Available to admins and accountants) -->
        {% if user.is_superuser or user|can_show_ui:'menu_reports' %}
        <li class="nav-item {% if '/billing/reports/' in request.path or '/pharmacy/revenue/' in request.path or '/core/revenue/' in request.path or '/radiology/sales-report/' in request.path %}active{% endif %}">
            <a class="nav-link {% if not '/billing/reports/' in request.path and not '/pharmacy/revenue/' in request.path and not '/core/revenue/' in request.path and not '/radiology/sales-report/' in request.path %}collapsed{% endif %}" href="#" data-bs-toggle="collapse" data-bs-target="#collapseFinancialReports" aria-expanded="{% if '/billing/reports/' in request.path or '/pharmacy/revenue/' in request.path or '/core/revenue/' in request.path or '/radiology/sales-report/' in request.path %}true{% else %}false{% endif %}" aria-controls="collapseFinancialReports">
                <i class="fas fa-fw fa-chart-bar text-white"></i>
                <span class="text-white">Financial Reports</span>
            </a>
            <div id="collapseFinancialReports" class="collapse {% if '/billing/reports/' in request.path or '/pharmacy/revenue/' in request.path or '/core/revenue/' in request.path or '/radiology/sales-report/' in request.path %}show{% endif %}" aria-labelledby="headingFinancialReports" data-parent="#accordionSidebar">
                <div class="bg-white py-2 collapse-inner rounded">
                    <h6 class="collapse-header">Hospital-Wide Revenue:</h6>
                    <a class="collapse-item {% if '/core/revenue/dashboard/' in request.path %}active{% endif %}" href="{% url 'core:revenue_point_dashboard' %}">
                        <i class="fas fa-tachometer-alt fa-sm fa-fw mr-1"></i>Revenue Dashboard
                    </a>
                    <a class="collapse-item {% if '/core/revenue/trends/' in request.path %}active{% endif %}" href="{% url 'core:revenue_trends_view' %}">
                        <i class="fas fa-chart-line fa-sm fa-fw mr-1"></i>Revenue Trends
                    </a>
                    {% if user.is_authenticated %}
                    {% load url_helpers %}
                    {% safe_url_or_default 'pharmacy:simple_revenue_statistics' '#' as revenue_url %}
                    <a class="collapse-item {% if '/pharmacy/revenue/statistics/' in request.path %}active{% endif %}" href="{{ revenue_url }}">
                        <i class="fas fa-hospital fa-sm fa-fw mr-1"></i>All Departments Revenue
                    </a>
                    {% endif %}

                    <div class="collapse-divider"></div>
                    <h6 class="collapse-header">Department Revenue:</h6>
                    {% if user.is_authenticated %}
                    {% safe_url_or_default 'pharmacy:pharmacy_dispensary_revenue' '#' as dispensary_revenue_url %}
                    <a class="collapse-item {% if '/pharmacy/revenue/dispensary/' in request.path %}active{% endif %}" href="{{ dispensary_revenue_url }}">
                        <i class="fas fa-store-alt fa-sm fa-fw mr-1"></i>Pharmacy Dispensary Breakdown
                    </a>
                    {% endif %}

                </div>
            </div>
        </li>
        {% endif %}



        <!-- Nav Item - Reports (Available to admins only) - Temporarily disabled -->
        <!-- {% if user.is_superuser or user.profile and user.profile.role == 'admin' %}
        <li class="nav-item {% if '/reporting/' in request.path %}active{% endif %}">
            <a class="nav-link" href="{% url 'reporting:dashboard' %}">
                <i class="fas fa-fw fa-chart-bar text-white"></i>
                <span class="text-white">Reports</span>
            </a>
        </li>
        {% endif %} -->

        <!-- Nav Item - Departments (Available to application admins only) -->
        {% if user|has_permission:'manage_departments' %}
        <li class="nav-item {% if '/accounts/departments/' in request.path %}active{% endif %}">
            <a class="nav-link" href="{% url 'accounts:department_list' %}">
                <i class="fas fa-building text-white"></i>
                <span class="text-white">Departments</span>
            </a>
        </li>
        {% endif %}

        <!-- Divider -->
        <hr class="sidebar-divider d-none d-md-block">

        <!-- Sidebar Toggler (Sidebar) -->
        <div class="text-center d-none d-md-inline">
            <button class="rounded-circle border-0 btn btn-dark" id="sidebarToggle" style="width: 40px; height: 40px;">
                <i class="fas fa-angle-left"></i>
            </button>
        </div>

    </ul>
</div>
<!-- End of Sidebar -->

<style>
/* Desktop sidebar collapsed state */
.sidebar.sidebar-collapsed,
#sidebar-container.sidebar-collapsed {
    width: 70px !important;
    min-width: 70px !important;
    max-width: 70px !important;
    transition: width 0.3s ease;
}

/* Hide text and headings when sidebar is collapsed */
.sidebar.sidebar-collapsed .sidebar-brand-text,
.sidebar.sidebar-collapsed .nav-link .text-white,
.sidebar.sidebar-collapsed .sidebar-heading,
.sidebar.sidebar-collapsed .collapse-inner,
.sidebar.sidebar-collapsed .collapse-header,
#sidebar-container.sidebar-collapsed .sidebar-brand-text,
#sidebar-container.sidebar-collapsed .nav-link .text-white,
#sidebar-container.sidebar-collapsed .sidebar-heading,
#sidebar-container.sidebar-collapsed .collapse-inner,
#sidebar-container.sidebar-collapsed .collapse-header {
    display: none !important;
}

/* Show only icons when collapsed */
.sidebar.sidebar-collapsed .nav-link,
#sidebar-container.sidebar-collapsed .nav-link {
    justify-content: center !important;
    padding: 1rem 0.5rem !important;
    text-align: center !important;
}

/* Center icons when sidebar is collapsed */
.sidebar.sidebar-collapsed .nav-link,
.sidebar.toggled .nav-link,
#sidebar-container.sidebar-collapsed .nav-link,
#sidebar-container.toggled .nav-link {
    justify-content: center !important;
    text-align: center !important;
}

/* Show text when sidebar is expanded (not collapsed) */
.sidebar:not(.sidebar-collapsed):not(.toggled) .nav-link .text-white,
#sidebar-container:not(.sidebar-collapsed):not(.toggled) .nav-link .text-white {
    display: inline;
    opacity: 1;
}

/* Adjust content wrapper when sidebar is collapsed */
body.sidebar-toggled #content-wrapper {
    margin-left: 70px;
}

/* Desktop sidebar hover effect when collapsed */
.sidebar.sidebar-collapsed:hover,
#sidebar-container.sidebar-collapsed:hover {
    width: 300px !important;
    min-width: 300px !important;
    max-width: 300px !important;
}

.sidebar.sidebar-collapsed:hover .sidebar-brand-text,
.sidebar.sidebar-collapsed:hover .nav-link .text-white,
.sidebar.sidebar-collapsed:hover .sidebar-heading,
.sidebar.sidebar-collapsed:hover .collapse-inner,
.sidebar.sidebar-collapsed:hover .collapse-header,
#sidebar-container.sidebar-collapsed:hover .sidebar-brand-text,
#sidebar-container.sidebar-collapsed:hover .nav-link .text-white,
#sidebar-container.sidebar-collapsed:hover .sidebar-heading,
#sidebar-container.sidebar-collapsed:hover .collapse-inner,
#sidebar-container.sidebar-collapsed:hover .collapse-header {
    display: block !important;
    opacity: 1;
}

.sidebar.sidebar-collapsed:hover .nav-link,
#sidebar-container.sidebar-collapsed:hover .nav-link {
    justify-content: flex-start !important;
    padding: 12px 24px !important;
    text-align: left !important;
}

/* Prevent dropdown menu from expanding when collapsed */
.sidebar.sidebar-collapsed .nav-link[data-bs-toggle="collapse"],
#sidebar-container.sidebar-collapsed .nav-link[data-bs-toggle="collapse"] {
    pointer-events: none;
}

/* Allow dropdown menu expansion on hover */
.sidebar.sidebar-collapsed:hover .nav-link[data-bs-toggle="collapse"],
#sidebar-container.sidebar-collapsed:hover .nav-link[data-bs-toggle="collapse"] {
    pointer-events: auto;
}

/* Tablet sidebar styles (768px - 991px) */
@media (min-width: 768px) and (max-width: 991.98px) {
    .sidebar, #sidebar-container {
        width: 80px !important;
        min-width: 80px !important;
        max-width: 80px !important;
        transition: width 0.3s ease;
    }

    /* Hide text and headings on tablet by default */
    .sidebar .sidebar-brand-text,
    .sidebar .nav-link span,
    .sidebar .sidebar-heading,
    .sidebar .collapse-inner,
    .sidebar .collapse-header,
    #sidebar-container .sidebar-brand-text,
    #sidebar-container .nav-link span,
    #sidebar-container .sidebar-heading,
    #sidebar-container .collapse-inner,
    #sidebar-container .collapse-header {
        display: none !important;
    }

    /* Center icons on tablet */
    .sidebar .nav-link,
    #sidebar-container .nav-link {
        justify-content: center !important;
        padding: 1rem 0.5rem !important;
        text-align: center !important;
    }

    /* Tablet sidebar hover effect */
    .sidebar:hover, #sidebar-container:hover {
        width: 280px !important;
        min-width: 280px !important;
        max-width: 280px !important;
    }

    .sidebar:hover .sidebar-brand-text,
    .sidebar:hover .nav-link span,
    .sidebar:hover .sidebar-heading,
    .sidebar:hover .collapse-inner,
    .sidebar:hover .collapse-header,
    #sidebar-container:hover .sidebar-brand-text,
    #sidebar-container:hover .nav-link span,
    #sidebar-container:hover .sidebar-heading,
    #sidebar-container:hover .collapse-inner,
    #sidebar-container:hover .collapse-header {
        display: block !important;
        opacity: 1;
    }

    .sidebar:hover .nav-link,
    #sidebar-container:hover .nav-link {
        justify-content: flex-start !important;
        padding: 12px 24px !important;
        text-align: left !important;
    }

    /* Prevent dropdown menu from expanding when collapsed on tablet */
    .sidebar .nav-link[data-bs-toggle="collapse"],
    #sidebar-container .nav-link[data-bs-toggle="collapse"] {
        pointer-events: none;
    }

    /* Allow dropdown menu expansion on hover */
    .sidebar:hover .nav-link[data-bs-toggle="collapse"],
    #sidebar-container:hover .nav-link[data-bs-toggle="collapse"] {
        pointer-events: auto;
    }

    /* Hide desktop brand on tablet */
    .sidebar-brand.d-none.d-md-flex {
        display: none !important;
    }

    /* Show simplified brand icon on tablet */
    .sidebar .sidebar-brand-icon,
    #sidebar-container .sidebar-brand-icon {
        display: flex !important;
        justify-content: center;
        margin: 1rem 0;
    }
}

/* Mobile sidebar styles (< 768px) */
@media (max-width: 767.98px) {
    .sidebar, #sidebar-container {
        position: fixed;
        top: 0;
        left: -300px;
        z-index: 1050 !important;
        transition: left 0.3s ease;
        height: 100vh;
        box-shadow: 2px 0 10px rgba(0,0,0,0.3);
        width: 300px !important;
        min-width: 300px !important;
        max-width: 300px !important;
    }

    .sidebar.sidebar-open, #sidebar-container.sidebar-open {
        left: 0 !important;
    }

    .sidebar-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        z-index: 1040;
        display: none;
        opacity: 0;
        transition: opacity 0.3s ease;
    }

    .sidebar-overlay.active {
        display: block;
        opacity: 1;
    }

    .mobile-sidebar-header {
        position: sticky;
        top: 0;
        z-index: 1060;
    }

    body.sidebar-open {
        overflow: hidden;
    }

    /* Ensure mobile sidebar doesn't interfere with content */
    .sidebar.sidebar-open ~ #content-wrapper,
    #sidebar-container.sidebar-open ~ #content-wrapper {
        margin-left: 0 !important;
    }

    /* Disable desktop collapse styles on mobile */
    .sidebar.sidebar-collapsed,
    #sidebar-container.sidebar-collapsed {
        width: 300px !important;
        min-width: 300px !important;
        max-width: 300px !important;
        left: -300px;
    }

    .sidebar.sidebar-collapsed.sidebar-open,
    #sidebar-container.sidebar-collapsed.sidebar-open {
        left: 0 !important;
    }

    /* Show all elements normally on mobile */
    .sidebar.sidebar-collapsed .sidebar-brand-text,
    .sidebar.sidebar-collapsed .nav-link .text-white,
    .sidebar.sidebar-collapsed .sidebar-heading,
    .sidebar.sidebar-collapsed .collapse-inner,
    .sidebar.sidebar-collapsed .collapse-header,
    #sidebar-container.sidebar-collapsed .sidebar-brand-text,
    #sidebar-container.sidebar-collapsed .nav-link .text-white,
    #sidebar-container.sidebar-collapsed .sidebar-heading,
    #sidebar-container.sidebar-collapsed .collapse-inner,
    #sidebar-container.sidebar-collapsed .collapse-header {
        display: block !important;
        opacity: 1;
    }

    .sidebar.sidebar-collapsed .nav-link,
    #sidebar-container.sidebar-collapsed .nav-link {
        justify-content: flex-start !important;
        padding: 12px 24px !important;
        text-align: left !important;
    }

    /* Hide desktop toggle button on mobile */
    #sidebarToggle {
        display: none !important;
    }

    /* Ensure hamburger menu is visible */
    #sidebarToggleTop {
        display: block !important;
        visibility: visible !important;
    }
}

/* Make collapse menus have dark background in all states */
.sidebar .collapse-inner {
    background: #23272b !important;
}
.sidebar .collapse-inner .collapse-item {
    color: #fff !important;
}
.sidebar .collapse-inner .collapse-item.active,
.sidebar .collapse-inner .collapse-item:focus,
.sidebar .collapse-inner .collapse-item:hover {
    background: #0d6efd !important;
    color: #fff !important;
}
.sidebar .collapse-header {
    color: #adb5bd !important;
    background: #23272b !important;
}

/* Desktop responsive styles (992px - 1199px) */
@media (min-width: 992px) and (max-width: 1199.98px) {
    .sidebar, #sidebar-container {
        width: 260px !important;
        min-width: 260px !important;
        max-width: 260px !important;
    }

    .sidebar .nav-link,
    #sidebar-container .nav-link {
        font-size: 0.9rem;
        padding: 10px 20px;
    }

    .sidebar .sidebar-brand-text,
    #sidebar-container .sidebar-brand-text {
        font-size: 1.1rem;
    }
}

/* Large Desktop responsive styles (>= 1200px) */
@media (min-width: 1200px) {
    .sidebar, #sidebar-container {
        width: 300px !important;
        min-width: 300px !important;
        max-width: 300px !important;
    }

    .sidebar .nav-link,
    #sidebar-container .nav-link {
        font-size: 1rem;
        padding: 12px 24px;
    }

    .sidebar .sidebar-brand-text,
    #sidebar-container .sidebar-brand-text {
        font-size: 1.25rem;
    }
}

/* Smooth scrolling for sidebar content */
.sidebar, #sidebar-container {
    overflow-y: auto;
    overflow-x: hidden;
    scroll-behavior: smooth;
}

/* Custom scrollbar for sidebar */
.sidebar::-webkit-scrollbar,
#sidebar-container::-webkit-scrollbar {
    width: 6px;
}

.sidebar::-webkit-scrollbar-track,
#sidebar-container::-webkit-scrollbar-track {
    background: #1a1d20;
}

.sidebar::-webkit-scrollbar-thumb,
#sidebar-container::-webkit-scrollbar-thumb {
    background: #4a5568;
    border-radius: 3px;
}

.sidebar::-webkit-scrollbar-thumb:hover,
#sidebar-container::-webkit-scrollbar-thumb:hover {
    background: #5a6778;
}

/* Ensure sidebar doesn't affect content layout on different screen sizes */
@media (min-width: 768px) {
    body {
        transition: margin-left 0.3s ease;
    }
}

/* Touch-friendly tap targets for mobile */
@media (max-width: 767.98px) {
    .sidebar .nav-link,
    #sidebar-container .nav-link {
        min-height: 44px;
        display: flex;
        align-items: center;
    }
}

/* Accessibility: Focus styles */
.sidebar .nav-link:focus,
#sidebar-container .nav-link:focus,
.sidebar .collapse-item:focus,
#sidebar-container .collapse-item:focus {
    outline: 2px solid #0d6efd;
    outline-offset: 2px;
}

/* Prevent layout shifts during transitions */
.sidebar, #sidebar-container {
    will-change: width, left;
}

/* Handle orientation changes */
@media (orientation: landscape) and (max-width: 991.98px) {
    .sidebar, #sidebar-container {
        max-height: 100vh;
    }
}

@media (orientation: portrait) and (max-width: 767.98px) {
    .sidebar, #sidebar-container {
        width: 80vw !important;
        min-width: 80vw !important;
        max-width: 80vw !important;
        left: -80vw;
    }

    .sidebar.sidebar-open, #sidebar-container.sidebar-open {
        left: 0 !important;
    }

    .sidebar.sidebar-collapsed.sidebar-open,
    #sidebar-container.sidebar-collapsed.sidebar-open {
        left: 0 !important;
    }
}
</style>

<script>
// Enhanced responsive sidebar behavior
document.addEventListener('DOMContentLoaded', function() {
    const sidebar = document.getElementById('sidebar-container') || document.querySelector('.sidebar');
    const sidebarToggleTop = document.getElementById('sidebarToggleTop');
    const sidebarToggle = document.getElementById('sidebarToggle');
    const sidebarOverlay = document.getElementById('sidebar-overlay') || document.querySelector('.sidebar-overlay');
    const mobileSidebarClose = document.getElementById('mobileSidebarClose');

    // Function to check screen size
    function isMobile() {
        return window.innerWidth < 768;
    }

    function isTablet() {
        return window.innerWidth >= 768 && window.innerWidth < 992;
    }

    function isDesktop() {
        return window.innerWidth >= 992;
    }

    // Mobile sidebar toggle
    if (sidebarToggleTop && sidebar) {
        sidebarToggleTop.addEventListener('click', function(e) {
            e.preventDefault();
            if (isMobile() || isTablet()) {
                sidebar.classList.toggle('sidebar-open');
                if (sidebarOverlay) {
                    sidebarOverlay.classList.toggle('active');
                }
                document.body.classList.toggle('sidebar-open');
            }
        });
    }

    // Desktop sidebar toggle
    if (sidebarToggle && sidebar) {
        sidebarToggle.addEventListener('click', function(e) {
            e.preventDefault();
            if (isDesktop()) {
                sidebar.classList.toggle('sidebar-collapsed');
                // Update toggle icon
                const icon = this.querySelector('i');
                if (icon) {
                    icon.classList.toggle('fa-angle-left');
                    icon.classList.toggle('fa-angle-right');
                }
            }
        });
    }

    // Close mobile sidebar
    if (mobileSidebarClose && sidebar) {
        mobileSidebarClose.addEventListener('click', function(e) {
            e.preventDefault();
            sidebar.classList.remove('sidebar-open');
            if (sidebarOverlay) {
                sidebarOverlay.classList.remove('active');
            }
            document.body.classList.remove('sidebar-open');
        });
    }

    // Close sidebar when clicking overlay
    if (sidebarOverlay && sidebar) {
        sidebarOverlay.addEventListener('click', function() {
            sidebar.classList.remove('sidebar-open');
            this.classList.remove('active');
            document.body.classList.remove('sidebar-open');
        });
    }

    // Handle window resize
    let resizeTimer;
    window.addEventListener('resize', function() {
        clearTimeout(resizeTimer);
        resizeTimer = setTimeout(function() {
            // Close mobile sidebar on resize to desktop
            if (isDesktop() && sidebar) {
                sidebar.classList.remove('sidebar-open');
                if (sidebarOverlay) {
                    sidebarOverlay.classList.remove('active');
                }
                document.body.classList.remove('sidebar-open');
            }

            // Remove collapsed state on mobile
            if (isMobile() && sidebar) {
                sidebar.classList.remove('sidebar-collapsed');
            }
        }, 250);
    });

    // Improve touch interactions on mobile
    if (isMobile() && sidebar) {
        let touchStartX = 0;
        let touchEndX = 0;

        sidebar.addEventListener('touchstart', function(e) {
            touchStartX = e.changedTouches[0].screenX;
        }, { passive: true });

        sidebar.addEventListener('touchend', function(e) {
            touchEndX = e.changedTouches[0].screenX;
            handleSwipe();
        }, { passive: true });

        function handleSwipe() {
            // Swipe left to close
            if (touchStartX - touchEndX > 50 && sidebar.classList.contains('sidebar-open')) {
                sidebar.classList.remove('sidebar-open');
                if (sidebarOverlay) {
                    sidebarOverlay.classList.remove('active');
                }
                document.body.classList.remove('sidebar-open');
            }
        }
    }
});
</script>

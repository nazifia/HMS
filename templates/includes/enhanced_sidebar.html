{% load custom_filters %}
{% load core_tags %}
<!-- Enhanced Sidebar Navigation -->
<div class="sidebar-wrapper">
    <!-- Sidebar -->
    <nav id="sidebar" class="sidebar bg-dark vh-100 flex-column">
        <!-- Sidebar Header -->
        <div class="sidebar-header text-center p-3">
            <a href="{% url 'home' %}" class="sidebar-brand d-inline-flex align-items-center text-decoration-none">
                <div class="sidebar-brand-icon">
                    <i class="fas fa-hospital text-primary fs-4"></i>
                </div>
                <div class="sidebar-brand-text ms-2">
                    <h5 class="text-white mb-0 fw-bold">HMS</h5>
                    <span class="text-muted small d-none d-sm-inline">Hospital System</span>
                </div>
            </a>
            <button class="sidebar-toggle btn btn-sm btn-outline-secondary mt-2" onclick="toggleSidebar()">
                <i class="fas fa-bars"></i>
            </button>
        </div>

        <!-- User Profile Section -->
        <div class="sidebar-user p-3 border-bottom border-secondary">
            <div class="d-flex align-items-center">
                <div class="user-avatar">
                    {% if user.profile and user.profile.profile_picture %}
                        <img src="{{ user.profile.profile_picture.url }}" class="rounded-circle" alt="{{ user.get_full_name|default:user.username }}" width="40" height="40">
                    {% else %}
                        <div class="avatar-placeholder bg-primary rounded-circle d-flex align-items-center justify-content-center text-white" style="width: 40px; height: 40px;">
                            {{ user.username.0|upper }}
                        </div>
                    {% endif %}
                </div>
                <div class="user-info ms-2 flex-grow-1">
                    <div class="text-white fw-semibold small text-truncate">{{ user.get_full_name|default:user.username }}</div>
                    <div class="d-flex align-items-center">
                        {% if user.profile and user.profile.role %}
                            <span class="badge bg-info me-1" style="font-size: 0.6rem;">{{ user.profile.role|title }}</span>
                        {% endif %}
                        {% if user.profile and user.profile.department %}
                            <span class="text-muted user-role small">{{ user.profile.department }}</span>
                        {% else %}
                            <span class="text-muted user-role small">User</span>
                        {% endif %}
                    </div>
                </div>
                <div class="dropdown">
                    <button class="btn btn-link text-white p-1" type="button" data-bs-toggle="dropdown">
                        <i class="fas fa-ellipsis-v"></i>
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end">
                        <li><a class="dropdown-item" href="{% url 'accounts:profile' %}">
                            <i class="fas fa-user me-2"></i>Profile
                        </a></li>
                        <li><a class="dropdown-item" href="{% url 'accounts:edit_profile' %}">
                            <i class="fas fa-cog me-2"></i>Settings
                        </a></li>
                        
                        <!-- Admin Items -->
                        {% if user.is_superuser or user|has_role:'admin' %}
                        <li><hr class="dropdown-divider"></li>
                        <li><h6 class="dropdown-header">Admin Tools</h6></li>
                        <li><a class="dropdown-item" href="{% url 'core:admin_dashboard' %}">
                            <i class="fas fa-shield-alt me-2"></i>Admin Dashboard
                        </a></li>
                        <li><a class="dropdown-item" href="{% url 'core:activity_log' %}">
                            <i class="fas fa-history me-2"></i>Activity Log
                        </a></li>
                        <li><a class="dropdown-item" href="{% url 'accounts:permission_management' %}">
                            <i class="fas fa-shield-alt me-2"></i>Permissions
                        </a></li>
                        <li><a class="dropdown-item" href="{% url 'core:security_overview' %}">
                            <i class="fas fa-lock me-2"></i>Security
                        </a></li>
                        {% endif %}
                        
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item text-danger" href="{% url 'accounts:logout' %}">
                            <i class="fas fa-sign-out-alt me-2"></i>Logout
                        </a></li>
                    </ul>
                </div>
            </div>
            
            <!-- Session Info -->
            {% if request.session.session_info %}
            <div class="session-info mt-2">
                <div class="d-flex align-items-center justify-content-between">
                    <small class="text-muted">Session:</small>
                    <small class="session-time-remaining {% get_session_status_class request.session.session_info %}">
                        {% with remaining=request.session.session_info.time_remaining %}
                            {% if remaining <= 60 %}
                                Expired
                            {% elif remaining <= 300 %}
                                {% widthratio remaining 60 1 %}min left
                            {% else %}
                                {% widthratio remaining 60 1 %}min
                            {% endif %}
                        {% endwith %}
                    </small>
                </div>
            </div>
            {% endif %}
        </div>

        <!-- Sidebar Menu -->
        <div class="sidebar-menu flex-grow-1 overflow-y-auto">
            <ul class="nav nav-pills flex-column mb-auto">
                <!-- Dashboard -->
                <li class="nav-item">
                    <a href="{% url 'dashboard:dashboard' %}" class="nav-link nav-link-sidebar {% if request.path == '/dashboard/' %}active{% endif %}">
                        <i class="fas fa-tachometer-alt sidebar-icon"></i>
                        <span class="sidebar-text">Dashboard</span>
                    </a>
                </li>

                <!-- Admin Section (Admin/Superuser only) -->
                {% if user.is_superuser or user|has_role:'admin' %}
                <li class="nav-item">
                    <a class="nav-link nav-link-sidebar {% if '/core/admin/' in request.path %}active{% endif %}" href="#" data-bs-toggle="collapse" data-bs-target="#adminMenu">
                        <i class="fas fa-shield-alt sidebar-icon text-warning"></i>
                        <span class="sidebar-text">Admin Tools</span>
                        <i class="fas fa-chevron-down ms-auto sidebar-arrow"></i>
                    </a>
                    <div class="collapse {% if '/core/admin/' in request.path %}show{% endif %}" id="adminMenu">
                        <ul class="nav nav-pills flex-column ms-3">
                            <li class="nav-item">
                                <a href="{% url 'core:admin_dashboard' %}" class="nav-link nav-link-submenu {% if request.path == '/core/admin/' %}active{% endif %}">
                                    <i class="fas fa-tachometer-alt sidebar-icon-sub"></i>
                                    <span class="sidebar-text">Admin Dashboard</span>
                                </a>
                            </li>
                            <li class="nav-item">
                                <a href="{% url 'core:activity_log' %}" class="nav-link nav-link-submenu {% if '/core/admin/activity-log/' in request.path %}active{% endif %}">
                                    <i class="fas fa-history sidebar-icon-sub"></i>
                                    <span class="sidebar-text">Activity Log</span>
                                    {% if failed_logins or permission_denied %}
                                    <span class="badge bg-warning ms-auto">{{ failed_logins|add:permission_denied }}</span>
                                    {% endif %}
                                </a>
                            </li>
                            <li class="nav-item">
                                <a href="{% url 'accounts:permission_management' %}" class="nav-link nav-link-submenu {% if '/accounts/permissions/' in request.path %}active{% endif %}">
                                    <i class="fas fa-shield-alt sidebar-icon-sub"></i>
                                    <span class="sidebar-text">Permissions</span>
                                </a>
                            </li>
                            <li class="nav-item">
                                <a href="{% url 'core:security_overview' %}" class="nav-link nav-link-submenu {% if '/core/admin/security/' in request.path %}active{% endif %}">
                                    <i class="fas fa-lock sidebar-icon-sub"></i>
                                    <span class="sidebar-text">Security</span>
                                </a>
                            </li>
                            <li class="nav-item">
                                <a href="{% url 'core:audit_report' %}" class="nav-link nav-link-submenu {% if '/core/admin/audit-report/' in request.path %}active{% endif %}">
                                    <i class="fas fa-file-alt sidebar-icon-sub"></i>
                                    <span class="sidebar-text">Audit Reports</span>
                                </a>
                            </li>
                            
                            <li class="nav-item">
                                <span class="sidebar-subtitle">User Management</span>
                            </li>
                            <li class="nav-item">
                                <a href="#" onclick="showUserManagementModal()" class="nav-link nav-link-submenu">
                                    <i class="fas fa-users sidebar-icon-sub"></i>
                                    <span class="sidebar-text">Manage Users</span>
                                </a>
                            </li>
                            <li class="nav-item">
                                <a href="#" onclick="showCreateUserModal()" class="nav-link nav-link-submenu">
                                    <i class="fas fa-user-plus sidebar-icon-sub"></i>
                                    <span class="sidebar-text">Create User</span>
                                </a>
                            </li>
                        </ul>
                    </div>
                </li>
                {% endif %}

                <!-- Patient Care -->
                {% if user.is_superuser or user.profile and user.profile.role in 'admin,doctor,nurse,receptionist,health_record_officer' %}
                <li class="nav-item">
                    <a class="nav-link nav-link-sidebar {% if '/patients/' in request.path %}active{% endif %}" href="#" data-bs-toggle="collapse" data-bs-target="#patientMenu">
                        <i class="fas fa-user-injured sidebar-icon"></i>
                        <span class="sidebar-text">Patient Care</span>
                        <i class="fas fa-chevron-down ms-auto sidebar-arrow"></i>
                    </a>
                    <div class="collapse {% if '/patients/' in request.path %}show{% endif %}" id="patientMenu">
                        <ul class="nav nav-pills flex-column ms-3">
                            <li class="nav-item">
                                <a href="{% url 'patients:list' %}" class="nav-link nav-link-submenu {% if request.path == '/patients/list/' %}active{% endif %}">
                                    <i class="fas fa-list sidebar-icon-sub"></i>
                                    <span class="sidebar-text">All Patients</span>
                                </a>
                            </li>
                            {% if user.is_superuser or user.profile and user.profile.role in 'admin,receptionist,health_record_officer' %}
                            <li class="nav-item">
                                <a href="{% url 'patients:register' %}" class="nav-link nav-link-submenu {% if request.path == '/patients/register/' %}active{% endif %}">
                                    <i class="fas fa-user-plus sidebar-icon-sub"></i>
                                    <span class="sidebar-text">Register Patient</span>
                                </a>
                            </li>
                            <li class="nav-item">
                                <a href="{% url 'nhia:nhia_patient_list' %}" class="nav-link nav-link-submenu {% if '/nhia/patients/' in request.path %}active{% endif %}">
                                    <i class="fas fa-shield-alt sidebar-icon-sub"></i>
                                    <span class="sidebar-text">NHIA Patients</span>
                                </a>
                            </li>
                            <li class="nav-item">
                                <a href="{% url 'retainership:retainership_patient_list' %}" class="nav-link nav-link-submenu {% if '/retainership/patients/' in request.path %}active{% endif %}">
                                    <i class="fas fa-handshake sidebar-icon-sub"></i>
                                    <span class="sidebar-text">Retainership</span>
                                </a>
                            </li>
                            {% endif %}
                        </ul>
                    </div>
                </li>
                {% endif %}

                <!-- Medical Services -->
                <li class="nav-item">
                    <span class="sidebar-section-title">Medical Services</span>
                </li>

                <!-- Pharmacy -->
                {% if user.is_superuser or user|has_role:'admin' or user|has_role:'pharmacist' or user|has_role:'doctor' %}
                <li class="nav-item">
                    <a class="nav-link nav-link-sidebar {% if '/pharmacy/' in request.path %}active{% endif %}" href="#" data-bs-toggle="collapse" data-bs-target="#pharmacyMenu">
                        <i class="fas fa-pills sidebar-icon"></i>
                        <span class="sidebar-text">Pharmacy</span>
                        <i class="fas fa-chevron-down ms-auto sidebar-arrow"></i>
                    </a>
                    <div class="collapse {% if '/pharmacy/' in request.path %}show{% endif %}" id="pharmacyMenu">
                        <ul class="nav nav-pills flex-column ms-3">
                            {% if user.is_superuser or user|has_role:'admin' or user|has_role:'pharmacist' %}
                            <li class="nav-item">
                                <a href="{% url 'pharmacy:inventory' %}" class="nav-link nav-link-submenu {% if request.path == '/pharmacy/inventory/' %}active{% endif %}">
                                    <i class="fas fa-box sidebar-icon-sub"></i>
                                    <span class="sidebar-text">Inventory</span>
                                </a>
                            </li>
                            {% endif %}
                            <li class="nav-item">
                                <a href="{% url 'pharmacy:prescriptions' %}" class="nav-link nav-link-submenu {% if request.path == '/pharmacy/prescriptions/' %}active{% endif %}">
                                    <i class="fas fa-prescription sidebar-icon-sub"></i>
                                    <span class="sidebar-text">Prescriptions</span>
                                </a>
                            </li>
                            <li class="nav-item">
                                <a href="{% url 'pharmacy:dispensed_items_tracker' %}" class="nav-link nav-link-submenu {% if '/pharmacy/dispensed-items/' in request.path %}active{% endif %}">
                                    <i class="fas fa-truck sidebar-icon-sub"></i>
                                    <span class="sidebar-text">Dispensed Items</span>
                                </a>
                            </li>
                            {% if user.is_superuser or user|has_role:'admin' or user|has_role:'pharmacist' %}
                            <li class="nav-item">
                                <span class="sidebar-subtitle">Medical Packs</span>
                            </li>
                            <li class="nav-item">
                                <a href="{% url 'pharmacy:medical_pack_list' %}" class="nav-link nav-link-submenu {% if '/pharmacy/packs/' in request.path %}active{% endif %}">
                                    <i class="fas fa-box-open sidebar-icon-sub"></i>
                                    <span class="sidebar-text">Medical Packs</span>
                                </a>
                            </li>
                            <li class="nav-item">
                                <a href="{% url 'pharmacy:inter_dispensary_transfer_list' %}" class="nav-link nav-link-submenu {% if '/pharmacy/transfers/inter/' in request.path %}active{% endif %}">
                                    <i class="fas fa-exchange-alt sidebar-icon-sub"></i>
                                    <span class="sidebar-text">Transfers</span>
                                </a>
                            </li>
                            <li class="nav-item">
                                <span class="sidebar-subtitle">Reports</span>
                            </li>
                            <li class="nav-item">
                                <a href="{% url 'pharmacy:expiring_medications_report' %}" class="nav-link nav-link-submenu {% if request.path == '/pharmacy/expiring-medications/' %}active{% endif %}">
                                    <i class="fas fa-clock sidebar-icon-sub"></i>
                                    <span class="sidebar-text">Expiring Medications</span>
                                </a>
                            </li>
                            <li class="nav-item">
                                <a href="{% url 'pharmacy:low_stock_medications_report' %}" class="nav-link nav-link-submenu {% if request.path == '/pharmacy/low-stock/' %}active{% endif %}">
                                    <i class="fas fa-exclamation-triangle sidebar-icon-sub"></i>
                                    <span class="sidebar-text">Low Stock</span>
                                </a>
                            </li>
                            {% endif %}
                        </ul>
                    </div>
                </li>
                {% endif %}

                <!-- Laboratory -->
                {% if user.is_superuser or user.profile and user.profile.role in 'admin,lab_technician,doctor' %}
                <li class="nav-item">
                    <a class="nav-link nav-link-sidebar {% if '/laboratory/' in request.path %}active{% endif %}" href="#" data-bs-toggle="collapse" data-bs-target="#labMenu">
                        <i class="fas fa-flask sidebar-icon"></i>
                        <span class="sidebar-text">Laboratory</span>
                        <i class="fas fa-chevron-down ms-auto sidebar-arrow"></i>
                    </a>
                    <div class="collapse {% if '/laboratory/' in request.path %}show{% endif %}" id="labMenu">
                        <ul class="nav nav-pills flex-column ms-3">
                            <li class="nav-item">
                                <a href="{% url 'laboratory:test_requests' %}" class="nav-link nav-link-submenu {% if request.path == '/laboratory/test-requests/' %}active{% endif %}">
                                    <i class="fas fa-clipboard-list sidebar-icon-sub"></i>
                                    <span class="sidebar-text">Test Requests</span>
                                </a>
                            </li>
                            <li class="nav-item">
                                <a href="{% url 'laboratory:results' %}" class="nav-link nav-link-submenu {% if request.path == '/laboratory/results/' %}active{% endif %}">
                                    <i class="fas fa-file-medical sidebar-icon-sub"></i>
                                    <span class="sidebar-text">Results</span>
                                </a>
                            </li>
                            <!-- Lab Reports link removed -->
                        </ul>
                    </div>
                </li>
                {% endif %}

                <!-- Theatre -->
                {% if user.is_superuser or user.profile and user.profile.role in 'admin,doctor,nurse,theatre_staff' %}
                <li class="nav-item">
                    <a class="nav-link nav-link-sidebar {% if '/theatre/' in request.path %}active{% endif %}" href="#" data-bs-toggle="collapse" data-bs-target="#theatreMenu">
                        <i class="fas fa-procedures sidebar-icon"></i>
                        <span class="sidebar-text">Theatre</span>
                        <i class="fas fa-chevron-down ms-auto sidebar-arrow"></i>
                    </a>
                    <div class="collapse {% if '/theatre/' in request.path %}show{% endif %}" id="theatreMenu">
                        <ul class="nav nav-pills flex-column ms-3">
                            <li class="nav-item">
                                <a href="{% url 'theatre:dashboard' %}" class="nav-link nav-link-submenu {% if request.path == '/theatre/' %}active{% endif %}">
                                    <i class="fas fa-tachometer-alt sidebar-icon-sub"></i>
                                    <span class="sidebar-text">Dashboard</span>
                                </a>
                            </li>
                            <li class="nav-item">
                                <a href="{% url 'theatre:surgery_list' %}" class="nav-link nav-link-submenu {% if request.path == '/theatre/surgeries/' %}active{% endif %}">
                                    <i class="fas fa-procedures sidebar-icon-sub"></i>
                                    <span class="sidebar-text">Surgeries</span>
                                </a>
                            </li>
                        </ul>
                    </div>
                </li>
                {% endif %}

                <!-- Medical Specialties -->
                <li class="nav-item">
                    <a class="nav-link nav-link-sidebar {% if '/dental/' in request.path or '/ophthalmic/' in request.path or '/ent/' in request.path or '/oncology/' in request.path or '/scbu/' in request.path or '/anc/' in request.path or '/labor/' in request.path or '/icu/' in request.path or '/family-planning/' in request.path or '/gynae-emergency/' in request.path %}active{% endif %}" href="#" data-bs-toggle="collapse" data-bs-target="#medicalSpecialtiesMenu">
                        <i class="fas fa-hospital sidebar-icon"></i>
                        <span class="sidebar-text">Medical Specialties</span>
                        <i class="fas fa-chevron-down ms-auto sidebar-arrow"></i>
                    </a>
                    <div class="collapse {% if '/dental/' in request.path or '/ophthalmic/' in request.path or '/ent/' in request.path or '/oncology/' in request.path or '/scbu/' in request.path or '/anc/' in request.path or '/labor/' in request.path or '/icu/' in request.path or '/family-planning/' in request.path or '/gynae-emergency/' in request.path %}show{% endif %}" id="medicalSpecialtiesMenu">
                        <ul class="nav nav-pills flex-column ms-3">
                            <li class="nav-item">
                                <a href="{% url 'dental:dashboard' %}" class="nav-link nav-link-submenu {% if '/dental/' in request.path %}active{% endif %}">
                                    <i class="fas fa-tooth sidebar-icon-sub"></i>
                                    <span class="sidebar-text">Dental</span>
                                </a>
                            </li>
                            <li class="nav-item">
                                <a href="{% url 'ophthalmic:dashboard' %}" class="nav-link nav-link-submenu {% if '/ophthalmic/' in request.path %}active{% endif %}">
                                    <i class="fas fa-eye sidebar-icon-sub"></i>
                                    <span class="sidebar-text">Ophthalmic</span>
                                </a>
                            </li>
                            <li class="nav-item">
                                <a href="{% url 'ent:dashboard' %}" class="nav-link nav-link-submenu {% if '/ent/' in request.path %}active{% endif %}">
                                    <i class="fas fa-head-side-medical sidebar-icon-sub"></i>
                                    <span class="sidebar-text">ENT</span>
                                </a>
                            </li>
                            <li class="nav-item">
                                <a href="{% url 'oncology:dashboard' %}" class="nav-link nav-link-submenu {% if '/oncology/' in request.path %}active{% endif %}">
                                    <i class="fas fa-ribbon sidebar-icon-sub"></i>
                                    <span class="sidebar-text">Oncology</span>
                                </a>
                            </li>
                            <li class="nav-item">
                                <a href="{% url 'scbu:dashboard' %}" class="nav-link nav-link-submenu {% if '/scbu/' in request.path %}active{% endif %}">
                                    <i class="fas fa-baby sidebar-icon-sub"></i>
                                    <span class="sidebar-text">SCBU</span>
                                </a>
                            </li>
                            <li class="nav-item">
                                <a href="{% url 'anc:dashboard' %}" class="nav-link nav-link-submenu {% if '/anc/' in request.path %}active{% endif %}">
                                    <i class="fas fa-baby-carriage sidebar-icon-sub"></i>
                                    <span class="sidebar-text">ANC</span>
                                </a>
                            </li>
                            <li class="nav-item">
                                <a href="{% url 'labor:dashboard' %}" class="nav-link nav-link-submenu {% if '/labor/' in request.path %}active{% endif %}">
                                    <i class="fas fa-female sidebar-icon-sub"></i>
                                    <span class="sidebar-text">Labor</span>
                                </a>
                            </li>
                            <li class="nav-item">
                                <a href="{% url 'icu:dashboard' %}" class="nav-link nav-link-submenu {% if '/icu/' in request.path %}active{% endif %}">
                                    <i class="fas fa-procedures sidebar-icon-sub"></i>
                                    <span class="sidebar-text">ICU</span>
                                </a>
                            </li>
                            <li class="nav-item">
                                <a href="{% url 'family_planning:dashboard' %}" class="nav-link nav-link-submenu {% if '/family-planning/' in request.path %}active{% endif %}">
                                    <i class="fas fa-heart sidebar-icon-sub"></i>
                                    <span class="sidebar-text">Family Planning</span>
                                </a>
                            </li>
                            <li class="nav-item">
                                <a href="{% url 'gynae_emergency:dashboard' %}" class="nav-link nav-link-submenu {% if '/gynae-emergency/' in request.path %}active{% endif %}">
                                    <i class="fas fa-hospital-user sidebar-icon-sub"></i>
                                    <span class="sidebar-text">Gynae Emergency</span>
                                </a>
                            </li>
                        </ul>
                    </div>
                </li>

                <!-- Administration -->
                <li class="nav-item">
                    <span class="sidebar-section-title">Administration</span>
                </li>

                <!-- Billing -->
                {% if user.is_superuser or user.profile and user.profile.role in 'admin,accountant,receptionist' %}
                <li class="nav-item">
                    <a class="nav-link nav-link-sidebar {% if '/billing/' in request.path %}active{% endif %}" href="#" data-bs-toggle="collapse" data-bs-target="#billingMenu">
                        <i class="fas fa-file-invoice-dollar sidebar-icon"></i>
                        <span class="sidebar-text">Billing</span>
                        <i class="fas fa-chevron-down ms-auto sidebar-arrow"></i>
                    </a>
                    <div class="collapse {% if '/billing/' in request.path %}show{% endif %}" id="billingMenu">
                        <ul class="nav nav-pills flex-column ms-3">
                            <li class="nav-item">
                                <a href="{% url 'billing:list' %}" class="nav-link nav-link-submenu {% if request.path == '/billing/list/' %}active{% endif %}">
                                    <i class="fas fa-list sidebar-icon-sub"></i>
                                    <span class="sidebar-text">Invoices</span>
                                </a>
                            </li>
                            {% if user.is_superuser or user.profile and user.profile.role in 'admin,accountant,receptionist' %}
                            <li class="nav-item">
                                <a href="{% url 'billing:create' %}" class="nav-link nav-link-submenu {% if request.path == '/billing/create/' %}active{% endif %}">
                                    <i class="fas fa-plus sidebar-icon-sub"></i>
                                    <span class="sidebar-text">Create Invoice</span>
                                </a>
                            </li>
                            {% endif %}
                        </ul>
                    </div>
                </li>
                {% endif %}

                <!-- NHIA -->
                {% if user.is_superuser or user.profile and user.profile.role in 'admin,doctor,nurse,accountant,receptionist' %}
                <li class="nav-item">
                    <a class="nav-link nav-link-sidebar {% if '/nhia/' in request.path %}active{% endif %}" href="#" data-bs-toggle="collapse" data-bs-target="#nhiaMenu">
                        <i class="fas fa-shield-alt sidebar-icon"></i>
                        <span class="sidebar-text">NHIA</span>
                        <i class="fas fa-chevron-down ms-auto sidebar-arrow"></i>
                    </a>
                    <div class="collapse {% if '/nhia/' in request.path %}show{% endif %}" id="nhiaMenu">
                        <ul class="nav nav-pills flex-column ms-3">
                            <li class="nav-item">
                                <a href="{% url 'nhia:dashboard' %}" class="nav-link nav-link-submenu {% if request.path == '/nhia/dashboard/' %}active{% endif %}">
                                    <i class="fas fa-tachometer-alt sidebar-icon-sub"></i>
                                    <span class="sidebar-text">Dashboard</span>
                                </a>
                            </li>
                            <li class="nav-item">
                                <a href="{% url 'nhia:authorization_code_list' %}" class="nav-link nav-link-submenu {% if '/nhia/authorization-codes/' in request.path %}active{% endif %}">
                                    <i class="fas fa-check-circle sidebar-icon-sub"></i>
                                    <span class="sidebar-text">Authorization Codes</span>
                                </a>
                            </li>
                            <li class="nav-item">
                                <a href="{% url 'nhia:nhia_patient_list' %}" class="nav-link nav-link-submenu {% if '/nhia/patients/' in request.path %}active{% endif %}">
                                    <i class="fas fa-users sidebar-icon-sub"></i>
                                    <span class="sidebar-text">NHIA Patients</span>
                                </a>
                            </li>
                        </ul>
                    </div>
                </li>
                {% endif %}

                <!-- Retainership -->
                {% if user.is_superuser or user.profile and user.profile.role in 'admin,accountant,receptionist' %}
                <li class="nav-item">
                    <a class="nav-link nav-link-sidebar {% if '/retainership/' in request.path %}active{% endif %}" href="#" data-bs-toggle="collapse" data-bs-target="#retainershipMenu">
                        <i class="fas fa-handshake sidebar-icon"></i>
                        <span class="sidebar-text">Retainership</span>
                        <i class="fas fa-chevron-down ms-auto sidebar-arrow"></i>
                    </a>
                    <div class="collapse {% if '/retainership/' in request.path %}show{% endif %}" id="retainershipMenu">
                        <ul class="nav nav-pills flex-column ms-3">
                            <li class="nav-item">
                                <a href="{% url 'retainership:retainership_patient_list' %}" class="nav-link nav-link-submenu {% if '/retainership/patients/' in request.path %}active{% endif %}">
                                    <i class="fas fa-users sidebar-icon-sub"></i>
                                    <span class="sidebar-text">Retainership Patients</span>
                                </a>
                            </li>
                            <li class="nav-item">
                                <a href="{% url 'retainership:select_patient_for_retainership' %}" class="nav-link nav-link-submenu {% if '/retainership/select-patient/' in request.path %}active{% endif %}">
                                    <i class="fas fa-user-plus sidebar-icon-sub"></i>
                                    <span class="sidebar-text">Register Patient</span>
                                </a>
                            </li>
                        </ul>
                    </div>
                </li>
                {% endif %}

                <!-- Desk Office -->
                {% if user.is_superuser or user.profile and user.profile.role in 'admin,doctor,nurse,accountant,receptionist' %}
                <li class="nav-item">
                    <a class="nav-link nav-link-sidebar {% if '/desk-office/' in request.path %}active{% endif %}" href="#" data-bs-toggle="collapse" data-bs-target="#deskOfficeMenu">
                        <i class="fas fa-briefcase sidebar-icon"></i>
                        <span class="sidebar-text">Desk Office</span>
                        <i class="fas fa-chevron-down ms-auto sidebar-arrow"></i>
                    </a>
                    <div class="collapse {% if '/desk-office/' in request.path %}show{% endif %}" id="deskOfficeMenu">
                        <ul class="nav nav-pills flex-column ms-3">
                            <li class="nav-item">
                                <a href="{% url 'desk_office:authorization_dashboard' %}" class="nav-link nav-link-submenu {% if '/desk-office/authorization-dashboard/' in request.path %}active{% endif %}">
                                    <i class="fas fa-tachometer-alt sidebar-icon-sub"></i>
                                    <span class="sidebar-text">Authorization Dashboard</span>
                                </a>
                            </li>
                            <li class="nav-item">
                                <a href="{% url 'desk_office:pending_consultations' %}" class="nav-link nav-link-submenu {% if '/desk-office/pending-consultations/' in request.path %}active{% endif %}">
                                    <i class="fas fa-clock sidebar-icon-sub"></i>
                                    <span class="sidebar-text">Pending Consultations</span>
                                </a>
                            </li>
                            <li class="nav-item">
                                <a href="{% url 'desk_office:pending_referrals' %}" class="nav-link nav-link-submenu {% if '/desk-office/pending-referrals/' in request.path %}active{% endif %}">
                                    <i class="fas fa-exchange-alt sidebar-icon-sub"></i>
                                    <span class="sidebar-text">Pending Referrals</span>
                                </a>
                            </li>
                            <li class="nav-item">
                                <a href="{% url 'desk_office:authorization_code_list' %}" class="nav-link nav-link-submenu {% if '/desk-office/authorization-codes/' in request.path %}active{% endif %}">
                                    <i class="fas fa-check-double sidebar-icon-sub"></i>
                                    <span class="sidebar-text">Authorization Codes</span>
                                </a>
                            </li>
                        </ul>
                    </div>
                </li>
                {% endif %}

                <!-- Settings & System (permission-based) -->
                {% if user|has_any_permission:'system_configuration,manage_departments,view_audit_logs' %}
                <li class="nav-item">
                    <a class="nav-link nav-link-sidebar" href="#" onclick="toggleSettingsMenu(event); return false;">
                        <i class="fas fa-cog sidebar-icon"></i>
                        <span class="sidebar-text">Settings</span>
                        <i class="fas fa-chevron-down ms-auto sidebar-arrow" id="settingsArrow"></i>
                    </a>
                    <div class="collapse" id="settingsMenu">
                        <ul class="nav nav-pills flex-column ms-3">
                            <li class="nav-item">
                                <a href="{% url 'accounts:user_dashboard' %}" class="nav-link nav-link-submenu {% if 'user-dashboard' in request.path %}active{% endif %}">
                                    <i class="fas fa-users sidebar-icon-sub"></i>
                                    <span class="sidebar-text">Users</span>
                                </a>
                            </li>
                            <li class="nav-item">
                                <a href="{% url 'hr:staff' %}" class="nav-link nav-link-submenu {% if '/hr/' in request.path %}active{% endif %}">
                                    <i class="fas fa-user-tie sidebar-icon-sub"></i>
                                    <span class="sidebar-text">HR</span>
                                </a>
                            </li>
                        </ul>
                    </div>
                </li>
                {% endif %}

            </ul>
        </div>

        <!-- Sidebar Footer -->
        <div class="sidebar-footer p-3 border-top border-secondary">
            <div class="text-center small text-muted">
                <div class="mb-1">HMS Version 1.0</div>
                <div>Â© 2024 Hospital Management</div>
            </div>
        </div>
    </nav>
</div>

<style>
/* Enhanced Sidebar Styles */
.sidebar-wrapper {
    position: fixed;
    top: 0;
    left: 0;
    height: 100vh;
    z-index: 1000;
    transition: all 0.3s ease;
}

.sidebar {
    width: 280px;
    transition: all 0.3s ease;
    box-shadow: 2px 0 10px rgba(0,0,0,0.1);
}

.sidebar.collapsed {
    width: 70px;
}

.sidebar-brand {
    text-decoration: none;
    transition: all 0.3s ease;
}

.sidebar.collapsed .sidebar-brand-text {
    opacity: 0;
    visibility: hidden;
}

.sidebar-user {
    transition: all 0.3s ease;
}

.sidebar.collapsed .sidebar-user {
    padding: 0.5rem !important;
    text-align: center;
}

.sidebar.collapsed .user-info,
.sidebar.collapsed .dropdown {
    display: none;
}

.sidebar-toggle {
    transition: all 0.3s ease;
    border: none !important;
}

.sidebar.collapsed .sidebar-toggle {
    position: absolute;
    right: -15px;
    top: 60px;
    background: var(--bs-dark) !important;
    color: var(--bs-white) !important;
    border-radius: 50%;
    width: 30px;
    height: 30px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.sidebar-toggle:hover {
    background: var(--bs-primary) !important;
}

.sidebar-section-title {
    display: block;
    padding: 0.75rem 1rem 0.5rem;
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: #6c757d;
    border-bottom: 1px solid rgba(255,255,255,0.1);
    margin-bottom: 0.5rem;
}

.sidebar.collapsed .sidebar-section-title {
    display: none;
}

.nav-link-sidebar {
    display: flex;
    align-items: center;
    padding: 0.75rem 1rem;
    color: rgba(255,255,255,0.8);
    text-decoration: none;
    transition: all 0.2s ease;
    border-radius: 0.5rem;
    margin: 0.25rem 0.5rem;
}

.nav-link-sidebar:hover,
.nav-link-sidebar:focus {
    color: #fff;
    background: rgba(255,255,255,0.1);
    transform: translateX(2px);
}

.nav-link-sidebar.active {
    color: #fff;
    background: var(--bs-primary);
    box-shadow: 0 4px 12px rgba(13,110,253,0.3);
}

.sidebar-icon {
    width: 20px;
    text-align: center;
    transition: all 0.3s ease;
}

.sidebar-arrow {
    font-size: 0.75rem;
    transition: transform 0.3s ease;
}

.nav-link-sidebar[aria-expanded="true"] .sidebar-arrow {
    transform: rotate(180deg);
}

.sidebar.collapsed .sidebar-text,
.sidebar.collapsed .sidebar-arrow {
    display: none;
}

.sidebar.collapsed .nav-link-sidebar {
    justify-content: center;
    padding: 0.75rem;
}

.sidebar.collapsed .nav-link-sidebar:hover {
    transform: none;
}

/* Submenu Styles */
.nav-link-submenu {
    display: flex;
    align-items: center;
    padding: 0.5rem 0.75rem 0.5rem 2rem;
    color: rgba(255,255,255,0.7);
    text-decoration: none;
    font-size: 0.875rem;
    transition: all 0.2s ease;
    border-radius: 0.375rem;
    margin: 0.125rem 0.75rem;
}

.nav-link-submenu:hover,
.nav-link-submenu:focus {
    color: #fff;
    background: rgba(255,255,255,0.05);
}

.nav-link-submenu.active {
    color: #fff;
    background: rgba(13,110,253,0.5);
}

.sidebar-icon-sub {
    width: 16px;
    text-align: center;
    margin-right: 0.5rem;
    opacity: 0.7;
    transition: all 0.2s ease;
}

.nav-link-submenu:hover .sidebar-icon-sub,
.nav-link-submenu.active .sidebar-icon-sub {
    opacity: 1;
}

.sidebar-subtitle {
    display: block;
    padding: 0.5rem 0.75rem 0.25rem 2rem;
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: rgba(255,255,255,0.5);
}

.sidebar.collapsed .sidebar-subtitle {
    display: none;
}

/* User Avatar Styles */
.avatar-placeholder {
    background: linear-gradient(135deg, var(--bs-primary), var(--bs-info));
    font-weight: 600;
}

.user-avatar img {
    object-fit: cover;
    border: 2px solid var(--bs-primary);
}

.sidebar-footer {
    background: rgba(0,0,0,0.2);
    transition: all 0.3s ease;
}

.sidebar.collapsed .sidebar-footer {
    text-align: center;
    padding: 0.5rem !important;
}

.sidebar.collapsed .sidebar-footer div:not(.mb-1) {
    display: none;
}

/* Mobile Responsiveness */
@media (max-width: 768px) {
    .sidebar-wrapper {
        transform: translateX(-100%);
    }
    
    .sidebar-wrapper.show {
        transform: translateX(0);
    }
    
    .sidebar {
        width: 280px;
    }
    
    .sidebar.collapsed {
        width: 280px;
    }
    
    .sidebar.collapsed .sidebar-text,
    .sidebar.collapsed .sidebar-arrow,
    .sidebar.collapsed .user-info,
    .sidebar.collapsed .dropdown,
    .sidebar.collapsed .sidebar-section-title,
    .sidebar.collapsed .sidebar-subtitle {
        display: block !important;
        opacity: 1 !important;
        visibility: visible !important;
    }
    
    .sidebar.collapsed .nav-link-sidebar {
        justify-content: flex-start;
        padding: 0.75rem 1rem;
    }
}

/* Overlay for mobile */
.sidebar-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.5);
    z-index: 999;
}

@media (max-width: 768px) {
    .sidebar-overlay.show {
        display: block;
    }
}

/* Animations */
.nav-link-sidebar {
    position: relative;
    overflow: hidden;
}

.nav-link-sidebar::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
    transition: left 0.5s;
}

.nav-link-sidebar:hover::before {
    left: 100%;
}

/* Badge for new features */
.badge {
    font-size: 0.65rem;
    padding: 0.25rem 0.4rem;
    border-radius: 0.25rem;
}

/* Smooth transitions for all interactive elements */
* {
    transition-timing-function: ease-in-out;
    transition-duration: 0.2s;
}

/* Settings menu specific styles */
#settingsMenu.show {
    display: block !important;
}

.sidebar-arrow.fa-chevron-up {
    transform: rotate(180deg);
    transition: transform 0.3s ease;
}
</style>

<script>
// Sidebar functionality
function toggleSidebar() {
    const sidebar = document.getElementById('sidebar');
    const mainContent = document.getElementById('main-content');
    
    sidebar.classList.toggle('collapsed');
    
    // Adjust main content margin
    if (sidebar.classList.contains('collapsed')) {
        mainContent.style.marginLeft = '70px';
        localStorage.setItem('sidebarCollapsed', 'true');
    } else {
        mainContent.style.marginLeft = '280px';
        localStorage.setItem('sidebarCollapsed', 'false');
    }
}

// Settings menu toggle
function toggleSettingsMenu(event) {
    event.preventDefault();
    const settingsMenu = document.getElementById('settingsMenu');
    const settingsArrow = document.getElementById('settingsArrow');
    
    if (settingsMenu) {
        const isShowing = settingsMenu.classList.contains('show');
        
        // Close all other menus first
        document.querySelectorAll('.collapse.show').forEach(menu => {
            if (menu.id !== 'settingsMenu') {
                menu.classList.remove('show');
            }
        });
        
        // Reset all arrows
        document.querySelectorAll('.sidebar-arrow').forEach(arrow => {
            if (arrow.id !== 'settingsArrow') {
                arrow.classList.remove('fa-chevron-up');
                arrow.classList.add('fa-chevron-down');
            }
        });
        
        // Toggle current menu
        if (!isShowing) {
            settingsMenu.classList.add('show');
            if (settingsArrow) {
                settingsArrow.classList.remove('fa-chevron-down');
                settingsArrow.classList.add('fa-chevron-up');
            }
        } else {
            settingsMenu.classList.remove('show');
            if (settingsArrow) {
                settingsArrow.classList.remove('fa-chevron-up');
                settingsArrow.classList.add('fa-chevron-down');
            }
        }
    }
}

// Initialize sidebar state on page load
document.addEventListener('DOMContentLoaded', function() {
    const sidebar = document.getElementById('sidebar');
    const mainContent = document.getElementById('main-content');
    const sidebarCollapsed = localStorage.getItem('sidebarCollapsed') === 'true';
    
    if (sidebarCollapsed) {
        sidebar.classList.add('collapsed');
        if (mainContent) {
            mainContent.style.marginLeft = '70px';
        }
    } else {
        if (mainContent) {
            mainContent.style.marginLeft = '280px';
        }
    }
    
    // Mobile sidebar toggle
    const sidebarOverlay = document.createElement('div');
    sidebarOverlay.className = 'sidebar-overlay';
    document.body.appendChild(sidebarOverlay);
    
    // Mobile menu button
    const mobileMenuBtn = document.getElementById('mobile-menu-btn');
    if (mobileMenuBtn) {
        mobileMenuBtn.addEventListener('click', function() {
            document.querySelector('.sidebar-wrapper').classList.add('show');
            sidebarOverlay.classList.add('show');
        });
    }
    
    sidebarOverlay.addEventListener('click', function() {
        document.querySelector('.sidebar-wrapper').classList.remove('show');
        sidebarOverlay.classList.remove('show');
    });
    
    // Handle resize for mobile
    window.addEventListener('resize', function() {
        if (window.innerWidth > 768) {
            sidebarOverlay.classList.remove('show');
            document.querySelector('.sidebar-wrapper').classList.remove('show');
        }
    });
});
</script>

{% extends 'base.html' %}
{% load static %}
{% load custom_filters %}

{% block title %}
  {{ page_title }} | {{ block.super }}
{% endblock title %}

{% block page_title %}
  {{ page_title }}
{% endblock page_title %}

{% block breadcrumbs %}
  <li class="breadcrumb-item"><a href="{% url 'patients:list' %}">Patients</a></li>
  <li class="breadcrumb-item"><a href="{% url 'patients:detail' patient.id %}">{{ patient.get_full_name }}</a></li>
  <li class="breadcrumb-item"><a href="{% url 'patients:wallet_dashboard' patient.id %}">Wallet</a></li>
  <li class="breadcrumb-item active" aria-current="page">Settle Outstanding Balance</li>
{% endblock breadcrumbs %}

{% block content %}
<div class="row">
    <div class="col-md-8">
        <div class="card shadow">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">Settle Outstanding Wallet Balance</h6>
            </div>
            <div class="card-body">
                <!-- Warning Alert -->
                <div class="alert alert-warning">
                    <h6><i class="fas fa-exclamation-triangle"></i> Settlement Confirmation</h6>
                    <p class="mb-0">This action will settle the outstanding negative balance in the patient's wallet by converting any positive balance to offset it. This is an administrative action that should be used carefully. All settlements are logged and audited.</p>
                </div>

                <!-- Patient Info -->
                <div class="alert alert-info">
                    <h6><i class="fas fa-user"></i> Patient Information</h6>
                    <p class="mb-1"><strong>Name:</strong> {{ patient.get_full_name }}</p>
                    <p class="mb-1"><strong>Patient ID:</strong> {{ patient.patient_id }}</p>
                    <p class="mb-1"><strong>Type:</strong> <span class="badge bg-primary">{{ patient.get_patient_type_display }}</span></p>
                    <p class="mb-0"><strong>Current Wallet Balance:</strong> 
                        <span class="{% if wallet.balance < 0 %}text-danger{% else %}text-success{% endif %} font-weight-bold">
                            {{ wallet.balance|currency }}
                        </span>
                    </p>
                </div>

                <!-- Settlement Information -->
                {% if wallet.balance < 0 %}
                <div class="alert alert-danger">
                    <h6><i class="fas fa-exclamation-circle"></i> Outstanding Balance</h6>
                    <p class="mb-0">This patient has an outstanding negative balance of <strong>{{ outstanding_balance|currency }}</strong> in their wallet.</p>
                </div>
                
                <div class="card border-left-warning shadow mb-4">
                    <div class="card-body">
                        <h6 class="text-warning font-weight-bold">Settlement Details</h6>
                        <div class="row">
                            <div class="col-md-6">
                                <p><strong>Current Balance:</strong> <span class="text-danger">{{ wallet.balance|currency }}</span></p>
                                <p><strong>Outstanding Amount:</strong> <span class="text-danger">{{ outstanding_balance|currency }}</span></p>
                            </div>
                            <div class="col-md-6">
                                <p><strong>Action:</strong> Convert negative balance to zero</p>
                                <p><strong>Result:</strong> <span class="text-success">â‚¦0.00</span></p>
                            </div>
                        </div>
                        <div class="alert alert-info mt-3">
                            <h6><i class="fas fa-info-circle"></i> How Settlement Works</h6>
                            <p class="mb-0">This process will create two transactions in the wallet:</p>
                            <ol class="mb-0">
                                <li>A credit adjustment to offset the negative balance</li>
                                <li>A debit adjustment to record the settlement of the outstanding amount</li>
                            </ol>
                        </div>
                    </div>
                </div>
                
                <!-- Settlement Form -->
                <form method="post">
                    {% csrf_token %}
                    
                    <div class="alert alert-warning">
                        <h6><i class="fas fa-exclamation-triangle"></i> Confirm Settlement</h6>
                        <p>Are you sure you want to settle the outstanding balance of {{ outstanding_balance|currency }}? This action cannot be undone.</p>
                    </div>
                    
                    <!-- Action Buttons -->
                    <div class="form-group mt-4">
                        <button type="submit" class="btn btn-danger" id="settlement-btn">
                            <i class="fas fa-check"></i> Confirm Settlement
                        </button>
                        <a href="{% url 'patients:wallet_dashboard' patient.id %}" class="btn btn-secondary">
                            <i class="fas fa-times"></i> Cancel
                        </a>
                    </div>
                </form>
                {% else %}
                <div class="alert alert-success">
                    <h6><i class="fas fa-check-circle"></i> No Outstanding Balance</h6>
                    <p class="mb-0">This patient does not have an outstanding negative balance. Current wallet balance is <strong>{{ wallet.balance|currency }}</strong>.</p>
                </div>
                
                <div class="form-group mt-4">
                    <a href="{% url 'patients:wallet_dashboard' patient.id %}" class="btn btn-secondary">
                        <i class="fas fa-arrow-left"></i> Back to Wallet Dashboard
                    </a>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="col-md-4">
        <!-- Wallet Summary -->
        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">Wallet Summary</h6>
            </div>
            <div class="card-body">
                <div class="text-center">
                    <i class="fas fa-wallet fa-3x text-gray-300 mb-3"></i>
                    <h4 class="{% if wallet.balance < 0 %}text-danger{% else %}text-success{% endif %}">{{ wallet.balance|currency }}</h4>
                    <p class="text-muted">Current Balance</p>
                </div>
                <hr>
                <div class="row text-center">
                    <div class="col-6">
                        <div class="text-success">
                            <i class="fas fa-arrow-up"></i>
                            <div class="font-weight-bold">{{ wallet.get_total_credits|currency }}</div>
                            <small>Total Credits</small>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="text-danger">
                            <i class="fas fa-arrow-down"></i>
                            <div class="font-weight-bold">{{ wallet.get_total_debits|currency }}</div>
                            <small>Total Debits</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">Quick Actions</h6>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <a href="{% url 'patients:add_funds_to_wallet' patient.id %}" class="btn btn-success btn-sm">
                        <i class="fas fa-plus"></i> Add Funds
                    </a>
                    <a href="{% url 'patients:wallet_withdrawal' patient.id %}" class="btn btn-warning btn-sm">
                        <i class="fas fa-minus"></i> Withdraw Funds
                    </a>
                    <a href="{% url 'patients:wallet_transfer' patient.id %}" class="btn btn-info btn-sm">
                        <i class="fas fa-exchange-alt"></i> Transfer Funds
                    </a>
                    <a href="{% url 'patients:wallet_refund' patient.id %}" class="btn btn-primary btn-sm">
                        <i class="fas fa-undo"></i> Process Refund
                    </a>
                    <a href="{% url 'patients:wallet_adjustment' patient.id %}" class="btn btn-secondary btn-sm">
                        <i class="fas fa-edit"></i> Manual Adjustment
                    </a>
                    <a href="{% url 'patients:wallet_transactions' patient.id %}" class="btn btn-dark btn-sm">
                        <i class="fas fa-list"></i> View Transactions
                    </a>
                </div>
            </div>
        </div>

        <!-- Settlement Guidelines -->
        <div class="card shadow">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-warning">Settlement Guidelines</h6>
            </div>
            <div class="card-body">
                <ul class="list-unstyled mb-0">
                    <li class="mb-2">
                        <i class="fas fa-info-circle text-info"></i>
                        <small>Only applies to wallets with negative balances</small>
                    </li>
                    <li class="mb-2">
                        <i class="fas fa-file-invoice text-success"></i>
                        <small>Creates proper audit trail with transaction records</small>
                    </li>
                    <li class="mb-2">
                        <i class="fas fa-shield-alt text-warning"></i>
                        <small>Administrative action requiring confirmation</small>
                    </li>
                    <li class="mb-0">
                        <i class="fas fa-receipt text-primary"></i>
                        <small>Settlement transactions are clearly labeled</small>
                    </li>
                </ul>
            </div>
        </div>
    </div>
</div>
{% endblock %}
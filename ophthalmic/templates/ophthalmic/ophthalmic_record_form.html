{% extends 'base.html' %}
{% load static %}
{% load custom_filters %}
{% load widget_tweaks %}

{% block title %}{{ title }}{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-sm-flex align-items-center justify-content-between mb-4">
        <h1 class="h3 mb-0 text-gray-800">{{ title }}</h1>
    </div>

    <div class="card shadow mb-4">
        <div class="card-body">
            <form method="POST">
                {% csrf_token %}
                <div class="row">
                    <div class="col-md-6">
                        
                <div class="form-group">
                    <label for="{{ form.visual_acuity_right.id_for_label }}">Visual Acuity Right</label>
                    {{ form.visual_acuity_right|add_class:"form-control" }}
                </div>
                
                <div class="form-group">
                    <label for="{{ form.visual_acuity_left.id_for_label }}">Visual Acuity Left</label>
                    {{ form.visual_acuity_left|add_class:"form-control" }}
                </div>
                
                <div class="form-group">
                    <label for="{{ form.refraction_right_sphere.id_for_label }}">Refraction Right Sphere</label>
                    {{ form.refraction_right_sphere|add_class:"form-control" }}
                </div>
                
                <div class="form-group">
                    <label for="{{ form.refraction_right_cylinder.id_for_label }}">Refraction Right Cylinder</label>
                    {{ form.refraction_right_cylinder|add_class:"form-control" }}
                </div>
                
                <div class="form-group">
                    <label for="{{ form.refraction_right_axis.id_for_label }}">Refraction Right Axis</label>
                    {{ form.refraction_right_axis|add_class:"form-control" }}
                </div>
                
                <div class="form-group">
                    <label for="{{ form.refraction_left_sphere.id_for_label }}">Refraction Left Sphere</label>
                    {{ form.refraction_left_sphere|add_class:"form-control" }}
                </div>
                
                <div class="form-group">
                    <label for="{{ form.refraction_left_cylinder.id_for_label }}">Refraction Left Cylinder</label>
                    {{ form.refraction_left_cylinder|add_class:"form-control" }}
                </div>
                
                <div class="form-group">
                    <label for="{{ form.refraction_left_axis.id_for_label }}">Refraction Left Axis</label>
                    {{ form.refraction_left_axis|add_class:"form-control" }}
                </div>
                
                <div class="form-group">
                    <label for="{{ form.iop_right.id_for_label }}">IOP Right (mmHg)</label>
                    {{ form.iop_right|add_class:"form-control" }}
                </div>
                
                <div class="form-group">
                    <label for="{{ form.iop_left.id_for_label }}">IOP Left (mmHg)</label>
                    {{ form.iop_left|add_class:"form-control" }}
                </div>
                
                <div class="form-group">
                    <label for="{{ form.clinical_findings.id_for_label }}">Clinical Findings</label>
                    {{ form.clinical_findings|add_class:"form-control" }}
                </div>
                
<div class="form-group">
                            <label for="{{ form.patient.id_for_label }}">Patient *</label>
                            {{ form.patient|add_class:"form-control" }}
                        </div>
                    </div>
                    <div class="col-md-6">
                        <!-- Doctor Selection with Search -->
                        <div class="form-group">
                            <label for="{{ form.doctor.id_for_label }}">Doctor</label>

                            <!-- Enhanced Doctor Search Field -->
                            <div class="input-group mb-2">
                                <input type="text" id="doctor_search" class="form-control" placeholder="Search by name...">
                                <button class="btn btn-outline-secondary" type="button" id="clear_doctor_search">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>

                            <!-- Doctor Dropdown with Select2 -->
                            <select id="doctor_dropdown" class="form-control select2" data-placeholder="Select a doctor...">
                                <option value="">Select a doctor...</option>
                                <!-- Options will be populated by JavaScript -->
                            </select>

                            <!-- Hidden field for form submission (will be updated by JavaScript) -->
                            {{ form.doctor|add_class:"d-none" }}

                            <!-- Selected Doctor Info -->
                            <div id="selected_doctor_info" class="mt-2 p-2 bg-light rounded" style="display: none;">
                                <strong>Selected Doctor:</strong>
                                <span id="doctor_name"></span>
                                <br>
                                <small class="text-muted">
                                    Department: <span id="doctor_department"></span>
                                </small>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="{{ form.visit_date.id_for_label }}">Visit Date *</label>
                            {{ form.visit_date|add_class:"form-control" }}
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="{{ form.chief_complaint.id_for_label }}">Chief Complaint</label>
                    {{ form.chief_complaint|add_class:"form-control" }}
                </div>
                
                <div class="form-group">
                    <label for="{{ form.history_of_present_illness.id_for_label }}">History of Present Illness</label>
                    {{ form.history_of_present_illness|add_class:"form-control" }}
                </div>
                
                <div class="form-group">
                    <label for="{{ form.diagnosis.id_for_label }}">Diagnosis</label>
                    {{ form.diagnosis|add_class:"form-control" }}
                </div>
                
                <div class="form-group">
                    <label for="{{ form.treatment_plan.id_for_label }}">Treatment Plan</label>
                    {{ form.treatment_plan|add_class:"form-control" }}
                </div>
                
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="{{ form.follow_up_required.id_for_label }}">Follow-up Required</label>
                            {{ form.follow_up_required|add_class:"form-control" }}
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="{{ form.follow_up_date.id_for_label }}">Follow-up Date</label>
                            {{ form.follow_up_date|add_class:"form-control" }}
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="{{ form.authorization_code.id_for_label }}">Authorization Code (Optional)</label>
                    {{ form.authorization_code|add_class:"form-control" }}
                    <small class="form-text text-muted">Enter authorization code from desk office if applicable</small>
                </div>
                
                <div class="form-group">
                    <label for="{{ form.notes.id_for_label }}">Notes</label>
                    {{ form.notes|add_class:"form-control" }}
                </div>
                
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-save"></i> Save Record
                </button>
                <a href="{% url 'ophthalmic:ophthalmic_records_list' %}" class="btn btn-secondary">
                    <i class="fas fa-times"></i> Cancel
                </a>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize Select2 for dropdowns
    if (typeof $ !== 'undefined') {
        $('.select2').select2({
            theme: 'bootstrap-5',
            width: '100%',
            allowClear: true
        });
    }

    // Doctor Search Functionality
    const doctorSearchField = document.getElementById('doctor_search');
    const doctorDropdown = document.getElementById('doctor_dropdown');
    const doctorHiddenField = document.getElementById('{{ form.doctor.auto_id }}');
    const selectedDoctorInfo = document.getElementById('selected_doctor_info');
    const clearDoctorSearchBtn = document.getElementById('clear_doctor_search');

    let doctorSearchTimeout;

    // Load all doctors for dropdown
    function loadAllDoctors() {
        fetch('/accounts/api/users/?role=doctor')
            .then(response => response.json())
            .then(data => {
                const options = data.map(doctor => {
                    const doctorName = `Dr. ${doctor.first_name} ${doctor.last_name}`;
                    const department = doctor.department || 'N/A';
                    return `<option value="${doctor.id}"
                             data-name="${doctorName}"
                             data-department="${department}">
                             ${doctorName}${department ? ` (${department})` : ''}
                             </option>`;
                }).join('');
                doctorDropdown.innerHTML = '<option value="">Select a doctor...</option>' + options;
                $(doctorDropdown).trigger('change.select2');
            })
            .catch(error => console.error('Error loading doctors:', error));
    }

    // Initialize doctors dropdown with data
    loadAllDoctors();

    // Doctor Search Handler
    if (doctorSearchField) {
        doctorSearchField.addEventListener('input', function() {
            const searchTerm = this.value.trim();

            clearTimeout(doctorSearchTimeout);

            if (searchTerm.length === 0) {
                // Reload all doctors
                loadAllDoctors();
                return;
            }

            if (searchTerm.length < 2) {
                return;
            }

            doctorSearchTimeout = setTimeout(() => {
                fetch('/accounts/api/users/?role=doctor')
                    .then(response => response.json())
                    .then(data => {
                        // Filter doctors based on search term
                        const filteredDoctors = data.filter(doctor =>
                            `${doctor.first_name} ${doctor.last_name}`.toLowerCase().includes(searchTerm.toLowerCase())
                        );

                        const options = filteredDoctors.map(doctor => {
                            const doctorName = `Dr. ${doctor.first_name} ${doctor.last_name}`;
                            const department = doctor.department || 'N/A';
                            return `<option value="${doctor.id}"
                                     data-name="${doctorName}"
                                     data-department="${department}">
                                     ${doctorName}${department ? ` (${department})` : ''}
                                     </option>`;
                        }).join('');
                        doctorDropdown.innerHTML = '<option value="">Select a doctor...</option>' + options;
                        $(doctorDropdown).trigger('change.select2');
                    })
                    .catch(error => console.error('Error searching doctors:', error));
            }, 300);
        });
    }

    // Doctor Dropdown Selection Handler
    if (doctorDropdown) {
        doctorDropdown.addEventListener('change', function() {
            const selectedOption = this.options[this.selectedIndex];
            if (selectedOption && selectedOption.value) {
                const doctorId = selectedOption.value;
                const doctorName = selectedOption.dataset.name;
                const doctorDepartment = selectedOption.dataset.department;

                // Update hidden field
                doctorHiddenField.value = doctorId;

                // Update selected doctor info display
                document.getElementById('doctor_name').textContent = doctorName;
                document.getElementById('doctor_department').textContent = doctorDepartment;
                selectedDoctorInfo.style.display = 'block';

                // Sync search field
                doctorSearchField.value = doctorName;
            } else {
                // Clear selection
                doctorHiddenField.value = '';
                selectedDoctorInfo.style.display = 'none';
                doctorSearchField.value = '';
            }
        });
    }

    // Clear Doctor Search
    if (clearDoctorSearchBtn) {
        clearDoctorSearchBtn.addEventListener('click', function() {
            doctorSearchField.value = '';
            doctorHiddenField.value = '';
            selectedDoctorInfo.style.display = 'none';
            loadAllDoctors(); // Reload all doctors
        });
    }

    // Pre-fill if editing existing record
    {% if record and record.doctor %}
        const doctorId = "{{ record.doctor.id }}";
        const doctorName = "Dr. {{ record.doctor.get_full_name }}";
        const doctorDepartment = "{{ record.doctor.profile.department.name|default:'N/A' }}";

        doctorHiddenField.value = doctorId;
        document.getElementById('doctor_name').textContent = doctorName;
        document.getElementById('doctor_department').textContent = doctorDepartment;
        selectedDoctorInfo.style.display = 'block';

        // Set dropdown selection
        $(doctorDropdown).val(doctorId).trigger('change.select2');
    {% endif %}
});
</script>
{% endblock %}
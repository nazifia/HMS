<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <title>Generate Authorization Code - NHIA Authorization</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <!-- HTMX -->
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <script>
        // Configure HTMX to send CSRF token with all requests
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof htmx !== 'undefined') {
                htmx.config.globalViewTransitions = false;
                htmx.config.scrollBehavior = 'smooth';
                htmx.config.defaultSwapStyle = 'innerHTML';
                htmx.config.defaultSwapDelay = 0;
                htmx.config.defaultSettleDelay = 50;
                
                // Include CSRF token in all requests
                htmx.on('htmx:configRequest', function(evt) {
                    // Add CSRF token to all non-GET requests
                    if (evt.detail.verb !== 'get') {
                        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value ||
                                        document.cookie.split('; ').find(row => row.startsWith('csrftoken='))?.split('=')[1];
                        if (csrfToken) {
                            evt.detail.parameters['csrfmiddlewaretoken'] = csrfToken;
                        }
                    }
                });
                
                console.log('HTMX configured successfully');
            } else {
                console.error('HTMX not loaded');
            }
        });
    </script>

    <!-- DataTables CSS -->
    <link href="https://cdn.datatables.net/1.11.5/css/dataTables.bootstrap5.min.css" rel="stylesheet">

    <!-- Select2 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" />

    <!-- Custom CSS -->
    



    
    <link rel="stylesheet" href="/static/css/style_new.css">
    <link rel="stylesheet" href="/static/css/patient_search.css">
    

    
<style>
.form-container {
    max-width: 800px;
    margin: 0 auto;
}
.patient-card {
    border-left: 4px solid #007bff;
    transition: transform 0.2s ease-in-out;
}
.patient-card:hover {
    transform: translateY(-2px);
}
.code-preview {
    background-color: #f8f9fa;
    border: 2px dashed #dee2e6;
    font-family: 'Courier New', monospace;
    font-size: 1.2rem;
    text-align: center;
    padding: 20px;
    letter-spacing: 2px;
}
.required-field::after {
    content: " *";
    color: #dc3545;
}
.search-results {
    max-height: 300px;
    overflow-y: auto;
}
.patient-result-item {
    cursor: pointer;
    transition: background-color 0.2s ease;
}
.patient-result-item:hover {
    background-color: #e9ecef;
}
.loading-indicator {
    display: none;
}
.htmx-request .loading-indicator {
    display: inline-block;
}
.htmx-request .search-icon {
    display: none;
}
</style>


    <!-- Custom Message Styles for Prescription Status -->
    <style>
        /* Custom message styling for dispensed prescriptions */
        .alert-dispensed {
            background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
            border: 1px solid #b8dacc;
            color: #155724;
            font-weight: 500;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .alert-cancelled {
            background: linear-gradient(135deg, #fff3cd 0%, #fdeaa7 100%);
            border: 1px solid #f3d9a2;
            color: #856404;
            font-weight: 500;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .alert-error-custom {
            background: linear-gradient(135deg, #f8d7da 0%, #f1b0b7 100%);
            border: 1px solid #f5c6cb;
            color: #721c24;
            font-weight: 500;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        /* Message icon styling */
        .alert-icon {
            display: inline-block;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            text-align: center;
            line-height: 30px;
            margin-right: 10px;
            background: rgba(255, 255, 255, 0.3);
            font-size: 16px;
            vertical-align: middle;
        }

        .alert-dispensed .alert-icon {
            background: rgba(25, 135, 84, 0.2);
            color: #198754;
        }

        .alert-cancelled .alert-icon {
            background: rgba(255, 193, 7, 0.2);
            color: #ffc107;
        }

        .alert-error-custom .alert-icon {
            background: rgba(220, 53, 69, 0.2);
            color: #dc3545;
        }

        /* Enhanced transitions */
        .alert-dispensed,
        .alert-cancelled,
        .alert-error-custom {
            transition: all 0.3s ease;
            border-left: 4px solid;
        }

        .alert-dispensed {
            border-left-color: #198754;
        }

        .alert-cancelled {
            border-left-color: #ffc107;
        }

        .alert-error-custom {
            border-left-color: #dc3545;
        }

        /* Main layout for sidebar and content */
        html, body {
            height: 100%;
            overflow-x: hidden; /* Allow horizontal scrolling if needed */
            overflow-y: auto; /* Allow vertical scrolling */
        }
        #wrapper {
            display: flex;
            min-height: 100vh;
            width: 100vw;
            background: #f8f9fc;
            overflow-x: hidden; /* Keep horizontal hidden if desired, but allow vertical */
            overflow-y: auto; /* Allow vertical scrolling */
        }

        /* Content Wrapper */
        #content-wrapper {
            display: flex;
            flex-direction: column;
            flex-grow: 1;
            width: 100%;
            min-width: 0;
            background: #f8f9fc;
            overflow-y: auto; /* Changed from hidden to auto */
            height: 100vh;
        }

        /* Main Content Area */
        #content {
            flex: 1 0 auto;
            width: 100%;
            display: flex;
            flex-direction: column;
            padding-bottom: 80px; /* Space for footer */
            overflow-y: auto;
            height: 100vh;
        }

        /* Container Fluid for content padding */
        .container-fluid {
            flex: 1 0 auto;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
            padding: 1rem;
        }

        /* Topbar custom style */
        .topbar {
            background: #fff;
            box-shadow: 0 2px 8px rgba(0,0,0,0.03);
            border-radius: 0 0 12px 12px;
            padding: 0.5rem 2rem;
            min-height: 64px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            z-index: 1020;
        }
        .topbar .navbar-brand {
            font-weight: 700;
            color: #00bfff !important;
            font-size: 1.4rem;
            letter-spacing: 1px;
        }
        .topbar .nav-link, .topbar .fa {
            color: #23272b !important;
            font-size: 1.1rem;
        }
        .topbar .nav-link:hover {
            color: #00bfff !important;
        }

        /* Enhanced User Profile Elements */
        .img-profile {
            border: 2px solid #fff;
            box-shadow: 0 0 0 2px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
        }
        
        .img-profile:hover {
            transform: scale(1.05);
            box-shadow: 0 0 8px rgba(0,0,0,0.3);
        }

        .avatar-placeholder {
            border: 2px solid #fff;
            box-shadow: 0 0 0 2px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
            font-weight: 600;
            font-size: 14px;
        }

        .avatar-placeholder:hover {
            transform: scale(1.05);
            box-shadow: 0 0 8px rgba(0,0,0,0.3);
        }

        .user-dropdown-toggle {
            transition: all 0.3s ease;
            position: relative;
        }

        .user-dropdown-toggle:hover {
            background: rgba(0, 184, 255, 0.1);
            border-radius: 8px;
            transform: translateY(-1px);
        }

        .session-status-container {
            transition: all 0.3s ease;
            position: relative;
            border-radius: 20px;
        }

        .session-status-container:hover {
            background: rgba(40, 167, 69, 0.1);
            transform: scale(1.05);
        }

        .patient-context-container {
            transition: all 0.3s ease;
            position: relative;
            border-radius: 20px;
        }

        .patient-context-container:hover {
            background: rgba(23, 162, 184, 0.1);
            transform: scale(1.05);
        }

        .dropdown-menu {
            animation: slideDown 0.3s ease;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .dropdown-menu.show {
            animation: slideDown 0.3s ease;
        }

        /* Enhanced User Name Visibility */
        .user-dropdown-toggle .font-weight-bold {
            color: #23272b !important;
            font-size: 0.9rem;
            font-weight: 700;
        }

        /* Better Chevron Styling */
        .user-dropdown-toggle .fa-chevron-down {
            transition: transform 0.2s ease;
        }

        .user-dropdown-toggle[aria-expanded="true"] .fa-chevron-down {
            transform: rotate(180deg);
        }
        /* Footer custom style */
        footer, .footer {
            flex-shrink: 0;
            background: #fff;
            color: #23272b;
            box-shadow: 0 -2px 8px rgba(0,0,0,0.03);
            border-radius: 12px 12px 0 0;
            padding: 1rem 2rem;
            text-align: center;
            font-size: 1rem;
            margin-top: auto;
            position: sticky;
            bottom: 0;
            width: 100%;
        }
        /* Responsive tweaks */
        @media (max-width: 991.98px) {
            .topbar, footer, .footer {
                padding: 0.5rem 1rem;
                border-radius: 0;
            }
        }
        @media (max-width: 600px) {
            .topbar, footer, .footer {
                padding: 0.5rem 0.5rem;
                font-size: 0.95rem;
            }
            .topbar .navbar-brand {
                font-size: 1.1rem;
            }
        }

        /* Auto Logout Modal Styles */
        #logoutWarningModal .modal-content {
            border: 2px solid #ffc107;
            box-shadow: 0 0 20px rgba(255, 193, 7, 0.3);
        }

        #logoutWarningModal #countdownTimer {
            font-family: 'Courier New', monospace;
            font-weight: bold;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
        }

        #logoutModal .modal-content {
            border: none;
            box-shadow: 0 0 20px rgba(0,0,0,0.2);
        }

        .modal-backdrop.show {
            opacity: 0.15;  /* Reduced from 0.3 to 0.15 */
        }

        /* Global Modal Z-Index Override */
        #logoutWarningModal, #logoutModal {
            z-index: 50010 !important;
        }

        #logoutWarningModal .modal-backdrop, #logoutModal .modal-backdrop {
            z-index: 50000 !important;
        }

        /* Session Status Indicator */
        #sessionStatus {
            cursor: default;
            font-size: 0.9rem;
        }

        #sessionIndicator {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }
    </style>
    <script>
        // Sidebar toggle for mobile - handled by sidebar.js
    </script>
    
    
    <!-- Additional head content here -->
    
</head>
<body id="page-top">

    <!-- Page Wrapper -->
    <div id="wrapper">
        <!-- Sidebar -->
        
            


<!-- Mobile Overlay -->
<div id="sidebar-overlay" class="sidebar-overlay"></div>

<!-- Sidebar -->
<div class="d-flex flex-column bg-dark sidebar vh-100" id="sidebar-container" style="width:300px !important;min-height:100vh;overflow-y:auto;scroll-behavior:auto;">
    <ul class="navbar-nav sidebar-dark accordion flex-grow-1" id="accordionSidebar" style="overflow:visible;scroll-behavior:auto;">

        <!-- Mobile Header with Hamburger Menu -->
        <div class="d-md-none mobile-sidebar-header bg-dark d-flex align-items-center justify-content-between p-3 border-bottom border-secondary">
            <div class="sidebar-brand d-flex align-items-center" href="/">
                <div class="sidebar-brand-icon">
                    <i class="fas fa-hospital text-white"></i>
                </div>
                <div class="sidebar-brand-text mx-2 text-white">HMS</div>
            </div>
            <button class="btn btn-link text-white p-0" id="mobileSidebarClose">
                <i class="fas fa-times fa-lg"></i>
            </button>
        </div>

        <!-- Desktop Sidebar - Brand -->
        <a class="sidebar-brand d-none d-md-flex align-items-center justify-content-center mt-3 mb-4" href="/">
            <div class="sidebar-brand-icon">
                <i class="fas fa-hospital text-white"></i>
            </div>
            <div class="sidebar-brand-text mx-3 text-white">HMS</div>
        </a>

        <!-- Divider -->
        <hr class="sidebar-divider my-0">

        <!-- Nav Item - Dashboard -->
        
        <li class="nav-item ">
            <a class="nav-link" href="/dashboard/">
                <i class="fas fa-fw fa-tachometer-alt text-white"></i>
                <span class="text-white">Dashboard</span>
            </a>
        </li>
        

        
        <li class="nav-item ">
            <a class="nav-link collapsed" href="#" data-bs-toggle="collapse" data-bs-target="#collapseAccessControl" aria-expanded="false" aria-controls="collapseAccessControl">
                <i class="fas fa-fw fa-shield-alt text-white"></i>
                <span class="text-white">Access Control</span>
            </a>
            <div id="collapseAccessControl" class="collapse " aria-labelledby="headingAccessControl" data-parent="#accordionSidebar">
                <div class="bg-white py-2 collapse-inner rounded">
                    <h6 class="collapse-header">RBAC Management:</h6>
                    <a class="collapse-item " href="/accounts/roles/">Manage Roles</a>
                    <a class="collapse-item " href="/accounts/roles/create/">Create Role</a>
                    <a class="collapse-item " href="/accounts/permissions/">Permissions</a>
                    <a class="collapse-item " href="/accounts/role-demo/">Role Demo</a>
                </div>
            </div>
        </li>
        

        <!-- Divider -->
        <hr class="sidebar-divider">



        <!-- Divider -->
        <hr class="sidebar-divider">

        <!-- Heading -->
        <div class="sidebar-heading">
            Patient Care
        </div>

        <!-- Nav Item - Consultations -->
        
        <li class="nav-item ">
            <a class="nav-link collapsed" href="#" data-bs-toggle="collapse" data-bs-target="#collapseConsultations" aria-expanded="false" aria-controls="collapseConsultations">
                <i class="fas fa-fw fa-comments text-white"></i>
                <span class="text-white">Consultations</span>
            </a>
            <div id="collapseConsultations" class="collapse " aria-labelledby="headingConsultations" data-parent="#accordionSidebar">
                <div class="bg-white py-2 collapse-inner rounded">
                    <h6 class="collapse-header">Consultation Management:</h6>
                    <a class="collapse-item " href="/consultations/doctor/consultations/">All Consultations</a>
                    <a class="collapse-item " href="/consultations/doctor/patients/">Create Consultation</a>
                    <a class="collapse-item " href="/consultations/doctor/referrals/">Referrals</a>
                    
                    <a class="collapse-item " href="/consultations/doctor/dashboard/">Doctor Dashboard</a>
                    
                </div>
            </div>
        </li>
        

        <!-- Nav Item - Patients -->
        
        <li class="nav-item ">
            <a class="nav-link collapsed" href="#" data-bs-toggle="collapse" data-bs-target="#collapsePatients" aria-expanded="false" aria-controls="collapsePatients">
                <i class="fas fa-fw fa-user-injured text-white"></i>
                <span class="text-white">Patients</span>
            </a>
            <div id="collapsePatients" class="collapse " aria-labelledby="headingPatients" data-parent="#accordionSidebar">
                <div class="bg-white py-2 collapse-inner rounded">
                    <h6 class="collapse-header">Patient Management:</h6>
                    <a class="collapse-item " href="/patients/">All Patients</a>
                    
                    <a class="collapse-item " href="/patients/register/">Register Patient</a>
                    <a class="collapse-item " href="/nhia/register-independent/">Register NHIA Patient</a>
                    <a class="collapse-item " href="/nhia/register-patient/">Add Patient to NHIA</a>
                    <a class="collapse-item " href="/retainership/register-independent/">Register Retainership Patient</a>
                    
                    <a class="collapse-item " href="/nhia/patients/">NHIA Patients</a>
                    
                    <!-- Retainership Patients: always visible, styled like NHIA -->
                    <a class="collapse-item " href="/retainership/patients/">Retainership Patients</a>
                </div>
            </div>
        </li>
        

        <!-- Nav Item - Doctors (Admin can manage, All can view list) -->
        
        <li class="nav-item ">
            <a class="nav-link collapsed" href="#" data-bs-toggle="collapse" data-bs-target="#collapseDoctors" aria-expanded="false" aria-controls="collapseDoctors">
                <i class="fas fa-fw fa-user-md text-white"></i>
                <span class="text-white">Doctors</span>
            </a>
            <div id="collapseDoctors" class="collapse " aria-labelledby="headingDoctors" data-parent="#accordionSidebar">
                <div class="bg-white py-2 collapse-inner rounded">
                    <h6 class="collapse-header">Doctor Directory:</h6>
                    <a class="collapse-item " href="/doctors/">All Doctors</a>

                    
                    <div class="collapse-divider"></div>
                    <h6 class="collapse-header">Administration:</h6>
                    <a class="collapse-item " href="/doctors/admin/doctors/">Manage Doctors</a>
                    <a class="collapse-item " href="/doctors/admin/doctors/add/">Add New Doctor</a>
                    <a class="collapse-item " href="/doctors/admin/specializations/">Specializations</a>
                    <a class="collapse-item " href="/doctors/admin/leave-requests/">Leave Requests</a>
                    

                    
                    <div class="collapse-divider"></div>
                    <h6 class="collapse-header">Doctor Portal:</h6>
                    <a class="collapse-item " href="/consultations/doctor/dashboard/">My Dashboard</a>
                    <a class="collapse-item " href="/consultations/doctor/waiting-list/">Waiting Patients</a>
                    <a class="collapse-item " href="/consultations/doctor/patients/">My Patients</a>
                    <a class="collapse-item " href="/consultations/doctor/consultations/">Consultations</a>
                    <a class="collapse-item " href="/consultations/doctor/referrals/">Referrals</a>
                    <a class="collapse-item " href="/doctors/profile/">My Profile</a>
                    <a class="collapse-item " href="/doctors/availability/">My Availability</a>
                    <a class="collapse-item " href="/doctors/education/">Education</a>
                    <a class="collapse-item " href="/doctors/experience/">Experience</a>
                    <a class="collapse-item " href="/doctors/leave/">Request Leave</a>
                    
                </div>
            </div>
        </li>
        

        <!-- Nav Item - Inpatient Management -->
        
        <li class="nav-item ">
            <a class="nav-link collapsed" href="#" data-bs-toggle="collapse" data-bs-target="#collapseInpatient" aria-expanded="false" aria-controls="collapseInpatient">
                <i class="fas fa-fw fa-hospital-alt text-white"></i>
                <span class="text-white">Inpatient</span>
            </a>
            <div id="collapseInpatient" class="collapse " aria-labelledby="headingInpatient" data-parent="#accordionSidebar">
                <div class="bg-white py-2 collapse-inner rounded">
                    <h6 class="collapse-header">Inpatient Management:</h6>
                    <a class="collapse-item " href="/inpatient/admissions/">Admissions</a>
                    <a class="collapse-item " href="/inpatient/wards/">Wards</a>
                    <a class="collapse-item " href="/inpatient/beds/">Beds</a>
                    <a class="collapse-item " href="/inpatient/bed-dashboard/">Bed Dashboard</a>
                    <div class="collapse-divider"></div>
                    <h6 class="collapse-header">Reports:</h6>
                    <a class="collapse-item " href="/inpatient/reports/bed-occupancy/">Bed Occupancy Report</a>
                </div>
            </div>
        </li>
        

        <!-- Nav Item - Appointments -->
        
        <li class="nav-item ">
            <a class="nav-link collapsed" href="#" data-bs-toggle="collapse" data-bs-target="#collapseAppointments" aria-expanded="false" aria-controls="collapseAppointments">
                <i class="fas fa-fw fa-calendar-check text-white"></i>
                <span class="text-white">Appointments</span>
            </a>
            <div id="collapseAppointments" class="collapse " aria-labelledby="headingAppointments" data-parent="#accordionSidebar">
                <div class="bg-white py-2 collapse-inner rounded">
                    <h6 class="collapse-header">Appointment Management:</h6>
                    <a class="collapse-item " href="/appointments/">All Appointments</a>

                    <!-- Only receptionists, health record officers, and admins can create appointments -->
                    
                    <a class="collapse-item " href="/appointments/create/">Schedule Appointment</a>
                    

                    <!-- Doctor-specific appointment views -->
                    
                    <a class="collapse-item " href="/appointments/doctor/1/">My Appointments</a>
                    
                </div>
            </div>
        </li>
        

        <!-- Nav Item - Consulting Rooms and Waiting List (HMS Custom Permission: access_sensitive_data) -->
        
        <li class="nav-item ">
            <a class="nav-link collapsed" href="#" data-bs-toggle="collapse" data-bs-target="#collapseConsultingRooms" aria-expanded="false" aria-controls="collapseConsultingRooms">
                <i class="fas fa-fw fa-door-open text-white"></i>
                <span class="text-white">Consulting Rooms</span>
            </a>
            <div id="collapseConsultingRooms" class="collapse " aria-labelledby="headingConsultingRooms" data-parent="#accordionSidebar">
                <div class="bg-white py-2 collapse-inner rounded">
                    <h6 class="collapse-header">Room Management:</h6>
                    <a class="collapse-item " href="/consultations/consulting-rooms/">All Rooms</a>

                    
                    <a class="collapse-item " href="/consultations/consulting-rooms/create/">Add New Room</a>
                    

                    <div class="collapse-divider"></div>
                    <h6 class="collapse-header">Patient Management:</h6>

                    
                    <a class="collapse-item " href="/consultations/waiting-list/">Waiting List</a>
                    <a class="collapse-item " href="/consultations/waiting-list/add/">Add to Waiting List</a>
                    

                    
                    <a class="collapse-item " href="/consultations/doctor/waiting-list/">My Waiting Patients</a>
                    
                </div>
            </div>
        </li>
        

        <!-- Divider -->
        <hr class="sidebar-divider">

        <!-- Heading -->
        <div class="sidebar-heading">
            Medical Services
        </div>

        <!-- Nav Item - Pharmacy -->
        
        <li class="nav-item ">
            <a class="nav-link collapsed" href="#" data-bs-toggle="collapse" data-bs-target="#collapsePharmacy" aria-expanded="false" aria-controls="collapsePharmacy">
                <i class="fas fa-fw fa-pills text-white"></i>
                <span class="text-white">Pharmacy</span>
            </a>
            <div id="collapsePharmacy" class="collapse " aria-labelledby="headingPharmacy" data-parent="#accordionSidebar">
                <div class="bg-white py-2 collapse-inner rounded">
                    <h6 class="collapse-header">Pharmacy Management:</h6>

                    <!-- Core Operations -->
                    <a class="collapse-item " href="/pharmacy/prescriptions/">Prescriptions</a>
                    <a class="collapse-item " href="/pharmacy/dispensed-items/">Dispensed Items Tracker</a>

                    <!-- Cart Management -->
                    <a class="collapse-item " href="/pharmacy/carts/">Prescription Carts</a>

                    <!-- Enhanced Transfer System -->
                    <a class="collapse-item " href="/pharmacy/transfers/">Enhanced Transfers</a>

                    <!-- Inventory management for pharmacists and admins -->
                    
                    <a class="collapse-item " href="/pharmacy/inventory/">Inventory</a>
                    <a class="collapse-item " href="/pharmacy/alerts/">Stock Alerts</a>

                    <div class="collapse-divider"></div>
                    <h6 class="collapse-header">Medical Packs:</h6>
                    <a class="collapse-item " href="/pharmacy/packs/">All Medical Packs</a>
                    <a class="collapse-item " href="/pharmacy/packs/create/">Create New Pack</a>
                    <a class="collapse-item " href="/pharmacy/pack-orders/">Pack Orders</a>
                    <a class="collapse-item " href="/pharmacy/pack-orders/create/">Order Medical Pack</a>

                    <div class="collapse-divider"></div>
                    <h6 class="collapse-header">Inter-Dispensary:</h6>
                    <a class="collapse-item " href="/pharmacy/transfers/inter/">Inter-Dispensary Transfers</a>
                    <a class="collapse-item " href="/pharmacy/transfers/inter/create/">Create Transfer</a>
                    <a class="collapse-item " href="/pharmacy/transfers/inter/statistics/">Transfer Statistics</a>

                    <div class="collapse-divider"></div>
                    <h6 class="collapse-header">Procurement:</h6>
                    <a class="collapse-item " href="/pharmacy/procurement/">Procurement Dashboard</a>
                    <a class="collapse-item " href="/pharmacy/purchases/">Purchase Management</a>
                    <a class="collapse-item " href="/pharmacy/bulk-store/">Bulk Store</a>

                    <div class="collapse-divider"></div>
                    <h6 class="collapse-header">Reports:</h6>
                    <a class="collapse-item " href="/pharmacy/reports/expiring-medications/">Expiring Medications</a>
                    <a class="collapse-item " href="/pharmacy/reports/low-stock/">Low Stock Report</a>
                    <a class="collapse-item " href="/pharmacy/revenue/analysis/">Revenue Analysis</a>
                    
                </div>
            </div>
        </li>
        

        <!-- Nav Item - Dispensary Management (Available to pharmacists and admins) -->
        
        <li class="nav-item ">
            <a class="nav-link collapsed" href="#" data-bs-toggle="collapse" data-bs-target="#collapseDispensary" aria-expanded="false" aria-controls="collapseDispensary">
                <i class="fas fa-fw fa-store-alt text-white"></i>
                <span class="text-white">Dispensaries</span>
            </a>
            <div id="collapseDispensary" class="collapse " aria-labelledby="headingDispensary" data-parent="#accordionSidebar">
                <div class="bg-white py-2 collapse-inner rounded">
                    <h6 class="collapse-header">Dispensary Management:</h6>
                    <a class="collapse-item " href="/pharmacy/dispensaries/">Manage Dispensaries</a>
                    
                </div>
            </div>
        </li>
        

        <!-- Nav Item - Pharmacy Reports - Temporarily disabled -->
        <!-- <li class="nav-item ">
            <a class="nav-link" href="/reporting/pharmacy/sales-report/">
                <i class="fas fa-fw fa-chart-bar text-white"></i>
                <span class="text-white">Pharmacy Report Dashboard</span>
            </a>
        </li> -->

        <!-- Nav Item - Laboratory (Available to lab technicians, doctors, and admins only) -->
        
        <li class="nav-item ">
            <a class="nav-link collapsed" href="#" data-bs-toggle="collapse" data-bs-target="#collapseLaboratory" aria-expanded="false" aria-controls="collapseLaboratory">
                <i class="fas fa-fw fa-flask text-white"></i>
                <span class="text-white">Laboratory</span>
            </a>
            <div id="collapseLaboratory" class="collapse " aria-labelledby="headingLaboratory" data-parent="#accordionSidebar">
                <div class="bg-white py-2 collapse-inner rounded">
                    <h6 class="collapse-header">Lab Management:</h6>

                    <!-- Dashboard for lab staff -->
                    <a class="collapse-item " href="/laboratory/">
                        <i class="fas fa-tachometer-alt"></i> Dashboard
                    </a>

                    <!-- Test catalog visible to all lab users -->
                    <a class="collapse-item " href="/laboratory/tests/">Tests</a>

                    <!-- Test requests for all lab users -->
                    <a class="collapse-item " href="/laboratory/requests/">Test Requests</a>

                    <!-- Results visible to all lab users -->
                    <a class="collapse-item " href="/laboratory/results/">Results</a>

                    <!-- Lab technician specific options -->
                    
                    <div class="collapse-divider"></div>
                    <h6 class="collapse-header">Lab Technician:</h6>
                    <a class="collapse-item " href="/laboratory/requests/">Enter Results</a>
                    
                </div>
            </div>
        </li>
        

        <!-- Nav Item - Radiology (Radiology Staff full access, Doctors request, Admin full) -->
        
        <li class="nav-item ">
            <a class="nav-link" href="/radiology/">
                <i class="fas fa-fw fa-x-ray text-white"></i>
                <span class="text-white">Radiology</span>
            </a>
        </li>
        

        <!-- Dental Module (Available to doctors, nurses, and admins) -->
        
        <li class="nav-item ">
            <a class="nav-link" href="/dental/">
                <i class="fas fa-fw fa-tooth text-white"></i>
                <span class="text-white">Dental</span>
            </a>
        </li>
        

        <!-- Ophthalmic Module (Available to doctors, nurses, and admins) -->
        
        <li class="nav-item ">
            <a class="nav-link" href="/ophthalmic/">
                <i class="fas fa-fw fa-eye text-white"></i>
                <span class="text-white">Ophthalmic</span>
            </a>
        </li>
        

        <!-- ENT Module (Available to doctors, nurses, and admins) -->
        
        <li class="nav-item ">
            <a class="nav-link" href="/ent/">
                <i class="fas fa-fw fa-ear-listen text-white"></i>
                <span class="text-white">ENT</span>
            </a>
        </li>
        

        <!-- Oncology Module (Available to doctors, nurses, and admins) -->
        
        <li class="nav-item ">
            <a class="nav-link" href="/oncology/">
                <i class="fas fa-fw fa-ribbon text-white"></i>
                <span class="text-white">Oncology</span>
            </a>
        </li>
        

        <!-- SCBU Module (Available to doctors, nurses, and admins) -->
        
        <li class="nav-item ">
            <a class="nav-link" href="/scbu/">
                <i class="fas fa-fw fa-baby text-white"></i>
                <span class="text-white">SCBU</span>
            </a>
        </li>
        

        <!-- ANC Module (Available to doctors, nurses, and admins) -->
        
        <li class="nav-item ">
            <a class="nav-link" href="/anc/">
                <i class="fas fa-fw fa-person-pregnant text-white"></i>
                <span class="text-white">ANC</span>
            </a>
        </li>
        

        <!-- Labor Module (Available to doctors, nurses, and admins) -->
        
        <li class="nav-item ">
            <a class="nav-link" href="/labor/">
                <i class="fas fa-fw fa-baby-carriage text-white"></i>
                <span class="text-white">Labor</span>
            </a>
        </li>
        

        <!-- ICU Module (Available to doctors, nurses, and admins) -->
        
        <li class="nav-item ">
            <a class="nav-link" href="/icu/">
                <i class="fas fa-fw fa-heartbeat text-white"></i>
                <span class="text-white">ICU</span>
            </a>
        </li>
        

        <!-- Family Planning Module (Available to doctors, nurses, and admins) -->
        
        <li class="nav-item ">
            <a class="nav-link" href="/family-planning/">
                <i class="fas fa-fw fa-users text-white"></i>
                <span class="text-white">Family Planning</span>
            </a>
        </li>
        

        <!-- Gynae Emergency Module (Available to doctors, nurses, and admins) -->
        
        <li class="nav-item ">
            <a class="nav-link" href="/gynae-emergency/">
                <i class="fas fa-fw fa-ambulance text-white"></i>
                <span class="text-white">Gynae Emergency</span>
            </a>
        </li>
        

        <!-- Include Theatre Module Sidebar -->
        
        <li class="nav-item ">
            <a class="nav-link collapsed" href="#" data-bs-toggle="collapse" data-bs-target="#collapseTheatre" aria-expanded="false" aria-controls="collapseTheatre">
                <i class="fas fa-fw fa-hospital-symbol text-white"></i>
                <span class="text-white">Theatre</span>
            </a>
            <div id="collapseTheatre" class="collapse " aria-labelledby="headingTheatre" data-parent="#accordionSidebar">
                <div class="bg-white py-2 collapse-inner rounded">
                    <h6 class="collapse-header">Theatre Management:</h6>
                    <a class="collapse-item " href="/theatre/">Dashboard</a>
                    <a class="collapse-item " href="/theatre/surgeries/">Surgeries</a>
                    <a class="collapse-item " href="/theatre/theatres/">Operation Theatres</a>
                    <a class="collapse-item " href="/theatre/surgery-types/">Surgery Types</a>
                    <a class="collapse-item " href="/theatre/teams/">Surgical Teams</a>
                    <a class="collapse-item " href="/theatre/equipment/">Equipment</a>
                    <a class="collapse-item " href="/theatre/equipment/maintenance/">Equipment Maintenance</a>
                    <div class="collapse-divider"></div>
                    <h6 class="collapse-header">Medical Supplies:</h6>
                    <a class="collapse-item " href="/pharmacy/packs/?pack_type=surgery">Surgery Packs</a>
                    <a class="collapse-item " href="/pharmacy/pack-orders/create/">Order Surgery Pack</a>
                    <div class="collapse-divider"></div>
                    <h6 class="collapse-header">Reports:</h6>
                    <a class="collapse-item " href="/theatre/reports/surgery-report/">Surgery Report</a>
                </div>
            </div>
        </li>
        

        <!-- Divider -->
        <hr class="sidebar-divider">

        <!-- Heading -->
        <div class="sidebar-heading">
            Administration
        </div>

        <!-- Nav Item - Desk Office (Available to admins and receptionists for NHIA) -->
        
        <li class="nav-item active">
            <a class="nav-link " href="#" data-bs-toggle="collapse" data-bs-target="#collapseDeskOffice" aria-expanded="true" aria-controls="collapseDeskOffice">
                <i class="fas fa-fw fa-desktop text-white"></i>
                <span class="text-white">Desk Office</span>
            </a>
            <div id="collapseDeskOffice" class="collapse show" aria-labelledby="headingDeskOffice" data-parent="#accordionSidebar">
                <div class="bg-white py-2 collapse-inner rounded">
                    <h6 class="collapse-header">NHIA Authorization:</h6>
                    <a class="collapse-item " href="/core/authorization/dashboard/">
                        <i class="fas fa-globe me-1"></i> Universal Dashboard <span class="badge badge-success"></span>
                    </a>
                    <a class="collapse-item " href="/desk-office/authorization-dashboard/">
                        <i class="fas fa-tachometer-alt me-1"></i> Dashboard
                    </a>
                    <a class="collapse-item " href="/desk-office/pending-consultations/">
                        <i class="fas fa-stethoscope me-1"></i> Pending Consultations
                    </a>
                    <a class="collapse-item " href="/desk-office/pending-referrals/">
                        <i class="fas fa-exchange-alt me-1"></i> Pending Referrals
                    </a>
                    <a class="collapse-item " href="/desk-office/authorization-codes/">
                        <i class="fas fa-key me-1"></i> Authorization Codes
                    </a>

                    
                    <div class="collapse-divider"></div>
                    <h6 class="collapse-header">Bulk Operations:</h6>
                    <a class="collapse-item " href="/desk-office/bulk-authorize-consultations/">
                        <i class="fas fa-check-double me-1"></i> Bulk Authorize Consultations
                    </a>
                    <a class="collapse-item " href="/desk-office/bulk-authorize-referrals/">
                        <i class="fas fa-check-double me-1"></i> Bulk Authorize Referrals
                    </a>
                    

                    <div class="collapse-divider"></div>
                    
                </div>
            </div>
        </li>
        

        <!-- Nav Item - Notifications -->
        

        <!-- Nav Item - Billing (Available to accountants, receptionists, and admins) -->
        
        <li class="nav-item ">
            <a class="nav-link collapsed" href="#" data-bs-toggle="collapse" data-bs-target="#collapseBilling" aria-expanded="false" aria-controls="collapseBilling">
                <i class="fas fa-fw fa-file-invoice-dollar text-white"></i>
                <span class="text-white">Billing</span>
            </a>
            <div id="collapseBilling" class="collapse " aria-labelledby="headingBilling" data-parent="#accordionSidebar">
                <div class="bg-white py-2 collapse-inner rounded">
                    <h6 class="collapse-header">Billing Management:</h6>
                    <a class="collapse-item " href="/billing/">Invoices</a>
                    
                    <a class="collapse-item " href="/billing/create/">Create Invoice</a>
                    
                    
                    <a class="collapse-item " href="/billing/services/">Services</a>
                    <a class="collapse-item " href="/billing/admission-invoices/">Admission Invoices</a>
                    
                </div>
            </div>
        </li>
        

        <!-- Nav Item - Wallet Management -->
        
        <li class="nav-item ">
            <a class="nav-link collapsed" href="#" data-bs-toggle="collapse" data-bs-target="#collapseWallet" aria-expanded="false" aria-controls="collapseWallet">
                <i class="fas fa-fw fa-wallet text-white"></i>
                <span class="text-white">Wallet Management</span>
            </a>
            <div id="collapseWallet" class="collapse " aria-labelledby="headingWallet" data-parent="#accordionSidebar">
                <div class="bg-white py-2 collapse-inner rounded">
                    <h6 class="collapse-header">Wallet Operations:</h6>
                    <a class="collapse-item " href="/patients/wallet/">All Wallets</a>
                    <a class="collapse-item " href="/patients/wallet/net-impact/">Net Impact Report</a>
                    <!-- Commented out Admission Net Impact link as it needs a pk parameter -->
                    <!-- <a class="collapse-item " href="/inpatient/admissions/1/net-impact/">Admission Net Impact</a> -->
                </div>
            </div>
        </li>
        

        <!-- Nav Item - Core Features & Administration (Available to admins and authorized users) -->
        
        <li class="nav-item ">
            <a class="nav-link collapsed" href="#" data-bs-toggle="collapse" data-bs-target="#collapseCoreFeatures" aria-expanded="false" aria-controls="collapseCoreFeatures">
                <i class="fas fa-fw fa-cogs text-white"></i>
                <span class="text-white">Core Features</span>
            </a>
            <div id="collapseCoreFeatures" class="collapse " aria-labelledby="headingCoreFeatures" data-parent="#accordionSidebar">
                <div class="bg-white py-2 collapse-inner rounded">
                    <h6 class="collapse-header">Revenue & Analytics:</h6>
                    <a class="collapse-item " href="/core/revenue/dashboard/">Revenue Dashboard</a>
                    <a class="collapse-item " href="/core/revenue/trends/">Revenue Trends</a>

                    <div class="collapse-divider"></div>
                    <h6 class="collapse-header">Transaction Management:</h6>
                    <a class="collapse-item " href="/core/transactions/">Transaction History</a>

                    <div class="collapse-divider"></div>
                    <h6 class="collapse-header">Authorization System:</h6>
                    <a class="collapse-item " href="/core/authorization/dashboard/">Universal Authorization</a>

                    <div class="collapse-divider"></div>
                    <h6 class="collapse-header">Admin Tools:</h6>
                    <a class="collapse-item " href="/core/admin/">Admin Dashboard</a>
                    <a class="collapse-item " href="/core/admin/activity-log/">Activity Log</a>
                    <a class="collapse-item " href="/core/admin/security/">Security Overview</a>
                </div>
            </div>
        </li>
        

        <!-- Nav Item - User & Privilege Management (Available to admins only) -->
        
        <li class="nav-item ">
            <a class="nav-link collapsed" href="#" data-bs-toggle="collapse" data-bs-target="#collapseUserManagement" aria-expanded="false" aria-controls="collapseUserManagement">
                <i class="fas fa-fw fa-users-cog text-white"></i>
                <span class="text-white">User Management</span>
            </a>
            <div id="collapseUserManagement" class="collapse " aria-labelledby="headingUserManagement" data-parent="#accordionSidebar">
                <div class="bg-white py-2 collapse-inner rounded">
                    <h6 class="collapse-header">User Administration:</h6>
                    <a class="collapse-item " href="/accounts/user-dashboard/">All Users</a>
                    <a class="collapse-item " href="/accounts/staff/create/">Add New User</a>

                    <div class="collapse-divider"></div>
                    <h6 class="collapse-header">Privilege Management:</h6>
                    <a class="collapse-item " href="/accounts/role-demo/">Role System Demo</a>
                    <a class="collapse-item " href="/accounts/activity-dashboard/">Activity Monitor</a>
                    <a class="collapse-item " href="/accounts/alerts/">Activity Alerts</a>
                    <a class="collapse-item " href="/accounts/sessions/">User Sessions</a>
                    <a class="collapse-item " href="/accounts/live-monitor/">Live Monitor</a>
                    <a class="collapse-item " href="/accounts/activity-statistics/">Activity Statistics</a>
                    <a class="collapse-item " href="/accounts/roles/">Manage Roles</a>
                    <a class="collapse-item " href="/accounts/roles/create/">Create Role</a>
                    <a class="collapse-item " href="/accounts/permissions/">Permissions</a>

                    <div class="collapse-divider"></div>
                    <h6 class="collapse-header">Monitoring:</h6>
                    <a class="collapse-item " href="/accounts/alerts/">Activity Alerts</a>
                </div>
            </div>
        </li>
        

        <!-- Nav Item - Superuser User Management (Available to superusers only) -->
        
        <li class="nav-item ">
            <a class="nav-link collapsed" href="#" data-bs-toggle="collapse" data-bs-target="#collapseSuperuserManagement" aria-expanded="false" aria-controls="collapseSuperuserManagement">
                <i class="fas fa-fw fa-user-shield text-white"></i>
                <span class="text-white">Superuser Admin</span>
            </a>
            <div id="collapseSuperuserManagement" class="collapse " aria-labelledby="headingSuperuserManagement" data-parent="#accordionSidebar">
                <div class="bg-white py-2 collapse-inner rounded">
                    <h6 class="collapse-header">User Profile Management:</h6>
                    <a class="collapse-item " href="/accounts/superuser/user-profiles/">Edit User Profiles</a>
                    <a class="collapse-item " href="/accounts/superuser/password-reset/">Reset User Passwords</a>
                    <a class="collapse-item " href="/accounts/superuser/bulk-operations/">Bulk User Operations</a>
                    <a class="collapse-item " href="/accounts/superuser/user-permissions/">Manage Permissions</a>

                    <div class="collapse-divider"></div>
                    <h6 class="collapse-header">System Administration:</h6>
                    <a class="collapse-item " href="/accounts/superuser/system-config/">System Configuration</a>
                    <a class="collapse-item " href="/accounts/superuser/database-management/">Database Management</a>
                    <a class="collapse-item " href="/accounts/superuser/security-audit/">Security Audit</a>
                    <a class="collapse-item " href="/accounts/superuser/backup-restore/">Backup & Restore</a>

                    <div class="collapse-divider"></div>
                    <h6 class="collapse-header">Advanced Tools:</h6>
                    <a class="collapse-item " href="/accounts/superuser/system-diagnostics/">System Diagnostics</a>
                    <a class="collapse-item " href="/accounts/superuser/mass-email/">Mass Email Users</a>
                    <a class="collapse-item " href="/accounts/superuser/api-management/">API Management</a>
                    <a class="collapse-item " href="/accounts/superuser/logs-viewer/">System Logs Viewer</a>
                </div>
            </div>
        </li>
        

        <!-- Nav Item - HR (Available to admins only) -->
        
        <li class="nav-item ">
            <a class="nav-link" href="/hr/staff/">
                <i class="fas fa-fw fa-users text-white"></i>
                <span class="text-white">HR</span>
            </a>
        </li>
        

        <!-- Nav Item - Financial Reports (Available to admins and accountants) -->
        
        <li class="nav-item ">
            <a class="nav-link collapsed" href="#" data-bs-toggle="collapse" data-bs-target="#collapseFinancialReports" aria-expanded="false" aria-controls="collapseFinancialReports">
                <i class="fas fa-fw fa-chart-bar text-white"></i>
                <span class="text-white">Financial Reports</span>
            </a>
            <div id="collapseFinancialReports" class="collapse " aria-labelledby="headingFinancialReports" data-parent="#accordionSidebar">
                <div class="bg-white py-2 collapse-inner rounded">
                    <h6 class="collapse-header">Revenue Reports:</h6>
                    
                    
                    
                    <a class="collapse-item " href="/pharmacy/revenue/statistics/">Pharmacy Revenue Statistics</a>
                    
                    <a class="collapse-item " href="/core/revenue/dashboard/">Revenue Dashboard</a>
                    <a class="collapse-item " href="/core/revenue/trends/">Revenue Trends</a>

                    <div class="collapse-divider"></div>
                    <h6 class="collapse-header">Department Reports:</h6>
                    <a class="collapse-item " href="/radiology/sales-report/">Radiology Report Dashboard</a>
                    <a class="collapse-item " href="/pharmacy/revenue/analysis/">Pharmacy Revenue Analysis</a>
                </div>
            </div>
        </li>
        

        <!-- Nav Item - Radiology Report Dashboard (Available to radiology staff, admins, and accountants) -->
        
        <li class="nav-item ">
            <a class="nav-link" href="/radiology/sales-report/">
                <i class="fas fa-fw fa-chart-bar text-white"></i>
                <span class="text-white">Radiology Report Dashboard</span>
            </a>
        </li>
        

        <!-- Nav Item - Reports (Available to admins only) - Temporarily disabled -->
        <!-- 
        <li class="nav-item ">
            <a class="nav-link" href="/reporting/dashboard/">
                <i class="fas fa-fw fa-chart-bar text-white"></i>
                <span class="text-white">Reports</span>
            </a>
        </li>
         -->

        <!-- Nav Item - Departments (Available to application admins only) -->
        
        <li class="nav-item ">
            <a class="nav-link" href="/accounts/departments/">
                <i class="fas fa-building text-white"></i>
                <span class="text-white">Departments</span>
            </a>
        </li>
        

        <!-- Divider -->
        <hr class="sidebar-divider d-none d-md-block">

        <!-- Sidebar Toggler (Sidebar) -->
        <div class="text-center d-none d-md-inline">
            <button class="rounded-circle border-0 btn btn-dark" id="sidebarToggle" style="width: 40px; height: 40px;">
                <i class="fas fa-angle-left"></i>
            </button>
        </div>

    </ul>
</div>
<!-- End of Sidebar -->

<style>
/* Desktop sidebar collapsed state */
.sidebar.sidebar-collapsed,
#sidebar-container.sidebar-collapsed {
    width: 70px !important;
    min-width: 70px !important;
    max-width: 70px !important;
    transition: width 0.3s ease;
}

/* Hide text and headings when sidebar is collapsed */
.sidebar.sidebar-collapsed .sidebar-brand-text,
.sidebar.sidebar-collapsed .nav-link .text-white,
.sidebar.sidebar-collapsed .sidebar-heading,
.sidebar.sidebar-collapsed .collapse-inner,
.sidebar.sidebar-collapsed .collapse-header,
#sidebar-container.sidebar-collapsed .sidebar-brand-text,
#sidebar-container.sidebar-collapsed .nav-link .text-white,
#sidebar-container.sidebar-collapsed .sidebar-heading,
#sidebar-container.sidebar-collapsed .collapse-inner,
#sidebar-container.sidebar-collapsed .collapse-header {
    display: none !important;
}

/* Show only icons when collapsed */
.sidebar.sidebar-collapsed .nav-link,
#sidebar-container.sidebar-collapsed .nav-link {
    justify-content: center !important;
    padding: 1rem 0.5rem !important;
    text-align: center !important;
}

/* Center icons when sidebar is collapsed */
.sidebar.sidebar-collapsed .nav-link,
.sidebar.toggled .nav-link,
#sidebar-container.sidebar-collapsed .nav-link,
#sidebar-container.toggled .nav-link {
    justify-content: center !important;
    text-align: center !important;
}

/* Show text when sidebar is expanded (not collapsed) */
.sidebar:not(.sidebar-collapsed):not(.toggled) .nav-link .text-white,
#sidebar-container:not(.sidebar-collapsed):not(.toggled) .nav-link .text-white {
    display: inline;
    opacity: 1;
}

/* Adjust content wrapper when sidebar is collapsed */
body.sidebar-toggled #content-wrapper {
    margin-left: 70px;
}

/* Desktop sidebar hover effect when collapsed */
.sidebar.sidebar-collapsed:hover,
#sidebar-container.sidebar-collapsed:hover {
    width: 300px !important;
    min-width: 300px !important;
    max-width: 300px !important;
}

.sidebar.sidebar-collapsed:hover .sidebar-brand-text,
.sidebar.sidebar-collapsed:hover .nav-link .text-white,
.sidebar.sidebar-collapsed:hover .sidebar-heading,
.sidebar.sidebar-collapsed:hover .collapse-inner,
.sidebar.sidebar-collapsed:hover .collapse-header,
#sidebar-container.sidebar-collapsed:hover .sidebar-brand-text,
#sidebar-container.sidebar-collapsed:hover .nav-link .text-white,
#sidebar-container.sidebar-collapsed:hover .sidebar-heading,
#sidebar-container.sidebar-collapsed:hover .collapse-inner,
#sidebar-container.sidebar-collapsed:hover .collapse-header {
    display: block !important;
    opacity: 1;
}

.sidebar.sidebar-collapsed:hover .nav-link,
#sidebar-container.sidebar-collapsed:hover .nav-link {
    justify-content: flex-start !important;
    padding: 12px 24px !important;
    text-align: left !important;
}

/* Prevent dropdown menu from expanding when collapsed */
.sidebar.sidebar-collapsed .nav-link[data-bs-toggle="collapse"],
#sidebar-container.sidebar-collapsed .nav-link[data-bs-toggle="collapse"] {
    pointer-events: none;
}

/* Allow dropdown menu expansion on hover */
.sidebar.sidebar-collapsed:hover .nav-link[data-bs-toggle="collapse"],
#sidebar-container.sidebar-collapsed:hover .nav-link[data-bs-toggle="collapse"] {
    pointer-events: auto;
}

/* Tablet sidebar styles (768px - 991px) */
@media (min-width: 768px) and (max-width: 991.98px) {
    .sidebar, #sidebar-container {
        width: 80px !important;
        min-width: 80px !important;
        max-width: 80px !important;
        transition: width 0.3s ease;
    }

    /* Hide text and headings on tablet by default */
    .sidebar .sidebar-brand-text,
    .sidebar .nav-link span,
    .sidebar .sidebar-heading,
    .sidebar .collapse-inner,
    .sidebar .collapse-header,
    #sidebar-container .sidebar-brand-text,
    #sidebar-container .nav-link span,
    #sidebar-container .sidebar-heading,
    #sidebar-container .collapse-inner,
    #sidebar-container .collapse-header {
        display: none !important;
    }

    /* Center icons on tablet */
    .sidebar .nav-link,
    #sidebar-container .nav-link {
        justify-content: center !important;
        padding: 1rem 0.5rem !important;
        text-align: center !important;
    }

    /* Tablet sidebar hover effect */
    .sidebar:hover, #sidebar-container:hover {
        width: 280px !important;
        min-width: 280px !important;
        max-width: 280px !important;
    }

    .sidebar:hover .sidebar-brand-text,
    .sidebar:hover .nav-link span,
    .sidebar:hover .sidebar-heading,
    .sidebar:hover .collapse-inner,
    .sidebar:hover .collapse-header,
    #sidebar-container:hover .sidebar-brand-text,
    #sidebar-container:hover .nav-link span,
    #sidebar-container:hover .sidebar-heading,
    #sidebar-container:hover .collapse-inner,
    #sidebar-container:hover .collapse-header {
        display: block !important;
        opacity: 1;
    }

    .sidebar:hover .nav-link,
    #sidebar-container:hover .nav-link {
        justify-content: flex-start !important;
        padding: 12px 24px !important;
        text-align: left !important;
    }

    /* Prevent dropdown menu from expanding when collapsed on tablet */
    .sidebar .nav-link[data-bs-toggle="collapse"],
    #sidebar-container .nav-link[data-bs-toggle="collapse"] {
        pointer-events: none;
    }

    /* Allow dropdown menu expansion on hover */
    .sidebar:hover .nav-link[data-bs-toggle="collapse"],
    #sidebar-container:hover .nav-link[data-bs-toggle="collapse"] {
        pointer-events: auto;
    }

    /* Hide desktop brand on tablet */
    .sidebar-brand.d-none.d-md-flex {
        display: none !important;
    }

    /* Show simplified brand icon on tablet */
    .sidebar .sidebar-brand-icon,
    #sidebar-container .sidebar-brand-icon {
        display: flex !important;
        justify-content: center;
        margin: 1rem 0;
    }
}

/* Mobile sidebar styles (< 768px) */
@media (max-width: 767.98px) {
    .sidebar, #sidebar-container {
        position: fixed;
        top: 0;
        left: -300px;
        z-index: 1050 !important;
        transition: left 0.3s ease;
        height: 100vh;
        box-shadow: 2px 0 10px rgba(0,0,0,0.3);
        width: 300px !important;
        min-width: 300px !important;
        max-width: 300px !important;
    }

    .sidebar.sidebar-open, #sidebar-container.sidebar-open {
        left: 0 !important;
    }

    .sidebar-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        z-index: 1040;
        display: none;
        opacity: 0;
        transition: opacity 0.3s ease;
    }

    .sidebar-overlay.active {
        display: block;
        opacity: 1;
    }

    .mobile-sidebar-header {
        position: sticky;
        top: 0;
        z-index: 1060;
    }

    body.sidebar-open {
        overflow: hidden;
    }

    /* Ensure mobile sidebar doesn't interfere with content */
    .sidebar.sidebar-open ~ #content-wrapper,
    #sidebar-container.sidebar-open ~ #content-wrapper {
        margin-left: 0 !important;
    }

    /* Disable desktop collapse styles on mobile */
    .sidebar.sidebar-collapsed,
    #sidebar-container.sidebar-collapsed {
        width: 300px !important;
        min-width: 300px !important;
        max-width: 300px !important;
        left: -300px;
    }

    .sidebar.sidebar-collapsed.sidebar-open,
    #sidebar-container.sidebar-collapsed.sidebar-open {
        left: 0 !important;
    }

    /* Show all elements normally on mobile */
    .sidebar.sidebar-collapsed .sidebar-brand-text,
    .sidebar.sidebar-collapsed .nav-link .text-white,
    .sidebar.sidebar-collapsed .sidebar-heading,
    .sidebar.sidebar-collapsed .collapse-inner,
    .sidebar.sidebar-collapsed .collapse-header,
    #sidebar-container.sidebar-collapsed .sidebar-brand-text,
    #sidebar-container.sidebar-collapsed .nav-link .text-white,
    #sidebar-container.sidebar-collapsed .sidebar-heading,
    #sidebar-container.sidebar-collapsed .collapse-inner,
    #sidebar-container.sidebar-collapsed .collapse-header {
        display: block !important;
        opacity: 1;
    }

    .sidebar.sidebar-collapsed .nav-link,
    #sidebar-container.sidebar-collapsed .nav-link {
        justify-content: flex-start !important;
        padding: 12px 24px !important;
        text-align: left !important;
    }

    /* Hide desktop toggle button on mobile */
    #sidebarToggle {
        display: none !important;
    }

    /* Ensure hamburger menu is visible */
    #sidebarToggleTop {
        display: block !important;
        visibility: visible !important;
    }
}

/* Make collapse menus have dark background in all states */
.sidebar .collapse-inner {
    background: #23272b !important;
}
.sidebar .collapse-inner .collapse-item {
    color: #fff !important;
}
.sidebar .collapse-inner .collapse-item.active,
.sidebar .collapse-inner .collapse-item:focus,
.sidebar .collapse-inner .collapse-item:hover {
    background: #0d6efd !important;
    color: #fff !important;
}
.sidebar .collapse-header {
    color: #adb5bd !important;
    background: #23272b !important;
}

/* Desktop responsive styles (992px - 1199px) */
@media (min-width: 992px) and (max-width: 1199.98px) {
    .sidebar, #sidebar-container {
        width: 260px !important;
        min-width: 260px !important;
        max-width: 260px !important;
    }

    .sidebar .nav-link,
    #sidebar-container .nav-link {
        font-size: 0.9rem;
        padding: 10px 20px;
    }

    .sidebar .sidebar-brand-text,
    #sidebar-container .sidebar-brand-text {
        font-size: 1.1rem;
    }
}

/* Large Desktop responsive styles (>= 1200px) */
@media (min-width: 1200px) {
    .sidebar, #sidebar-container {
        width: 300px !important;
        min-width: 300px !important;
        max-width: 300px !important;
    }

    .sidebar .nav-link,
    #sidebar-container .nav-link {
        font-size: 1rem;
        padding: 12px 24px;
    }

    .sidebar .sidebar-brand-text,
    #sidebar-container .sidebar-brand-text {
        font-size: 1.25rem;
    }
}

/* Smooth scrolling for sidebar content */
.sidebar, #sidebar-container {
    overflow-y: auto;
    overflow-x: hidden;
    scroll-behavior: smooth;
}

/* Custom scrollbar for sidebar */
.sidebar::-webkit-scrollbar,
#sidebar-container::-webkit-scrollbar {
    width: 6px;
}

.sidebar::-webkit-scrollbar-track,
#sidebar-container::-webkit-scrollbar-track {
    background: #1a1d20;
}

.sidebar::-webkit-scrollbar-thumb,
#sidebar-container::-webkit-scrollbar-thumb {
    background: #4a5568;
    border-radius: 3px;
}

.sidebar::-webkit-scrollbar-thumb:hover,
#sidebar-container::-webkit-scrollbar-thumb:hover {
    background: #5a6778;
}

/* Ensure sidebar doesn't affect content layout on different screen sizes */
@media (min-width: 768px) {
    body {
        transition: margin-left 0.3s ease;
    }
}

/* Touch-friendly tap targets for mobile */
@media (max-width: 767.98px) {
    .sidebar .nav-link,
    #sidebar-container .nav-link {
        min-height: 44px;
        display: flex;
        align-items: center;
    }
}

/* Accessibility: Focus styles */
.sidebar .nav-link:focus,
#sidebar-container .nav-link:focus,
.sidebar .collapse-item:focus,
#sidebar-container .collapse-item:focus {
    outline: 2px solid #0d6efd;
    outline-offset: 2px;
}

/* Prevent layout shifts during transitions */
.sidebar, #sidebar-container {
    will-change: width, left;
}

/* Handle orientation changes */
@media (orientation: landscape) and (max-width: 991.98px) {
    .sidebar, #sidebar-container {
        max-height: 100vh;
    }
}

@media (orientation: portrait) and (max-width: 767.98px) {
    .sidebar, #sidebar-container {
        width: 80vw !important;
        min-width: 80vw !important;
        max-width: 80vw !important;
        left: -80vw;
    }

    .sidebar.sidebar-open, #sidebar-container.sidebar-open {
        left: 0 !important;
    }

    .sidebar.sidebar-collapsed.sidebar-open,
    #sidebar-container.sidebar-collapsed.sidebar-open {
        left: 0 !important;
    }
}
</style>

<script>
// Enhanced responsive sidebar behavior
document.addEventListener('DOMContentLoaded', function() {
    const sidebar = document.getElementById('sidebar-container') || document.querySelector('.sidebar');
    const sidebarToggleTop = document.getElementById('sidebarToggleTop');
    const sidebarToggle = document.getElementById('sidebarToggle');
    const sidebarOverlay = document.getElementById('sidebar-overlay') || document.querySelector('.sidebar-overlay');
    const mobileSidebarClose = document.getElementById('mobileSidebarClose');

    // Function to check screen size
    function isMobile() {
        return window.innerWidth < 768;
    }

    function isTablet() {
        return window.innerWidth >= 768 && window.innerWidth < 992;
    }

    function isDesktop() {
        return window.innerWidth >= 992;
    }

    // Mobile sidebar toggle
    if (sidebarToggleTop && sidebar) {
        sidebarToggleTop.addEventListener('click', function(e) {
            e.preventDefault();
            if (isMobile() || isTablet()) {
                sidebar.classList.toggle('sidebar-open');
                if (sidebarOverlay) {
                    sidebarOverlay.classList.toggle('active');
                }
                document.body.classList.toggle('sidebar-open');
            }
        });
    }

    // Desktop sidebar toggle
    if (sidebarToggle && sidebar) {
        sidebarToggle.addEventListener('click', function(e) {
            e.preventDefault();
            if (isDesktop()) {
                sidebar.classList.toggle('sidebar-collapsed');
                // Update toggle icon
                const icon = this.querySelector('i');
                if (icon) {
                    icon.classList.toggle('fa-angle-left');
                    icon.classList.toggle('fa-angle-right');
                }
            }
        });
    }

    // Close mobile sidebar
    if (mobileSidebarClose && sidebar) {
        mobileSidebarClose.addEventListener('click', function(e) {
            e.preventDefault();
            sidebar.classList.remove('sidebar-open');
            if (sidebarOverlay) {
                sidebarOverlay.classList.remove('active');
            }
            document.body.classList.remove('sidebar-open');
        });
    }

    // Close sidebar when clicking overlay
    if (sidebarOverlay && sidebar) {
        sidebarOverlay.addEventListener('click', function() {
            sidebar.classList.remove('sidebar-open');
            this.classList.remove('active');
            document.body.classList.remove('sidebar-open');
        });
    }

    // Handle window resize
    let resizeTimer;
    window.addEventListener('resize', function() {
        clearTimeout(resizeTimer);
        resizeTimer = setTimeout(function() {
            // Close mobile sidebar on resize to desktop
            if (isDesktop() && sidebar) {
                sidebar.classList.remove('sidebar-open');
                if (sidebarOverlay) {
                    sidebarOverlay.classList.remove('active');
                }
                document.body.classList.remove('sidebar-open');
            }

            // Remove collapsed state on mobile
            if (isMobile() && sidebar) {
                sidebar.classList.remove('sidebar-collapsed');
            }
        }, 250);
    });

    // Improve touch interactions on mobile
    if (isMobile() && sidebar) {
        let touchStartX = 0;
        let touchEndX = 0;

        sidebar.addEventListener('touchstart', function(e) {
            touchStartX = e.changedTouches[0].screenX;
        }, { passive: true });

        sidebar.addEventListener('touchend', function(e) {
            touchEndX = e.changedTouches[0].screenX;
            handleSwipe();
        }, { passive: true });

        function handleSwipe() {
            // Swipe left to close
            if (touchStartX - touchEndX > 50 && sidebar.classList.contains('sidebar-open')) {
                sidebar.classList.remove('sidebar-open');
                if (sidebarOverlay) {
                    sidebarOverlay.classList.remove('active');
                }
                document.body.classList.remove('sidebar-open');
            }
        }
    }
});
</script>

        
        <!-- Content Wrapper -->
        <div id="content-wrapper" class="d-flex flex-column">
            <!-- Main Content -->
            <div id="content">
                <!-- Topbar -->
                <nav class="navbar navbar-expand navbar-light bg-white topbar mb-4 static-top shadow">
                    
                    <!-- Mobile Hamburger Menu Button -->
                    <button class="btn btn-link d-md-none rounded-circle mr-3" id="sidebarToggleTop">
                        <i class="fa fa-bars"></i>
                    </button>
                    
                    <a class="navbar-brand" href="/dashboard/">HMS</a>
                    <!-- Topbar Navbar -->
                    <ul class="navbar-nav ms-auto align-items-center">
                        
                            <!-- Session Status Indicator -->
                            <li class="nav-item me-3">
                                <div class="nav-link session-status-container px-3 py-2" id="sessionStatus" title="Session Status">
                                    <i class="fas fa-circle text-success me-2" id="sessionIndicator"></i>
                                    <span class="badge bg-success rounded-pill px-2 py-1" id="sessionText">Active</span>
                                </div>
                            </li>

                            <!-- Current Patient Context -->
                            
                            
                            <!-- Enhanced User Dropdown -->
                            <li class="nav-item dropdown">
                                <a class="nav-link user-dropdown-toggle px-3 py-2 d-flex align-items-center justify-content-between" href="#" id="userDropdown" role="button"
                                    data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                    <div class="d-flex align-items-center">
                                        
                                            <div class="avatar-placeholder bg-primary text-white rounded-circle me-2 d-flex align-items-center justify-content-center" 
                                                style="width: 35px; height: 35px; border: 2px solid #fff;">
                                                <i class="fas fa-user"></i>
                                            </div>
                                        
                                        <div class="d-flex flex-column">
                                            <span class="font-weight-bold text-dark me-2">superuser</span>
                                            
                                        </div>
                                    </div>
                                    <i class="fas fa-chevron-down text-gray-400 ms-2"></i>
                                </a>
                                <!-- Enhanced Dropdown Menu -->
                                <div class="dropdown-menu dropdown-menu-end shadow-lg animated--grow-in"
                                    aria-labelledby="userDropdown" style="min-width: 220px;">
                                    <!-- User Info Header -->
                                    <div class="dropdown-header bg-light py-2">
                                        <div class="d-flex align-items-center">
                                            
                                                <div class="avatar-placeholder bg-primary text-white rounded-circle me-3 d-flex align-items-center justify-content-center" 
                                                    style="width: 45px; height: 45px;">
                                                    <i class="fas fa-user"></i>
                                                </div>
                                            
                                            <div class="d-flex flex-column">
                                                <strong class="text-dark">superuser</strong>
                                                
                                                
                                            </div>
                                        </div>
                                    </div>
                                    <div class="dropdown-divider"></div>
                                    <a class="dropdown-item" href="/accounts/profile/">
                                        <i class="fas fa-user fa-sm fa-fw me-2 text-primary"></i>
                                        <span>My Profile</span>
                                    </a>
                                    <a class="dropdown-item" href="/accounts/profile/edit/">
                                        <i class="fas fa-cog fa-sm fa-fw me-2 text-secondary"></i>
                                        <span>Settings</span>
                                    </a>
                                    
                                    <a class="dropdown-item" href="/core/admin/">
                                        <i class="fas fa-shield-alt fa-sm fa-fw me-2 text-warning"></i>
                                        <span>Admin Dashboard</span>
                                    </a>
                                    
                                    <div class="dropdown-divider"></div>
                                    <a class="dropdown-item text-danger" href="#" data-bs-toggle="modal" data-bs-target="#logoutModal">
                                        <i class="fas fa-sign-out-alt fa-sm fa-fw me-2"></i>
                                        <span>Logout</span>
                                    </a>
                                </div>
                            </li>
                        
                    </ul>
                </nav>
                <!-- End of Topbar -->
                <!-- Begin Page Content -->
                <div class="container-fluid">
                    
                    
<div class="container-fluid">
    <!-- Page Heading -->
    <div class="d-sm-flex align-items-center justify-content-between mb-4">
        <h1 class="h3 mb-0 text-gray-800">
            <i class="fas fa-qrcode"></i> Generate Authorization Code
        </h1>
        <div class="btn-group" role="group">
            <a href="/desk-office/authorization-codes/" class="btn btn-outline-primary btn-sm">
                <i class="fas fa-list"></i> All Codes
            </a>
            <a href="/desk-office/authorization-dashboard/" class="btn btn-outline-info btn-sm">
                <i class="fas fa-tachometer-alt"></i> Dashboard
            </a>
        </div>
    </div>

    

    <div class="row">
        <div class="col-lg-8">
            <div class="card shadow form-container">
                <div class="card-header py-3 bg-primary text-white">
                    <h6 class="m-0 font-weight-bold">
                        <i class="fas fa-plus-circle"></i> Create New Authorization Code
                    </h6>
                </div>
                <div class="card-body">
                    <form method="post" id="generateCodeForm">
                        <input type="hidden" name="csrfmiddlewaretoken" value="L5szAuQljcyeSukXwp4cM63YVTL9ECXoPd99YBHGyCnYjiDMscB8XbjlDWKCGY6K">
                        
                        <!-- Patient Search Section -->
                        <div class="mb-4">
                            <label for="patient_search" class="form-label required-field">
                                <i class="fas fa-search"></i> Search NHIA Patient
                            </label>
                            <div class="input-group">
                                <input type="text"
                                       class="form-control"
                                       id="patient_search"
                                       name="q"
                                       placeholder="Search by patient name, ID, NHIA number, or phone..."
                                       value=""
                                       hx-get="/core/api/patients/search-ajax/"
                                       hx-target="#patientResults"
                                       hx-trigger="keyup changed delay:300ms"
                                       hx-include="[name='q']"
                                       hx-vals='{"patient_type": "nhia"}'
                                       hx-headers='{"X-CSRFToken": "L5szAuQljcyeSukXwp4cM63YVTL9ECXoPd99YBHGyCnYjiDMscB8XbjlDWKCGY6K"}'
                                       disabled>
                                <button type="submit" name="search_patients" class="btn btn-outline-primary" disabled>
                                    <i class="fas fa-search search-icon"></i>
                                    <span class="spinner-border spinner-border-sm loading-indicator" role="status"></span>
                                    Search
                                </button>
                                
                                    <button type="button" class="btn btn-outline-secondary" onclick="clearPatientSelection()">
                                        <i class="fas fa-times"></i> Clear
                                    </button>
                                
                            </div>
                            <input type="hidden" name="patient_type" value="nhia">
                            
                            <!-- Search Results -->
                            <div id="patientResults" class="search-results mt-3">
                                <!-- HTMX will populate this -->
                            </div>
                        </div>

                        
                        <!-- Selected Patient Display -->
                        <div class="card patient-card mb-4">
                            <div class="card-body">
                                <h6 class="card-title text-primary mb-3">
                                    <i class="fas fa-user-check"></i> Selected Patient
                                </h6>
                                <div class="row">
                                    <div class="col-md-6">
                                        <h6>Mary Sule</h6>
                                        <p class="mb-1">
                                            <strong>Patient ID:</strong> 4406145170
                                        </p>
                                        <p class="mb-1">
                                            <strong>Age:</strong> 35 years | 
                                            <strong>Gender:</strong> Female
                                        </p>
                                        <p class="mb-1">
                                            <strong>Phone:</strong> 08012345678
                                        </p>
                                    </div>
                                    <div class="col-md-6">
                                        
                                            <p class="mb-1">
                                                <strong>NHIA Number:</strong><br>
                                                <span class="badge bg-info">NHIA-20251121-0002</span>
                                            </p>
                                            
                                        
                                        <p class="mb-1">
                                            <strong>Patient Type:</strong><br>
                                            <span class="badge bg-info">NHIA</span>
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Authorization Code Details -->
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="amount" class="form-label required-field">Authorization Amount ()</label>
                                    <input type="number" 
                                           class="form-control" 
                                           id="amount" 
                                           name="amount" 
                                           value="0.00"
                                           step="0.01" 
                                           min="0" 
                                           required>
                                    <small class="form-text text-muted">
                                        Maximum amount this authorization code can cover
                                    </small>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="expiry_days" class="form-label">Expiry Period</label>
                                    <select class="form-select" id="expiry_days" name="expiry_days" required>
                                        <option value="7" >7 days</option>
                                        <option value="14" >14 days</option>
                                        <option value="30" selected>30 days (Recommended)</option>
                                        <option value="60" >60 days</option>
                                        <option value="90" >90 days</option>
                                    </select>
                                    <small class="form-text text-muted">
                                        How long this authorization code remains valid
                                    </small>
                                </div>
                            </div>
                        </div>

                        <div class="row mb-4">
                            <div class="col-md-12">
                                <div class="mb-3">
                                    <label class="form-label required-field">Code Generation Method</label>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="code_type" id="auto_code" value="auto" 
                                               checked>
                                        <label class="form-check-label" for="auto_code">
                                            <i class="fas fa-magic"></i> Auto-generate code (Recommended)
                                        </label>
                                        <small class="form-text text-muted d-block ml-4">
                                            System will generate a unique authorization code automatically
                                        </small>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="code_type" id="manual_code" value="manual"
                                               >
                                        <label class="form-check-label" for="manual_code">
                                            <i class="fas fa-keyboard"></i> Enter manual code
                                        </label>
                                        <small class="form-text text-muted d-block ml-4">
                                            You can specify your own authorization code
                                        </small>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="row mb-4" id="manual_code_field" style="display: none;">
                            <div class="col-md-12">
                                <div class="mb-3">
                                    <label for="manual_code_input" class="form-label">Manual Authorization Code</label>
                                    <input type="text" 
                                           class="form-control" 
                                           id="manual_code_input" 
                                           name="manual_code" 
                                           value=""
                                           placeholder="Enter authorization code (e.g., AUTH-20231024-ABC123)"
                                           maxlength="20"
                                           >
                                    <small class="form-text text-muted">
                                        Code must be unique and follow the format: AUTH-YYYYMMDD-XXXXXX
                                    </small>
                                </div>
                            </div>
                        </div>

                        <!-- Code Preview -->
                        <div class="row mb-4">
                            <div class="col-md-12">
                                <div class="mb-3">
                                    <label class="form-label">Code Preview</label>
                                    <div class="code-preview" id="codePreview">
                                        
                                            AUTH--XXXXXX
                                        
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="row mb-4">
                            <div class="col-md-12">
                                <div class="mb-3">
                                    <label for="notes" class="form-label">Authorization Notes (Optional)</label>
                                    <textarea class="form-control" 
                                              id="notes" 
                                              name="notes" 
                                              rows="3" 
                                              placeholder="Add any notes about this authorization..."></textarea>
                                    <small class="form-text text-muted">
                                        These notes will be visible to medical staff when using this code
                                    </small>
                                </div>
                            </div>
                        </div>

                        <div class="row mb-4">
                            <div class="col-md-12">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="notify_patient" id="notify_patient" checked>
                                    <label class="form-check-label" for="notify_patient">
                                        <i class="fas fa-bell"></i> Send notification to patient (if contact information available)
                                    </label>
                                </div>
                            </div>
                        </div>

                        <!-- Hidden patient ID field -->
                        <input type="hidden" name="patient_id" value="1">
                        <input type="hidden" name="generate_code" value="1">

                        <!-- Form Actions -->
                        <div class="d-flex justify-content-between">
                            <div>
                                <a href="/desk-office/authorization-dashboard/" class="btn btn-secondary">
                                    <i class="fas fa-arrow-left"></i> Back to Dashboard
                                </a>
                                <a href="/desk-office/authorization-codes/" class="btn btn-outline-info">
                                    <i class="fas fa-list"></i> View All Codes
                                </a>
                            </div>
                            <div>
                                <button type="submit" class="btn btn-success btn-lg">
                                    <i class="fas fa-qrcode"></i> Generate Authorization Code
                                </button>
                            </div>
                        </div>
                        
                    </form>
                </div>
            </div>
        </div>

        <!-- Side Panel -->
        <div class="col-lg-4">
            <!-- Instructions Card -->
            <div class="card shadow mb-4">
                <div class="card-header py-3 bg-info text-white">
                    <h6 class="m-0 font-weight-bold">
                        <i class="fas fa-info-circle"></i> Instructions
                    </h6>
                </div>
                <div class="card-body">
                    <ol class="mb-0">
                        <li class="mb-2">Search for the NHIA patient using name, ID, NHIA number, or phone</li>
                        <li class="mb-2">Select the patient from the search results</li>
                        <li class="mb-2">Enter the authorization amount</li>
                        <li class="mb-2">Choose the expiry period</li>
                        <li class="mb-2">Select code generation method (auto or manual)</li>
                        <li class="mb-2">Add optional notes</li>
                        <li class="mb-0">Click "Generate Authorization Code"</li>
                    </ol>
                </div>
            </div>

            <!-- Recent Codes Card -->
            

            <!-- Help Card -->
            <div class="card shadow mb-4">
                <div class="card-header py-3 bg-warning text-dark">
                    <h6 class="m-0 font-weight-bold">
                        <i class="fas fa-question-circle"></i> Need Help?
                    </h6>
                </div>
                <div class="card-body">
                    <p class="mb-2">
                        <strong>Authorization codes</strong> are used for NHIA patients to authorize medical services.
                    </p>
                    <p class="mb-2">
                        <strong>Format:</strong> AUTH-YYYYMMDD-XXXXXX
                    </p>
                    <p class="mb-2">
                        <strong>Expiry:</strong> Codes can be set to expire after 7, 14, 30, 60, or 90 days.
                    </p>
                    <p class="mb-0">
                        <strong>Support:</strong> Contact IT support for technical issues.
                    </p>
                </div>
            </div>
        </div>
    </div>
</div>

                <!-- /.container-fluid -->
            </div>
            <!-- End of Main Content -->
            <!-- Footer -->
            <footer class="sticky-footer bg-white">
                <div class="container my-auto">
                    <div class="copyright text-center my-auto">
                        <span>&copy; 2025 Hospital Management System. All rights reserved.</span>
                    </div>
                </div>
            </footer>
            <!-- End of Footer -->
        </div>
        <!-- End of Content Wrapper -->
    </div>
    <!-- End of Page Wrapper -->

    <!-- Logout Modal-->
    <div class="modal fade" id="logoutModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel"
        aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalLabel">Ready to Leave?</h5>
                    <button class="btn-close" type="button" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">Select "Logout" below if you are ready to end your current session.</div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" type="button" data-bs-dismiss="modal">Cancel</button>
                    <form method="post" action="/accounts/logout/" style="display:inline;">
                        <input type="hidden" name="csrfmiddlewaretoken" value="L5szAuQljcyeSukXwp4cM63YVTL9ECXoPd99YBHGyCnYjiDMscB8XbjlDWKCGY6K">
                        <button type="submit" class="btn btn-primary">Logout</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Alpine.js -->
    <script defer src="https://unpkg.com/alpinejs@3.13.8/dist/cdn.min.js"></script>

    <!-- jQuery - Load FIRST before any scripts that use it -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Modal Fix Script -->
    <script>
        $(document).ready(function() {
            // Ensure modals work properly with custom CSS
            $('.modal').on('show.bs.modal', function (e) {
                $('body').addClass('modal-open');
                $('#wrapper').addClass('modal-open');

                // Ensure modal is properly positioned
                $(this).css({
                    'display': 'block',
                    'pointer-events': 'auto'
                });

                // Initialize Select2 for elements in the modal
                $(this).find('.select2').select2({
                    dropdownParent: $(this),
                    theme: 'bootstrap-5'
                });
            });

            $('.modal').on('shown.bs.modal', function (e) {
                // Ensure modal content is interactive
                $(this).find('.modal-content').css('pointer-events', 'auto');
                $(this).find('button, input, select, textarea, a').css('pointer-events', 'auto');

                // Focus on first input after modal is fully shown
                setTimeout(() => {
                    $(this).find('input, select, textarea').first().focus();
                }, 100);
            });

            $('.modal').on('hidden.bs.modal', function (e) {
                $('body').removeClass('modal-open');
                $('#wrapper').removeClass('modal-open');

                // Reset pointer events
                $(this).css('pointer-events', '');

                // Destroy Select2 instances to prevent memory leaks
                $(this).find('.select2').each(function() {
                    if ($(this).hasClass('select2-hidden-accessible')) {
                        $(this).select2('destroy');
                    }
                });
            });

            // Fix for modal backdrop click issues
            $('.modal').on('click', function(e) {
                if (e.target === this) {
                    $(this).modal('hide');
                }
            });

            // Handle clicks outside modal content to close modal
            $(document).on('click', '.modal', function(e) {
                if ($(e.target).hasClass('modal')) {
                    $(this).modal('hide');
                }
            });

            // Ensure modal content is clickable
            $('.modal-content').on('click', function(e) {
                e.stopPropagation();
            });

            // Prevent form submission on Enter key in modal inputs (except textareas)
            $('.modal').on('keypress', 'input:not([type="submit"])', function(e) {
                if (e.which === 13) {
                    e.preventDefault();
                    return false;
                }
            });

            // Additional fix for modal interaction issues
            $(document).on('click', '.modal-backdrop', function(e) {
                e.preventDefault();
                e.stopPropagation();
                $('.modal.show').modal('hide');
            });

            // Handle ESC key to close modal
            $(document).on('keydown', function(e) {
                if (e.key === 'Escape' && $('.modal.show').length > 0) {
                    $('.modal.show').modal('hide');
                }
            });

            // Ensure buttons in modals are clickable
            $(document).on('click', '.modal button', function(e) {
                e.stopPropagation();
            });
        });
    </script>

    <!-- Auto Logout for Inactive Users -->
    <script>
        $(document).ready(function() {
            // Auto logout configuration
            const INACTIVITY_TIMEOUT = 5 * 60 * 1000; // 5 minutes in milliseconds
            const WARNING_TIME = 1 * 60 * 1000; // Show warning 1 minute before logout

            let inactivityTimer;
            let warningTimer;
            let warningShown = false;

            // Events that reset the inactivity timer
            const resetEvents = ['mousedown', 'mousemove', 'keypress', 'scroll', 'touchstart', 'click'];

            // Function to update session status indicator
            function updateSessionStatus(status) {
                const indicator = $('#sessionIndicator');
                const text = $('#sessionText');

                switch(status) {
                    case 'active':
                        indicator.removeClass('text-warning text-danger').addClass('text-success');
                        text.text('Active');
                        break;
                    case 'warning':
                        indicator.removeClass('text-success text-danger').addClass('text-warning');
                        text.text('Warning');
                        break;
                    case 'expired':
                        indicator.removeClass('text-success text-warning').addClass('text-danger');
                        text.text('Expired');
                        break;
                }
            }

            // Function to show logout warning
            function showLogoutWarning() {
                if (warningShown) return;
                warningShown = true;
                updateSessionStatus('warning');

                // Create warning modal
                const warningModal = `
                    <div class="modal fade" id="logoutWarningModal" tabindex="-1" aria-hidden="true" data-backdrop="static" data-keyboard="false">
                        <div class="modal-dialog modal-dialog-centered">
                            <div class="modal-content border-warning">
                                <div class="modal-header bg-warning text-dark">
                                    <h5 class="modal-title">
                                        <i class="fas fa-exclamation-triangle me-2"></i>Session Timeout Warning
                                    </h5>
                                </div>
                                <div class="modal-body text-center">
                                    <div class="mb-3">
                                        <i class="fas fa-clock fa-3x text-warning mb-3"></i>
                                        <h6>Your session will expire in:</h6>
                                        <h3 class="text-danger" id="countdownTimer">01:00</h3>
                                    </div>
                                    <p class="text-muted">You will be automatically logged out due to inactivity. Click "Stay Logged In" to continue your session.</p>
                                </div>
                                <div class="modal-footer justify-content-center">
                                    <button type="button" class="btn btn-success" id="stayLoggedInBtn">
                                        <i class="fas fa-user-check me-1"></i>Stay Logged In
                                    </button>
                                    <button type="button" class="btn btn-secondary" id="logoutNowBtn">
                                        <i class="fas fa-sign-out-alt me-1"></i>Logout Now
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                // Add modal to page if it doesn't exist
                if (!$('#logoutWarningModal').length) {
                    $('body').append(warningModal);
                }

                // Show the modal
                $('#logoutWarningModal').modal('show');

                // Start countdown
                let timeLeft = 60; // 60 seconds
                const countdownInterval = setInterval(function() {
                    timeLeft--;
                    const minutes = Math.floor(timeLeft / 60);
                    const seconds = timeLeft % 60;
                    $('#countdownTimer').text(
                        String(minutes).padStart(2, '0') + ':' + String(seconds).padStart(2, '0')
                    );

                    if (timeLeft <= 0) {
                        clearInterval(countdownInterval);
                        performLogout();
                    }
                }, 1000);

                // Handle stay logged in button
                $('#stayLoggedInBtn').off('click').on('click', function() {
                    clearInterval(countdownInterval);
                    $('#logoutWarningModal').modal('hide');
                    warningShown = false;
                    updateSessionStatus('active');
                    resetInactivityTimer();
                });

                // Handle logout now button
                $('#logoutNowBtn').off('click').on('click', function() {
                    clearInterval(countdownInterval);
                    performLogout();
                });

                // Clean up when modal is hidden
                $('#logoutWarningModal').on('hidden.bs.modal', function() {
                    if (!warningShown) {
                        clearInterval(countdownInterval);
                    }
                });
            }

            // Function to perform logout
            function performLogout() {
                updateSessionStatus('expired');

                // Clear any existing modals
                $('#logoutWarningModal').modal('hide');

                // Show logout message
                const logoutMessage = `
                    <div class="modal fade" id="logoutModal" tabindex="-1" aria-hidden="true" data-backdrop="static" data-keyboard="false">
                        <div class="modal-dialog modal-dialog-centered">
                            <div class="modal-content border-warning">
                                <div class="modal-header bg-warning text-dark">
                                    <h5 class="modal-title">
                                        <i class="fas fa-exclamation-triangle me-2"></i>Session Expired
                                    </h5>
                                </div>
                                <div class="modal-body text-center py-4">
                                    <div class="mb-3">
                                        <i class="fas fa-clock fa-3x text-warning mb-3"></i>
                                        <h5>Session Timeout</h5>
                                        <p class="text-muted">You have been automatically logged out due to inactivity.</p>
                                        <p class="text-info">You will be redirected to the login page in <span id="redirectCountdown">3</span> seconds...</p>
                                    </div>
                                    <div class="d-grid gap-2">
                                        <button type="button" class="btn btn-primary" onclick="redirectToLogin()">
                                            <i class="fas fa-sign-in-alt me-2"></i>Go to Login Page Now
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                $('body').append(logoutMessage);
                $('#logoutModal').modal('show');

                // Start countdown for redirect
                let redirectTime = 3;
                const redirectInterval = setInterval(function() {
                    redirectTime--;
                    $('#redirectCountdown').text(redirectTime);

                    if (redirectTime <= 0) {
                        clearInterval(redirectInterval);
                        redirectToLogin();
                    }
                }, 1000);
            }

            // Function to redirect to login page
            function redirectToLogin() {
                // First, try to logout via AJAX to clear server session
                $.ajax({
                    url: '/accounts/logout/',
                    type: 'POST',
                    headers: {
                        'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val() ||
                                      $('meta[name=csrf-token]').attr('content') ||
                                      getCookie('csrftoken')
                    },
                    complete: function() {
                        // Always redirect to login page regardless of AJAX result
                        window.location.href = '/accounts/login/?auto_logout=1&reason=inactivity';
                    }
                });
            }

            // Function to get CSRF cookie
            function getCookie(name) {
                let cookieValue = null;
                if (document.cookie && document.cookie !== '') {
                    const cookies = document.cookie.split(';');
                    for (let i = 0; i < cookies.length; i++) {
                        const cookie = cookies[i].trim();
                        if (cookie.substring(0, name.length + 1) === (name + '=')) {
                            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                            break;
                        }
                    }
                }
                return cookieValue;
            }

            // Function to reset inactivity timer
            function resetInactivityTimer() {
                // Clear existing timers
                clearTimeout(inactivityTimer);
                clearTimeout(warningTimer);

                // Set warning timer (show warning 1 minute before logout)
                warningTimer = setTimeout(function() {
                    showLogoutWarning();
                }, INACTIVITY_TIMEOUT - WARNING_TIME);

                // Set logout timer
                inactivityTimer = setTimeout(function() {
                    if (!warningShown) {
                        performLogout();
                    }
                }, INACTIVITY_TIMEOUT);
            }

            // Bind events to reset timer
            resetEvents.forEach(function(event) {
                document.addEventListener(event, function() {
                    if (!warningShown) {
                        resetInactivityTimer();
                    }
                }, true);
            });

            // Initialize the timer and session status
            resetInactivityTimer();
            updateSessionStatus('active');

            // Handle page visibility change (when user switches tabs)
            document.addEventListener('visibilitychange', function() {
                if (document.visibilityState === 'visible' && !warningShown) {
                    resetInactivityTimer();
                }
            });

            // Make redirectToLogin globally accessible
            window.redirectToLogin = redirectToLogin;

            // Handle browser/tab close events
            window.addEventListener('beforeunload', function(e) {
                if (warningShown) {
                    // If warning is shown, prevent default browser behavior
                    e.preventDefault();
                    e.returnValue = 'Your session is about to expire. Are you sure you want to leave?';
                    return e.returnValue;
                }
            });

            // Network connectivity handling disabled (was part of PWA functionality)
            /*
            window.addEventListener('online', function() {
                if (!warningShown) {
                    resetInactivityTimer();
                }
            });

            window.addEventListener('offline', function() {
                // Pause timers when offline
                clearTimeout(inactivityTimer);
                clearTimeout(warningTimer);
            });
            */

        });

        // Patient context management functions
        function clearPatientContext() {
            if (confirm('Are you sure you want to clear the current patient context?')) {
                // Get CSRF token using multiple fallback methods
                let csrfToken = '';

                // Method 1: Try to get from meta tag
                const metaToken = document.querySelector('meta[name=csrf-token]');
                if (metaToken) {
                    csrfToken = metaToken.getAttribute('content');
                }

                // Method 2: Try to get from hidden input field
                if (!csrfToken) {
                    const inputToken = document.querySelector('input[name=csrfmiddlewaretoken]');
                    if (inputToken) {
                        csrfToken = inputToken.value;
                    }
                }

                // Method 3: Try to get from cookie (fallback)
                if (!csrfToken) {
                    const cookieValue = document.cookie
                        .split('; ')
                        .find(row => row.startsWith('csrftoken='))
                        ?.split('=')[1];
                    if (cookieValue) {
                        csrfToken = cookieValue;
                    }
                }

                // If no CSRF token found, show error
                if (!csrfToken) {
                    alert('Error: CSRF token not found. Please refresh the page and try again.');
                    return;
                }

                fetch('/patients/clear-context/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Remove the patient context from the UI
                        const patientContextElement = document.getElementById('currentPatientContext');
                        if (patientContextElement) {
                            patientContextElement.remove();
                        }
                        // Show success message
                        alert('Patient context cleared successfully.');
                        // Optionally reload the page to refresh context
                        location.reload();
                    } else {
                        alert('Error clearing patient context: ' + (data.error || 'Unknown error'));
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error clearing patient context. Please try again.');
                });
            }
        }
    </script>

    

    
<script>
// Toggle manual code field based on code type selection
document.querySelectorAll('input[name="code_type"]').forEach(function(radio) {
    radio.addEventListener('change', function() {
        const manualField = document.getElementById('manual_code_field');
        const manualInput = document.getElementById('manual_code_input');
        
        if (this.value === 'manual') {
            manualField.style.display = 'block';
            manualInput.required = true;
            manualInput.focus();
        } else {
            manualField.style.display = 'none';
            manualInput.required = false;
            manualInput.value = '';
            updateCodePreview();
        }
    });
});

// Update code preview
function updateCodePreview() {
    const codeType = document.querySelector('input[name="code_type"]:checked').value;
    const manualCode = document.getElementById('manual_code_input').value;
    const preview = document.getElementById('codePreview');
    
    if (codeType === 'manual' && manualCode) {
        preview.textContent = manualCode;
    } else {
        const date = new Date();
        const dateStr = date.getFullYear() + 
                       String(date.getMonth() + 1).padStart(2, '0') + 
                       String(date.getDate()).padStart(2, '0');
        preview.textContent = `AUTH-${dateStr}-XXXXXX`;
    }
}

// Update preview when manual code changes
document.getElementById('manual_code_input').addEventListener('input', updateCodePreview);

// Clear patient selection
function clearPatientSelection() {
    window.location.href = '/desk-office/generate-code/';
}

// Form validation
document.getElementById('generateCodeForm').addEventListener('submit', function(e) {
    const codeType = document.querySelector('input[name="code_type"]:checked').value;
    
    if (codeType === 'manual') {
        const manualCode = document.getElementById('manual_code_input').value;
        
        if (!manualCode.trim()) {
            e.preventDefault();
            alert('Please enter a manual authorization code.');
            document.getElementById('manual_code_input').focus();
            return;
        }
        
        // Validate manual code format
        if (!manualCode.match(/^AUTH-\d{8}-[A-Z0-9]{6,}$/)) {
            e.preventDefault();
            alert('Manual code must follow the format: AUTH-YYYYMMDD-XXXXXX (minimum 6 characters after date)');
            document.getElementById('manual_code_input').focus();
            return;
        }
    }
    
    const amount = parseFloat(document.getElementById('amount').value);
    if (isNaN(amount) || amount <= 0) {
        e.preventDefault();
        alert('Please enter a valid positive amount.');
        document.getElementById('amount').focus();
        return;
    }
    
    const expiryDays = parseInt(document.getElementById('expiry_days').value);
    if (expiryDays < 1 || expiryDays > 365) {
        e.preventDefault();
        alert('Expiry days must be between 1 and 365.');
        document.getElementById('expiry_days').focus();
        return;
    }
    
    // Confirm before generating
    if (!confirm('Are you sure you want to generate this authorization code?')) {
        e.preventDefault();
        return;
    }
});

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    updateCodePreview();
});

// Handle HTMX errors
htmx.on('htmx:responseError', function(evt) {
    console.error('HTMX error:', evt.detail);
    const target = evt.target;
    if (target.id === 'patientResults') {
        target.innerHTML = '<div class="alert alert-danger">Error loading patients. Please try again.</div>';
    }
});

// Clear search results when input is cleared
document.getElementById('patient_search').addEventListener('input', function() {
    if (this.value.trim() === '') {
        document.getElementById('patientResults').innerHTML = '';
    }
});
</script>


    <!-- Global Event Delegation for Pharmacy Active Store -->
    <script>
    $(document).ready(function() {
        // Global event delegation for medication checkboxes (works with dynamically shown/hidden elements)
        $(document).on('change', '.medication-checkbox', function() {
            console.log('Global: Medication checkbox changed', this.checked);
            const $checkbox = $(this);
            const $row = $checkbox.closest('tr');
            const $quantityInput = $row.find('.quantity-input');
            const available = parseInt($checkbox.data('available')) || 0;

            if ($checkbox.is(':checked')) {
                console.log('Global: Enabling quantity input, available:', available);
                $quantityInput.prop('disabled', false);
                $quantityInput.val(1);
                $quantityInput.attr('max', available);
            } else {
                console.log('Global: Disabling quantity input');
                $quantityInput.prop('disabled', true);
                $quantityInput.val(0);
            }

            // Trigger updateSubmitButton if it exists
            if (typeof updateSubmitButton === 'function') {
                updateSubmitButton();
            }
        });
    });
    </script>

    <!-- DataTables JS -->
    <script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.11.5/js/dataTables.bootstrap5.min.js"></script>

    <!-- Select2 JS -->
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

    <!-- Custom JS -->
    
    
    <script src="/static/js/sidebar.js"></script>
    

    <!-- Final Scroll Prevention Script -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Prevent any remaining auto-scroll behaviors
            const sidebar = document.getElementById('sidebar-container');
            if (sidebar) {
                // Force sidebar to top on page load
                setTimeout(function() {
                    sidebar.scrollTop = 0;
                }, 100);
                
                // Override any scrollIntoView calls for sidebar elements
                const sidebarElements = sidebar.querySelectorAll('*');
                sidebarElements.forEach(element => {
                    if (element.scrollIntoView) {
                        element.scrollIntoView = function(options) {
                            return false;
                        };
                    }
                });
                
                // Prevent hash-based scrolling in sidebar
                if (window.location.hash) {
                    window.scrollTo(0, 0);
                }
                
                // Monitor scroll events to detect and prevent auto-scroll
                let userScrolling = false;
                let scrollTimeout;
                
                sidebar.addEventListener('wheel', function() {
                    userScrolling = true;
                    clearTimeout(scrollTimeout);
                    scrollTimeout = setTimeout(function() {
                        userScrolling = false;
                    }, 150);
                });
                
                sidebar.addEventListener('touchstart', function() {
                    userScrolling = true;
                });
                
                // Reset scroll if it changes without user interaction
                const observer = new MutationObserver(function(mutations) {
                    if (!userScrolling) {
                        sidebar.scrollTop = 0;
                    }
                });
                
                observer.observe(sidebar, { 
                    attributes: true, 
                    attributeFilter: ['scrollTop'],
                    childList: true, 
                    subtree: true 
                });
            }
        });
    </script>

    <!-- HTMX/Alpine.js Performance Optimizations -->
    <script>
        // Only handle H.match errors after HTMX has loaded
        document.addEventListener('htmx:afterSettle', function() {
            // If HTMX has loaded and there are issues with H.match, handle them gracefully
            if (typeof window.H !== 'undefined' && window.H) {
                // Ensure H has safe methods
                if (!window.H.match) {
                    window.H.match = function() { return true; };
                }
                if (!window.H.find) {
                    window.H.find = function() { return null; };
                }
            }
        });

        // Global error handler to prevent JavaScript errors
        window.addEventListener('error', function(e) {
            // Suppress H.match errors that might break functionality
            if (e.error && e.error.message && e.error.message.includes('H.match')) {
                e.preventDefault();
                console.warn('Suppressed H.match error:', e.error);
                return false;
            }
            
            // Suppress undefined object errors
            if (e.error && e.error.message && e.error.message.includes('undefined is not an object')) {
                e.preventDefault();
                console.warn('Suppressed undefined object error:', e.error);
                return false;
            }
            
            // Suppress other common library errors
            if (e.error && (
                e.error.message.includes('Cannot read property') ||
                e.error.message.includes('Cannot access property') ||
                e.error.message.includes('null is not an object') ||
                e.error.message.includes('is not a function')
            )) {
                e.preventDefault();
                console.warn('Suppressed library error:', e.error);
                return false;
            }
        });

        // Additional error handler for htmx-specific errors
        window.addEventListener('error', function(e) {
            if (e.error && (
                e.error.message.includes('H.match') ||
                e.error.message.includes('htmx') ||
                e.error.message.includes('undefined is not an object')
            )) {
                e.preventDefault();
                return false;
            }
        }, true); // Use capture phase for better error interception

        // Additional error handler for unhandled promise rejections
        window.addEventListener('unhandledrejection', function(e) {
            if (e.reason && e.reason.message && (
                e.reason.message.includes('H.match') ||
                e.reason.message.includes('undefined is not an object') ||
                e.reason.message.includes('htmx')
            )) {
                e.preventDefault();
                console.warn('Suppressed promise rejection error:', e.reason);
                return false;
            }
        });

        // HTMX Configuration
        try {
            if (typeof htmx !== 'undefined' && htmx.config) {
                htmx.config.globalViewTransitions = true;
                htmx.config.scrollBehavior = 'auto'; // Changed to 'auto' to prevent auto-scroll
                htmx.config.defaultSwapStyle = 'innerHTML';
                htmx.config.defaultSwapDelay = 0;
                htmx.config.defaultSettleDelay = 50;
                
                // Show loading indicators
                if (htmx.on) {
                    htmx.on('htmx:beforeRequest', function(evt) {
                        const target = evt.target;
                        if (target) {
                            target.style.opacity = '0.6';
                        }
                    });
                    
                    htmx.on('htmx:afterRequest', function(evt) {
                        const target = evt.target;
                        if (target) {
                            target.style.opacity = '1';
                        }
                        // Re-initialize tooltips and other Bootstrap components
                        if (typeof bootstrap !== 'undefined') {
                            const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
                            tooltipTriggerList.map(function (tooltipTriggerEl) {
                                return new bootstrap.Tooltip(tooltipTriggerEl);
                            });
                        }
                    });
                    
                    // Add custom event for search
                    htmx.on('search', function(evt) {
                        try {
                            const form = evt.detail.elt;
                            if (form && form.tagName === 'FORM') {
                                // Get all form data
                                const formData = new FormData(form);
                                const url = new URL(form.action || window.location.pathname);
                                
                                // Add form data to URL
                                for (let [key, value] of formData.entries()) {
                                    if (value) {
                                        url.searchParams.set(key, value);
                                    }
                                }
                                
                                // Trigger HTMX request only if ajax method exists
                                if (htmx.ajax) {
                                    htmx.ajax('GET', url, {
                                        target: form.getAttribute('hx-target') || '#patient-table-container',
                                        swap: form.getAttribute('hx-swap') || 'innerHTML',
                                        select: form.getAttribute('hx-select') || 'body'
                                    });
                                }
                            }
                        } catch (error) {
                            console.warn('HTMX search error suppressed:', error);
                        }
                    });
                }
            }
        } catch (error) {
            console.warn('HTMX configuration error suppressed:', error);
        }
        
        // Alpine.js Global Utilities
        try {
            if (typeof Alpine !== 'undefined' && Alpine.data) {
                Alpine.data('loading', () => ({
                    loading: false,
                    show() { this.loading = true; },
                    hide() { this.loading = false; }
                }));
                
                Alpine.data('search', () => ({
                    query: '',
                    typing: false,
                    timeout: null,
                    search() {
                        this.typing = true;
                        clearTimeout(this.timeout);
                        this.timeout = setTimeout(() => {
                            this.typing = false;
                            // Trigger HTMX search if available
                            const searchForm = document.getElementById('search-form');
                            if (searchForm && typeof htmx !== 'undefined' && htmx.trigger) {
                                try {
                                    htmx.trigger(searchForm, 'search');
                                } catch (error) {
                                    console.warn('HTMX trigger error suppressed:', error);
                                }
                            }
                        }, 500);
                    }
                }));
            }
        } catch (error) {
            console.warn('Alpine.js configuration error suppressed:', error);
        }

        // Manual Sidebar Operation Enforcer
        document.addEventListener('DOMContentLoaded', function() {
            // Disable any automatic sidebar behaviors
            const sidebarContainer = document.getElementById('sidebar-container');
            const accordionSidebar = document.getElementById('accordionSidebar');
            
            if (sidebarContainer) {
                // Force manual operation only
                sidebarContainer.setAttribute('data-manual-only', 'true');
                
                // Remove any auto-update attributes
                sidebarContainer.removeAttribute('hx-get');
                sidebarContainer.removeAttribute('hx-trigger');
                sidebarContainer.removeAttribute('hx-swap');
                sidebarContainer.removeAttribute('hx-target');
                sidebarContainer.removeAttribute('data-refresh-url');
                sidebarContainer.removeAttribute('data-auto-refresh');
                sidebarContainer.removeAttribute('data-interval');
                
                // Override scroll behavior
                sidebarContainer.scrollIntoView = function() { return false; };
                sidebarContainer.scrollTop = 0;
                
                // Prevent any automatic scrolling
                Object.defineProperty(sidebarContainer, 'scrollTop', {
                    set: function(value) {
                        if (this._manualScroll) {
                            this._scrollTop = value;
                        }
                    },
                    get: function() {
                        return this._scrollTop || 0;
                    }
                });
            }
            
            if (accordionSidebar) {
                // Disable auto-expand/collapse
                accordionSidebar.querySelectorAll('[data-bs-toggle="collapse"]').forEach(function(element) {
                    element.addEventListener('click', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        const target = document.querySelector(this.getAttribute('data-bs-target'));
                        if (target) {
                            // Manual toggle only
                            target.classList.toggle('show');
                        }
                        // Force sidebar back to top
                        if (sidebarContainer) {
                            sidebarContainer._manualScroll = true;
                            sidebarContainer.scrollTop = 0;
                            setTimeout(() => { sidebarContainer._manualScroll = false; }, 100);
                        }
                    });
                });
            }
            
            // Clear any existing intervals that might cause auto-refresh
            for (let i = 1; i < 99999; i++) {
                clearInterval(i);
            }
            
            // Disable any future auto-refresh attempts
            const originalSetInterval = window.setInterval;
            window.setInterval = function(callback, delay, ...args) {
                // Block any intervals that might refresh sidebar
                if (callback.toString().includes('sidebar') || 
                    callback.toString().includes('refresh') || 
                    callback.toString().includes('reload')) {
                    console.warn('Blocked auto-refresh interval for manual operation');
                    return null;
                }
                return originalSetInterval.call(this, callback, delay, ...args);
            };
        });
    </script>
</body>
</html>
